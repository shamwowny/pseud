<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 ICCA Championship Map</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    min-height: 100vh;
    background: #0A0A0F;
    font-family: 'Outfit', 'Segoe UI', sans-serif;
    color: #E8E6E3;
    overflow: hidden;
  }
  .header {
    padding: 28px 32px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
    display: flex; align-items: flex-end; justify-content: space-between; flex-wrap: wrap; gap: 16px;
  }
  .header-subtitle { font-family: 'Space Mono', monospace; font-size: 11px; color: #666; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .header h1 {
    font-family: 'Outfit'; font-size: 32px; font-weight: 800; letter-spacing: -1px;
    background: linear-gradient(135deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .header-desc { color: #666; font-size: 13px; margin-top: 4px; }
  .stats { display: flex; gap: 28px; }
  .stat { text-align: center; }
  .stat-number { font-family: 'Space Mono', monospace; font-size: 28px; font-weight: 700; line-height: 1; }
  .stat-label { font-size: 11px; color: #666; margin-top: 2px; }
  .main { display: flex; height: calc(100vh - 120px); }

  .sidebar {
    width: 320px; min-width: 320px; border-right: 1px solid rgba(255,255,255,0.06);
    overflow-y: auto; background: rgba(255,255,255,0.01);
  }
  .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .sidebar-title { font-size: 12px; font-weight: 600; color: #888; letter-spacing: 1.5px; text-transform: uppercase; }

  .view-toggle { display: flex; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 3px; border: 1px solid rgba(255,255,255,0.1); }
  .view-toggle button {
    padding: 6px 16px; border: none; background: transparent; color: #888;
    font-family: 'Outfit'; font-size: 12px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: all 0.2s;
  }
  .view-toggle button.active { background: rgba(255,255,255,0.1); color: #E8E6E3; }

  .region-list { display: flex; flex-direction: column; gap: 6px; }
  .region-btn {
    padding: 10px 16px; border: 1.5px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03);
    color: #E8E6E3; border-radius: 8px; cursor: pointer; font-family: 'Outfit'; font-size: 13px; font-weight: 500;
    transition: all 0.25s ease; display: flex; align-items: center; gap: 8px; width: 100%; text-align: left;
  }
  .region-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.25); transform: translateY(-1px); }
  .region-btn.active { border-color: var(--rc); background: color-mix(in srgb, var(--rc) 15%, transparent); box-shadow: 0 0 20px color-mix(in srgb, var(--rc) 20%, transparent); }
  .region-swatch { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
  .region-name { flex: 1; }
  .region-count { font-size: 11px; color: #666; font-family: 'Space Mono', monospace; }

  .region-detail { margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.08); animation: fadeIn 0.4s ease; }
  .region-detail h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
  .region-detail .meta { font-size: 12px; color: #666; margin-bottom: 16px; }

  .qf-list { display: flex; flex-direction: column; gap: 8px; }
  .qf-card {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.25s ease;
  }
  .qf-card:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); }
  .qf-card.active { border-color: var(--rc); background: color-mix(in srgb, var(--rc) 8%, transparent); }
  .qf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .qf-label { font-size: 12px; font-weight: 600; font-family: 'Space Mono', monospace; }
  .qf-date { font-size: 11px; color: #555; }
  .qf-location { font-size: 12px; color: #999; margin-bottom: 8px; }
  .qf-count { font-size: 11px; color: #555; }
  .groups-wrap { display: flex; flex-wrap: wrap; gap: 0; animation: fadeIn 0.4s ease; }
  .group-tag {
    display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); margin: 3px; transition: all 0.2s;
  }
  .group-tag:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }

  .map-area { flex: 1; position: relative; overflow: hidden; }
  .map-bg {
    position: absolute; inset: 0;
    background: radial-gradient(ellipse 80% 60% at 50% 40%, rgba(255,255,255,0.012) 0%, transparent 70%),
      radial-gradient(circle at 20% 80%, rgba(69,123,157,0.03) 0%, transparent 40%),
      radial-gradient(circle at 80% 20%, rgba(212,160,48,0.03) 0%, transparent 40%);
  }
  #map-container { position: absolute; inset: 0; }
  #map-container svg { width: 100%; height: 100%; }

  .state-path { transition: fill 0.3s, stroke 0.3s; cursor: pointer; }
  .school-dot { transition: r 0.3s, opacity 0.3s; }
  .school-glow { transition: opacity 0.3s; }
  .venue-marker { cursor: pointer; transition: transform 0.2s; }
  .venue-marker:hover { filter: brightness(1.4); }

  .venue-popup {
    position: absolute; z-index: 40; background: rgba(10,10,15,0.94); border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px; padding: 16px 18px; backdrop-filter: blur(16px); max-width: 320px;
    pointer-events: auto; animation: fadeIn 0.25s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    cursor: grab; user-select: none;
  }
  .venue-popup.dragging { cursor: grabbing; opacity: 0.92; }
  .venue-popup-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
  .venue-popup-title { font-size: 13px; font-weight: 700; }
  .venue-popup-meta { font-size: 11px; color: #888; margin-top: 2px; }
  .venue-popup-close {
    background: none; border: none; color: #666; font-size: 16px; cursor: pointer; padding: 0 2px;
    line-height: 1; flex-shrink: 0;
  }
  .venue-popup-close:hover { color: #fff; }
  .venue-popup-groups { display: flex; flex-wrap: wrap; gap: 4px; }
  .venue-popup-group {
    font-size: 11px; padding: 3px 10px; border-radius: 14px;
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
  }

  .finals-banner {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(10,10,15,0.85); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 14px 28px; display: flex; align-items: center; gap: 16px;
    backdrop-filter: blur(16px); z-index: 20; white-space: nowrap;
  }
  .finals-dot { width: 8px; height: 8px; border-radius: 50%; background: #FFD700; box-shadow: 0 0 12px rgba(255,215,0,0.5); flex-shrink: 0; }
  .finals-label { font-family: 'Space Mono', monospace; font-size: 10px; color: #FFD700; letter-spacing: 2px; }
  .finals-text { font-size: 14px; font-weight: 600; }

  .legend {
    position: absolute; top: 16px; right: 16px; background: rgba(10,10,15,0.8);
    border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 14px 18px;
    backdrop-filter: blur(12px); z-index: 20;
  }
  .legend-title { font-size: 10px; font-weight: 600; color: #666; letter-spacing: 1.5px; margin-bottom: 10px; text-transform: uppercase; }
  .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; cursor: pointer; }
  .legend-item:hover .legend-label { color: #ddd; }
  .legend-swatch { width: 10px; height: 10px; border-radius: 2px; }
  .legend-label { font-size: 12px; color: #aaa; transition: color 0.2s; }

  .loading-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #666; font-size: 14px; }

  .zoom-controls {
    position: absolute; bottom: 90px; right: 16px; display: flex; flex-direction: column; gap: 4px; z-index: 20;
  }
  .zoom-btn {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12);
    background: rgba(10,10,15,0.8); color: #aaa; font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; backdrop-filter: blur(12px);
    transition: all 0.2s; font-family: 'Space Mono', monospace;
  }
  .zoom-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.25); }
  .zoom-hint {
    position: absolute; bottom: 90px; right: 56px; color: #555; font-size: 10px;
    white-space: nowrap; z-index: 20; pointer-events: none;
  }

  .tooltip-box {
    position: absolute; pointer-events: none; background: rgba(10,10,15,0.92); border: 1px solid rgba(255,255,255,0.15);
    padding: 8px 14px; border-radius: 8px; font-size: 12px; z-index: 50; backdrop-filter: blur(12px);
    opacity: 0; transition: opacity 0.15s; max-width: 280px;
  }
  .tooltip-box.visible { opacity: 1; }
  .tooltip-school { font-weight: 600; white-space: nowrap; }
  .tooltip-region { font-size: 10px; margin-top: 2px; white-space: nowrap; }
  .tooltip-groups { font-size: 10px; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); color: #aaa; line-height: 1.5; }

  .sheet-handle { display: none; }
  .sheet-handle-bar { width: 36px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.25); margin-bottom: 8px; }
  .sheet-content { overflow-y: auto; height: 100%; padding: 20px 16px; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }

  /* ─── MOBILE RESPONSIVE ─── */
  @media (max-width: 768px) {
    body { overflow: hidden; position: fixed; inset: 0; }

    .header {
      padding: 14px 16px 10px; flex-direction: row; align-items: center; gap: 12px;
      position: fixed; top: 0; left: 0; right: 0; z-index: 30;
      background: rgba(10,10,15,0.92); backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .header h1 { font-size: 18px; }
    .header-subtitle { font-size: 9px; letter-spacing: 2px; margin-bottom: 2px; }
    .header-desc { display: none; }
    .stats { gap: 16px; }
    .stat-number { font-size: 18px; }
    .stat-label { font-size: 9px; }

    .main {
      flex-direction: column; height: 100vh; height: 100dvh;
      padding-top: 68px; /* compact header height */
      padding-bottom: 0;
    }

    /* Map takes full remaining space */
    .map-area {
      flex: 1; width: 100%; position: relative; order: 1;
      min-height: 0; /* flex child needs this to shrink properly */
    }

    /* Hide desktop legend on mobile */
    .legend { display: none !important; }

    /* Compact finals banner */
    .finals-banner {
      bottom: auto; top: 8px; left: 8px; transform: none;
      padding: 6px 12px; gap: 8px; border-radius: 8px; z-index: 15;
    }
    .finals-label { font-size: 8px; letter-spacing: 1.5px; }
    .finals-text { font-size: 10px; }
    .finals-dot { width: 6px; height: 6px; }

    /* Zoom controls - move to left side, above bottom sheet */
    .zoom-controls {
      bottom: auto; top: 50px; right: 8px; z-index: 15;
    }
    .zoom-btn { width: 36px; height: 36px; font-size: 18px; }
    .zoom-hint { display: none; }

    /* ─── BOTTOM SHEET ─── */
    .sidebar {
      width: 100%; min-width: unset; position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 25; border-right: none; border-top: 1px solid rgba(255,255,255,0.12);
      background: rgba(10,10,15,0.95); backdrop-filter: blur(20px);
      border-radius: 20px 20px 0 0; padding: 0;
      max-height: 70vh; max-height: 70dvh;
      transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
      order: 2; overflow: hidden;
      box-shadow: 0 -8px 40px rgba(0,0,0,0.5);
    }
    .sidebar.collapsed {
      transform: translateY(calc(100% - 210px));
    }
    .sidebar.expanded {
      transform: translateY(0);
    }

    /* Drag handle */
    .sheet-handle {
      display: flex; flex-direction: column; align-items: center;
      padding: 10px 16px 6px; cursor: grab; touch-action: none;
    }
    .sheet-handle-bar {
      width: 36px; height: 4px; border-radius: 2px;
      background: rgba(255,255,255,0.25); margin-bottom: 8px;
    }

    /* Sheet content area */
    .sheet-content {
      overflow-y: auto; padding: 0 16px 24px;
      max-height: calc(70vh - 60px); max-height: calc(70dvh - 60px);
      -webkit-overflow-scrolling: touch;
    }

    .sidebar-header {
      margin-bottom: 12px; padding: 0;
    }
    .sidebar-title { font-size: 11px; }
    .view-toggle button { padding: 6px 14px; font-size: 11px; }

    .region-list { gap: 4px; }
    .region-btn { padding: 12px 14px; font-size: 14px; }
    .region-swatch { width: 14px; height: 14px; }
    .region-count { font-size: 12px; }

    .qf-card { padding: 14px; }
    .group-tag { padding: 6px 12px; font-size: 11px; }

    /* Venue popup - anchor to middle of screen on mobile */
    .venue-popup {
      position: fixed !important; top: 80px !important; bottom: auto !important;
      left: 8px !important; right: 8px !important;
      max-width: none; border-radius: 14px; z-index: 35;
    }

    /* Tooltip - position above finger */
    .tooltip-box { font-size: 13px; padding: 10px 16px; max-width: 260px; }
    .tooltip-school { font-size: 14px; }
    .tooltip-groups { font-size: 11px; }
  }

  /* Extra small phones */
  @media (max-width: 380px) {
    .header h1 { font-size: 15px; }
    .stat-number { font-size: 16px; }
    .stats { gap: 12px; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="header-subtitle">Varsity Vocals</div>
    <h1>2026 ICCA Championship</h1>
    <p class="header-desc">International Championship of Collegiate A Cappella</p>
  </div>
  <div class="stats">
    <div class="stat"><div class="stat-number" style="color:#D4A030">9</div><div class="stat-label">Regions</div></div>
    <div class="stat"><div class="stat-number" id="stat-groups" style="color:#457B9D">0</div><div class="stat-label">Groups</div></div>
    <div class="stat"><div class="stat-number" id="stat-schools" style="color:#2A9D8F">0</div><div class="stat-label">Schools</div></div>
  </div>
</div>

<div class="main">
  <div class="sidebar" id="sidebar">
    <div class="sheet-handle" id="sheet-handle">
      <div class="sheet-handle-bar"></div>
    </div>
    <div class="sheet-content">
    <div class="sidebar-header">
      <span class="sidebar-title">Regions</span>
      <div class="view-toggle">
        <button id="btn-us" class="active" onclick="setView('us')">N. America</button>
        <button id="btn-uk" onclick="setView('uk')">UK</button>
      </div>
    </div>
    <div class="region-list" id="region-list"></div>
    <div id="region-detail"></div>
    </div>
  </div>

  <div class="map-area">
    <div class="map-bg"></div>
    <div id="map-container"><div class="loading-msg" id="loading">Loading map data…</div></div>
    <div class="tooltip-box" id="tooltip"><div class="tooltip-school" id="tt-school"></div><div class="tooltip-region" id="tt-region"></div><div class="tooltip-groups" id="tt-groups"></div></div>
    <div id="venue-popup" style="display:none"></div>
    <div class="finals-banner">
      <div class="finals-dot"></div>
      <div><div class="finals-label">FINALS</div><div class="finals-text">April 25, 2026 — The Town Hall, New York City</div></div>
    </div>
    <div class="legend" id="legend"></div>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">+</button>
      <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">−</button>
      <button class="zoom-btn" onclick="resetZoom()" title="Reset zoom" style="font-size:12px">⟲</button>
    </div>
    <div class="zoom-hint" id="zoom-hint">scroll to zoom · drag to pan</div>
  </div>
</div>

<script>
// ─── DATA ───
const isMobile = () => window.innerWidth <= 768;
const REGIONS = {
  Central: {
    color: "#D4A030", accent: "#F0C75E",
    schools: ["Cornell University","Lehigh University","Binghamton University","Ithaca College","Syracuse University","University of Waterloo","Western University","McMaster University","Toronto Metropolitan University","University of Toronto","Rochester Institute of Technology","Queen's University","Nazareth University","SUNY Fredonia","Wilfrid Laurier University","Monroe Community College","University of Rochester","University of Pittsburgh","Carnegie Mellon University","Penn State University","Millersville University","Indiana University of Pennsylvania","Duquesne University"],
    quarterfinals: [
      {date:"Jan 31",location:"Binghamton University, NY",lat:42.09,lng:-75.97,groups:["The Chordials","The Class Notes","Echoes","The Harpur Harpeggios","Ithacappella","Off the Record","Otto Tunes","Rhythm Method","Tone Cold","Voicestream"]},
      {date:"Feb 7",location:"University of Waterloo",lat:43.47,lng:-80.54,groups:["The AcaBellas","Equivox","The MacaFellas","Macappella","On That Note","PitchSlapped","RESONATE","Tunes. Beats. Awesome.","The Unaccompanied Minors","The Water Boys"]},
      {date:"Feb 14",location:"Rochester, NY",lat:43.13,lng:-77.63,groups:["The Brick City Singers","The Caledonias","Call4Backup","Dynamic Intonation","Encore","Hawkapella","Tributones","Vocal Accent","Vocal Point","YellowJackets"]},
      {date:"Feb 21",location:"Pittsburgh, PA",lat:40.44,lng:-79.96,groups:["C Flat Run","C Sharp Singers","Counterpoint","The Originals","Pitches & Tones","The Pitt Pendulums","Sargam","The Songburghs","Sounds Like Treble","The Treblemakers"]},
      {date:"Feb 28",location:"Penn State University, PA",lat:40.80,lng:-77.86,groups:["A Whole Step Up","Chromatic","The Coda Conduct","Crimson Chords","Fanaa","The Melismatics","Mic Drop","None of the Above","The Statesmen","VilleHarmonics"]},
    ],
    semifinal:{date:"Mar 21",location:"University at Buffalo",lat:42.95,lng:-78.82},
  },
  "Great Lakes": {
    color: "#457B9D", accent: "#6BAED6",
    schools: ["Eastern Illinois University","University of Chicago","North Central College","University of Wisconsin - Madison","Columbia College Chicago","University of Illinois Urbana-Champaign","University of Wisconsin - Parkside","Northwestern University","University of Minnesota","University of Wisconsin - Stevens Point","Marquette University","University of Wisconsin - Eau Claire","Loyola University - Chicago","Grand Valley State University","University of Michigan","Oakland University","Wayne State University","Central Michigan University","Michigan State University","Macomb Community College","Western Michigan University","Illinois State University","Northern Illinois University","University of Illinois","University Of Wisconsin - Milwaukee"],
    quarterfinals: [
      {date:"Feb 7",location:"University of Chicago",lat:41.79,lng:-87.60,groups:["Blue Fusion","Cadenza","Final Cut","Fundamentally Sound","Horizon","Illini Awaaz","Parkside Range","The Ransom Notes","Sonata Problem","Undertones"]},
      {date:"Feb 14",location:"University of Wisconsin",lat:43.08,lng:-89.41,groups:["7Days","CounterPoint","The Enchantments","Gold 'n Blues","Impromptu","The Naturals","Pitches & Notes","Under A-Rest","Urban Sound","Vocal U"]},
      {date:"Feb 21",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["Counterpoint","Euphoria","Gimble","Gold Vibrations","Maize Mirchi","Melodytroit","On The Rox","Sopranos","State of Fifths","The Treblemakers"]},
      {date:"Feb 22",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["58 Greene","The Accafellas","Amazin' Blue","Capital Green","DJs","The Expressions","The G-Men","The Harmonettes","Ladies First","Radio Treble"]},
      {date:"Feb 28",location:"Illinois State University",lat:40.51,lng:-88.99,groups:["The Acafellaz","Clef Hangers","The Harmelodics","No Comment","No Strings Attached","On the Brink of Normal","Public Hearing","The Rip Chords","Secondary Dominance","The Xtension Chords"]},
    ],
    semifinal:{date:"Mar 28",location:"Pabst Theater",lat:43.04,lng:-87.92},
  },
  "Mid-Atlantic": {
    color: "#2A9D8F", accent: "#4ECDC4",
    schools: ["Rutgers University","University of Maryland","Westminster Choir College","Rowan University","The College of New Jersey","Drexel University","Temple University","University of Maryland Eastern Shore","University of Pennsylvania","Georgetown University","Villanova University","Johns Hopkins University","University of Maryland Baltimore County","George Washington University","Towson University","Salisbury University","Southern Virginia University","Christopher Newport University","Washington and Lee University","James Madison University","William & Mary","George Mason University","Virginia Commonwealth University","Lafayette College","University of Delaware","West Chester University","Stockton University"],
    quarterfinals: [
      {date:"Jan 31",location:"The College of New Jersey",lat:40.27,lng:-74.78,groups:["Casual Harmony","DaCadence","The Deaftones","The OrphanSporks","Profecy","RAAG","Rowan Vocals","ShockWave","The Trentones"]},
      {date:"Feb 14",location:"Drexel University",lat:39.96,lng:-75.19,groups:["The Cleftomaniacs","Faux Paz","LiaChorus","The Muses","Owlcappella","Penny Loafers","Pitch, Please","Superfood","The Supernovas","The TrebleMakers"]},
      {date:"Feb 21",location:"Towson University",lat:39.39,lng:-76.61,groups:["The AllNighters","Cleftomaniacs","The GW Vibes","The Notes of Ranvier","Off Track","Sons of Pitch","Squawkappella","The Stilettos","UNTITLED","The Vocal Chords"]},
      {date:"Feb 28",location:"Oakton High School, Vienna, VA",lat:38.89,lng:-77.26,groups:["Accolade","Extreme Measures","General Admission","Low Key","No Ceiling","Noteworthy","Purple Reign","The Ramifications","Take Note","University Sounds"]},
      {date:"Feb 28",location:"West Chester University",lat:39.95,lng:-75.60,groups:["Cadence","The Chorduroys","The Golden Blues","High Street Harmonix","The Mar-Keys","The MelUDees","Soulfege","Stockapella","Under A Rest","Vocal Point"]},
    ],
    semifinal:{date:"Mar 21",location:"The Grand, Wilmington, DE",lat:39.75,lng:-75.55},
  },
  Midwest: {
    color: "#F4A261", accent: "#FFD166",
    schools: ["Purdue University","Bowling Green State University","Washington University in St. Louis","University of Dayton","Indiana University","Miami University","Indiana University Indianapolis","Kent State University","University of Cincinnati","Saint Louis University","University of Notre Dame","University of Missouri","Missouri University of Science and Technology","Missouri State University","Iowa State University","University of Kansas","Murray State University","Truman State University","Case Western Reserve University","The Ohio State University","Baldwin Wallace University","University of Kentucky","Ohio University","The University of Akron"],
    quarterfinals: [
      {date:"Jan 24",location:"Indianapolis, IN",lat:39.77,lng:-86.16,groups:["Acabellas","AcousChicks","After Dark","Audio Pilots","The Bloomingtones","Just Duet","On A Side Note","Resting Pitch Face","Soundtracks","Vocal Intensity"]},
      {date:"Jan 31",location:"Washington University in St. Louis",lat:38.65,lng:-90.31,groups:["Avocalypse","The Bare Naked Statues","Beyond All Reason","Decadence","The Echoes","Forte","Miner Key","The Naturelles","The Sensasians","The Vocaholics"]},
      {date:"Feb 14",location:"Missouri State University",lat:37.21,lng:-93.28,groups:["A Cub Bella","Astha","The Beartones","Count Me In","Crimson and Blues","EQ Blu","The Hibernotes","Mezzo Forte","Minor Detail","Reverb"]},
      {date:"Feb 21",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["Case in Point","The Flying Solos","Remedy","Retrograde","Scarlet and Grace Notes","SŌL","Ten40!","The Ohio State of Mind","Tonal Eclipse","Underscore"]},
      {date:"Feb 28",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["AcoUstiKats","Buck That!","Cosmos","Dhamakapella","Dynamics","Majors & minors","New Chords on the Block","Rhythm & Roos","Sound of Science","The Tempo Tantrums"]},
    ],
    semifinal:{date:"Mar 14",location:"Indianapolis, IN",lat:39.77,lng:-86.16},
  },
  Northeast: {
    color: "#9B5DE5", accent: "#C77DFF",
    schools: ["SUNY Potsdam","University of Massachusetts Amherst","University at Albany","Rensselaer Polytechnic Institute","SUNY New Paltz","University of Vermont","Emerson College","Boston University","Worcester Polytechnic Institute","Northeastern University","Boston College","Brown University","The Colleges of Fenway","Wesleyan University","The New School","Bryant University","Marist University","Bentley University","Berklee College of Music","University of Connecticut","Eastern Connecticut State University","Fordham University","University of Hartford","Hunter College","Roger Williams University","Quinnipiac University","New York University","Columbia University","Pace University","Hofstra University"],
    quarterfinals: [
      {date:"Jan 24",location:"Rensselaer Polytechnic Institute",lat:42.73,lng:-73.68,groups:["A Sharp Arrangement","Duly Noted","Pitch Please","The Potsdam Pitches","The Potsdam Pointercounts","The Rusty Pipes","S#arp Attitude","The Sexy Pitches","Stay Tuned","Viridescent"]},
      {date:"Feb 14",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["Acappellics","Allegrettos","Audiophiles","Distilled Harmony","Dynamics","The Jabberwocks","The Sirens","Treble on Huntington","Triple Major","Unjust Intonation"]},
      {date:"Feb 15",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["The Bostonians","The Bottom Line","The Enharmonics","The Nor'easters","Off The Clock","The Ramifications","Treble Threat","Treblemakers","The Unisons","Upper Structure"]},
      {date:"Mar 7",location:"University of Hartford",lat:41.80,lng:-72.72,groups:["A Minor","East Harmonies","The F Sharps","The Fordham Ramblers","HartAttack","Hawkappella","Hawkward","L'Shir","The Legends","The Vocaholics"]},
      {date:"Mar 7",location:"NY Society for Ethical Culture",lat:40.77,lng:-73.97,groups:["The Clefhangers","The Cleftomaniacs","Frequency","The Hofbeats","Makin' Treble","The Mixtapes","N'Harmonics","Sigma'cappella","Tonal Recall","Vocollision"]},
    ],
    semifinal:{date:"Mar 28",location:"Berklee College of Music",lat:42.35,lng:-71.09},
  },
  South: {
    color: "#E76F51", accent: "#FF9F7F",
    schools: ["North Carolina State University","University of Mount Olive","University of South Carolina","University of Georgia","Georgia Institute of Technology","High Point University","University of North Carolina at Chapel Hill","University of Florida","University of Miami","University of Central Florida","Florida International University","University of South Florida","East Tennessee State University","Belmont University","University of Tennessee","Vanderbilt University","Emory University","University of North Carolina At Greensboro","Wake Forest University","Appalachian State University","Duke University","Florida State University","Pearl River Community College","East Central Community College","University of Southern Mississippi","Mississippi State University","University of Alabama"],
    quarterfinals: [
      {date:"Jan 24",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Acappology","Carolina Sound","Chordination","Cockappella","Noteworthy","Nothin' But Treble","Offbeats","Tar Heel Voices"]},
      {date:"Jan 31",location:"Trinity Prep HS, Orlando, FL",lat:28.54,lng:-81.38,groups:["Accent","BisCaydence","Gemini Boulevard","HEARTbeats","KeyHarmony","Mixed Mode","The Sedoctaves","Tone Definition","Tones of Gold","Tufaan"]},
      {date:"Feb 7",location:"University of Tennessee",lat:35.95,lng:-83.93,groups:["Ascension","The Belles","The Beltones","Harmonium","Intonations","Prismatics","reVOLution","Spectrum","VOLT"]},
      {date:"Feb 21",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Aural Pleasure","The Chariots","Demon Divas","Ear Candy","Grains of Time","Harmonic Notion","Ladies In Red","Rhythm & Blue","VoiceMale","Wolfgang"]},
      {date:"Mar 7",location:"IMPAC, Biloxi, MS",lat:30.40,lng:-88.89,groups:["AcaBelles","All-Night Yahtzee","Currents","Dooley Noted","EC Listening","Reverb","Spirit of Southern","TrebullDawgs","Tune In","The Voices"]},
    ],
    semifinal:{date:"Mar 28",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90},
  },
  Southwest: {
    color: "#D62828", accent: "#FF4D4D",
    schools: ["University of Texas at Austin","Texas Tech University","University of Houston","Texas A&M University","University of Texas at Dallas","University of Texas at Arlington","Baylor University","University of Nebraska","University of Denver","University of Colorado Boulder","Colorado State University","Oklahoma City University","University of California, San Diego","University of California, Irvine","San Diego State University","University of Arizona","Northern Arizona University","Grand Canyon University","Arizona State University","The Claremont Colleges","Mt. San Antonio College"],
    quarterfinals: [
      {date:"Jan 31",location:"MacArthur High School",lat:29.55,lng:-98.37,groups:["Beauties and the Beat","Empire","Final Measure","HardChord DynaMix","Noteworthy","Novis","RISE","Star Struck","Trillium","VirtuOSO"]},
      {date:"Feb 7",location:"Rococo Theatre, Lincoln, NE",lat:40.81,lng:-96.70,groups:["The Bathtub Dogs","Boots & Cats","Exit 205","Extreme Measures","Mainstreet","Pitch Please","The Red Keys","Take Note","Tonal Eclipse"]},
      {date:"Feb 7",location:"UC San Diego",lat:32.88,lng:-117.23,groups:["Acamazing","Clair de Lune","The Daughters of Triton","Morse Coda","NOVA","Sitaare","SoundWave","The Trebles","The Tritones","Vermillion Vocalists"]},
      {date:"Feb 21",location:"Scottsdale, AZ",lat:33.49,lng:-111.93,groups:["Amplified","The Axecidentals","Canyon Crescendos","Devil Clefs","Enharmonics","Meow or Never","Noteriety","The Pitchforks","Priority Male","The TEMPEtations"]},
      {date:"Feb 28",location:"Claremont University, CA",lat:34.10,lng:-117.71,groups:["Aerodynamix","Claremont Shades","Earth Tones","Elevation","Haath","The Highlanders","Midnight Echo","Nu Aria","Uniting Voices","VocaLotus"]},
    ],
    semifinal:{date:"Mar 15",location:"Scottsdale, AZ",lat:33.49,lng:-111.93},
  },
  West: {
    color: "#264653", accent: "#4A8FA8",
    schools: ["University of Washington","Gonzaga University","University of British Columbia","Western Washington University","Oregon State University","Southern Oregon University","Portland State University","Willamette University","University of Oregon","Montana State University","University of Utah","University of California, Los Angeles","Chapman University","California State University, Fullerton","Moorpark College","University of California, Santa Barbara","University of Southern California","California State University, Northridge","University of California, Santa Cruz","University of California, Davis","UC Berkeley","Stanford University","Diablo Valley College","San Jose State University"],
    quarterfinals: [
      {date:"Jan 24",location:"Tacoma Armory",lat:47.25,lng:-122.44,groups:["Awaaz","Big Bing Theory","Eh? Cappella","For Good Measure","Furmata","The Northwest Collective","Pacific Note West","Trebled Acaholics","The Trill Seekers"]},
      {date:"Jan 31",location:"The Elsinore Theatre",lat:44.94,lng:-123.04,groups:["Divine","Dulcet","The Green Note","Headband","Mind the Gap","Power Chord","Rhapsody","Salt Flats","Tandem","Up Top"]},
      {date:"Jan 31",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Bruin Harmony","Chapman SoundCheck","The Dissonants","The FullerTones","MoorHarmony","Naked Voices","Naya Zamaana","Reverse Osmosis","ScatterTones"]},
      {date:"Feb 21",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Acasola","Awaken","The ChapTones","Cloud 9","Pitch, Please!","Random Voices","Resonance","Simply Vocale","Vocal Percussion Radio"]},
      {date:"Feb 28",location:"Fox Theatre",lat:38.58,lng:-121.50,groups:["The Cleftomaniacs","Drawn to Scale","The Golden Overtones","Jhankaar","The Liquid Hotplates","The Lounge Lizards","The Mendicants","The pH Scale","The Spartones","The Spokes"]},
    ],
    semifinal:{date:"Mar 21",location:"Fox Theatre",lat:38.58,lng:-121.50},
  },
  "United Kingdom": {
    color: "#6A994E", accent: "#95D175",
    schools: ["University of Aberdeen","University of St Andrews","University of Cambridge","University of Edinburgh","University of Stirling","University of Birmingham","University of Nottingham","University of Warwick","University of Leeds","University of Sheffield","University of York","University of Bristol","University of Bath","Royal Welsh College of Music and Drama","Cardiff University","University of Exeter","University of Oxford","Durham University","Lancaster University","University of Manchester","Newcastle University","University College London","London School of Economics","Imperial College London","King's College London","University of Reading"],
    quarterfinals: [
      {date:"Jan 31",location:"Tivoli Theatre, Aberdeen",lat:57.15,lng:-2.09,groups:["Aberpella","The Accidentals","The Alleycats","Cadenza","Cloud IX","The Hummingbirds","Killer Quines","Licence To Trill","Stirling Stellars","Tone Up"]},
      {date:"Feb 8",location:"Nottingham",lat:52.95,lng:-1.15,groups:["AbraCappella","Aca-Pocalypse","Firecracappella","The Leamingtones","RadioOctave","The Songsmiths","Steelworks","VOX"]},
      {date:"Feb 15",location:"Northcott Theatre, Exeter",lat:50.73,lng:-3.53,groups:["Academy","Aquapella","Aurum Voices","The Bristol Suspensions","DeciBelles","The Illuminations","Pitch Fight","Sweet Nothings","Vox"]},
      {date:"Feb 15",location:"Crescent Theatre, Birmingham",lat:52.47,lng:-1.90,groups:["The Acappellads","Northern Lights","OffScore","The Oxford Commas","Roselution","The Skylarks","Tune Army","The Uptone Girls"]},
      {date:"Feb 22",location:"Richmond Theatre, London",lat:51.46,lng:-0.30,groups:["Echotones","The Eustones","The Houghtones","The Imperielles","Kadence","Nth Harmonic","RACA","The Rolling Tones","The Scopes"]},
    ],
    semifinal:{date:"Mar 7",location:"London",lat:51.51,lng:-0.12},
  },
};

const SCHOOL_COORDS = {
  "Cornell University":[42.45,-76.47],"Lehigh University":[40.61,-75.38],"Binghamton University":[42.09,-75.97],"Ithaca College":[42.42,-76.50],"Syracuse University":[43.04,-76.14],"University of Waterloo":[43.47,-80.54],"Western University":[43.01,-81.27],"McMaster University":[43.26,-79.92],"Toronto Metropolitan University":[43.66,-79.38],"University of Toronto":[43.66,-79.40],"Rochester Institute of Technology":[43.08,-77.67],"Queen's University":[44.23,-76.50],"Nazareth University":[43.10,-77.51],"SUNY Fredonia":[42.45,-79.33],"Wilfrid Laurier University":[43.47,-80.53],"Monroe Community College":[43.08,-77.62],"University of Rochester":[43.13,-77.63],"University of Pittsburgh":[40.44,-79.96],"Carnegie Mellon University":[40.44,-79.94],"Penn State University":[40.80,-77.86],"Millersville University":[39.99,-76.35],"Indiana University of Pennsylvania":[40.62,-79.15],"Duquesne University":[40.44,-79.99],
  "Eastern Illinois University":[39.48,-88.18],"University of Chicago":[41.79,-87.60],"North Central College":[41.77,-88.15],"University of Wisconsin - Madison":[43.08,-89.41],"Columbia College Chicago":[41.87,-87.62],"University of Illinois Urbana-Champaign":[40.10,-88.23],"University of Wisconsin - Parkside":[42.64,-87.85],"Northwestern University":[42.06,-87.68],"University of Minnesota":[44.97,-93.23],"University of Wisconsin - Stevens Point":[44.53,-89.57],"Marquette University":[43.04,-87.93],"University of Wisconsin - Eau Claire":[44.80,-91.50],"Loyola University - Chicago":[41.99,-87.66],"Grand Valley State University":[42.96,-85.89],"University of Michigan":[42.28,-83.74],"Oakland University":[42.67,-83.22],"Wayne State University":[42.36,-83.07],"Central Michigan University":[43.59,-84.77],"Michigan State University":[42.73,-84.48],"Macomb Community College":[42.67,-82.95],"Western Michigan University":[42.28,-85.61],"Illinois State University":[40.51,-88.99],"Northern Illinois University":[41.93,-88.77],"University of Illinois":[40.10,-88.23],"University Of Wisconsin - Milwaukee":[43.08,-87.88],
  "Rutgers University":[40.50,-74.45],"University of Maryland":[38.99,-76.94],"Westminster Choir College":[40.35,-74.66],"Rowan University":[39.71,-75.12],"The College of New Jersey":[40.27,-74.78],"Drexel University":[39.96,-75.19],"Temple University":[39.98,-75.16],"University of Maryland Eastern Shore":[38.39,-75.67],"University of Pennsylvania":[39.95,-75.19],"Georgetown University":[38.91,-77.07],"Villanova University":[40.04,-75.34],"Johns Hopkins University":[39.33,-76.62],"University of Maryland Baltimore County":[39.25,-76.71],"George Washington University":[38.90,-77.05],"Towson University":[39.39,-76.61],"Salisbury University":[38.37,-75.60],"Southern Virginia University":[37.78,-79.44],"Christopher Newport University":[37.06,-76.49],"Washington and Lee University":[37.79,-79.44],"James Madison University":[38.43,-78.87],"William & Mary":[37.27,-76.71],"George Mason University":[38.83,-77.31],"Virginia Commonwealth University":[37.55,-77.43],"Lafayette College":[40.70,-75.21],"University of Delaware":[39.68,-75.75],"West Chester University":[39.95,-75.60],"Stockton University":[39.48,-74.54],
  "Purdue University":[40.42,-86.92],"Bowling Green State University":[41.38,-83.64],"Washington University in St. Louis":[38.65,-90.31],"University of Dayton":[39.74,-84.18],"Indiana University":[39.17,-86.52],"Miami University":[39.51,-84.73],"Indiana University Indianapolis":[39.77,-86.17],"Kent State University":[41.15,-81.34],"University of Cincinnati":[39.13,-84.52],"Saint Louis University":[38.64,-90.23],"University of Notre Dame":[41.70,-86.24],"University of Missouri":[38.95,-92.33],"Missouri University of Science and Technology":[37.96,-91.77],"Missouri State University":[37.21,-93.28],"Iowa State University":[42.03,-93.65],"University of Kansas":[38.96,-95.24],"Murray State University":[36.62,-88.33],"Truman State University":[40.19,-92.58],"Case Western Reserve University":[41.50,-81.61],"The Ohio State University":[39.99,-83.01],"Baldwin Wallace University":[41.37,-81.85],"University of Kentucky":[38.04,-84.50],"Ohio University":[39.32,-82.10],"The University of Akron":[41.08,-81.51],
  "SUNY Potsdam":[44.67,-74.98],"University of Massachusetts Amherst":[42.39,-72.53],"University at Albany":[42.69,-73.82],"Rensselaer Polytechnic Institute":[42.73,-73.68],"SUNY New Paltz":[41.74,-74.09],"University of Vermont":[44.48,-73.20],"Emerson College":[42.35,-71.07],"Boston University":[42.35,-71.10],"Worcester Polytechnic Institute":[42.27,-71.81],"Northeastern University":[42.34,-71.09],"Boston College":[42.34,-71.17],"Brown University":[41.83,-71.40],"The Colleges of Fenway":[42.34,-71.10],"Wesleyan University":[41.56,-72.66],"The New School":[40.74,-73.99],"Bryant University":[41.87,-71.46],"Marist University":[41.72,-73.93],"Bentley University":[42.39,-71.22],"Berklee College of Music":[42.35,-71.09],"University of Connecticut":[41.81,-72.25],"Eastern Connecticut State University":[41.72,-72.23],"Fordham University":[40.86,-73.88],"University of Hartford":[41.80,-72.72],"Hunter College":[40.77,-73.96],"Roger Williams University":[41.64,-71.26],"Quinnipiac University":[41.42,-72.89],"New York University":[40.73,-73.99],"Columbia University":[40.81,-73.96],"Pace University":[40.71,-74.00],"Hofstra University":[40.72,-73.60],
  "North Carolina State University":[35.79,-78.68],"University of Mount Olive":[35.20,-78.07],"University of South Carolina":[33.99,-81.02],"University of Georgia":[33.95,-83.37],"Georgia Institute of Technology":[33.77,-84.40],"High Point University":[35.97,-80.01],"University of North Carolina at Chapel Hill":[35.91,-79.05],"University of Florida":[29.64,-82.35],"University of Miami":[25.72,-80.28],"University of Central Florida":[28.60,-81.20],"Florida International University":[25.76,-80.37],"University of South Florida":[28.06,-82.41],"East Tennessee State University":[36.30,-82.37],"Belmont University":[36.13,-86.79],"University of Tennessee":[35.95,-83.93],"Vanderbilt University":[36.15,-86.80],"Emory University":[33.79,-84.32],"University of North Carolina At Greensboro":[36.07,-79.81],"Wake Forest University":[36.13,-80.28],"Appalachian State University":[36.22,-81.69],"Duke University":[36.00,-78.94],"Florida State University":[30.44,-84.30],"Pearl River Community College":[30.77,-89.57],"East Central Community College":[32.35,-89.12],"University of Southern Mississippi":[31.33,-89.33],"Mississippi State University":[33.45,-88.79],"University of Alabama":[33.21,-87.54],
  "University of Texas at Austin":[30.28,-97.74],"Texas Tech University":[33.58,-101.85],"University of Houston":[29.72,-95.34],"Texas A&M University":[30.62,-96.34],"University of Texas at Dallas":[32.99,-96.75],"University of Texas at Arlington":[32.73,-97.11],"Baylor University":[31.55,-97.12],"University of Nebraska":[40.82,-96.70],"University of Denver":[39.68,-104.96],"University of Colorado Boulder":[40.01,-105.27],"Colorado State University":[40.57,-105.08],"Oklahoma City University":[35.47,-97.52],"University of California, San Diego":[32.88,-117.23],"University of California, Irvine":[33.64,-117.84],"San Diego State University":[32.77,-117.07],"University of Arizona":[32.23,-110.95],"Northern Arizona University":[35.19,-111.65],"Grand Canyon University":[33.51,-112.13],"Arizona State University":[33.42,-111.93],"The Claremont Colleges":[34.10,-117.71],"Mt. San Antonio College":[34.05,-117.84],
  "University of Washington":[47.65,-122.30],"Gonzaga University":[47.67,-117.40],"University of British Columbia":[49.26,-123.25],"Western Washington University":[48.73,-122.49],"Oregon State University":[44.56,-123.28],"Southern Oregon University":[42.34,-122.71],"Portland State University":[45.51,-122.68],"Willamette University":[44.94,-123.03],"University of Oregon":[44.04,-123.07],"Montana State University":[45.67,-111.05],"University of Utah":[40.76,-111.84],"University of California, Los Angeles":[34.07,-118.44],"Chapman University":[33.79,-117.85],"California State University, Fullerton":[33.88,-117.89],"Moorpark College":[34.28,-118.88],"University of California, Santa Barbara":[34.41,-119.85],"University of Southern California":[34.02,-118.29],"California State University, Northridge":[34.24,-118.53],"University of California, Santa Cruz":[36.99,-122.06],"University of California, Davis":[38.54,-121.76],"UC Berkeley":[37.87,-122.26],"Stanford University":[37.43,-122.17],"Diablo Valley College":[37.95,-122.06],"San Jose State University":[37.34,-121.88],
  "University of Aberdeen":[57.17,-2.10],"University of St Andrews":[56.34,-2.80],"University of Cambridge":[52.20,0.12],"University of Edinburgh":[55.94,-3.19],"University of Stirling":[56.15,-3.92],"University of Birmingham":[52.45,-1.93],"University of Nottingham":[52.94,-1.19],"University of Warwick":[52.38,-1.56],"University of Leeds":[53.81,-1.55],"University of Sheffield":[53.38,-1.49],"University of York":[53.95,-1.05],"University of Bristol":[51.46,-2.60],"University of Bath":[51.38,-2.33],"Royal Welsh College of Music and Drama":[51.49,-3.18],"Cardiff University":[51.49,-3.18],"University of Exeter":[50.74,-3.54],"University of Oxford":[51.75,-1.25],"Durham University":[54.77,-1.57],"Lancaster University":[54.01,-2.79],"University of Manchester":[53.47,-2.23],"Newcastle University":[54.98,-1.62],"University College London":[51.52,-0.13],"London School of Economics":[51.51,-0.12],"Imperial College London":[51.50,-0.18],"King's College London":[51.51,-0.12],"University of Reading":[51.44,-0.94],
};

// QF venue → schools lookup (which schools compete at each quarterfinal)
const QF_SCHOOLS = {"Central-0": ["Ithaca College", "Binghamton University", "Syracuse University", "Cornell University", "Lehigh University"], "Central-1": ["Toronto Metropolitan University", "University of Waterloo", "Western University", "University of Toronto", "McMaster University"], "Central-2": ["Queen's University", "Rochester Institute of Technology", "Nazareth University", "Wilfrid Laurier University", "University of Rochester", "Monroe Community College", "SUNY Fredonia"], "Central-3": ["University of Pittsburgh", "Carnegie Mellon University"], "Central-4": ["Penn State University", "Duquesne University", "Millersville University", "Indiana University of Pennsylvania", "Lehigh University"], "Great Lakes-0": ["Columbia College Chicago", "Northwestern University", "Eastern Illinois University", "University of Wisconsin - Parkside", "University of Illinois Urbana-Champaign", "University of Chicago", "University of Wisconsin - Madison", "North Central College"], "Great Lakes-1": ["University of Wisconsin - Stevens Point", "Marquette University", "University of Minnesota", "University of Wisconsin - Eau Claire", "University of Wisconsin - Madison"], "Great Lakes-2": ["Northwestern University", "Loyola University - Chicago", "Central Michigan University", "Wayne State University", "Michigan State University", "Grand Valley State University", "Oakland University", "University of Michigan"], "Great Lakes-3": ["Western Michigan University", "University of Michigan - Ann Arbor", "Macomb Community College", "Michigan State University", "University of Michigan"], "Great Lakes-4": ["Illinois State University", "University Of Wisconsin - Milwaukee", "University of Illinois", "Northern Illinois University"], "Mid-Atlantic-0": ["University of Maryland", "The College of New Jersey", "Rowan University", "Rutgers University", "Westminster Choir College"], "Mid-Atlantic-1": ["University of Maryland Eastern Shore", "University of Maryland", "Villanova University", "University of Pennsylvania", "Drexel University", "Georgetown University", "Temple University"], "Mid-Atlantic-2": ["Towson University", "University of Maryland Baltimore County", "George Washington University", "Salisbury University", "Johns Hopkins University"], "Mid-Atlantic-3": ["Southern Virginia University", "Virginia Commonwealth University", "George Mason University", "William & Mary", "James Madison University", "Christopher Newport University", "Washington and Lee University"], "Mid-Atlantic-4": ["University of Delaware", "Lafayette College", "West Chester University", "Stockton University"], "Midwest-0": ["Kent State University", "Indiana University Indianapolis", "Purdue University", "Bowling Green State University", "Miami University", "Indiana University", "Washington University in St. Louis", "University of Dayton"], "Midwest-1": ["University of Notre Dame", "Saint Louis University", "Missouri University of Science and Technology", "University of Missouri", "University of Cincinnati", "Washington University in St. Louis"], "Midwest-2": ["University of Kansas", "Saint Louis University", "Iowa State University", "Missouri State University", "Truman State University", "Murray State University", "Washington University in St. Louis"], "Midwest-3": ["Case Western Reserve University", "The Ohio State University", "Bowling Green State University", "University of Dayton", "Baldwin Wallace University"], "Midwest-4": ["Case Western Reserve University", "Ohio University", "University of Kentucky", "The Ohio State University", "The University of Akron", "Baldwin Wallace University"], "Northeast-0": ["University of Vermont", "SUNY Potsdam", "SUNY New Paltz", "Rensselaer Polytechnic Institute", "University at Albany", "University of Massachusetts Amherst"], "Northeast-1": ["Boston University", "The Colleges of Fenway", "The New School", "Northeastern University", "Wesleyan University", "Emerson College", "Boston College", "Brown University", "Worcester Polytechnic Institute"], "Northeast-2": ["Boston University", "Berklee College of Music", "Suffolk University", "Bryant University", "Northeastern University", "Boston College", "Marist University", "Bentley University"], "Northeast-3": ["University of Hartford", "Hunter College", "Roger Williams University", "Fordham University", "University of Connecticut", "Eastern Connecticut State University", "Quinnipiac University", "New York University"], "Northeast-4": ["Pace University", "Hofstra University", "Columbia University", "New York University"], "South-0": ["University of Mount Olive", "North Carolina State University", "University of Georgia", "Georgia Institute of Technology", "University of North Carolina at Chapel Hill", "University of South Carolina", "High Point University"], "South-1": ["Florida International University", "University of Miami", "University of Central Florida", "University of Florida", "University of South Florida"], "South-2": ["Belmont University", "East Tennessee State University", "University of Tennessee", "Vanderbilt University"], "South-3": ["Vanderbilt University", "North Carolina State University", "Wake Forest University", "Emory University", "Appalachian State University", "Duke University", "University of North Carolina At Greensboro"], "South-4": ["University of Southern Mississippi", "Pearl River Community College", "Florida State University", "Mississippi State University", "East Central Community College", "University of Alabama", "Emory University"], "Southwest-0": ["University of Houston", "Baylor University", "Texas A&M University", "University of Texas at Arlington", "Texas Tech University", "University of Texas at Austin", "University of Texas at Dallas"], "Southwest-1": ["University of Denver", "Colorado State University", "University of Nebraska", "Oklahoma City University", "University of Colorado Boulder"], "Southwest-2": ["University of California, San Diego", "University of California, Irvine", "San Diego State University"], "Southwest-3": ["Grand Canyon University", "Arizona State University", "Northern Arizona University", "University of Arizona"], "Southwest-4": ["Mt. San Antonio College", "The Claremont Colleges", "Northern Arizona University", "University of California, Irvine"], "United Kingdom-0": ["University of Cambridge", "University of Aberdeen", "University of St Andrews", "University of Stirling", "University of Edinburgh"], "United Kingdom-1": ["University of Warwick", "University of Nottingham", "University of Leeds", "University of Sheffield", "University of York", "University of Birmingham"], "United Kingdom-2": ["University of Bath", "University of Exeter", "University of Bristol", "Cardiff University", "Royal Welsh College of Music and Drama"], "United Kingdom-3": ["University of Warwick", "University of Oxford", "Cardiff University", "Lancaster University", "Newcastle University", "Durham University", "University of Manchester", "University of Birmingham"], "United Kingdom-4": ["University of Nottingham", "University College London", "King's College London", "Imperial College London", "London School of Economics", "University of Reading"], "West-0": ["University of British Columbia", "Gonzaga University", "Western Washington University", "University of Washington"], "West-1": ["University of Utah", "Oregon State University", "Portland State University", "University of Oregon", "Southern Oregon University", "Montana State University", "Willamette University"], "West-2": ["University of Southern California", "Chapman University", "University of California, Santa Barbara", "University of California, Los Angeles", "California State University, Fullerton", "Moorpark College"], "West-3": ["Chapman University", "California State University, Northridge", "University of California, Los Angeles", "University of California, Santa Cruz"], "West-4": ["San Jose State University", "Diablo Valley College", "UC Berkeley", "Stanford University", "University of California, Davis"]};

// State → ICCA region mapping (by FIPS or name)
const STATE_REGION = {
  "New York":"Central","Pennsylvania":"Central",
  "Minnesota":"Great Lakes","Wisconsin":"Great Lakes","Illinois":"Great Lakes","Michigan":"Great Lakes",
  "New Jersey":"Mid-Atlantic","Maryland":"Mid-Atlantic","Delaware":"Mid-Atlantic","Virginia":"Mid-Atlantic","West Virginia":"Mid-Atlantic","District of Columbia":"Mid-Atlantic",
  "Indiana":"Midwest","Ohio":"Midwest","Missouri":"Midwest","Kentucky":"Midwest","Kansas":"Midwest","Iowa":"Midwest","North Dakota":"Midwest","South Dakota":"Midwest",
  "Connecticut":"Northeast","Rhode Island":"Northeast","Massachusetts":"Northeast","Vermont":"Northeast","New Hampshire":"Northeast","Maine":"Northeast",
  "Tennessee":"South","North Carolina":"South","South Carolina":"South","Georgia":"South","Florida":"South","Alabama":"South","Mississippi":"South","Arkansas":"South","Louisiana":"South",
  "Texas":"Southwest","Nebraska":"Southwest","Colorado":"Southwest","Oklahoma":"Southwest","Arizona":"Southwest","New Mexico":"Southwest","Nevada":"Southwest",
  "Washington":"West","Oregon":"West","California":"West","Idaho":"West","Montana":"West","Wyoming":"West","Utah":"West",
};

// ─── STATE ───
let currentView = "us";
let selectedRegion = null;
let selectedQF = null;
let usTopoData = null;
let ukGeoData = null;
let usProjection = null;
let ukProjection = null;
let highlightedQF = null; // index of QF whose schools should be highlighted

// Get the set of schools that should be highlighted for current selection
function getHighlightedSchools() {
  if (highlightedQF === null || !selectedRegion) return null;
  const key = `${selectedRegion}-${highlightedQF}`;
  return QF_SCHOOLS[key] ? new Set(QF_SCHOOLS[key]) : null;
}

// Compute stats
let totalGroups = 0, totalSchools = 0;
for (const r of Object.values(REGIONS)) {
  totalSchools += r.schools.length;
  for (const qf of r.quarterfinals) totalGroups += qf.groups.length;
}
document.getElementById("stat-groups").textContent = totalGroups;
document.getElementById("stat-schools").textContent = totalSchools;

// School → groups lookup (parsed from PDF)
const SCHOOL_GROUPS = {"Cornell University": ["The Chordials", "The Class Notes"], "Lehigh University": ["Echoes", "Off the Record", "A Whole Step Up", "The Melismatics"], "Binghamton University": ["The Harpur Harpeggios", "Rhythm Method"], "Ithaca College": ["Ithacappella", "Tone Cold", "Voicestream"], "Syracuse University": ["Otto Tunes"], "University of Waterloo": ["The AcaBellas", "The Unaccompanied Minors", "The Water Boys"], "Western University": ["Equivox"], "McMaster University": ["The MacaFellas", "Macappella", "PitchSlapped"], "Toronto Metropolitan University": ["On That Note", "RESONATE"], "University of Toronto": ["Tunes. Beats. Awesome."], "Rochester Institute of Technology": ["The Brick City Singers", "Encore", "Vocal Accent"], "Queen's University": ["The Caledonias"], "Nazareth University": ["Call4Backup"], "SUNY Fredonia": ["Dynamic Intonation"], "Wilfrid Laurier University": ["Hawkapella"], "Monroe Community College": ["Tributones"], "University of Rochester": ["Vocal Point", "YellowJackets"], "University of Pittsburgh": ["C Flat Run", "Pitches & Tones", "The Pitt Pendulums", "Sargam", "The Songburghs", "Sounds Like Treble"], "Carnegie Mellon University": ["C Sharp Singers", "Counterpoint", "The Originals", "The Treblemakers"], "Millersville University": ["Chromatic", "VilleHarmonics"], "Penn State University": ["The Coda Conduct", "Fanaa", "None of the Above", "The Statesmen"], "Indiana University of Pennsylvania": ["Crimson Chords"], "Duquesne University": ["Mic Drop"], "Eastern Illinois University": ["Blue Fusion"], "University of Chicago": ["Cadenza", "The Ransom Notes"], "North Central College": ["Final Cut", "Sonata Problem"], "University of Wisconsin - Madison": ["Fundamentally Sound", "Pitches & Notes", "Under A-Rest"], "Columbia College Chicago": ["Horizon"], "University of Illinois Urbana-Champaign": ["Illini Awaaz"], "University of Wisconsin - Parkside": ["Parkside Range"], "Northwestern University": ["Undertones", "The Treblemakers"], "University of Minnesota": ["7Days", "The Enchantments", "Urban Sound", "Vocal U"], "University of Wisconsin - Stevens Point": ["CounterPoint"], "Marquette University": ["Gold 'n Blues", "The Naturals"], "University of Wisconsin - Eau Claire": ["Impromptu"], "Loyola University - Chicago": ["Counterpoint"], "Grand Valley State University": ["Euphoria"], "University of Michigan": ["Gimble", "Maize Mirchi", "Sopranos", "58 Greene", "DJs", "The G-Men", "The Harmonettes"], "Oakland University": ["Gold Vibrations"], "Wayne State University": ["Melodytroit"], "Central Michigan University": ["On The Rox"], "Michigan State University": ["State of Fifths", "The Accafellas", "Capital Green", "Ladies First"], "University of Michigan - Ann Arbor": ["Amazin' Blue"], "Macomb Community College": ["The Expressions"], "Western Michigan University": ["Radio Treble"], "Illinois State University": ["The Acafellaz", "Clef Hangers", "On the Brink of Normal", "Secondary Dominance"], "Northern Illinois University": ["The Harmelodics"], "University of Illinois": ["No Comment", "No Strings Attached", "The Rip Chords", "The Xtension Chords"], "University Of Wisconsin - Milwaukee": ["Public Hearing"], "Rutgers University": ["Casual Harmony", "The OrphanSporks", "RAAG", "ShockWave"], "University of Maryland": ["DaCadence", "Faux Paz"], "Westminster Choir College": ["The Deaftones"], "Rowan University": ["Profecy", "Rowan Vocals"], "The College of New Jersey": ["The Trentones"], "Drexel University": ["The Cleftomaniacs", "The TrebleMakers"], "Temple University": ["LiaChorus", "Owlcappella", "Pitch, Please"], "University of Maryland Eastern Shore": ["The Muses"], "University of Pennsylvania": ["Penny Loafers"], "Georgetown University": ["Superfood"], "Villanova University": ["The Supernovas"], "Johns Hopkins University": ["The AllNighters", "The Notes of Ranvier", "The Vocal Chords"], "University of Maryland Baltimore County": ["Cleftomaniacs", "The Stilettos"], "George Washington University": ["The GW Vibes", "Sons of Pitch"], "Towson University": ["Off Track", "UNTITLED"], "Salisbury University": ["Squawkappella"], "Southern Virginia University": ["Accolade"], "Christopher Newport University": ["Extreme Measures", "Take Note", "University Sounds"], "Washington and Lee University": ["General Admission"], "James Madison University": ["Low Key", "Purple Reign"], "William & Mary": ["No Ceiling"], "George Mason University": ["Noteworthy"], "Virginia Commonwealth University": ["The Ramifications"], "Lafayette College": ["Cadence", "The Chorduroys", "The Mar-Keys", "Soulfege"], "University of Delaware": ["The Golden Blues", "The MelUDees", "Vocal Point"], "West Chester University": ["High Street Harmonix", "Under A Rest"], "Stockton University": ["Stockapella"], "Purdue University": ["Acabellas", "Soundtracks"], "Bowling Green State University": ["AcousChicks", "Retrograde", "Ten40!", "Tonal Eclipse"], "Washington University in St. Louis": ["After Dark", "The Sensasians", "Reverb"], "University of Dayton": ["Audio Pilots", "The Flying Solos", "Remedy", "Underscore"], "Indiana University": ["The Bloomingtones", "Resting Pitch Face"], "Miami University": ["Just Duet"], "Indiana University Indianapolis": ["On A Side Note"], "Kent State University": ["Vocal Intensity"], "University of Cincinnati": ["Avocalypse", "The Vocaholics"], "Saint Louis University": ["The Bare Naked Statues", "Beyond All Reason", "Decadence", "Astha"], "University of Notre Dame": ["The Echoes"], "University of Missouri": ["Forte", "The Naturelles"], "Missouri University of Science and Technology": ["Miner Key"], "Missouri State University": ["A Cub Bella", "The Beartones", "The Hibernotes"], "Iowa State University": ["Count Me In", "Mezzo Forte"], "University of Kansas": ["Crimson and Blues"], "Murray State University": ["EQ Blu"], "Truman State University": ["Minor Detail"], "Case Western Reserve University": ["Case in Point", "Dhamakapella"], "The Ohio State University": ["Scarlet and Grace Notes", "The Ohio State of Mind", "Buck That!", "Majors & minors", "Sound of Science"], "Baldwin Wallace University": ["S\u014cL", "Cosmos"], "University of Kentucky": ["AcoUstiKats"], "Ohio University": ["Dynamics", "New Chords on the Block", "The Tempo Tantrums"], "The University of Akron": ["Rhythm & Roos"], "SUNY Potsdam": ["A Sharp Arrangement", "The Potsdam Pitches", "The Potsdam Pointercounts", "Stay Tuned"], "University of Massachusetts Amherst": ["Duly Noted", "S#arp Attitude"], "University at Albany": ["Pitch Please"], "Rensselaer Polytechnic Institute": ["The Rusty Pipes"], "SUNY New Paltz": ["The Sexy Pitches"], "University of Vermont": ["Viridescent"], "Emerson College": ["Acappellics"], "Boston University": ["Allegrettos", "Treblemakers"], "Worcester Polytechnic Institute": ["Audiophiles"], "Northeastern University": ["Distilled Harmony", "Treble on Huntington", "The Nor'easters", "The Unisons"], "Boston College": ["Dynamics", "The Bostonians"], "Brown University": ["The Jabberwocks"], "The Colleges of Fenway": ["The Sirens"], "Wesleyan University": ["Triple Major"], "The New School": ["Unjust Intonation"], "Bryant University": ["The Bottom Line"], "Marist University": ["The Enharmonics"], "Bentley University": ["Off The Clock"], "Suffolk University": ["The Ramifications"], "Berklee College of Music": ["Treble Threat", "Upper Structure"], "University of Connecticut": ["A Minor"], "Eastern Connecticut State University": ["East Harmonies"], "Fordham University": ["The F Sharps", "The Fordham Ramblers"], "University of Hartford": ["HartAttack", "L'Shir"], "Hunter College": ["Hawkappella"], "Roger Williams University": ["Hawkward"], "Quinnipiac University": ["The Legends"], "New York University": ["The Vocaholics", "The Cleftomaniacs", "The Mixtapes", "N'Harmonics", "Vocollision"], "Columbia University": ["The Clefhangers"], "Pace University": ["Frequency", "Tonal Recall"], "Hofstra University": ["The Hofbeats", "Makin' Treble", "Sigma'cappella"], "North Carolina State University": ["Acappology", "Chordination", "Grains of Time", "Ladies In Red", "Wolfgang"], "University of Mount Olive": ["Carolina Sound"], "University of South Carolina": ["Cockappella"], "University of Georgia": ["Noteworthy"], "Georgia Institute of Technology": ["Nothin' But Treble"], "High Point University": ["Offbeats"], "University of North Carolina at Chapel Hill": ["Tar Heel Voices"], "University of Florida": ["Accent", "The Sedoctaves", "Tone Definition"], "University of Miami": ["BisCaydence", "Tufaan"], "University of Central Florida": ["Gemini Boulevard", "KeyHarmony", "Mixed Mode"], "Florida International University": ["HEARTbeats"], "University of South Florida": ["Tones of Gold"], "East Tennessee State University": ["Ascension", "Harmonium"], "Belmont University": ["The Belles", "The Beltones", "Intonations", "Prismatics"], "University of Tennessee": ["reVOLution", "VOLT"], "Vanderbilt University": ["Spectrum", "Harmonic Notion"], "Emory University": ["Aural Pleasure", "Dooley Noted"], "University of North Carolina At Greensboro": ["The Chariots"], "Wake Forest University": ["Demon Divas"], "Appalachian State University": ["Ear Candy", "VoiceMale"], "Duke University": ["Rhythm & Blue"], "Florida State University": ["AcaBelles", "All-Night Yahtzee", "Reverb"], "Pearl River Community College": ["Currents", "The Voices"], "East Central Community College": ["EC Listening"], "University of Southern Mississippi": ["Spirit of Southern"], "Mississippi State University": ["TrebullDawgs"], "University of Alabama": ["Tune In"], "University of Texas at Austin": ["Beauties and the Beat", "Noteworthy"], "Texas Tech University": ["Empire"], "University of Houston": ["Final Measure", "Star Struck"], "Texas A&M University": ["HardChord DynaMix"], "University of Texas at Dallas": ["Novis", "Trillium"], "University of Texas at Arlington": ["RISE"], "Baylor University": ["VirtuOSO"], "University of Nebraska": ["The Bathtub Dogs", "Boots & Cats", "Pitch Please", "The Red Keys", "Take Note"], "University of Denver": ["Exit 205"], "University of Colorado Boulder": ["Extreme Measures"], "Colorado State University": ["Mainstreet"], "Oklahoma City University": ["Tonal Eclipse"], "University of California, San Diego": ["Acamazing", "The Daughters of Triton", "Sitaare", "The Trebles", "The Tritones"], "University of California, Irvine": ["Clair de Lune", "Morse Coda", "NOVA", "Vermillion Vocalists", "Aerodynamix", "Haath", "Uniting Voices", "VocaLotus"], "San Diego State University": ["SoundWave"], "University of Arizona": ["Amplified", "Enharmonics", "Meow or Never", "Noteriety"], "Northern Arizona University": ["The Axecidentals", "Elevation", "The Highlanders"], "Grand Canyon University": ["Canyon Crescendos"], "Arizona State University": ["Devil Clefs", "The Pitchforks", "Priority Male", "The TEMPEtations"], "The Claremont Colleges": ["Claremont Shades", "Earth Tones", "Midnight Echo"], "Mt. San Antonio College": ["Nu Aria"], "University of Aberdeen": ["Aberpella", "Killer Quines"], "University of St Andrews": ["The Accidentals", "The Alleycats", "The Hummingbirds"], "University of Cambridge": ["Cadenza"], "University of Edinburgh": ["Cloud IX", "Licence To Trill", "Tone Up"], "University of Stirling": ["Stirling Stellars"], "University of Birmingham": ["AbraCappella", "The Uptone Girls"], "University of Nottingham": ["Aca-Pocalypse", "Firecracappella", "RadioOctave", "Echotones"], "University of Warwick": ["The Leamingtones", "OffScore"], "University of Leeds": ["The Songsmiths"], "University of Sheffield": ["Steelworks"], "University of York": ["VOX"], "University of Bristol": ["Academy", "The Bristol Suspensions", "Pitch Fight"], "University of Bath": ["Aquapella"], "Royal Welsh College of Music and Drama": ["Aurum Voices"], "Cardiff University": ["DeciBelles", "Vox", "The Acappellads"], "University of Exeter": ["The Illuminations", "Sweet Nothings"], "Durham University": ["Northern Lights"], "University of Oxford": ["The Oxford Commas"], "Lancaster University": ["Roselution"], "University of Manchester": ["The Skylarks"], "Newcastle University": ["Tune Army"], "University College London": ["The Eustones"], "London School of Economics": ["The Houghtones"], "Imperial College London": ["The Imperielles", "Nth Harmonic", "The Scopes"], "King's College London": ["Kadence", "The Rolling Tones"], "University of Reading": ["RACA"], "University of Washington": ["Awaaz", "Furmata"], "Gonzaga University": ["Big Bing Theory"], "University of British Columbia": ["Eh? Cappella", "The Northwest Collective", "Trebled Acaholics", "The Trill Seekers"], "Western Washington University": ["For Good Measure", "Pacific Note West"], "Oregon State University": ["Divine", "Power Chord"], "Southern Oregon University": ["Dulcet"], "Portland State University": ["The Green Note"], "Willamette University": ["Headband", "Tandem", "Up Top"], "University of Oregon": ["Mind the Gap"], "Montana State University": ["Rhapsody"], "University of Utah": ["Salt Flats"], "University of California, Los Angeles": ["Bruin Harmony", "Naya Zamaana", "ScatterTones", "Awaken", "Pitch, Please!", "Random Voices", "Resonance"], "Chapman University": ["Chapman SoundCheck", "The Dissonants", "The ChapTones", "Simply Vocale"], "California State University, Fullerton": ["The FullerTones"], "Moorpark College": ["MoorHarmony"], "University of California, Santa Barbara": ["Naked Voices"], "University of Southern California": ["Reverse Osmosis"], "California State University, Northridge": ["Acasola", "Vocal Percussion Radio (VPR)"], "University of California, Santa Cruz": ["Cloud 9"], "University of California, Davis": ["The Cleftomaniacs", "Jhankaar", "The Liquid Hotplates", "The Lounge Lizards", "The Spokes"], "UC Berkeley": ["Drawn to Scale", "The Golden Overtones"], "Stanford University": ["The Mendicants"], "Diablo Valley College": ["The pH Scale"], "San Jose State University": ["The Spartones"]};

// ─── LOAD MAP DATA ───
async function loadData() {
  try {
    const [usResp, ukResp] = await Promise.all([
      fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
      fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
    ]);
    usTopoData = await usResp.json();
    ukGeoData = await ukResp.json();
  } catch(e) {
    // Fallback: try alternative CDNs
    try {
      const [usResp, ukResp] = await Promise.all([
        fetch("https://unpkg.com/us-atlas@3/states-10m.json"),
        fetch("https://unpkg.com/world-atlas@2/countries-110m.json"),
      ]);
      usTopoData = await usResp.json();
      ukGeoData = await ukResp.json();
    } catch(e2) {
      document.getElementById("loading").textContent = "Could not load map boundaries. Dots will still display.";
    }
  }
  document.getElementById("loading").style.display = "none";
  renderAll();
}

function renderAll() {
  closeVenuePopup();
  renderRegionList();
  renderDetail();
  renderMap();
  renderLegend();
}

function setView(v) {
  currentView = v;
  selectedRegion = v === "uk" ? "United Kingdom" : null;
  selectedQF = null;
  highlightedQF = null;
  currentZoom = null;
  document.getElementById("btn-us").className = v === "us" ? "active" : "";
  document.getElementById("btn-uk").className = v === "uk" ? "active" : "";
  renderAll();
}

function selectRegion(name) {
  selectedRegion = selectedRegion === name ? null : name;
  selectedQF = null;
  highlightedQF = null;
  renderAll();
  // On mobile, expand sheet to show QF details when region selected, collapse when deselected
  if (window.innerWidth <= 768) {
    if (selectedRegion) {
      window.expandSheet && window.expandSheet();
    } else {
      window.collapseSheet && window.collapseSheet();
    }
  }
}

function selectQF(idx) {
  selectedQF = selectedQF === idx ? null : idx;
  renderDetail();
}

// ─── MAP RENDERING ───
let currentZoom = null; // store zoom state to persist across re-renders

function renderMap() {
  const container = document.getElementById("map-container");
  d3.select("#map-container svg").remove();
  const w = container.clientWidth;
  const h = container.clientHeight;
  const svg = d3.select("#map-container").append("svg").attr("width", w).attr("height", h);

  // Create a zoomable group
  const g = svg.append("g").attr("class", "zoom-group");

  // Set up D3 zoom
  const zoom = d3.zoom()
    .scaleExtent([1, 12])
    .on("zoom", (event) => {
      g.attr("transform", event.transform);
      currentZoom = event.transform;
      // Scale dot sizes inversely so they don't become huge
      const k = event.transform.k;
      g.selectAll(".school-dot").attr("r", function() {
        const base = +d3.select(this).attr("data-base-r");
        return base / Math.sqrt(k);
      });
      g.selectAll(".school-glow").attr("r", function() {
        const base = +d3.select(this).attr("data-base-r");
        return base / Math.sqrt(k);
      });
      g.selectAll(".venue-marker").attr("stroke-width", function() {
        const base = +d3.select(this).attr("data-base-sw") || 1.5;
        return base / Math.sqrt(k);
      });
      g.selectAll(".state-path").attr("stroke-width", function() {
        const base = +d3.select(this).attr("data-base-sw") || 0.6;
        return base / k;
      });
    });

  svg.call(zoom);

  // Restore previous zoom if exists
  if (currentZoom) {
    svg.call(zoom.transform, currentZoom);
  }

  if (currentView === "us") {
    renderUSMap(g, w, h);
  } else {
    renderUKMap(g, w, h);
  }

  // Add reset zoom button behavior
  window.resetZoom = () => {
    currentZoom = null;
    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
  };
  window.zoomIn = () => {
    svg.transition().duration(300).call(zoom.scaleBy, 1.5);
  };
  window.zoomOut = () => {
    svg.transition().duration(300).call(zoom.scaleBy, 1 / 1.5);
  };

  // Bulk-tag elements with base sizes for zoom scaling
  g.selectAll(".school-dot").each(function() {
    const el = d3.select(this);
    if (!el.attr("data-base-r")) el.attr("data-base-r", el.attr("r"));
  });
  g.selectAll(".school-glow").each(function() {
    const el = d3.select(this);
    if (!el.attr("data-base-r")) el.attr("data-base-r", el.attr("r"));
  });
  g.selectAll(".state-path").each(function() {
    const el = d3.select(this);
    if (!el.attr("data-base-sw")) el.attr("data-base-sw", el.attr("stroke-width"));
  });
  g.selectAll(".venue-marker").each(function() {
    const el = d3.select(this);
    if (!el.attr("data-base-sw")) el.attr("data-base-sw", el.attr("stroke-width") || 1.5);
  });

  // Apply current zoom scale to elements if zoomed
  if (currentZoom && currentZoom.k !== 1) {
    const k = currentZoom.k;
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r")) / Math.sqrt(k); });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r")) / Math.sqrt(k); });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")) / k; });
    g.selectAll(".venue-marker").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")) / Math.sqrt(k); });
  }
}

function closeVenuePopup() {
  document.getElementById("venue-popup").style.display = "none";
  if (highlightedQF !== null) {
    highlightedQF = null;
    selectedQF = null;
    renderDetail();
    renderMap();
  }
}

// Draggable venue popup
(function() {
  let isDragging = false, startX, startY, startLeft, startTop;
  const popup = document.getElementById("venue-popup");

  popup.addEventListener("mousedown", function(e) {
    // Don't drag if clicking close button or scrolling groups
    if (e.target.closest(".venue-popup-close")) return;
    isDragging = true;
    popup.classList.add("dragging");
    startX = e.clientX;
    startY = e.clientY;
    startLeft = parseInt(popup.style.left) || 0;
    startTop = parseInt(popup.style.top) || 0;
    e.preventDefault();
  });

  document.addEventListener("mousemove", function(e) {
    if (!isDragging) return;
    popup.style.left = (startLeft + e.clientX - startX) + "px";
    popup.style.top = (startTop + e.clientY - startY) + "px";
  });

  document.addEventListener("mouseup", function() {
    if (isDragging) {
      isDragging = false;
      popup.classList.remove("dragging");
    }
  });
})();

// ─── MOBILE BOTTOM SHEET ───
(function() {
  const sidebar = document.getElementById("sidebar");
  const handle = document.getElementById("sheet-handle");
  const isMobile = () => window.innerWidth <= 768;
  let sheetDragging = false, sheetStartY, sheetStartTranslate;

  function getSheetTranslateY() {
    const transform = getComputedStyle(sidebar).transform;
    if (transform === "none") return 0;
    const m = transform.match(/matrix\(.*,\s*([\d.-]+)\)/);
    return m ? parseFloat(m[1]) : 0;
  }

  function setSheetState(collapsed) {
    if (!isMobile()) return;
    if (collapsed) {
      sidebar.classList.add("collapsed");
      sidebar.classList.remove("expanded");
    } else {
      sidebar.classList.remove("collapsed");
      sidebar.classList.add("expanded");
    }
    sidebar.style.transform = "";
  }

  // Initialize as collapsed on mobile
  function initSheet() {
    if (isMobile()) {
      setSheetState(true);
    } else {
      sidebar.classList.remove("collapsed", "expanded");
      sidebar.style.transform = "";
    }
  }

  // Touch drag
  handle.addEventListener("touchstart", function(e) {
    if (!isMobile()) return;
    sheetDragging = true;
    sheetStartY = e.touches[0].clientY;
    sheetStartTranslate = getSheetTranslateY();
    sidebar.style.transition = "none";
  }, { passive: true });

  document.addEventListener("touchmove", function(e) {
    if (!sheetDragging) return;
    const dy = e.touches[0].clientY - sheetStartY;
    const maxUp = 0;
    const sheetH = sidebar.offsetHeight;
    const collapsedOffset = sheetH - 210;
    const newY = Math.max(maxUp, Math.min(collapsedOffset, sheetStartTranslate + dy));
    sidebar.style.transform = `translateY(${newY}px)`;
  }, { passive: true });

  document.addEventListener("touchend", function() {
    if (!sheetDragging) return;
    sheetDragging = false;
    sidebar.style.transition = "";
    const currentY = getSheetTranslateY();
    const sheetH = sidebar.offsetHeight;
    const collapsedOffset = sheetH - 210;
    // Snap to closest state
    setSheetState(currentY > collapsedOffset * 0.4);
  });

  // Click handle to toggle
  handle.addEventListener("click", function() {
    if (!isMobile()) return;
    const isCollapsed = sidebar.classList.contains("collapsed");
    setSheetState(!isCollapsed);
  });

  // Expose for use from region selection
  window.expandSheet = () => { if (isMobile()) setSheetState(false); };
  window.collapseSheet = () => { if (isMobile()) setSheetState(true); };
  window.initSheet = initSheet;

  // Handle resize
  window.addEventListener("resize", initSheet);
  initSheet();
})();

function showVenuePopup(screenX, screenY, qf, qfIdx, regionName, regionData) {
  const popup = document.getElementById("venue-popup");
  const mapArea = document.querySelector(".map-area");
  const rect = mapArea.getBoundingClientRect();
  let left = screenX - rect.left + 14;
  let top = screenY - rect.top - 10;
  if (left + 330 > rect.width) left = screenX - rect.left - 340;
  if (top + 250 > rect.height) top = rect.height - 260;
  if (top < 10) top = 10;
  if (left < 10) left = 10;

  popup.className = "venue-popup";
  popup.style.display = "block";
  popup.style.left = left + "px";
  popup.style.top = top + "px";
  popup.innerHTML = `
    <div style="width:32px;height:3px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 10px;"></div>
    <div class="venue-popup-header">
      <div>
        <div class="venue-popup-title" style="color:${regionData.accent}">QF ${qfIdx + 1} — ${qf.location}</div>
        <div class="venue-popup-meta">${qf.date} · ${regionName} · ${qf.groups.length} groups</div>
      </div>
      <button class="venue-popup-close" onclick="closeVenuePopup()">✕</button>
    </div>
    <div class="venue-popup-groups">
      ${qf.groups.map(g => `<span class="venue-popup-group">${g}</span>`).join("")}
    </div>
  `;
}

function renderUSMap(svg, w, h) {
  // Use Albers USA projection fitted to container
  usProjection = d3.geoAlbersUsa().fitSize([w * 0.92, h * 0.88], {type:"Sphere"});
  // Adjust translate to center better
  const [tx, ty] = usProjection.translate();
  usProjection.translate([tx + w * 0.02, ty + h * 0.02]);

  const path = d3.geoPath().projection(usProjection);

  // Draw state boundaries if data loaded
  if (usTopoData) {
    const states = topojson.feature(usTopoData, usTopoData.objects.states);
    svg.append("g").selectAll("path")
      .data(states.features)
      .enter().append("path")
      .attr("d", path)
      .attr("class", "state-path")
      .attr("fill", d => {
        const region = STATE_REGION[d.properties.name];
        const rd = region ? REGIONS[region] : null;
        if (!rd) return "rgba(255,255,255,0.02)";
        const isActive = !selectedRegion || selectedRegion === region;
        return isActive ? rd.color + "20" : rd.color + "08";
      })
      .attr("stroke", d => {
        const region = STATE_REGION[d.properties.name];
        const rd = region ? REGIONS[region] : null;
        if (!rd) return "rgba(255,255,255,0.04)";
        const isActive = !selectedRegion || selectedRegion === region;
        return isActive ? rd.color + "60" : "rgba(255,255,255,0.06)";
      })
      .attr("stroke-width", d => {
        const region = STATE_REGION[d.properties.name];
        const sw = selectedRegion && selectedRegion === region ? 1.5 : 0.6;
        return sw;
      })
      .each(function(d) { d3.select(this).attr("data-base-sw", selectedRegion && STATE_REGION[d.properties.name] === selectedRegion ? 1.5 : 0.6); })
      .on("click", (e, d) => {
        const region = STATE_REGION[d.properties.name];
        if (region) selectRegion(region);
      });
  }

  // Draw school dots
  const tooltip = document.getElementById("tooltip");
  const ttSchool = document.getElementById("tt-school");
  const ttRegion = document.getElementById("tt-region");
  const mapRect = document.querySelector(".map-area").getBoundingClientRect();
  const hlSchools = getHighlightedSchools();

  for (const [regionName, data] of Object.entries(REGIONS)) {
    if (regionName === "United Kingdom") continue;
    const isActive = !selectedRegion || selectedRegion === regionName;
    for (const school of data.schools) {
      const c = SCHOOL_COORDS[school];
      if (!c) continue;
      const projected = usProjection([c[1], c[0]]);
      if (!projected) continue;
      const [x, y] = projected;

      // Determine if this school is highlighted or dimmed by QF selection
      const isInQF = hlSchools ? hlSchools.has(school) : null;
      const isDimmedByQF = hlSchools && !isInQF;
      const isBrightByQF = hlSchools && isInQF;

      const mob = isMobile();
      const dotRadius = isBrightByQF ? (mob ? 7 : 6) : (isActive && selectedRegion ? (mob ? 5.5 : 4.5) : (mob ? 4 : 3));
      const dotOpacity = isDimmedByQF ? 0.08 : (isActive ? 0.9 : 0.12);

      if (isActive && selectedRegion && !isDimmedByQF) {
        svg.append("circle").attr("cx", x).attr("cy", y).attr("r", isBrightByQF ? (mob ? 16 : 14) : (mob ? 12 : 10))
          .attr("data-base-r", isBrightByQF ? (mob ? 16 : 14) : (mob ? 12 : 10))
          .attr("fill", data.color + (isBrightByQF ? "25" : "15")).attr("class", "school-glow");
      }

      // Invisible larger hit area for touch on mobile
      if (mob) {
        svg.append("circle").attr("cx", x).attr("cy", y).attr("r", 14)
          .attr("fill", "transparent").attr("class", "school-hit")
          .style("cursor", "pointer");
      }

      // Visible dot
      const dot = svg.append("circle").attr("cx", x).attr("cy", y)
        .attr("r", dotRadius)
        .attr("data-base-r", dotRadius)
        .attr("fill", data.color)
        .attr("opacity", dotOpacity)
        .attr("class", "school-dot")
        .style("cursor", "pointer");

      // Shared hover handlers for both the dot and the hit area
      const showTip = function(e) {
        const ev = e.touches ? e.touches[0] : e;
        const k = currentZoom ? currentZoom.k : 1;
        dot.attr("r", (mob ? 8 : 7) / Math.sqrt(k));
        ttSchool.textContent = school;
        ttRegion.textContent = regionName;
        ttRegion.style.color = data.accent;
        const groups = SCHOOL_GROUPS[school];
        const ttGroups = document.getElementById("tt-groups");
        if (groups && groups.length > 0) {
          ttGroups.innerHTML = groups.map(g => `<span style="color:#ddd">${g}</span>`).join(" · ");
          ttGroups.style.display = "block";
        } else {
          ttGroups.style.display = "none";
        }
        tooltip.classList.add("visible");
        const rx = ev.clientX - mapRect.left;
        const ry = ev.clientY - mapRect.top;
        tooltip.style.left = (rx + 14) + "px";
        tooltip.style.top = Math.max(10, ry - 40) + "px";
      };
      const moveTip = function(e) {
        const ev = e.touches ? e.touches[0] : e;
        const rx = ev.clientX - mapRect.left;
        const ry = ev.clientY - mapRect.top;
        tooltip.style.left = (rx + 14) + "px";
        tooltip.style.top = Math.max(10, ry - 40) + "px";
      };
      const hideTip = function() {
        const k = currentZoom ? currentZoom.k : 1;
        dot.attr("r", dotRadius / Math.sqrt(k));
        tooltip.classList.remove("visible");
      };

      dot.on("mouseenter", showTip).on("mousemove", moveTip).on("mouseleave", hideTip);
      if (mob) {
        // Also bind to the hit area (it's the previous sibling)
        const hitArea = d3.select(dot.node().previousElementSibling);
        if (hitArea.classed("school-hit")) {
          hitArea.on("touchstart", showTip, {passive: true}).on("touchend", hideTip);
        }
      }
    }
  }

  // Draw QF venue markers when a region is selected
  if (selectedRegion && selectedRegion !== "United Kingdom") {
    const rd = REGIONS[selectedRegion];
    const venueGroup = svg.append("g").attr("class", "venue-markers");

    // Semifinal marker (star shape)
    if (rd.semifinal.lat) {
      const sp = usProjection([rd.semifinal.lng, rd.semifinal.lat]);
      if (sp) {
        const [sx, sy] = sp;
        // Draw a star
        const starSize = isMobile() ? 6 : 10;
        const star = d3.symbol().type(d3.symbolStar).size(starSize * 22);
        venueGroup.append("circle").attr("cx", sx).attr("cy", sy).attr("r", isMobile() ? 10 : 16).attr("fill", rd.color + "20").attr("stroke", rd.color + "40").attr("stroke-width", 1);
        venueGroup.append("path").attr("d", star).attr("transform", `translate(${sx},${sy})`)
          .attr("fill", "#FFD700").attr("stroke", "#FFD700").attr("stroke-width", 0.5).attr("opacity", 0.9)
          .attr("class", "venue-marker")
          .style("cursor", "pointer")
          .on("mouseenter", function(e) {
            ttSchool.textContent = "★ SEMIFINAL — " + rd.semifinal.location;
            ttRegion.textContent = rd.semifinal.date + " · " + selectedRegion;
            ttRegion.style.color = "#FFD700";
            document.getElementById("tt-groups").style.display = "none";
            tooltip.classList.add("visible");
            const rx = e.clientX - mapRect.left;
            const ry = e.clientY - mapRect.top;
            tooltip.style.left = (rx + 14) + "px";
            tooltip.style.top = (ry - 32) + "px";
          })
          .on("mouseleave", function() { tooltip.classList.remove("visible"); });
      }
    }

    // QF venue markers (diamonds)
    rd.quarterfinals.forEach((qf, i) => {
      if (!qf.lat) return;
      const projected = usProjection([qf.lng, qf.lat]);
      if (!projected) return;
      const [vx, vy] = projected;
      const s = isMobile() ? 4.5 : 7;
      const isHighlighted = highlightedQF === i;

      // Outer glow
      const glowR = isHighlighted ? (isMobile() ? 11 : 18) : (isMobile() ? 8 : 14);
      venueGroup.append("circle").attr("cx", vx).attr("cy", vy).attr("r", glowR)
        .attr("fill", rd.color + (isHighlighted ? "30" : "15")).attr("stroke", isHighlighted ? rd.color + "50" : "none").attr("stroke-width", isHighlighted ? 1.5 : 0);

      // Diamond shape
      const diamond = `M${vx},${vy - s} L${vx + s},${vy} L${vx},${vy + s} L${vx - s},${vy} Z`;
      venueGroup.append("path").attr("d", diamond)
        .attr("fill", isHighlighted ? rd.accent : rd.color).attr("stroke", "#fff").attr("stroke-width", isHighlighted ? 2.5 : 1.5).attr("opacity", 0.95)
        .attr("class", "venue-marker")
        .style("cursor", "pointer")
        .on("mouseenter", function(e) {
          d3.select(this).attr("stroke-width", 2.5);
          ttSchool.textContent = `QF ${i+1} — ${qf.location}`;
          ttRegion.textContent = `${qf.date} · ${qf.groups.length} groups · click to highlight schools`;
          ttRegion.style.color = rd.accent;
          document.getElementById("tt-groups").style.display = "none";
          tooltip.classList.add("visible");
          const rx = e.clientX - mapRect.left;
          const ry = e.clientY - mapRect.top;
          tooltip.style.left = (rx + 14) + "px";
          tooltip.style.top = (ry - 32) + "px";
        })
        .on("mouseleave", function() {
          d3.select(this).attr("stroke-width", isHighlighted ? 2.5 : 1.5);
          tooltip.classList.remove("visible");
        })
        .on("click", function(e) {
          tooltip.classList.remove("visible");
          // Toggle highlight
          highlightedQF = highlightedQF === i ? null : i;
          selectedQF = highlightedQF;
          showVenuePopup(e.clientX, e.clientY, qf, i, selectedRegion, rd);
          renderDetail();
          renderMap(); // re-render to update dot brightness
        });

      // QF number label
      venueGroup.append("text").attr("x", vx).attr("y", vy + 0.5)
        .attr("text-anchor", "middle").attr("dominant-baseline", "central")
        .attr("fill", "#fff").attr("font-size", isMobile() ? "6px" : "8px").attr("font-weight", "700")
        .attr("font-family", "'Space Mono', monospace")
        .attr("pointer-events", "none")
        .text(i + 1);
    });
  }
}

function renderUKMap(svg, w, h) {
  ukProjection = d3.geoMercator().center([-2, 54]).scale(w * 2.8).translate([w / 2, h / 2]);
  const path = d3.geoPath().projection(ukProjection);
  const data = REGIONS["United Kingdom"];

  // Draw UK boundary if data loaded
  if (ukGeoData) {
    const countries = topojson.feature(ukGeoData, ukGeoData.objects.countries);
    // UK is id 826
    const uk = countries.features.filter(f => f.id === "826" || f.properties.name === "United Kingdom");
    // Also try Ireland for context
    const ireland = countries.features.filter(f => f.id === "372" || f.properties.name === "Ireland");
    const nearby = [...uk, ...ireland];

    svg.append("g").selectAll("path")
      .data(nearby)
      .enter().append("path")
      .attr("d", path)
      .attr("fill", d => (d.id === "826" || d.properties.name === "United Kingdom") ? data.color + "12" : "rgba(255,255,255,0.02)")
      .attr("stroke", d => (d.id === "826" || d.properties.name === "United Kingdom") ? data.color + "50" : "rgba(255,255,255,0.06)")
      .attr("stroke-width", 1);
  }

  // School dots
  const tooltip = document.getElementById("tooltip");
  const ttSchool = document.getElementById("tt-school");
  const ttRegion = document.getElementById("tt-region");
  const mapRect = document.querySelector(".map-area").getBoundingClientRect();
  const hlSchools = getHighlightedSchools();

  for (const school of data.schools) {
    const c = SCHOOL_COORDS[school];
    if (!c) continue;
    const projected = ukProjection([c[1], c[0]]);
    if (!projected) continue;
    const [x, y] = projected;

    const isInQF = hlSchools ? hlSchools.has(school) : null;
    const isDimmedByQF = hlSchools && !isInQF;
    const isBrightByQF = hlSchools && isInQF;

    const dotR = isBrightByQF ? 7 : 5;
    const dotOp = isDimmedByQF ? 0.1 : 0.9;

    if (!isDimmedByQF) {
      svg.append("circle").attr("cx", x).attr("cy", y).attr("r", isBrightByQF ? 14 : 10)
        .attr("data-base-r", isBrightByQF ? 14 : 10)
        .attr("fill", data.color + (isBrightByQF ? "25" : "18")).attr("class", "school-glow");
    }
    svg.append("circle").attr("cx", x).attr("cy", y).attr("r", dotR)
      .attr("data-base-r", dotR)
      .attr("fill", data.color).attr("opacity", dotOp).attr("class", "school-dot")
      .style("cursor", "pointer")
      .on("mouseenter", function(e) {
        const k = currentZoom ? currentZoom.k : 1;
        d3.select(this).attr("r", 8 / Math.sqrt(k));
        ttSchool.textContent = school;
        ttRegion.textContent = "United Kingdom";
        ttRegion.style.color = data.accent;
        const groups = SCHOOL_GROUPS[school];
        const ttGroups = document.getElementById("tt-groups");
        if (groups && groups.length > 0) {
          ttGroups.innerHTML = groups.map(g => `<span style="color:#ddd">${g}</span>`).join(" · ");
          ttGroups.style.display = "block";
        } else {
          ttGroups.style.display = "none";
        }
        tooltip.classList.add("visible");
        const rx = e.clientX - mapRect.left;
        const ry = e.clientY - mapRect.top;
        tooltip.style.left = (rx + 14) + "px";
        tooltip.style.top = (ry - 32) + "px";
      })
      .on("mousemove", function(e) {
        const rx = e.clientX - mapRect.left;
        const ry = e.clientY - mapRect.top;
        tooltip.style.left = (rx + 14) + "px";
        tooltip.style.top = (ry - 32) + "px";
      })
      .on("mouseleave", function() {
        const k = currentZoom ? currentZoom.k : 1;
        d3.select(this).attr("r", dotR / Math.sqrt(k));
        tooltip.classList.remove("visible");
      });
  }

  // QF venue markers for UK
  const venueGroup = svg.append("g").attr("class", "venue-markers");

  // Semifinal
  if (data.semifinal.lat) {
    const sp = ukProjection([data.semifinal.lng, data.semifinal.lat]);
    if (sp) {
      const [sx, sy] = sp;
      const star = d3.symbol().type(d3.symbolStar).size(isMobile() ? 120 : 220);
      venueGroup.append("circle").attr("cx", sx).attr("cy", sy).attr("r", isMobile() ? 10 : 16).attr("fill", data.color + "20").attr("stroke", data.color + "40").attr("stroke-width", 1);
      venueGroup.append("path").attr("d", star).attr("transform", `translate(${sx},${sy})`)
        .attr("fill", "#FFD700").attr("stroke", "#FFD700").attr("stroke-width", 0.5).attr("opacity", 0.9)
        .attr("class", "venue-marker")
        .on("mouseenter", function(e) {
          ttSchool.textContent = "★ SEMIFINAL — " + data.semifinal.location;
          ttRegion.textContent = data.semifinal.date + " · United Kingdom";
          ttRegion.style.color = "#FFD700";
          document.getElementById("tt-groups").style.display = "none";
          tooltip.classList.add("visible");
          const rx = e.clientX - mapRect.left;
          const ry = e.clientY - mapRect.top;
          tooltip.style.left = (rx + 14) + "px";
          tooltip.style.top = (ry - 32) + "px";
        })
        .on("mouseleave", function() { tooltip.classList.remove("visible"); });
    }
  }

  data.quarterfinals.forEach((qf, i) => {
    if (!qf.lat) return;
    const projected = ukProjection([qf.lng, qf.lat]);
    if (!projected) return;
    const [vx, vy] = projected;
    const s = isMobile() ? 5 : 8;
    const isHighlighted = highlightedQF === i;

    const ukGlowR = isHighlighted ? (isMobile() ? 12 : 20) : (isMobile() ? 9 : 16);
    venueGroup.append("circle").attr("cx", vx).attr("cy", vy).attr("r", ukGlowR)
      .attr("fill", data.color + (isHighlighted ? "30" : "15")).attr("stroke", isHighlighted ? data.color + "50" : "none").attr("stroke-width", isHighlighted ? 1.5 : 0);
    const diamond = `M${vx},${vy - s} L${vx + s},${vy} L${vx},${vy + s} L${vx - s},${vy} Z`;
    venueGroup.append("path").attr("d", diamond)
      .attr("fill", isHighlighted ? data.accent : data.color).attr("stroke", "#fff").attr("stroke-width", isHighlighted ? 2.5 : 1.5).attr("opacity", 0.95)
      .attr("class", "venue-marker")
      .style("cursor", "pointer")
      .on("mouseenter", function(e) {
        d3.select(this).attr("stroke-width", 2.5);
        ttSchool.textContent = `QF ${i+1} — ${qf.location}`;
        ttRegion.textContent = `${qf.date} · ${qf.groups.length} groups · click to highlight schools`;
        ttRegion.style.color = data.accent;
        document.getElementById("tt-groups").style.display = "none";
        tooltip.classList.add("visible");
        const rx = e.clientX - mapRect.left;
        const ry = e.clientY - mapRect.top;
        tooltip.style.left = (rx + 14) + "px";
        tooltip.style.top = (ry - 32) + "px";
      })
      .on("mouseleave", function() {
        d3.select(this).attr("stroke-width", isHighlighted ? 2.5 : 1.5);
        tooltip.classList.remove("visible");
      })
      .on("click", function(e) {
        tooltip.classList.remove("visible");
        highlightedQF = highlightedQF === i ? null : i;
        selectedQF = highlightedQF;
        showVenuePopup(e.clientX, e.clientY, qf, i, "United Kingdom", data);
        renderDetail();
        renderMap();
      });

    venueGroup.append("text").attr("x", vx).attr("y", vy + 0.5)
      .attr("text-anchor", "middle").attr("dominant-baseline", "central")
      .attr("fill", "#fff").attr("font-size", "9px").attr("font-weight", "700")
      .attr("font-family", "'Space Mono', monospace")
      .attr("pointer-events", "none")
      .text(i + 1);
  });
}

// ─── SIDEBAR ───
function renderRegionList() {
  const list = document.getElementById("region-list");
  list.innerHTML = "";
  for (const [name, data] of Object.entries(REGIONS)) {
    if (currentView === "uk" && name !== "United Kingdom") continue;
    if (currentView === "us" && name === "United Kingdom") continue;
    const count = data.quarterfinals.reduce((s, qf) => s + qf.groups.length, 0);
    const btn = document.createElement("button");
    btn.className = "region-btn" + (selectedRegion === name ? " active" : "");
    btn.style.setProperty("--rc", data.color);
    btn.onclick = () => selectRegion(name);
    btn.innerHTML = `<span class="region-swatch" style="background:${data.color}"></span><span class="region-name">${name}</span><span class="region-count">${count}</span>`;
    list.appendChild(btn);
  }
}

function renderDetail() {
  const el = document.getElementById("region-detail");
  if (!selectedRegion) { el.innerHTML = ""; return; }
  const data = REGIONS[selectedRegion];
  let html = `<div class="region-detail" style="--rc:${data.color}">
    <h3 style="color:${data.color}">${selectedRegion}</h3>
    <p class="meta">${data.quarterfinals.length} Quarterfinals · Semifinal ${data.semifinal.date} at ${data.semifinal.location}</p>
    <div class="qf-list">`;
  data.quarterfinals.forEach((qf, i) => {
    html += `<div class="qf-card${selectedQF === i ? " active" : ""}" style="--rc:${data.color}" onclick="selectQF(${i})">
      <div class="qf-header"><span class="qf-label" style="color:${data.accent}">QF ${i+1}</span><span class="qf-date">${qf.date}</span></div>
      <div class="qf-location">${qf.location}</div>`;
    if (selectedQF === i) {
      html += `<div class="groups-wrap">${qf.groups.map(g => `<span class="group-tag">${g}</span>`).join("")}</div>`;
    } else {
      html += `<span class="qf-count">${qf.groups.length} groups</span>`;
    }
    html += `</div>`;
  });
  html += `</div></div>`;
  el.innerHTML = html;
}

function renderLegend() {
  const el = document.getElementById("legend");
  if (selectedRegion || currentView === "uk") { el.style.display = "none"; return; }
  el.style.display = "block";
  el.innerHTML = `<div class="legend-title">Legend</div>` +
    Object.entries(REGIONS).filter(([n]) => n !== "United Kingdom").map(([name, data]) =>
      `<div class="legend-item" onclick="selectRegion('${name}')"><span class="legend-swatch" style="background:${data.color}"></span><span class="legend-label">${name}</span></div>`
    ).join("");
}

// Resize handler
window.addEventListener("resize", () => { if (usTopoData || ukGeoData) renderMap(); });

// Init
loadData();
</script>
</body>
</html>
