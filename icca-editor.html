<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ICCA Region Editor</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  min-height: 100vh; background: #0A0A0F;
  font-family: 'Outfit', sans-serif; color: #E8E6E3; overflow: hidden;
}

/* ─── TOOLBAR ─── */
.toolbar {
  height: 52px; display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.02);
}
.toolbar-left { display: flex; align-items: center; gap: 16px; }
.toolbar-title {
  font-size: 15px; font-weight: 700; letter-spacing: -0.5px;
  background: linear-gradient(135deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.toolbar-subtitle { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; letter-spacing: 2px; }
.toolbar-right { display: flex; align-items: center; gap: 8px; }
.tb-btn {
  padding: 6px 14px; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px;
  background: rgba(255,255,255,0.04); color: #bbb; font-family: 'Outfit'; font-size: 12px;
  font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.tb-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.25); }
.tb-btn.primary { background: rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.3); color: #FFD700; }
.tb-btn.primary:hover { background: rgba(255,215,0,0.2); }
.tb-btn.danger { border-color: rgba(255,80,80,0.3); color: #ff6b6b; }
.tb-btn.danger:hover { background: rgba(255,80,80,0.12); }

/* ─── MAIN LAYOUT ─── */
.main { display: flex; height: calc(100vh - 52px); }

/* ─── EDITOR PANEL ─── */
.editor {
  width: 380px; min-width: 380px; border-right: 1px solid rgba(255,255,255,0.06);
  overflow-y: auto; background: rgba(255,255,255,0.01); display: flex; flex-direction: column;
}
.editor-header {
  padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; background: rgba(10,10,15,0.95); z-index: 5; backdrop-filter: blur(8px);
}
.editor-title { font-size: 11px; font-weight: 600; color: #888; letter-spacing: 1.5px; text-transform: uppercase; }
.editor-stats { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.editor-body { flex: 1; overflow-y: auto; padding: 8px 0; }

/* Region blocks */
.region-block { border-bottom: 1px solid rgba(255,255,255,0.04); }
.region-header {
  display: flex; align-items: center; gap: 8px; padding: 10px 16px;
  cursor: pointer; transition: background 0.2s; user-select: none;
}
.region-header:hover { background: rgba(255,255,255,0.03); }
.region-chevron {
  font-size: 10px; color: #555; transition: transform 0.2s; width: 14px; text-align: center;
}
.region-chevron.open { transform: rotate(90deg); }
.region-swatch {
  width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s;
}
.region-swatch:hover { transform: scale(1.2); }
.region-name {
  flex: 1; font-size: 13px; font-weight: 600; cursor: text;
}
.region-name:focus { outline: none; border-bottom: 1px solid rgba(255,255,255,0.3); }
.region-meta { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.region-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
.region-header:hover .region-actions { opacity: 1; }
.region-action-btn {
  width: 22px; height: 22px; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
  background: rgba(255,255,255,0.03); color: #888; font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.region-action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.region-action-btn.del:hover { background: rgba(255,80,80,0.15); color: #ff6b6b; border-color: rgba(255,80,80,0.3); }

/* QF blocks */
.region-body { padding: 0 0 8px; }
.qf-block { margin: 0 10px 6px; }
.qf-header {
  display: flex; align-items: center; gap: 6px; padding: 6px 10px;
  background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 6px 6px 0 0; font-size: 11px; cursor: pointer; user-select: none;
}
.qf-header:hover { background: rgba(255,255,255,0.04); }
.qf-label { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 10px; }
.qf-location { flex: 1; color: #888; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.qf-count { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.qf-actions { display: flex; gap: 3px; opacity: 0; transition: opacity 0.2s; }
.qf-header:hover .qf-actions { opacity: 1; }

/* Group tags (draggable) */
.qf-groups {
  display: flex; flex-wrap: wrap; gap: 0; padding: 6px 8px;
  border: 1px solid rgba(255,255,255,0.06); border-top: none;
  border-radius: 0 0 6px 6px; background: rgba(255,255,255,0.01);
  min-height: 32px; transition: background 0.2s;
}
.qf-groups.drag-over { background: rgba(255,215,0,0.06); border-color: rgba(255,215,0,0.2); }
.group-tag {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 14px; font-size: 11px; margin: 2px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
  cursor: grab; transition: all 0.2s; user-select: none;
}
.group-tag:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
.group-tag.dragging { opacity: 0.4; }
.group-tag .remove-group {
  font-size: 9px; color: #555; cursor: pointer; margin-left: 2px;
  width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; transition: all 0.15s;
}
.group-tag .remove-group:hover { background: rgba(255,80,80,0.2); color: #ff6b6b; }

/* Unassigned groups pool */
.unassigned-pool {
  margin: 12px 10px; padding: 10px; border: 1px dashed rgba(255,255,255,0.1);
  border-radius: 8px; background: rgba(255,255,255,0.01); min-height: 40px;
}
.unassigned-pool.drag-over { background: rgba(255,215,0,0.06); border-color: rgba(255,215,0,0.3); }
.pool-label { font-size: 10px; color: #555; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }

/* ─── MAP AREA ─── */
.map-area { flex: 1; position: relative; overflow: hidden; }
.map-bg {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse 80% 60% at 50% 40%, rgba(255,255,255,0.012) 0%, transparent 70%);
}
#map-container { position: absolute; inset: 0; }
#map-container svg { width: 100%; height: 100%; }
.state-path { transition: fill 0.3s; cursor: pointer; }
.school-dot { transition: opacity 0.3s; }
.school-glow { transition: opacity 0.3s; }

/* Legend overlay */
.map-legend {
  position: absolute; top: 12px; right: 12px; background: rgba(10,10,15,0.85);
  border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px 16px;
  backdrop-filter: blur(12px); z-index: 10;
}
.legend-title { font-size: 9px; font-weight: 600; color: #555; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; }
.legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; font-size: 11px; color: #aaa; cursor: pointer; }
.legend-item:hover { color: #ddd; }
.legend-swatch { width: 8px; height: 8px; border-radius: 2px; }

/* Tooltip */
.tooltip-box {
  position: absolute; pointer-events: none; background: rgba(10,10,15,0.92); border: 1px solid rgba(255,255,255,0.15);
  padding: 8px 14px; border-radius: 8px; font-size: 12px; z-index: 50; backdrop-filter: blur(12px);
  opacity: 0; transition: opacity 0.15s; max-width: 300px;
}
.tooltip-box.visible { opacity: 1; }
.tt-school { font-weight: 600; }
.tt-region { font-size: 10px; margin-top: 2px; }
.tt-groups { font-size: 10px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); color: #aaa; }

/* Selection info panel */
.info-bar {
  position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
  background: rgba(10,10,15,0.85); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px; padding: 10px 20px; backdrop-filter: blur(12px); z-index: 10;
  font-size: 12px; color: #aaa; white-space: nowrap; display: none;
}

/* Zoom controls */
.zoom-controls {
  position: absolute; bottom: 60px; right: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 10;
}
.zoom-btn {
  width: 30px; height: 30px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.12);
  background: rgba(10,10,15,0.8); color: #aaa; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace;
}
.zoom-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

/* Modal overlay */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
  display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #14141a; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
  padding: 24px; min-width: 320px; max-width: 440px;
}
.modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
.modal-input {
  width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px; color: #E8E6E3; font-family: 'Outfit'; font-size: 13px; margin-bottom: 12px;
}
.modal-input:focus { outline: none; border-color: rgba(255,255,255,0.3); }
.modal-row { display: flex; gap: 8px; margin-bottom: 12px; }
.modal-label { font-size: 11px; color: #888; margin-bottom: 4px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
.color-picker { width: 40px; height: 32px; border: none; border-radius: 6px; cursor: pointer; background: none; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div class="toolbar">
  <div class="toolbar-left">
    <div>
      <div class="toolbar-subtitle">ICCA REGION</div>
      <div class="toolbar-title">Assignment Editor</div>
    </div>
  </div>
  <div class="toolbar-right">
    <button class="tb-btn" onclick="addRegion()">+ Region</button>
    <button class="tb-btn" onclick="addQFToSelected()">+ Quarterfinal</button>
    <button class="tb-btn" onclick="addGroupPrompt()">+ Group</button>
    <span style="width:1px;height:24px;background:rgba(255,255,255,0.08);margin:0 4px"></span>
    <button class="tb-btn" onclick="undoAction()">↩ Undo</button>
    <button class="tb-btn primary" onclick="exportJSON()">Export JSON</button>
  </div>
</div>

<div class="main">
  <div class="editor">
    <div class="editor-header">
      <span class="editor-title">Structure</span>
      <span class="editor-stats" id="editor-stats"></span>
    </div>
    <div class="editor-body" id="editor-body"></div>
  </div>

  <div class="map-area">
    <div class="map-bg"></div>
    <div id="map-container"></div>
    <div class="tooltip-box" id="tooltip">
      <div class="tt-school" id="tt-school"></div>
      <div class="tt-region" id="tt-region"></div>
      <div class="tt-groups" id="tt-groups"></div>
    </div>
    <div class="map-legend" id="map-legend"></div>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()">+</button>
      <button class="zoom-btn" onclick="zoomOut()">−</button>
      <button class="zoom-btn" onclick="resetZoom()">⟲</button>
    </div>
    <div class="info-bar" id="info-bar"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal"></div>
</div>

<script>
const REGIONS = {
  Central: {
    color: "#D4A030", accent: "#F0C75E",
    schools: ["Cornell University","Lehigh University","Binghamton University","Ithaca College","Syracuse University","University of Waterloo","Western University","McMaster University","Toronto Metropolitan University","University of Toronto","Rochester Institute of Technology","Queen's University","Nazareth University","SUNY Fredonia","Wilfrid Laurier University","Monroe Community College","University of Rochester","University of Pittsburgh","Carnegie Mellon University","Penn State University","Millersville University","Indiana University of Pennsylvania","Duquesne University"],
    quarterfinals: [
      {date:"Jan 31",location:"Binghamton University, NY",lat:42.09,lng:-75.97,groups:["The Chordials","The Class Notes","Echoes","The Harpur Harpeggios","Ithacappella","Off the Record","Otto Tunes","Rhythm Method","Tone Cold","Voicestream"]},
      {date:"Feb 7",location:"University of Waterloo",lat:43.47,lng:-80.54,groups:["The AcaBellas","Equivox","The MacaFellas","Macappella","On That Note","PitchSlapped","RESONATE","Tunes. Beats. Awesome.","The Unaccompanied Minors","The Water Boys"]},
      {date:"Feb 14",location:"Rochester, NY",lat:43.13,lng:-77.63,groups:["The Brick City Singers","The Caledonias","Call4Backup","Dynamic Intonation","Encore","Hawkapella","Tributones","Vocal Accent","Vocal Point","YellowJackets"]},
      {date:"Feb 21",location:"Pittsburgh, PA",lat:40.44,lng:-79.96,groups:["C Flat Run","C Sharp Singers","Counterpoint","The Originals","Pitches & Tones","The Pitt Pendulums","Sargam","The Songburghs","Sounds Like Treble","The Treblemakers"]},
      {date:"Feb 28",location:"Penn State University, PA",lat:40.80,lng:-77.86,groups:["A Whole Step Up","Chromatic","The Coda Conduct","Crimson Chords","Fanaa","The Melismatics","Mic Drop","None of the Above","The Statesmen","VilleHarmonics"]},
    ],
    semifinal:{date:"Mar 21",location:"University at Buffalo",lat:42.95,lng:-78.82},
  },
  "Great Lakes": {
    color: "#457B9D", accent: "#6BAED6",
    schools: ["Eastern Illinois University","University of Chicago","North Central College","University of Wisconsin - Madison","Columbia College Chicago","University of Illinois Urbana-Champaign","University of Wisconsin - Parkside","Northwestern University","University of Minnesota","University of Wisconsin - Stevens Point","Marquette University","University of Wisconsin - Eau Claire","Loyola University - Chicago","Grand Valley State University","University of Michigan","Oakland University","Wayne State University","Central Michigan University","Michigan State University","Macomb Community College","Western Michigan University","Illinois State University","Northern Illinois University","University of Illinois","University Of Wisconsin - Milwaukee"],
    quarterfinals: [
      {date:"Feb 7",location:"University of Chicago",lat:41.79,lng:-87.60,groups:["Blue Fusion","Cadenza","Final Cut","Fundamentally Sound","Horizon","Illini Awaaz","Parkside Range","The Ransom Notes","Sonata Problem","Undertones"]},
      {date:"Feb 14",location:"University of Wisconsin",lat:43.08,lng:-89.41,groups:["7Days","CounterPoint","The Enchantments","Gold 'n Blues","Impromptu","The Naturals","Pitches & Notes","Under A-Rest","Urban Sound","Vocal U"]},
      {date:"Feb 21",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["Counterpoint","Euphoria","Gimble","Gold Vibrations","Maize Mirchi","Melodytroit","On The Rox","Sopranos","State of Fifths","The Treblemakers"]},
      {date:"Feb 22",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["58 Greene","The Accafellas","Amazin' Blue","Capital Green","DJs","The Expressions","The G-Men","The Harmonettes","Ladies First","Radio Treble"]},
      {date:"Feb 28",location:"Illinois State University",lat:40.51,lng:-88.99,groups:["The Acafellaz","Clef Hangers","The Harmelodics","No Comment","No Strings Attached","On the Brink of Normal","Public Hearing","The Rip Chords","Secondary Dominance","The Xtension Chords"]},
    ],
    semifinal:{date:"Mar 28",location:"Pabst Theater",lat:43.04,lng:-87.92},
  },
  "Mid-Atlantic": {
    color: "#2A9D8F", accent: "#4ECDC4",
    schools: ["Rutgers University","University of Maryland","Westminster Choir College","Rowan University","The College of New Jersey","Drexel University","Temple University","University of Maryland Eastern Shore","University of Pennsylvania","Georgetown University","Villanova University","Johns Hopkins University","University of Maryland Baltimore County","George Washington University","Towson University","Salisbury University","Southern Virginia University","Christopher Newport University","Washington and Lee University","James Madison University","William & Mary","George Mason University","Virginia Commonwealth University","Lafayette College","University of Delaware","West Chester University","Stockton University"],
    quarterfinals: [
      {date:"Jan 31",location:"The College of New Jersey",lat:40.27,lng:-74.78,groups:["Casual Harmony","DaCadence","The Deaftones","The OrphanSporks","Profecy","RAAG","Rowan Vocals","ShockWave","The Trentones"]},
      {date:"Feb 14",location:"Drexel University",lat:39.96,lng:-75.19,groups:["The Cleftomaniacs","Faux Paz","LiaChorus","The Muses","Owlcappella","Penny Loafers","Pitch, Please","Superfood","The Supernovas","The TrebleMakers"]},
      {date:"Feb 21",location:"Towson University",lat:39.39,lng:-76.61,groups:["The AllNighters","Cleftomaniacs","The GW Vibes","The Notes of Ranvier","Off Track","Sons of Pitch","Squawkappella","The Stilettos","UNTITLED","The Vocal Chords"]},
      {date:"Feb 28",location:"Oakton High School, Vienna, VA",lat:38.89,lng:-77.26,groups:["Accolade","Extreme Measures","General Admission","Low Key","No Ceiling","Noteworthy","Purple Reign","The Ramifications","Take Note","University Sounds"]},
      {date:"Feb 28",location:"West Chester University",lat:39.95,lng:-75.60,groups:["Cadence","The Chorduroys","The Golden Blues","High Street Harmonix","The Mar-Keys","The MelUDees","Soulfege","Stockapella","Under A Rest","Vocal Point"]},
    ],
    semifinal:{date:"Mar 21",location:"The Grand, Wilmington, DE",lat:39.75,lng:-75.55},
  },
  Midwest: {
    color: "#F4A261", accent: "#FFD166",
    schools: ["Purdue University","Bowling Green State University","Washington University in St. Louis","University of Dayton","Indiana University","Miami University","Indiana University Indianapolis","Kent State University","University of Cincinnati","Saint Louis University","University of Notre Dame","University of Missouri","Missouri University of Science and Technology","Missouri State University","Iowa State University","University of Kansas","Murray State University","Truman State University","Case Western Reserve University","The Ohio State University","Baldwin Wallace University","University of Kentucky","Ohio University","The University of Akron"],
    quarterfinals: [
      {date:"Jan 24",location:"Indianapolis, IN",lat:39.77,lng:-86.16,groups:["Acabellas","AcousChicks","After Dark","Audio Pilots","The Bloomingtones","Just Duet","On A Side Note","Resting Pitch Face","Soundtracks","Vocal Intensity"]},
      {date:"Jan 31",location:"Washington University in St. Louis",lat:38.65,lng:-90.31,groups:["Avocalypse","The Bare Naked Statues","Beyond All Reason","Decadence","The Echoes","Forte","Miner Key","The Naturelles","The Sensasians","The Vocaholics"]},
      {date:"Feb 14",location:"Missouri State University",lat:37.21,lng:-93.28,groups:["A Cub Bella","Astha","The Beartones","Count Me In","Crimson and Blues","EQ Blu","The Hibernotes","Mezzo Forte","Minor Detail","Reverb"]},
      {date:"Feb 21",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["Case in Point","The Flying Solos","Remedy","Retrograde","Scarlet and Grace Notes","SŌL","Ten40!","The Ohio State of Mind","Tonal Eclipse","Underscore"]},
      {date:"Feb 28",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["AcoUstiKats","Buck That!","Cosmos","Dhamakapella","Dynamics","Majors & minors","New Chords on the Block","Rhythm & Roos","Sound of Science","The Tempo Tantrums"]},
    ],
    semifinal:{date:"Mar 14",location:"Indianapolis, IN",lat:39.77,lng:-86.16},
  },
  Northeast: {
    color: "#9B5DE5", accent: "#C77DFF",
    schools: ["SUNY Potsdam","University of Massachusetts Amherst","University at Albany","Rensselaer Polytechnic Institute","SUNY New Paltz","University of Vermont","Emerson College","Boston University","Worcester Polytechnic Institute","Northeastern University","Boston College","Brown University","The Colleges of Fenway","Wesleyan University","The New School","Bryant University","Marist University","Bentley University","Berklee College of Music","University of Connecticut","Eastern Connecticut State University","Fordham University","University of Hartford","Hunter College","Roger Williams University","Quinnipiac University","New York University","Columbia University","Pace University","Hofstra University"],
    quarterfinals: [
      {date:"Jan 24",location:"Rensselaer Polytechnic Institute",lat:42.73,lng:-73.68,groups:["A Sharp Arrangement","Duly Noted","Pitch Please","The Potsdam Pitches","The Potsdam Pointercounts","The Rusty Pipes","S#arp Attitude","The Sexy Pitches","Stay Tuned","Viridescent"]},
      {date:"Feb 14",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["Acappellics","Allegrettos","Audiophiles","Distilled Harmony","Dynamics","The Jabberwocks","The Sirens","Treble on Huntington","Triple Major","Unjust Intonation"]},
      {date:"Feb 15",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["The Bostonians","The Bottom Line","The Enharmonics","The Nor'easters","Off The Clock","The Ramifications","Treble Threat","Treblemakers","The Unisons","Upper Structure"]},
      {date:"Mar 7",location:"University of Hartford",lat:41.80,lng:-72.72,groups:["A Minor","East Harmonies","The F Sharps","The Fordham Ramblers","HartAttack","Hawkappella","Hawkward","L'Shir","The Legends","The Vocaholics"]},
      {date:"Mar 7",location:"NY Society for Ethical Culture",lat:40.77,lng:-73.97,groups:["The Clefhangers","The Cleftomaniacs","Frequency","The Hofbeats","Makin' Treble","The Mixtapes","N'Harmonics","Sigma'cappella","Tonal Recall","Vocollision"]},
    ],
    semifinal:{date:"Mar 28",location:"Berklee College of Music",lat:42.35,lng:-71.09},
  },
  South: {
    color: "#E76F51", accent: "#FF9F7F",
    schools: ["North Carolina State University","University of Mount Olive","University of South Carolina","University of Georgia","Georgia Institute of Technology","High Point University","University of North Carolina at Chapel Hill","University of Florida","University of Miami","University of Central Florida","Florida International University","University of South Florida","East Tennessee State University","Belmont University","University of Tennessee","Vanderbilt University","Emory University","University of North Carolina At Greensboro","Wake Forest University","Appalachian State University","Duke University","Florida State University","Pearl River Community College","East Central Community College","University of Southern Mississippi","Mississippi State University","University of Alabama"],
    quarterfinals: [
      {date:"Jan 24",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Acappology","Carolina Sound","Chordination","Cockappella","Noteworthy","Nothin' But Treble","Offbeats","Tar Heel Voices"]},
      {date:"Jan 31",location:"Trinity Prep HS, Orlando, FL",lat:28.54,lng:-81.38,groups:["Accent","BisCaydence","Gemini Boulevard","HEARTbeats","KeyHarmony","Mixed Mode","The Sedoctaves","Tone Definition","Tones of Gold","Tufaan"]},
      {date:"Feb 7",location:"University of Tennessee",lat:35.95,lng:-83.93,groups:["Ascension","The Belles","The Beltones","Harmonium","Intonations","Prismatics","reVOLution","Spectrum","VOLT"]},
      {date:"Feb 21",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Aural Pleasure","The Chariots","Demon Divas","Ear Candy","Grains of Time","Harmonic Notion","Ladies In Red","Rhythm & Blue","VoiceMale","Wolfgang"]},
      {date:"Mar 7",location:"IMPAC, Biloxi, MS",lat:30.40,lng:-88.89,groups:["AcaBelles","All-Night Yahtzee","Currents","Dooley Noted","EC Listening","Reverb","Spirit of Southern","TrebullDawgs","Tune In","The Voices"]},
    ],
    semifinal:{date:"Mar 28",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90},
  },
  Southwest: {
    color: "#D62828", accent: "#FF4D4D",
    schools: ["University of Texas at Austin","Texas Tech University","University of Houston","Texas A&M University","University of Texas at Dallas","University of Texas at Arlington","Baylor University","University of Nebraska","University of Denver","University of Colorado Boulder","Colorado State University","Oklahoma City University","University of California, San Diego","University of California, Irvine","San Diego State University","University of Arizona","Northern Arizona University","Grand Canyon University","Arizona State University","The Claremont Colleges","Mt. San Antonio College"],
    quarterfinals: [
      {date:"Jan 31",location:"MacArthur High School",lat:29.55,lng:-98.37,groups:["Beauties and the Beat","Empire","Final Measure","HardChord DynaMix","Noteworthy","Novis","RISE","Star Struck","Trillium","VirtuOSO"]},
      {date:"Feb 7",location:"Rococo Theatre, Lincoln, NE",lat:40.81,lng:-96.70,groups:["The Bathtub Dogs","Boots & Cats","Exit 205","Extreme Measures","Mainstreet","Pitch Please","The Red Keys","Take Note","Tonal Eclipse"]},
      {date:"Feb 7",location:"UC San Diego",lat:32.88,lng:-117.23,groups:["Acamazing","Clair de Lune","The Daughters of Triton","Morse Coda","NOVA","Sitaare","SoundWave","The Trebles","The Tritones","Vermillion Vocalists"]},
      {date:"Feb 21",location:"Scottsdale, AZ",lat:33.49,lng:-111.93,groups:["Amplified","The Axecidentals","Canyon Crescendos","Devil Clefs","Enharmonics","Meow or Never","Noteriety","The Pitchforks","Priority Male","The TEMPEtations"]},
      {date:"Feb 28",location:"Claremont University, CA",lat:34.10,lng:-117.71,groups:["Aerodynamix","Claremont Shades","Earth Tones","Elevation","Haath","The Highlanders","Midnight Echo","Nu Aria","Uniting Voices","VocaLotus"]},
    ],
    semifinal:{date:"Mar 15",location:"Scottsdale, AZ",lat:33.49,lng:-111.93},
  },
  West: {
    color: "#264653", accent: "#4A8FA8",
    schools: ["University of Washington","Gonzaga University","University of British Columbia","Western Washington University","Oregon State University","Southern Oregon University","Portland State University","Willamette University","University of Oregon","Montana State University","University of Utah","University of California, Los Angeles","Chapman University","California State University, Fullerton","Moorpark College","University of California, Santa Barbara","University of Southern California","California State University, Northridge","University of California, Santa Cruz","University of California, Davis","UC Berkeley","Stanford University","Diablo Valley College","San Jose State University"],
    quarterfinals: [
      {date:"Jan 24",location:"Tacoma Armory",lat:47.25,lng:-122.44,groups:["Awaaz","Big Bing Theory","Eh? Cappella","For Good Measure","Furmata","The Northwest Collective","Pacific Note West","Trebled Acaholics","The Trill Seekers"]},
      {date:"Jan 31",location:"The Elsinore Theatre",lat:44.94,lng:-123.04,groups:["Divine","Dulcet","The Green Note","Headband","Mind the Gap","Power Chord","Rhapsody","Salt Flats","Tandem","Up Top"]},
      {date:"Jan 31",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Bruin Harmony","Chapman SoundCheck","The Dissonants","The FullerTones","MoorHarmony","Naked Voices","Naya Zamaana","Reverse Osmosis","ScatterTones"]},
      {date:"Feb 21",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Acasola","Awaken","The ChapTones","Cloud 9","Pitch, Please!","Random Voices","Resonance","Simply Vocale","Vocal Percussion Radio"]},
      {date:"Feb 28",location:"Fox Theatre",lat:38.58,lng:-121.50,groups:["The Cleftomaniacs","Drawn to Scale","The Golden Overtones","Jhankaar","The Liquid Hotplates","The Lounge Lizards","The Mendicants","The pH Scale","The Spartones","The Spokes"]},
    ],
    semifinal:{date:"Mar 21",location:"Fox Theatre",lat:38.58,lng:-121.50},
  },
  "United Kingdom": {
    color: "#6A994E", accent: "#95D175",
    schools: ["University of Aberdeen","University of St Andrews","University of Cambridge","University of Edinburgh","University of Stirling","University of Birmingham","University of Nottingham","University of Warwick","University of Leeds","University of Sheffield","University of York","University of Bristol","University of Bath","Royal Welsh College of Music and Drama","Cardiff University","University of Exeter","University of Oxford","Durham University","Lancaster University","University of Manchester","Newcastle University","University College London","London School of Economics","Imperial College London","King's College London","University of Reading"],
    quarterfinals: [
      {date:"Jan 31",location:"Tivoli Theatre, Aberdeen",lat:57.15,lng:-2.09,groups:["Aberpella","The Accidentals","The Alleycats","Cadenza","Cloud IX","The Hummingbirds","Killer Quines","Licence To Trill","Stirling Stellars","Tone Up"]},
      {date:"Feb 8",location:"Nottingham",lat:52.95,lng:-1.15,groups:["AbraCappella","Aca-Pocalypse","Firecracappella","The Leamingtones","RadioOctave","The Songsmiths","Steelworks","VOX"]},
      {date:"Feb 15",location:"Northcott Theatre, Exeter",lat:50.73,lng:-3.53,groups:["Academy","Aquapella","Aurum Voices","The Bristol Suspensions","DeciBelles","The Illuminations","Pitch Fight","Sweet Nothings","Vox"]},
      {date:"Feb 15",location:"Crescent Theatre, Birmingham",lat:52.47,lng:-1.90,groups:["The Acappellads","Northern Lights","OffScore","The Oxford Commas","Roselution","The Skylarks","Tune Army","The Uptone Girls"]},
      {date:"Feb 22",location:"Richmond Theatre, London",lat:51.46,lng:-0.30,groups:["Echotones","The Eustones","The Houghtones","The Imperielles","Kadence","Nth Harmonic","RACA","The Rolling Tones","The Scopes"]},
    ],
    semifinal:{date:"Mar 7",location:"London",lat:51.51,lng:-0.12},
  },
};

const SCHOOL_COORDS = {
  "Cornell University":[42.45,-76.47],"Lehigh University":[40.61,-75.38],"Binghamton University":[42.09,-75.97],"Ithaca College":[42.42,-76.50],"Syracuse University":[43.04,-76.14],"University of Waterloo":[43.47,-80.54],"Western University":[43.01,-81.27],"McMaster University":[43.26,-79.92],"Toronto Metropolitan University":[43.66,-79.38],"University of Toronto":[43.66,-79.40],"Rochester Institute of Technology":[43.08,-77.67],"Queen's University":[44.23,-76.50],"Nazareth University":[43.10,-77.51],"SUNY Fredonia":[42.45,-79.33],"Wilfrid Laurier University":[43.47,-80.53],"Monroe Community College":[43.08,-77.62],"University of Rochester":[43.13,-77.63],"University of Pittsburgh":[40.44,-79.96],"Carnegie Mellon University":[40.44,-79.94],"Penn State University":[40.80,-77.86],"Millersville University":[39.99,-76.35],"Indiana University of Pennsylvania":[40.62,-79.15],"Duquesne University":[40.44,-79.99],
  "Eastern Illinois University":[39.48,-88.18],"University of Chicago":[41.79,-87.60],"North Central College":[41.77,-88.15],"University of Wisconsin - Madison":[43.08,-89.41],"Columbia College Chicago":[41.87,-87.62],"University of Illinois Urbana-Champaign":[40.10,-88.23],"University of Wisconsin - Parkside":[42.64,-87.85],"Northwestern University":[42.06,-87.68],"University of Minnesota":[44.97,-93.23],"University of Wisconsin - Stevens Point":[44.53,-89.57],"Marquette University":[43.04,-87.93],"University of Wisconsin - Eau Claire":[44.80,-91.50],"Loyola University - Chicago":[41.99,-87.66],"Grand Valley State University":[42.96,-85.89],"University of Michigan":[42.28,-83.74],"Oakland University":[42.67,-83.22],"Wayne State University":[42.36,-83.07],"Central Michigan University":[43.59,-84.77],"Michigan State University":[42.73,-84.48],"Macomb Community College":[42.67,-82.95],"Western Michigan University":[42.28,-85.61],"Illinois State University":[40.51,-88.99],"Northern Illinois University":[41.93,-88.77],"University of Illinois":[40.10,-88.23],"University Of Wisconsin - Milwaukee":[43.08,-87.88],
  "Rutgers University":[40.50,-74.45],"University of Maryland":[38.99,-76.94],"Westminster Choir College":[40.35,-74.66],"Rowan University":[39.71,-75.12],"The College of New Jersey":[40.27,-74.78],"Drexel University":[39.96,-75.19],"Temple University":[39.98,-75.16],"University of Maryland Eastern Shore":[38.39,-75.67],"University of Pennsylvania":[39.95,-75.19],"Georgetown University":[38.91,-77.07],"Villanova University":[40.04,-75.34],"Johns Hopkins University":[39.33,-76.62],"University of Maryland Baltimore County":[39.25,-76.71],"George Washington University":[38.90,-77.05],"Towson University":[39.39,-76.61],"Salisbury University":[38.37,-75.60],"Southern Virginia University":[37.78,-79.44],"Christopher Newport University":[37.06,-76.49],"Washington and Lee University":[37.79,-79.44],"James Madison University":[38.43,-78.87],"William & Mary":[37.27,-76.71],"George Mason University":[38.83,-77.31],"Virginia Commonwealth University":[37.55,-77.43],"Lafayette College":[40.70,-75.21],"University of Delaware":[39.68,-75.75],"West Chester University":[39.95,-75.60],"Stockton University":[39.48,-74.54],
  "Purdue University":[40.42,-86.92],"Bowling Green State University":[41.38,-83.64],"Washington University in St. Louis":[38.65,-90.31],"University of Dayton":[39.74,-84.18],"Indiana University":[39.17,-86.52],"Miami University":[39.51,-84.73],"Indiana University Indianapolis":[39.77,-86.17],"Kent State University":[41.15,-81.34],"University of Cincinnati":[39.13,-84.52],"Saint Louis University":[38.64,-90.23],"University of Notre Dame":[41.70,-86.24],"University of Missouri":[38.95,-92.33],"Missouri University of Science and Technology":[37.96,-91.77],"Missouri State University":[37.21,-93.28],"Iowa State University":[42.03,-93.65],"University of Kansas":[38.96,-95.24],"Murray State University":[36.62,-88.33],"Truman State University":[40.19,-92.58],"Case Western Reserve University":[41.50,-81.61],"The Ohio State University":[39.99,-83.01],"Baldwin Wallace University":[41.37,-81.85],"University of Kentucky":[38.04,-84.50],"Ohio University":[39.32,-82.10],"The University of Akron":[41.08,-81.51],
  "SUNY Potsdam":[44.67,-74.98],"University of Massachusetts Amherst":[42.39,-72.53],"University at Albany":[42.69,-73.82],"Rensselaer Polytechnic Institute":[42.73,-73.68],"SUNY New Paltz":[41.74,-74.09],"University of Vermont":[44.48,-73.20],"Emerson College":[42.35,-71.07],"Boston University":[42.35,-71.10],"Worcester Polytechnic Institute":[42.27,-71.81],"Northeastern University":[42.34,-71.09],"Boston College":[42.34,-71.17],"Brown University":[41.83,-71.40],"The Colleges of Fenway":[42.34,-71.10],"Wesleyan University":[41.56,-72.66],"The New School":[40.74,-73.99],"Bryant University":[41.87,-71.46],"Marist University":[41.72,-73.93],"Bentley University":[42.39,-71.22],"Berklee College of Music":[42.35,-71.09],"University of Connecticut":[41.81,-72.25],"Eastern Connecticut State University":[41.72,-72.23],"Fordham University":[40.86,-73.88],"University of Hartford":[41.80,-72.72],"Hunter College":[40.77,-73.96],"Roger Williams University":[41.64,-71.26],"Quinnipiac University":[41.42,-72.89],"New York University":[40.73,-73.99],"Columbia University":[40.81,-73.96],"Pace University":[40.71,-74.00],"Hofstra University":[40.72,-73.60],
  "North Carolina State University":[35.79,-78.68],"University of Mount Olive":[35.20,-78.07],"University of South Carolina":[33.99,-81.02],"University of Georgia":[33.95,-83.37],"Georgia Institute of Technology":[33.77,-84.40],"High Point University":[35.97,-80.01],"University of North Carolina at Chapel Hill":[35.91,-79.05],"University of Florida":[29.64,-82.35],"University of Miami":[25.72,-80.28],"University of Central Florida":[28.60,-81.20],"Florida International University":[25.76,-80.37],"University of South Florida":[28.06,-82.41],"East Tennessee State University":[36.30,-82.37],"Belmont University":[36.13,-86.79],"University of Tennessee":[35.95,-83.93],"Vanderbilt University":[36.15,-86.80],"Emory University":[33.79,-84.32],"University of North Carolina At Greensboro":[36.07,-79.81],"Wake Forest University":[36.13,-80.28],"Appalachian State University":[36.22,-81.69],"Duke University":[36.00,-78.94],"Florida State University":[30.44,-84.30],"Pearl River Community College":[30.77,-89.57],"East Central Community College":[32.35,-89.12],"University of Southern Mississippi":[31.33,-89.33],"Mississippi State University":[33.45,-88.79],"University of Alabama":[33.21,-87.54],
  "University of Texas at Austin":[30.28,-97.74],"Texas Tech University":[33.58,-101.85],"University of Houston":[29.72,-95.34],"Texas A&M University":[30.62,-96.34],"University of Texas at Dallas":[32.99,-96.75],"University of Texas at Arlington":[32.73,-97.11],"Baylor University":[31.55,-97.12],"University of Nebraska":[40.82,-96.70],"University of Denver":[39.68,-104.96],"University of Colorado Boulder":[40.01,-105.27],"Colorado State University":[40.57,-105.08],"Oklahoma City University":[35.47,-97.52],"University of California, San Diego":[32.88,-117.23],"University of California, Irvine":[33.64,-117.84],"San Diego State University":[32.77,-117.07],"University of Arizona":[32.23,-110.95],"Northern Arizona University":[35.19,-111.65],"Grand Canyon University":[33.51,-112.13],"Arizona State University":[33.42,-111.93],"The Claremont Colleges":[34.10,-117.71],"Mt. San Antonio College":[34.05,-117.84],
  "University of Washington":[47.65,-122.30],"Gonzaga University":[47.67,-117.40],"University of British Columbia":[49.26,-123.25],"Western Washington University":[48.73,-122.49],"Oregon State University":[44.56,-123.28],"Southern Oregon University":[42.34,-122.71],"Portland State University":[45.51,-122.68],"Willamette University":[44.94,-123.03],"University of Oregon":[44.04,-123.07],"Montana State University":[45.67,-111.05],"University of Utah":[40.76,-111.84],"University of California, Los Angeles":[34.07,-118.44],"Chapman University":[33.79,-117.85],"California State University, Fullerton":[33.88,-117.89],"Moorpark College":[34.28,-118.88],"University of California, Santa Barbara":[34.41,-119.85],"University of Southern California":[34.02,-118.29],"California State University, Northridge":[34.24,-118.53],"University of California, Santa Cruz":[36.99,-122.06],"University of California, Davis":[38.54,-121.76],"UC Berkeley":[37.87,-122.26],"Stanford University":[37.43,-122.17],"Diablo Valley College":[37.95,-122.06],"San Jose State University":[37.34,-121.88],
  "University of Aberdeen":[57.17,-2.10],"University of St Andrews":[56.34,-2.80],"University of Cambridge":[52.20,0.12],"University of Edinburgh":[55.94,-3.19],"University of Stirling":[56.15,-3.92],"University of Birmingham":[52.45,-1.93],"University of Nottingham":[52.94,-1.19],"University of Warwick":[52.38,-1.56],"University of Leeds":[53.81,-1.55],"University of Sheffield":[53.38,-1.49],"University of York":[53.95,-1.05],"University of Bristol":[51.46,-2.60],"University of Bath":[51.38,-2.33],"Royal Welsh College of Music and Drama":[51.49,-3.18],"Cardiff University":[51.49,-3.18],"University of Exeter":[50.74,-3.54],"University of Oxford":[51.75,-1.25],"Durham University":[54.77,-1.57],"Lancaster University":[54.01,-2.79],"University of Manchester":[53.47,-2.23],"Newcastle University":[54.98,-1.62],"University College London":[51.52,-0.13],"London School of Economics":[51.51,-0.12],"Imperial College London":[51.50,-0.18],"King's College London":[51.51,-0.12],"University of Reading":[51.44,-0.94],
};

const SCHOOL_GROUPS = {"Cornell University": ["The Chordials", "The Class Notes"], "Lehigh University": ["Echoes", "Off the Record", "A Whole Step Up", "The Melismatics"], "Binghamton University": ["The Harpur Harpeggios", "Rhythm Method"], "Ithaca College": ["Ithacappella", "Tone Cold", "Voicestream"], "Syracuse University": ["Otto Tunes"], "University of Waterloo": ["The AcaBellas", "The Unaccompanied Minors", "The Water Boys"], "Western University": ["Equivox"], "McMaster University": ["The MacaFellas", "Macappella", "PitchSlapped"], "Toronto Metropolitan University": ["On That Note", "RESONATE"], "University of Toronto": ["Tunes. Beats. Awesome."], "Rochester Institute of Technology": ["The Brick City Singers", "Encore", "Vocal Accent"], "Queen's University": ["The Caledonias"], "Nazareth University": ["Call4Backup"], "SUNY Fredonia": ["Dynamic Intonation"], "Wilfrid Laurier University": ["Hawkapella"], "Monroe Community College": ["Tributones"], "University of Rochester": ["Vocal Point", "YellowJackets"], "University of Pittsburgh": ["C Flat Run", "Pitches & Tones", "The Pitt Pendulums", "Sargam", "The Songburghs", "Sounds Like Treble"], "Carnegie Mellon University": ["C Sharp Singers", "Counterpoint", "The Originals", "The Treblemakers"], "Millersville University": ["Chromatic", "VilleHarmonics"], "Penn State University": ["The Coda Conduct", "Fanaa", "None of the Above", "The Statesmen"], "Indiana University of Pennsylvania": ["Crimson Chords"], "Duquesne University": ["Mic Drop"], "Eastern Illinois University": ["Blue Fusion"], "University of Chicago": ["Cadenza", "The Ransom Notes"], "North Central College": ["Final Cut", "Sonata Problem"], "University of Wisconsin - Madison": ["Fundamentally Sound", "Pitches & Notes", "Under A-Rest"], "Columbia College Chicago": ["Horizon"], "University of Illinois Urbana-Champaign": ["Illini Awaaz"], "University of Wisconsin - Parkside": ["Parkside Range"], "Northwestern University": ["Undertones", "The Treblemakers"], "University of Minnesota": ["7Days", "The Enchantments", "Urban Sound", "Vocal U"], "University of Wisconsin - Stevens Point": ["CounterPoint"], "Marquette University": ["Gold 'n Blues", "The Naturals"], "University of Wisconsin - Eau Claire": ["Impromptu"], "Loyola University - Chicago": ["Counterpoint"], "Grand Valley State University": ["Euphoria"], "University of Michigan": ["Gimble", "Maize Mirchi", "Sopranos", "58 Greene", "DJs", "The G-Men", "The Harmonettes"], "Oakland University": ["Gold Vibrations"], "Wayne State University": ["Melodytroit"], "Central Michigan University": ["On The Rox"], "Michigan State University": ["State of Fifths", "The Accafellas", "Capital Green", "Ladies First"], "University of Michigan - Ann Arbor": ["Amazin' Blue"], "Macomb Community College": ["The Expressions"], "Western Michigan University": ["Radio Treble"], "Illinois State University": ["The Acafellaz", "Clef Hangers", "On the Brink of Normal", "Secondary Dominance"], "Northern Illinois University": ["The Harmelodics"], "University of Illinois": ["No Comment", "No Strings Attached", "The Rip Chords", "The Xtension Chords"], "University Of Wisconsin - Milwaukee": ["Public Hearing"], "Rutgers University": ["Casual Harmony", "The OrphanSporks", "RAAG", "ShockWave"], "University of Maryland": ["DaCadence", "Faux Paz"], "Westminster Choir College": ["The Deaftones"], "Rowan University": ["Profecy", "Rowan Vocals"], "The College of New Jersey": ["The Trentones"], "Drexel University": ["The Cleftomaniacs", "The TrebleMakers"], "Temple University": ["LiaChorus", "Owlcappella", "Pitch, Please"], "University of Maryland Eastern Shore": ["The Muses"], "University of Pennsylvania": ["Penny Loafers"], "Georgetown University": ["Superfood"], "Villanova University": ["The Supernovas"], "Johns Hopkins University": ["The AllNighters", "The Notes of Ranvier", "The Vocal Chords"], "University of Maryland Baltimore County": ["Cleftomaniacs", "The Stilettos"], "George Washington University": ["The GW Vibes", "Sons of Pitch"], "Towson University": ["Off Track", "UNTITLED"], "Salisbury University": ["Squawkappella"], "Southern Virginia University": ["Accolade"], "Christopher Newport University": ["Extreme Measures", "Take Note", "University Sounds"], "Washington and Lee University": ["General Admission"], "James Madison University": ["Low Key", "Purple Reign"], "William & Mary": ["No Ceiling"], "George Mason University": ["Noteworthy"], "Virginia Commonwealth University": ["The Ramifications"], "Lafayette College": ["Cadence", "The Chorduroys", "The Mar-Keys", "Soulfege"], "University of Delaware": ["The Golden Blues", "The MelUDees", "Vocal Point"], "West Chester University": ["High Street Harmonix", "Under A Rest"], "Stockton University": ["Stockapella"], "Purdue University": ["Acabellas", "Soundtracks"], "Bowling Green State University": ["AcousChicks", "Retrograde", "Ten40!", "Tonal Eclipse"], "Washington University in St. Louis": ["After Dark", "The Sensasians", "Reverb"], "University of Dayton": ["Audio Pilots", "The Flying Solos", "Remedy", "Underscore"], "Indiana University": ["The Bloomingtones", "Resting Pitch Face"], "Miami University": ["Just Duet"], "Indiana University Indianapolis": ["On A Side Note"], "Kent State University": ["Vocal Intensity"], "University of Cincinnati": ["Avocalypse", "The Vocaholics"], "Saint Louis University": ["The Bare Naked Statues", "Beyond All Reason", "Decadence", "Astha"], "University of Notre Dame": ["The Echoes"], "University of Missouri": ["Forte", "The Naturelles"], "Missouri University of Science and Technology": ["Miner Key"], "Missouri State University": ["A Cub Bella", "The Beartones", "The Hibernotes"], "Iowa State University": ["Count Me In", "Mezzo Forte"], "University of Kansas": ["Crimson and Blues"], "Murray State University": ["EQ Blu"], "Truman State University": ["Minor Detail"], "Case Western Reserve University": ["Case in Point", "Dhamakapella"], "The Ohio State University": ["Scarlet and Grace Notes", "The Ohio State of Mind", "Buck That!", "Majors & minors", "Sound of Science"], "Baldwin Wallace University": ["S\u014cL", "Cosmos"], "University of Kentucky": ["AcoUstiKats"], "Ohio University": ["Dynamics", "New Chords on the Block", "The Tempo Tantrums"], "The University of Akron": ["Rhythm & Roos"], "SUNY Potsdam": ["A Sharp Arrangement", "The Potsdam Pitches", "The Potsdam Pointercounts", "Stay Tuned"], "University of Massachusetts Amherst": ["Duly Noted", "S#arp Attitude"], "University at Albany": ["Pitch Please"], "Rensselaer Polytechnic Institute": ["The Rusty Pipes"], "SUNY New Paltz": ["The Sexy Pitches"], "University of Vermont": ["Viridescent"], "Emerson College": ["Acappellics"], "Boston University": ["Allegrettos", "Treblemakers"], "Worcester Polytechnic Institute": ["Audiophiles"], "Northeastern University": ["Distilled Harmony", "Treble on Huntington", "The Nor'easters", "The Unisons"], "Boston College": ["Dynamics", "The Bostonians"], "Brown University": ["The Jabberwocks"], "The Colleges of Fenway": ["The Sirens"], "Wesleyan University": ["Triple Major"], "The New School": ["Unjust Intonation"], "Bryant University": ["The Bottom Line"], "Marist University": ["The Enharmonics"], "Bentley University": ["Off The Clock"], "Suffolk University": ["The Ramifications"], "Berklee College of Music": ["Treble Threat", "Upper Structure"], "University of Connecticut": ["A Minor"], "Eastern Connecticut State University": ["East Harmonies"], "Fordham University": ["The F Sharps", "The Fordham Ramblers"], "University of Hartford": ["HartAttack", "L'Shir"], "Hunter College": ["Hawkappella"], "Roger Williams University": ["Hawkward"], "Quinnipiac University": ["The Legends"], "New York University": ["The Vocaholics", "The Cleftomaniacs", "The Mixtapes", "N'Harmonics", "Vocollision"], "Columbia University": ["The Clefhangers"], "Pace University": ["Frequency", "Tonal Recall"], "Hofstra University": ["The Hofbeats", "Makin' Treble", "Sigma'cappella"], "North Carolina State University": ["Acappology", "Chordination", "Grains of Time", "Ladies In Red", "Wolfgang"], "University of Mount Olive": ["Carolina Sound"], "University of South Carolina": ["Cockappella"], "University of Georgia": ["Noteworthy"], "Georgia Institute of Technology": ["Nothin' But Treble"], "High Point University": ["Offbeats"], "University of North Carolina at Chapel Hill": ["Tar Heel Voices"], "University of Florida": ["Accent", "The Sedoctaves", "Tone Definition"], "University of Miami": ["BisCaydence", "Tufaan"], "University of Central Florida": ["Gemini Boulevard", "KeyHarmony", "Mixed Mode"], "Florida International University": ["HEARTbeats"], "University of South Florida": ["Tones of Gold"], "East Tennessee State University": ["Ascension", "Harmonium"], "Belmont University": ["The Belles", "The Beltones", "Intonations", "Prismatics"], "University of Tennessee": ["reVOLution", "VOLT"], "Vanderbilt University": ["Spectrum", "Harmonic Notion"], "Emory University": ["Aural Pleasure", "Dooley Noted"], "University of North Carolina At Greensboro": ["The Chariots"], "Wake Forest University": ["Demon Divas"], "Appalachian State University": ["Ear Candy", "VoiceMale"], "Duke University": ["Rhythm & Blue"], "Florida State University": ["AcaBelles", "All-Night Yahtzee", "Reverb"], "Pearl River Community College": ["Currents", "The Voices"], "East Central Community College": ["EC Listening"], "University of Southern Mississippi": ["Spirit of Southern"], "Mississippi State University": ["TrebullDawgs"], "University of Alabama": ["Tune In"], "University of Texas at Austin": ["Beauties and the Beat", "Noteworthy"], "Texas Tech University": ["Empire"], "University of Houston": ["Final Measure", "Star Struck"], "Texas A&M University": ["HardChord DynaMix"], "University of Texas at Dallas": ["Novis", "Trillium"], "University of Texas at Arlington": ["RISE"], "Baylor University": ["VirtuOSO"], "University of Nebraska": ["The Bathtub Dogs", "Boots & Cats", "Pitch Please", "The Red Keys", "Take Note"], "University of Denver": ["Exit 205"], "University of Colorado Boulder": ["Extreme Measures"], "Colorado State University": ["Mainstreet"], "Oklahoma City University": ["Tonal Eclipse"], "University of California, San Diego": ["Acamazing", "The Daughters of Triton", "Sitaare", "The Trebles", "The Tritones"], "University of California, Irvine": ["Clair de Lune", "Morse Coda", "NOVA", "Vermillion Vocalists", "Aerodynamix", "Haath", "Uniting Voices", "VocaLotus"], "San Diego State University": ["SoundWave"], "University of Arizona": ["Amplified", "Enharmonics", "Meow or Never", "Noteriety"], "Northern Arizona University": ["The Axecidentals", "Elevation", "The Highlanders"], "Grand Canyon University": ["Canyon Crescendos"], "Arizona State University": ["Devil Clefs", "The Pitchforks", "Priority Male", "The TEMPEtations"], "The Claremont Colleges": ["Claremont Shades", "Earth Tones", "Midnight Echo"], "Mt. San Antonio College": ["Nu Aria"], "University of Aberdeen": ["Aberpella", "Killer Quines"], "University of St Andrews": ["The Accidentals", "The Alleycats", "The Hummingbirds"], "University of Cambridge": ["Cadenza"], "University of Edinburgh": ["Cloud IX", "Licence To Trill", "Tone Up"], "University of Stirling": ["Stirling Stellars"], "University of Birmingham": ["AbraCappella", "The Uptone Girls"], "University of Nottingham": ["Aca-Pocalypse", "Firecracappella", "RadioOctave", "Echotones"], "University of Warwick": ["The Leamingtones", "OffScore"], "University of Leeds": ["The Songsmiths"], "University of Sheffield": ["Steelworks"], "University of York": ["VOX"], "University of Bristol": ["Academy", "The Bristol Suspensions", "Pitch Fight"], "University of Bath": ["Aquapella"], "Royal Welsh College of Music and Drama": ["Aurum Voices"], "Cardiff University": ["DeciBelles", "Vox", "The Acappellads"], "University of Exeter": ["The Illuminations", "Sweet Nothings"], "Durham University": ["Northern Lights"], "University of Oxford": ["The Oxford Commas"], "Lancaster University": ["Roselution"], "University of Manchester": ["The Skylarks"], "Newcastle University": ["Tune Army"], "University College London": ["The Eustones"], "London School of Economics": ["The Houghtones"], "Imperial College London": ["The Imperielles", "Nth Harmonic", "The Scopes"], "King's College London": ["Kadence", "The Rolling Tones"], "University of Reading": ["RACA"], "University of Washington": ["Awaaz", "Furmata"], "Gonzaga University": ["Big Bing Theory"], "University of British Columbia": ["Eh? Cappella", "The Northwest Collective", "Trebled Acaholics", "The Trill Seekers"], "Western Washington University": ["For Good Measure", "Pacific Note West"], "Oregon State University": ["Divine", "Power Chord"], "Southern Oregon University": ["Dulcet"], "Portland State University": ["The Green Note"], "Willamette University": ["Headband", "Tandem", "Up Top"], "University of Oregon": ["Mind the Gap"], "Montana State University": ["Rhapsody"], "University of Utah": ["Salt Flats"], "University of California, Los Angeles": ["Bruin Harmony", "Naya Zamaana", "ScatterTones", "Awaken", "Pitch, Please!", "Random Voices", "Resonance"], "Chapman University": ["Chapman SoundCheck", "The Dissonants", "The ChapTones", "Simply Vocale"], "California State University, Fullerton": ["The FullerTones"], "Moorpark College": ["MoorHarmony"], "University of California, Santa Barbara": ["Naked Voices"], "University of Southern California": ["Reverse Osmosis"], "California State University, Northridge": ["Acasola", "Vocal Percussion Radio (VPR)"], "University of California, Santa Cruz": ["Cloud 9"], "University of California, Davis": ["The Cleftomaniacs", "Jhankaar", "The Liquid Hotplates", "The Lounge Lizards", "The Spokes"], "UC Berkeley": ["Drawn to Scale", "The Golden Overtones"], "Stanford University": ["The Mendicants"], "Diablo Valley College": ["The pH Scale"], "San Jose State University": ["The Spartones"]};

const STATE_REGION = {
  "New York":"Central","Pennsylvania":"Central",
  "Minnesota":"Great Lakes","Wisconsin":"Great Lakes","Illinois":"Great Lakes","Michigan":"Great Lakes",
  "New Jersey":"Mid-Atlantic","Maryland":"Mid-Atlantic","Delaware":"Mid-Atlantic","Virginia":"Mid-Atlantic","West Virginia":"Mid-Atlantic","District of Columbia":"Mid-Atlantic",
  "Indiana":"Midwest","Ohio":"Midwest","Missouri":"Midwest","Kentucky":"Midwest","Kansas":"Midwest","Iowa":"Midwest","North Dakota":"Midwest","South Dakota":"Midwest",
  "Connecticut":"Northeast","Rhode Island":"Northeast","Massachusetts":"Northeast","Vermont":"Northeast","New Hampshire":"Northeast","Maine":"Northeast",
  "Tennessee":"South","North Carolina":"South","South Carolina":"South","Georgia":"South","Florida":"South","Alabama":"South","Mississippi":"South","Arkansas":"South","Louisiana":"South",
  "Texas":"Southwest","Nebraska":"Southwest","Colorado":"Southwest","Oklahoma":"Southwest","Arizona":"Southwest","New Mexico":"Southwest","Nevada":"Southwest",
  "Washington":"West","Oregon":"West","California":"West","Idaho":"West","Montana":"West","Wyoming":"West","Utah":"West",
};



// ─── DEEP CLONE HELPER ───
function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

// ─── EDITABLE STATE (mutable copy of data) ───
let state = deepClone(REGIONS);
let undoStack = [];
let openRegions = {}; // track which regions are expanded in editor
let openQFs = {}; // track which QFs are expanded
let selectedRegionName = null;
let currentZoom = null;

// ─── UNDO SYSTEM ───
function saveUndo() {
  undoStack.push(deepClone(state));
  if (undoStack.length > 30) undoStack.shift();
}
function undoAction() {
  if (undoStack.length === 0) return;
  state = undoStack.pop();
  renderEditor();
  renderMap();
}

// ─── COMPUTED HELPERS ───
function countGroups(region) {
  return region.quarterfinals.reduce((sum, qf) => sum + qf.groups.length, 0);
}
function totalStats() {
  let regions = 0, groups = 0, schools = 0;
  for (const r of Object.values(state)) {
    regions++;
    schools += r.schools.length;
    groups += countGroups(r);
  }
  return { regions, groups, schools };
}

// Rebuild schools list for a region based on QF assignments and SCHOOL_GROUPS
function rebuildSchools(regionName) {
  const region = state[regionName];
  const schoolSet = new Set();
  for (const qf of region.quarterfinals) {
    for (const group of qf.groups) {
      // Find which school this group belongs to
      for (const [school, groups] of Object.entries(SCHOOL_GROUPS)) {
        if (groups.includes(group)) {
          schoolSet.add(school);
        }
      }
    }
  }
  region.schools = Array.from(schoolSet).sort();
}

// ─── REGION OPERATIONS ───
function addRegion() {
  showModal('New Region', `
    <div class="modal-label">Region Name</div>
    <input class="modal-input" id="m-name" placeholder="e.g. Canhandle" autofocus>
    <div class="modal-label">Color</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="color" class="color-picker" id="m-color" value="#6C8EBF">
      <span style="font-size:11px;color:#888" id="m-color-label">#6C8EBF</span>
    </div>
  `, () => {
    const name = document.getElementById('m-name').value.trim();
    const color = document.getElementById('m-color').value;
    if (!name) return;
    saveUndo();
    state[name] = {
      color: color, accent: color,
      schools: [],
      quarterfinals: [],
      semifinal: { date: "", location: "", lat: null, lng: null }
    };
    openRegions[name] = true;
    renderEditor();
    renderMap();
  });
  document.getElementById('m-color').addEventListener('input', function() {
    document.getElementById('m-color-label').textContent = this.value;
  });
}

function renameRegion(oldName) {
  showModal('Rename Region', `
    <div class="modal-label">New Name</div>
    <input class="modal-input" id="m-name" value="${oldName}" autofocus>
  `, () => {
    const newName = document.getElementById('m-name').value.trim();
    if (!newName || newName === oldName) return;
    if (state[newName]) { alert('A region with that name already exists.'); return; }
    saveUndo();
    state[newName] = state[oldName];
    delete state[oldName];
    if (openRegions[oldName]) { openRegions[newName] = true; delete openRegions[oldName]; }
    if (selectedRegionName === oldName) selectedRegionName = newName;
    renderEditor();
    renderMap();
  });
}

function deleteRegion(name) {
  const groups = countGroups(state[name]);
  if (groups > 0 && !confirm(`Delete "${name}" and its ${groups} groups? This cannot be undone.`)) return;
  saveUndo();
  delete state[name];
  if (selectedRegionName === name) selectedRegionName = null;
  renderEditor();
  renderMap();
}

function changeRegionColor(name) {
  const input = document.createElement('input');
  input.type = 'color';
  input.value = state[name].color;
  input.addEventListener('input', function() {
    state[name].color = this.value;
    state[name].accent = this.value;
    renderEditor();
    renderMap();
  });
  input.click();
}

// ─── QF OPERATIONS ───
function addQFToSelected() {
  if (Object.keys(state).length === 0) { alert('Create a region first.'); return; }
  const regionNames = Object.keys(state);
  const options = regionNames.map(n => `<option value="${n}">${n}</option>`).join('');
  showModal('Add Quarterfinal', `
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${options}</select>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-location" placeholder="e.g. University of Rochester, NY">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" placeholder="e.g. Feb 14"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" placeholder="43.13"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" placeholder="-77.63"></div>
    </div>
  `, () => {
    const regionName = document.getElementById('m-region').value;
    const location = document.getElementById('m-location').value.trim();
    const date = document.getElementById('m-date').value.trim();
    const lat = parseFloat(document.getElementById('m-lat').value) || null;
    const lng = parseFloat(document.getElementById('m-lng').value) || null;
    saveUndo();
    state[regionName].quarterfinals.push({ date, location, lat, lng, groups: [] });
    openRegions[regionName] = true;
    renderEditor();
    renderMap();
  });
  if (selectedRegionName) document.getElementById('m-region').value = selectedRegionName;
}

function deleteQF(regionName, qfIndex) {
  const qf = state[regionName].quarterfinals[qfIndex];
  if (qf.groups.length > 0 && !confirm(`Delete QF at "${qf.location}" with ${qf.groups.length} groups?`)) return;
  saveUndo();
  state[regionName].quarterfinals.splice(qfIndex, 1);
  rebuildSchools(regionName);
  renderEditor();
  renderMap();
}

// ─── GROUP OPERATIONS ───
function addGroupPrompt() {
  if (Object.keys(state).length === 0) { alert('Create a region first.'); return; }
  // Build nested options: Region > QF
  let options = '';
  for (const [rn, rd] of Object.entries(state)) {
    rd.quarterfinals.forEach((qf, i) => {
      options += `<option value="${rn}|${i}">QF${i+1} — ${qf.location} (${rn})</option>`;
    });
  }
  showModal('Add Group', `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" placeholder="e.g. Midnight Ramblers" autofocus>
    <div class="modal-label">Assign to Quarterfinal</div>
    <select class="modal-input" id="m-target">${options}</select>
  `, () => {
    const groupName = document.getElementById('m-group').value.trim();
    const [rn, qi] = document.getElementById('m-target').value.split('|');
    if (!groupName) return;
    saveUndo();
    state[rn].quarterfinals[parseInt(qi)].groups.push(groupName);
    rebuildSchools(rn);
    renderEditor();
    renderMap();
  });
}

function removeGroup(regionName, qfIndex, groupName) {
  saveUndo();
  const groups = state[regionName].quarterfinals[qfIndex].groups;
  const idx = groups.indexOf(groupName);
  if (idx !== -1) groups.splice(idx, 1);
  rebuildSchools(regionName);
  renderEditor();
  renderMap();
}

// ─── DRAG & DROP ───
let dragData = null; // { regionName, qfIndex, groupName }

function onDragStart(e, regionName, qfIndex, groupName) {
  dragData = { regionName, qfIndex, groupName };
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', groupName);
}

function onDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}

function onDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

function onDropToQF(e, targetRegion, targetQF) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!dragData) return;
  if (dragData.regionName === targetRegion && dragData.qfIndex === targetQF) return;

  saveUndo();
  // Remove from source
  const srcGroups = state[dragData.regionName].quarterfinals[dragData.qfIndex].groups;
  const idx = srcGroups.indexOf(dragData.groupName);
  if (idx !== -1) srcGroups.splice(idx, 1);
  rebuildSchools(dragData.regionName);

  // Add to target
  state[targetRegion].quarterfinals[targetQF].groups.push(dragData.groupName);
  rebuildSchools(targetRegion);

  dragData = null;
  renderEditor();
  renderMap();
}

// ─── MODAL ───
function showModal(title, bodyHTML, onConfirm) {
  const overlay = document.getElementById('modal-overlay');
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <h3>${title}</h3>
    ${bodyHTML}
    <div class="modal-actions">
      <button class="tb-btn" onclick="closeModal()">Cancel</button>
      <button class="tb-btn primary" id="modal-confirm">Confirm</button>
    </div>
  `;
  overlay.classList.add('active');
  document.getElementById('modal-confirm').onclick = () => { onConfirm(); closeModal(); };
  // Focus first input
  setTimeout(() => { const inp = modal.querySelector('input'); if (inp) inp.focus(); }, 50);
  // Enter key
  modal.onkeydown = (e) => { if (e.key === 'Enter') { onConfirm(); closeModal(); } };
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('active');
}

// ─── EXPORT ───
function exportJSON() {
  const data = deepClone(state);
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'icca-regions.json'; a.click();
  URL.revokeObjectURL(url);
}

// ─── RENDER EDITOR PANEL ───
function renderEditor() {
  const body = document.getElementById('editor-body');
  const stats = totalStats();
  document.getElementById('editor-stats').textContent = `${stats.regions}R · ${stats.groups}G · ${stats.schools}S`;

  let html = '';
  for (const [regionName, region] of Object.entries(state)) {
    const isOpen = openRegions[regionName];
    const groupCount = countGroups(region);
    html += `<div class="region-block">`;
    html += `<div class="region-header" onclick="toggleRegion('${esc(regionName)}')">`;
    html += `<span class="region-chevron ${isOpen ? 'open' : ''}">▶</span>`;
    html += `<div class="region-swatch" style="background:${region.color}" onclick="event.stopPropagation();changeRegionColor('${esc(regionName)}')"></div>`;
    html += `<span class="region-name">${regionName}</span>`;
    html += `<span class="region-meta">${region.schools.length}s · ${groupCount}g · ${region.quarterfinals.length}qf</span>`;
    html += `<div class="region-actions">`;
    html += `<button class="region-action-btn" onclick="event.stopPropagation();renameRegion('${esc(regionName)}')" title="Rename">✎</button>`;
    html += `<button class="region-action-btn del" onclick="event.stopPropagation();deleteRegion('${esc(regionName)}')" title="Delete">✕</button>`;
    html += `</div></div>`;

    if (isOpen) {
      html += `<div class="region-body">`;
      region.quarterfinals.forEach((qf, i) => {
        const qfKey = `${regionName}-${i}`;
        html += `<div class="qf-block">`;
        html += `<div class="qf-header">`;
        html += `<span class="qf-label" style="color:${region.color}">QF${i+1}</span>`;
        html += `<span class="qf-location">${qf.location || 'No location'}</span>`;
        html += `<span class="qf-count">${qf.groups.length}</span>`;
        html += `<div class="qf-actions">`;
        html += `<button class="region-action-btn del" onclick="event.stopPropagation();deleteQF('${esc(regionName)}',${i})" title="Delete QF">✕</button>`;
        html += `</div></div>`;
        html += `<div class="qf-groups" data-region="${esc(regionName)}" data-qf="${i}" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDropToQF(event,'${esc(regionName)}',${i})">`;
        qf.groups.forEach(g => {
          html += `<span class="group-tag" draggable="true" ondragstart="onDragStart(event,'${esc(regionName)}',${i},'${esc(g)}')" ondragend="onDragEnd(event)">`;
          html += `${g}<span class="remove-group" onclick="removeGroup('${esc(regionName)}',${i},'${esc(g)}')" title="Remove">✕</span></span>`;
        });
        if (qf.groups.length === 0) {
          html += `<span style="font-size:10px;color:#444;padding:4px">Drop groups here</span>`;
        }
        html += `</div></div>`;
      });
      html += `</div>`;
    }
    html += `</div>`;
  }

  body.innerHTML = html;
}

function esc(s) { return s.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function toggleRegion(name) {
  openRegions[name] = !openRegions[name];
  selectedRegionName = openRegions[name] ? name : null;
  renderEditor();
  renderMap();
}

// ─── MAP RENDERING ───
let usTopoData = null, ukGeoData = null;
let mapSvg = null, mapG = null, mapZoom = null;

async function loadMapData() {
  try {
    const [usResp, ukResp] = await Promise.all([
      fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
      fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
    ]);
    usTopoData = await usResp.json();
    ukGeoData = await ukResp.json();
  } catch(e) {
    console.warn("Map data load failed:", e);
  }
  renderMap();
}

function renderMap() {
  const container = document.getElementById('map-container');
  const w = container.clientWidth, h = container.clientHeight;
  if (!w || !h) return;

  d3.select("#map-container svg").remove();
  const svg = d3.select("#map-container").append("svg").attr("width", w).attr("height", h);
  const g = svg.append("g");
  mapSvg = svg; mapG = g;

  const zoom = d3.zoom().scaleExtent([1, 20]).on("zoom", (event) => {
    g.attr("transform", event.transform);
    currentZoom = event.transform;
    const k = event.transform.k;
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r")) / Math.sqrt(k); });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r")) / Math.sqrt(k); });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw") || 0.6) / k; });
    g.selectAll(".venue-marker-g").each(function() {
      const el = d3.select(this);
      el.attr("transform", `translate(${el.attr("data-tx")},${el.attr("data-ty")}) scale(${1/Math.sqrt(k)})`);
    });
  });
  svg.call(zoom);
  if (currentZoom) svg.call(zoom.transform, currentZoom);
  mapZoom = zoom;

  // US map
  const projection = d3.geoAlbersUsa().fitSize([w * 0.92, h * 0.88], {type:"Sphere"});
  projection.translate([w * 0.48, h * 0.49]);

  // Draw states
  if (usTopoData) {
    const states = topojson.feature(usTopoData, usTopoData.objects.states);
    const statePaths = g.append("g").selectAll("path").data(states.features).enter().append("path");
    statePaths.attr("d", d3.geoPath().projection(projection))
      .attr("class", "state-path")
      .attr("data-base-sw", 0.6)
      .attr("stroke-width", 0.6)
      .attr("stroke", "rgba(255,255,255,0.08)")
      .attr("fill", function(d) {
        const stateName = d.properties.name;
        for (const [rn, rd] of Object.entries(state)) {
          // Check if any school in this region is in this state via STATE_REGION
          if (STATE_REGION[stateName] && STATE_REGION[stateName] === rn) {
            return rd.color + "10";
          }
        }
        return "rgba(255,255,255,0.015)";
      });
  }

  // Tooltip refs
  const tooltip = document.getElementById("tooltip");
  const ttSchool = document.getElementById("tt-school");
  const ttRegion = document.getElementById("tt-region");
  const mapRect = document.querySelector(".map-area").getBoundingClientRect();

  // Draw school dots
  for (const [regionName, region] of Object.entries(state)) {
    if (regionName === "United Kingdom") continue;
    const isActive = !selectedRegionName || selectedRegionName === regionName;
    for (const school of region.schools) {
      const c = SCHOOL_COORDS[school];
      if (!c) continue;
      const projected = projection([c[1], c[0]]);
      if (!projected) continue;
      const [x, y] = projected;

      const dotR = isActive && selectedRegionName ? 4.5 : 3;
      const dotOp = isActive ? 0.85 : 0.1;

      if (isActive && selectedRegionName) {
        g.append("circle").attr("cx", x).attr("cy", y).attr("r", 10)
          .attr("data-base-r", 10)
          .attr("fill", region.color + "15").attr("class", "school-glow");
      }

      g.append("circle").attr("cx", x).attr("cy", y).attr("r", dotR)
        .attr("data-base-r", dotR)
        .attr("fill", region.color).attr("opacity", dotOp)
        .attr("class", "school-dot").style("cursor", "pointer")
        .on("mouseenter", function(e) {
          const k = currentZoom ? currentZoom.k : 1;
          d3.select(this).attr("r", 7 / Math.sqrt(k));
          ttSchool.textContent = school;
          ttRegion.textContent = regionName;
          ttRegion.style.color = region.accent || region.color;
          const groups = SCHOOL_GROUPS[school];
          const ttg = document.getElementById("tt-groups");
          if (groups && groups.length > 0) {
            ttg.innerHTML = groups.map(g => `<span style="color:#ddd">${g}</span>`).join(" · ");
            ttg.style.display = "block";
          } else { ttg.style.display = "none"; }
          tooltip.classList.add("visible");
          tooltip.style.left = (e.clientX - mapRect.left + 14) + "px";
          tooltip.style.top = (e.clientY - mapRect.top - 32) + "px";
        })
        .on("mousemove", function(e) {
          tooltip.style.left = (e.clientX - mapRect.left + 14) + "px";
          tooltip.style.top = (e.clientY - mapRect.top - 32) + "px";
        })
        .on("mouseleave", function() {
          d3.select(this).attr("r", dotR / Math.sqrt(currentZoom ? currentZoom.k : 1));
          tooltip.classList.remove("visible");
        });
    }
  }

  // Draw QF venue markers
  for (const [regionName, region] of Object.entries(state)) {
    if (regionName === "United Kingdom") continue;
    if (selectedRegionName && selectedRegionName !== regionName) continue;
    if (!selectedRegionName) continue;

    const venueGroup = g.append("g").attr("class", "venue-markers");

    // Semifinal
    if (region.semifinal && region.semifinal.lat) {
      const sp = projection([region.semifinal.lng, region.semifinal.lat]);
      if (sp) {
        const [sx, sy] = sp;
        const sg = venueGroup.append("g").attr("class", "venue-marker-g").attr("data-tx", sx).attr("data-ty", sy).attr("transform", `translate(${sx},${sy})`);
        const star = d3.symbol().type(d3.symbolStar).size(220);
        sg.append("circle").attr("r", 16).attr("fill", region.color + "20").attr("stroke", region.color + "40").attr("stroke-width", 1);
        sg.append("path").attr("d", star).attr("fill", "#FFD700").attr("opacity", 0.9);
      }
    }

    // QF diamonds
    region.quarterfinals.forEach((qf, i) => {
      if (!qf.lat) return;
      const p = projection([qf.lng, qf.lat]);
      if (!p) return;
      const [vx, vy] = p;
      const qg = venueGroup.append("g").attr("class", "venue-marker-g").attr("data-tx", vx).attr("data-ty", vy).attr("transform", `translate(${vx},${vy})`);
      const s = 7;
      qg.append("circle").attr("r", 14).attr("fill", region.color + "15");
      const diamond = `M0,${-s} L${s},0 L0,${s} L${-s},0 Z`;
      qg.append("path").attr("d", diamond).attr("fill", region.color).attr("stroke", "#fff").attr("stroke-width", 1.5).attr("opacity", 0.95);
      qg.append("text").attr("x", 0).attr("y", 0).attr("dy", "0.35em")
        .attr("text-anchor", "middle").attr("fill", "#fff")
        .attr("font-size", "8px").attr("font-weight", "700").attr("font-family", "'Space Mono', monospace")
        .attr("pointer-events", "none").text(i + 1);
    });
  }

  // Apply zoom if needed
  if (currentZoom && currentZoom.k !== 1) {
    const k = currentZoom.k;
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r")) / Math.sqrt(k); });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r")) / Math.sqrt(k); });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw") || 0.6) / k; });
    g.selectAll(".venue-marker-g").each(function() {
      const el = d3.select(this);
      el.attr("transform", `translate(${el.attr("data-tx")},${el.attr("data-ty")}) scale(${1/Math.sqrt(k)})`);
    });
  }

  // Legend
  renderLegend();
}

function renderLegend() {
  const el = document.getElementById('map-legend');
  let html = '<div class="legend-title">Regions</div>';
  for (const [name, region] of Object.entries(state)) {
    const active = selectedRegionName === name;
    html += `<div class="legend-item" onclick="toggleRegion('${esc(name)}')" style="${active ? 'color:#fff;font-weight:600' : ''}">`;
    html += `<div class="legend-swatch" style="background:${region.color}${active ? '' : '88'}"></div>${name}`;
    html += `</div>`;
  }
  el.innerHTML = html;
}

// Zoom controls
window.zoomIn = () => { if (mapSvg && mapZoom) mapSvg.transition().duration(300).call(mapZoom.scaleBy, 1.5); };
window.zoomOut = () => { if (mapSvg && mapZoom) mapSvg.transition().duration(300).call(mapZoom.scaleBy, 1/1.5); };
window.resetZoom = () => { currentZoom = null; if (mapSvg && mapZoom) mapSvg.transition().duration(500).call(mapZoom.transform, d3.zoomIdentity); };

// ─── INIT ───
// Open first region by default
const firstRegion = Object.keys(state)[0];
if (firstRegion) openRegions[firstRegion] = true;

renderEditor();
loadMapData();

// Re-render map on resize
window.addEventListener('resize', () => renderMap());

</script>
</body>
</html>
