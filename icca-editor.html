<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé§</text></svg>">
<title>ICCA Region Editor</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  min-height: 100vh; background: #0A0A0F;
  font-family: 'Outfit', sans-serif; color: #E8E6E3; overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ‚îÄ */
.toolbar {
  height: 52px; display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.02); overflow: visible;
}
.toolbar-left { display: flex; align-items: center; gap: 16px; }
.toolbar-title {
  font-size: 15px; font-weight: 700; letter-spacing: -0.5px;
  background: linear-gradient(135deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.toolbar-subtitle { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; letter-spacing: 2px; }
.toolbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.tb-btn {
  padding: 6px 14px; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px;
  background: rgba(255,255,255,0.04); color: #bbb; font-family: 'Outfit'; font-size: 12px;
  font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; text-decoration: none;
}
.tb-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.25); }
.tb-btn.primary { background: rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.3); color: #FFD700; }
.tb-btn.primary:hover { background: rgba(255,215,0,0.2); }
.tb-btn.danger { border-color: rgba(255,80,80,0.3); color: #ff6b6b; }
.tb-btn.danger:hover { background: rgba(255,80,80,0.12); }
.tb-sep { width: 1px; height: 24px; background: rgba(255,255,255,0.08); margin: 0 4px; }

/* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
.main { display: flex; height: calc(100vh - 52px); }

/* ‚îÄ‚îÄ‚îÄ EDITOR PANEL ‚îÄ‚îÄ‚îÄ */
.editor {
  width: 380px; min-width: 380px; border-right: 1px solid rgba(255,255,255,0.06);
  overflow-y: auto; background: rgba(255,255,255,0.01); display: flex; flex-direction: column;
}
.editor-header {
  padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; background: rgba(10,10,15,0.95); z-index: 5; backdrop-filter: blur(8px);
}
.editor-title { font-size: 11px; font-weight: 600; color: #888; letter-spacing: 1.5px; text-transform: uppercase; }
.editor-stats { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.editor-body { flex: 1; overflow-y: auto; padding: 8px 0; }

/* Region blocks */
.region-block { border-bottom: 1px solid rgba(255,255,255,0.04); }
.region-header {
  display: flex; align-items: center; gap: 8px; padding: 10px 16px;
  cursor: pointer; transition: background 0.2s; user-select: none;
}
.region-header:hover { background: rgba(255,255,255,0.03); }
.region-chevron {
  font-size: 10px; color: #555; transition: transform 0.2s; width: 14px; text-align: center;
}
.region-chevron.open { transform: rotate(90deg); }
.region-swatch {
  width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s;
}
.region-swatch:hover { transform: scale(1.2); }
.region-name { flex: 1; font-size: 13px; font-weight: 600; }
.region-meta { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.region-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
.region-header:hover .region-actions { opacity: 1; }
.region-action-btn {
  width: 22px; height: 22px; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
  background: rgba(255,255,255,0.03); color: #888; font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.region-action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.region-action-btn.del:hover { background: rgba(255,80,80,0.15); color: #ff6b6b; border-color: rgba(255,80,80,0.3); }

/* QF blocks */
.region-body { padding: 0 0 8px; }
.qf-block { margin: 0 10px 6px; }
.qf-header {
  display: flex; align-items: center; gap: 6px; padding: 6px 10px;
  background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 6px 6px 0 0; font-size: 11px; cursor: pointer; user-select: none;
}
.qf-header:hover { background: rgba(255,255,255,0.04); }
.qf-header[draggable="true"] { cursor: grab; }
.qf-header.dragging { opacity: 0.4; }
.region-header.drag-over { background: rgba(255,215,0,0.08); outline: 1px dashed rgba(255,215,0,0.3); }
.qf-label { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 10px; }
.qf-location { flex: 1; color: #888; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.qf-count { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.qf-actions { display: flex; gap: 3px; opacity: 0; transition: opacity 0.2s; }
.qf-header:hover .qf-actions { opacity: 1; }

/* Group tags */
.qf-groups {
  display: flex; flex-wrap: wrap; gap: 0; padding: 6px 8px;
  border: 1px solid rgba(255,255,255,0.06); border-top: none;
  border-radius: 0 0 6px 6px; background: rgba(255,255,255,0.01);
  min-height: 32px; transition: background 0.2s;
}
.qf-groups.drag-over { background: rgba(255,215,0,0.06); border-color: rgba(255,215,0,0.2); }
.group-tag {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 14px; font-size: 11px; margin: 2px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
  cursor: grab; transition: all 0.2s; user-select: none;
}
.group-tag:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
.group-tag.dragging { opacity: 0.4; }
.group-tag .remove-group {
  font-size: 9px; color: #555; cursor: pointer; margin-left: 2px;
  width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; transition: all 0.15s;
}
.group-tag .remove-group:hover { background: rgba(255,80,80,0.2); color: #ff6b6b; }

/* ‚îÄ‚îÄ‚îÄ MAP AREA ‚îÄ‚îÄ‚îÄ */
.map-area { flex: 1; position: relative; overflow: hidden; }
.map-bg {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse 80% 60% at 50% 40%, rgba(255,255,255,0.012) 0%, transparent 70%);
}
#map-container { position: absolute; inset: 0; }
#map-container svg { width: 100%; height: 100%; }
.state-path { transition: fill 0.3s; }
.school-dot { transition: opacity 0.3s; }
.school-glow { transition: opacity 0.3s; }

/* Legend */
.map-legend {
  position: absolute; top: 12px; right: 12px; background: rgba(10,10,15,0.85);
  border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px 16px;
  backdrop-filter: blur(12px); z-index: 10;
}
.legend-title { font-size: 9px; font-weight: 600; color: #555; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; }
.legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; font-size: 11px; color: #aaa; cursor: pointer; }
.legend-item:hover { color: #ddd; }
.legend-swatch { width: 8px; height: 8px; border-radius: 2px; }

/* Tooltip */
.tooltip-box {
  position: absolute; pointer-events: none; background: rgba(10,10,15,0.92); border: 1px solid rgba(255,255,255,0.15);
  padding: 8px 14px; border-radius: 8px; font-size: 12px; z-index: 50; backdrop-filter: blur(12px);
  opacity: 0; transition: opacity 0.15s; max-width: 300px;
}
.tooltip-box.visible { opacity: 1; }
.tt-school { font-weight: 600; }
.tt-region { font-size: 10px; margin-top: 2px; }
.tt-groups { font-size: 10px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); color: #aaa; }

/* Zoom controls */
.zoom-controls {
  position: absolute; bottom: 20px; right: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 10;
}
.compare-toggle {
  position: absolute; bottom: 20px; right: 56px; z-index: 10;
}
.compare-toggle .zoom-btn.active {
  background: rgba(255,200,0,0.15); color: #ffd700; border-color: rgba(255,200,0,0.4);
}
.compare-banner {
  position: absolute; top: 8px; left: 50%; transform: translateX(-50%); z-index: 15;
  background: rgba(255,200,0,0.12); border: 1px solid rgba(255,200,0,0.3); border-radius: 6px;
  padding: 4px 14px; font-size: 11px; color: #ffd700; font-weight: 600; letter-spacing: 0.5px;
  pointer-events: none; display: none;
}
.compare-banner.active { display: block; }
.zoom-btn {
  width: 30px; height: 30px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.12);
  background: rgba(10,10,15,0.8); color: #aaa; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace;
}
.zoom-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
  display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #14141a; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
  padding: 24px; min-width: 360px; max-width: 480px;
}
.modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
.modal-input {
  width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px; color: #E8E6E3; font-family: 'Outfit'; font-size: 13px; margin-bottom: 12px;
}
.modal-input:focus { outline: none; border-color: rgba(255,255,255,0.3); }
.modal-row { display: flex; gap: 8px; margin-bottom: 12px; }
.modal-label { font-size: 11px; color: #888; margin-bottom: 4px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
.color-picker { width: 40px; height: 32px; border: none; border-radius: 6px; cursor: pointer; background: none; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }

/* Dropdown */
.dropdown-wrap { position: relative; }

/* Lasso selection */
.lasso-rect {
  position: absolute; border: 2px dashed rgba(255,215,0,0.6); background: rgba(255,215,0,0.06);
  pointer-events: none; z-index: 20; display: none; border-radius: 2px;
}
.lasso-hint {
  position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
  background: rgba(10,10,15,0.85); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px; padding: 6px 14px; font-size: 11px; color: #888;
  z-index: 15; pointer-events: none; white-space: nowrap;
  font-family: 'Space Mono', monospace;
}

/* Pool section */
.pool-section { padding: 12px 0 0; border-top: 1px solid rgba(255,255,255,0.06); }
.pool-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 16px 8px; }
.pool-label { font-size: 10px; font-weight: 600; color: #666; letter-spacing: 1.5px; text-transform: uppercase; }
.pool-drop { border-color: rgba(255,255,255,0.1) !important; }

/* ‚îÄ‚îÄ‚îÄ VIEW MODE ‚îÄ‚îÄ‚îÄ */
.view-mode .region-actions,
.view-mode .qf-actions,
.view-mode .remove-group,
.view-mode .lasso-hint,
.view-mode .lasso-rect,
.view-mode .pool-section { display: none !important; }
.view-mode .group-tag { cursor: default; -webkit-user-drag: none; }
.view-mode .region-swatch { pointer-events: none; cursor: default; }
.view-mode .qf-header { cursor: pointer; }
.view-mode .qf-header[draggable] { -webkit-user-drag: none; }

/* Venue popup */
.venue-popup {
  position: absolute; z-index: 40; background: rgba(10,10,15,0.94); border: 1px solid rgba(255,255,255,0.15);
  border-radius: 12px; padding: 16px 18px; backdrop-filter: blur(16px); max-width: 320px;
  pointer-events: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  cursor: grab; user-select: none; animation: fadeIn 0.2s ease;
}
.venue-popup.dragging { cursor: grabbing; opacity: 0.92; }
.venue-popup-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
.venue-popup-title { font-size: 13px; font-weight: 700; }
.venue-popup-meta { font-size: 11px; color: #888; margin-top: 2px; }
.venue-popup-close { background: none; border: none; color: #666; font-size: 16px; cursor: pointer; padding: 0 2px; line-height: 1; }
.venue-popup-close:hover { color: #fff; }
.venue-popup-groups { display: flex; flex-wrap: wrap; gap: 4px; }
.venue-popup-group { font-size: 11px; padding: 3px 10px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); }
.venue-popup-tabs { display: flex; gap: 4px; margin-bottom: 10px; }
.venue-popup-tab { font-size: 11px; padding: 4px 12px; border-radius: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #888; cursor: pointer; transition: all 0.15s; }
.venue-popup-tab:hover { background: rgba(255,255,255,0.1); color: #ccc; }
.venue-popup-tab.active { background: var(--tab-color, rgba(255,255,255,0.15)); border-color: var(--tab-color, rgba(255,255,255,0.3)); color: #fff; }
.qf-drop-highlight { outline: 2px dashed rgba(255,255,255,0.4) !important; outline-offset: -2px; background: rgba(255,255,255,0.04) !important; }
.region-header.qf-drop-highlight { outline: 2px dashed rgba(255,215,0,0.5) !important; background: rgba(255,215,0,0.06) !important; }
.loc-autocomplete {
  position: absolute; z-index: 500; background: rgba(20,20,35,0.97); border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px; max-height: 160px; overflow-y: auto; width: 100%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
}
.loc-autocomplete-item {
  padding: 6px 10px; font-size: 11px; color: #ccc; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.loc-autocomplete-item:hover, .loc-autocomplete-item.active { background: rgba(255,255,255,0.08); color: #fff; }
.loc-autocomplete-item small { color: #666; margin-left: 6px; }
.drag-ghost-dot {
  position: fixed; width: 8px; height: 8px; border-radius: 50%;
  pointer-events: none; z-index: 300; transition: all 0.25s ease-out;
  box-shadow: 0 0 6px rgba(255,255,255,0.4);
}
.drag-ghost-label {
  position: fixed; z-index: 301; pointer-events: none;
  background: rgba(10,10,15,0.9); border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px; padding: 4px 10px; font-size: 11px; color: #fff;
  font-family: 'Space Mono', monospace; white-space: nowrap;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* Map stats bar */
.map-stats {
  position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 15;
  display: none; gap: 16px; align-items: center;
  background: rgba(10,10,15,0.85); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px; padding: 6px 18px; backdrop-filter: blur(12px);
  font-family: 'Space Mono', monospace; font-size: 11px; color: #888;
}
.view-mode .map-stats { display: flex; }
.map-stats.selection-active { display: flex !important; cursor: grab; }
.map-stats.selection-active.dragging { cursor: grabbing; opacity: 0.9; }
.map-stats .sel-close { background: none; border: none; color: #666; font-size: 14px; cursor: pointer; margin-left: 6px; padding: 0 2px; }
.map-stats .sel-close:hover { color: #fff; }
.map-stats .sel-hint { color: #555; margin-left: 8px; }
.map-stat-val { color: #aaa; font-weight: 700; margin-right: 3px; }

/* Group hover tooltip */
.group-tooltip {
  position: fixed; z-index: 300; pointer-events: none;
  background: rgba(10,10,15,0.92); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 8px; padding: 5px 11px; backdrop-filter: blur(12px);
  font-family: 'Inter', sans-serif; font-size: 11px; color: #aaa;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  opacity: 0; transition: opacity 0.15s;
  white-space: nowrap;
}
.group-tooltip.visible { opacity: 1; }

/* Mobile disclaimer */
.mobile-disclaimer {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: #0A0A0F; text-align: center;
  padding: 60px 32px; flex-direction: column; align-items: center; justify-content: center;
}
@media (max-width: 900px) {
  .mobile-disclaimer { display: flex; }
}
.dropdown-menu {
  display: none; position: absolute; top: calc(100% + 6px); right: 0; z-index: 50;
  background: #14141a; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px;
  padding: 4px; min-width: 170px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.dropdown-menu.open { display: block; }
.dropdown-menu button {
  display: block; width: 100%; padding: 8px 14px; border: none; border-radius: 5px;
  background: transparent; color: #bbb; font-family: 'Outfit'; font-size: 12px;
  text-align: left; cursor: pointer; transition: all 0.15s;
}
.dropdown-menu button:hover { background: rgba(255,255,255,0.06); color: #fff; }
</style>
</head>
<body class="view-mode">

<div class="toolbar">
  <div class="toolbar-left">
    <button class="tb-btn" onclick="showAbout()" style="font-size:15px;padding:4px 8px" title="About">‚ìò</button>
    <div>
      <div class="toolbar-subtitle">ICCA REGION</div>
      <div class="toolbar-title">Assignment Editor</div>
    </div>
    <button class="tb-btn" onclick="resetToDefault()" style="display:flex;align-items:center;gap:5px">‚ü≤ Reset to 2026</button>
  </div>
  <div class="toolbar-right">
    <button class="tb-btn" onclick="addRegion()">+ Region</button>
    <button class="tb-btn" onclick="addQF()">+ Quarterfinal</button>
    <button class="tb-btn" onclick="addGroup()">+ Group</button>
    <div class="dropdown-wrap" style="position:relative">
      <button class="tb-btn" onclick="toggleBulkDropdown()">Bulk ‚ñæ</button>
      <div class="dropdown-menu" id="bulk-dropdown" style="min-width:210px">
        <button onclick="generateRegions();this.closest('.dropdown-menu').classList.remove('open')">‚ö° Generate Regions</button>
        <button onclick="seedFrom2026();this.closest('.dropdown-menu').classList.remove('open')">‚ö° Seed from 2026</button>
        <button onclick="bulkGenerateQFs();this.closest('.dropdown-menu').classList.remove('open')">‚ö° Generate QFs</button>
        <button onclick="bulkGenerateSFs();this.closest('.dropdown-menu').classList.remove('open')">‚ö° Generate Semifinals</button>
        <button onclick="rebalanceRegions();this.closest('.dropdown-menu').classList.remove('open')">‚öñ Rebalance Regions</button>
        <div style="height:1px;background:rgba(255,255,255,0.08);margin:4px 0"></div>
        <button onclick="bulkDeleteAllQFs();this.closest('.dropdown-menu').classList.remove('open')">üóë Dissolve QFs</button>
        <button onclick="bulkDeleteAllRegions();this.closest('.dropdown-menu').classList.remove('open')">üóë Delete regions</button>
        <button onclick="bulkClearAllGroups();this.closest('.dropdown-menu').classList.remove('open')">üóë Remove groups</button>
        <div style="height:1px;background:rgba(255,255,255,0.08);margin:4px 0"></div>
        <button onclick="runAudit();this.closest('.dropdown-menu').classList.remove('open')">üîç Audit Data</button>
      </div>
    </div>
    <span class="tb-sep"></span>
    <button class="tb-btn primary" id="view-toggle" onclick="toggleViewMode()">‚úé Edit</button>
    <button class="tb-btn" id="undo-btn" onclick="undoAction()">‚Ü© Undo</button>
    <span id="dirty-dot" style="display:none;width:8px;height:8px;border-radius:50%;background:#f59e0b;margin-left:-4px" title="Unsaved changes"></span>
    <span class="tb-sep"></span>
    <div class="dropdown-wrap" style="position:relative">
      <button class="tb-btn primary" onclick="toggleHistoryDropdown()">History ‚ñæ</button>
      <div class="dropdown-menu" id="history-dropdown" style="min-width:240px">
        <div id="history-year-list" style="max-height:200px;overflow-y:auto"></div>
        <div style="height:1px;background:rgba(255,255,255,0.08);margin:4px 0"></div>
        <button onclick="importHistoryJSON();this.closest('.dropdown-menu').classList.remove('open')">‚Üë Load Year from JSON</button>
      </div>
    </div>
    <div class="dropdown-wrap">
      <button class="tb-btn primary" onclick="toggleDropdown()">Import / Export ‚ñæ</button>
      <div class="dropdown-menu" id="json-dropdown">
        <button onclick="exportJSON();toggleDropdown()">‚Üì Export Config (JSON)</button>
        <button onclick="importJSON();toggleDropdown()">‚Üë Import Config (JSON)</button>
        <button onclick="exportGroupsCSV();toggleDropdown()">‚Üì Export Groups (CSV)</button>
        <button onclick="importGroupsCSV();toggleDropdown()">‚Üë Import Groups (CSV)</button>
        <div style="height:1px;background:rgba(255,255,255,0.08);margin:4px 0"></div>
        <button onclick="exportImage();toggleDropdown()">üì∑ Export Image (PNG)</button>
      </div>
    </div>
    <input type="file" id="file-import" accept=".json" style="display:none" onchange="handleImport(event)">
    <input type="file" id="file-history-import" accept=".json" style="display:none" onchange="handleHistoryImport(event)">
  </div>
</div>

<div class="main">
  <div class="editor">
    <div class="editor-header">
      <span class="editor-title">Structure</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="tb-btn" style="padding:3px 8px;font-size:10px" onclick="expandAll()" title="Expand all">‚ñº</button>
        <button class="tb-btn" style="padding:3px 8px;font-size:10px" onclick="collapseAll()" title="Collapse all">‚ñ≤</button>
        <span class="editor-stats" id="editor-stats"></span>
      </div>
    </div>
    <div class="editor-body" id="editor-body"></div>
  </div>

  <div class="map-area" id="map-area">
    <div class="map-bg"></div>
    <div id="map-container"></div>
    <div class="lasso-rect" id="lasso-rect"></div>
    <div class="lasso-hint" id="lasso-hint">shift + drag to select ¬∑ shift/‚åò + click to toggle</div>
    <div class="map-stats" id="map-stats"></div>
    <div id="venue-popup" class="venue-popup" style="display:none"></div>
    <div id="group-tooltip" class="group-tooltip"></div>
    <div class="tooltip-box" id="tooltip">
      <div class="tt-school" id="tt-school"></div>
      <div class="tt-region" id="tt-region"></div>
      <div class="tt-groups" id="tt-groups"></div>
    </div>
    <div class="map-legend" id="map-legend"></div>
    <div class="compare-banner" id="compare-banner">VIEWING BASE 2026</div>
    <div class="compare-toggle" id="compare-toggle">
      <button class="zoom-btn" onclick="toggleCompare()" id="compare-btn" title="Compare with 2026 base data" style="font-size:10px;width:auto;padding:0 8px">‚ü∑ Base</button>
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()">+</button>
      <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
      <button class="zoom-btn" onclick="resetZoom()">‚ü≤</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal"></div>
</div>

<div class="mobile-disclaimer" id="mobile-disclaimer">
  <div style="font-size:32px;margin-bottom:12px">üñ•Ô∏è</div>
  <div style="font-size:15px;font-weight:700;margin-bottom:6px">Desktop Recommended</div>
  <div style="font-size:12px;color:#888;line-height:1.5">The Region Editor uses drag‚Äëand‚Äëdrop, lasso selection, and detailed modals that work best on a larger screen.</div>
  <a href="icca-2026-map.html" class="tb-btn" style="margin-top:16px;display:inline-block">‚Üê View the 2026 Map instead</a>
  <button class="tb-btn" style="margin-top:8px;display:block;width:100%;color:#555" onclick="document.getElementById('mobile-disclaimer').style.display='none'">Continue anyway</button>
</div>

<script>
const REGIONS = {
  Central: {
    color: "#D4A030", accent: "#F0C75E",
    schools: ["Cornell University","Lehigh University","Binghamton University","Ithaca College","Syracuse University","University of Waterloo","Western University","McMaster University","Toronto Metropolitan University","University of Toronto","Rochester Institute of Technology","Queen's University","Nazareth University","SUNY Fredonia","Wilfrid Laurier University","Monroe Community College","University of Rochester","University of Pittsburgh","Carnegie Mellon University","Penn State University","Millersville University","Indiana University of Pennsylvania","Duquesne University"],
    quarterfinals: [
      {date:"Jan 31",location:"Binghamton University, NY",lat:42.09,lng:-75.97,groups:["The Chordials","The Class Notes","Echoes","The Harpur Harpeggios","Ithacappella","Off the Record","Otto Tunes","Rhythm Method","Tone Cold","Voicestream"]},
      {date:"Feb 7",location:"University of Waterloo",lat:43.47,lng:-80.54,groups:["The AcaBellas","Equivox","The MacaFellas","Macappella","On That Note","PitchSlapped","RESONATE","Tunes. Beats. Awesome.","The Unaccompanied Minors","The Water Boys"]},
      {date:"Feb 14",location:"Rochester, NY",lat:43.13,lng:-77.63,groups:["The Brick City Singers","The Caledonias","Call4Backup","Dynamic Intonation","Encore","Hawkapella","Tributones","Vocal Accent","Vocal Point","YellowJackets"]},
      {date:"Feb 21",location:"Pittsburgh, PA",lat:40.44,lng:-79.96,groups:["C Flat Run","C Sharp Singers","Counterpoint","The Originals","Pitches & Tones","The Pitt Pendulums","Sargam","The Songburghs","Sounds Like Treble","The Treblemakers"]},
      {date:"Feb 28",location:"Penn State University, PA",lat:40.80,lng:-77.86,groups:["A Whole Step Up","Chromatic","The Coda Conduct","Crimson Chords","Fanaa","The Melismatics","Mic Drop","None of the Above","The Statesmen","VilleHarmonics"]},
    ],
    semifinal:{date:"Mar 21",location:"University at Buffalo",lat:42.95,lng:-78.82},
  },
  "Great Lakes": {
    color: "#457B9D", accent: "#6BAED6",
    schools: ["Eastern Illinois University","University of Chicago","North Central College","University of Wisconsin - Madison","Columbia College Chicago","University of Wisconsin - Parkside","Northwestern University","University of Minnesota","University of Wisconsin - Stevens Point","Marquette University","University of Wisconsin - Eau Claire","Loyola University - Chicago","Grand Valley State University","University of Michigan","Oakland University","Wayne State University","Central Michigan University","Michigan State University","Macomb Community College","Western Michigan University","Illinois State University","Northern Illinois University","University of Illinois","University Of Wisconsin - Milwaukee"],
    quarterfinals: [
      {date:"Feb 7",location:"University of Chicago",lat:41.79,lng:-87.60,groups:["Blue Fusion","Cadenza","Final Cut","Fundamentally Sound","Horizon","Illini Awaaz","Parkside Range","The Ransom Notes","Sonata Problem","Undertones"]},
      {date:"Feb 14",location:"University of Wisconsin",lat:43.08,lng:-89.41,groups:["7Days","CounterPoint","The Enchantments","Gold 'n Blues","Impromptu","The Naturals","Pitches & Notes","Under A-Rest","Urban Sound","Vocal U"]},
      {date:"Feb 21",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["Counterpoint","Euphoria","Gimble","Gold Vibrations","Maize Mirchi","Melodytroit","On The Rox","Sopranos","State of Fifths","The Treblemakers"]},
      {date:"Feb 22",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["58 Greene","The Accafellas","Amazin' Blue","Capital Green","DJs","The Expressions","The G-Men","The Harmonettes","Ladies First","Radio Treble"]},
      {date:"Feb 28",location:"Illinois State University",lat:40.51,lng:-88.99,groups:["The Acafellaz","Clef Hangers","The Harmelodics","No Comment","No Strings Attached","On the Brink of Normal","Public Hearing","The Rip Chords","Secondary Dominance","The Xtension Chords"]},
    ],
    semifinal:{date:"Mar 28",location:"Pabst Theater",lat:43.04,lng:-87.92},
  },
  "Mid-Atlantic": {
    color: "#2A9D8F", accent: "#4ECDC4",
    schools: ["Rutgers University","University of Maryland","Westminster Choir College","Rowan University","The College of New Jersey","Drexel University","Temple University","University of Maryland Eastern Shore","University of Pennsylvania","Georgetown University","Villanova University","Johns Hopkins University","University of Maryland Baltimore County","George Washington University","Towson University","Salisbury University","Southern Virginia University","Christopher Newport University","Washington and Lee University","James Madison University","William & Mary","George Mason University","Virginia Commonwealth University","Lafayette College","University of Delaware","West Chester University","Stockton University"],
    quarterfinals: [
      {date:"Jan 31",location:"The College of New Jersey",lat:40.27,lng:-74.78,groups:["Casual Harmony","DaCadence","The Deaftones","The OrphanSporks","Profecy","RAAG","Rowan Vocals","ShockWave","The Trentones"]},
      {date:"Feb 14",location:"Drexel University",lat:39.96,lng:-75.19,groups:["The Cleftomaniacs","Faux Paz","LiaChorus","The Muses","Owlcappella","Penny Loafers","Pitch, Please","Superfood","The Supernovas","The TrebleMakers"]},
      {date:"Feb 21",location:"Towson University",lat:39.39,lng:-76.61,groups:["The AllNighters","Cleftomaniacs","The GW Vibes","The Notes of Ranvier","Off Track","Sons of Pitch","Squawkappella","The Stilettos","UNTITLED","The Vocal Chords"]},
      {date:"Feb 28",location:"Oakton High School, Vienna, VA",lat:38.89,lng:-77.26,groups:["Accolade","Extreme Measures","General Admission","Low Key","No Ceiling","Noteworthy","Purple Reign","The Ramifications","Take Note","University Sounds"]},
      {date:"Feb 28",location:"West Chester University",lat:39.95,lng:-75.60,groups:["Cadence","The Chorduroys","The Golden Blues","High Street Harmonix","The Mar-Keys","The MelUDees","Soulfege","Stockapella","Under A Rest","Vocal Point"]},
    ],
    semifinal:{date:"Mar 21",location:"The Grand, Wilmington, DE",lat:39.75,lng:-75.55},
  },
  Midwest: {
    color: "#F4A261", accent: "#FFD166",
    schools: ["Purdue University","Bowling Green State University","Washington University in St. Louis","University of Dayton","Indiana University","Miami University","Indiana University Indianapolis","Kent State University","University of Cincinnati","Saint Louis University","University of Notre Dame","University of Missouri","Missouri University of Science and Technology","Missouri State University","Iowa State University","University of Kansas","Murray State University","Truman State University","Case Western Reserve University","The Ohio State University","Baldwin Wallace University","University of Kentucky","Ohio University","The University of Akron"],
    quarterfinals: [
      {date:"Jan 24",location:"Indianapolis, IN",lat:39.77,lng:-86.16,groups:["Acabellas","AcousChicks","After Dark","Audio Pilots","The Bloomingtones","Just Duet","On A Side Note","Resting Pitch Face","Soundtracks","Vocal Intensity"]},
      {date:"Jan 31",location:"Washington University in St. Louis",lat:38.65,lng:-90.31,groups:["Avocalypse","The Bare Naked Statues","Beyond All Reason","Decadence","The Echoes","Forte","Miner Key","The Naturelles","The Sensasians","The Vocaholics"]},
      {date:"Feb 14",location:"Missouri State University",lat:37.21,lng:-93.28,groups:["A Cub Bella","Astha","The Beartones","Count Me In","Crimson and Blues","EQ Blu","The Hibernotes","Mezzo Forte","Minor Detail","Reverb"]},
      {date:"Feb 21",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["Case in Point","The Flying Solos","Remedy","Retrograde","Scarlet and Grace Notes","S≈åL","Ten40!","The Ohio State of Mind","Tonal Eclipse","Underscore"]},
      {date:"Feb 28",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["AcoUstiKats","Buck That!","Cosmos","Dhamakapella","Dynamics","Majors & minors","New Chords on the Block","Rhythm & Roos","Sound of Science","The Tempo Tantrums"]},
    ],
    semifinal:{date:"Mar 14",location:"Indianapolis, IN",lat:39.77,lng:-86.16},
  },
  Northeast: {
    color: "#9B5DE5", accent: "#C77DFF",
    schools: ["SUNY Potsdam","University of Massachusetts Amherst","University at Albany","Rensselaer Polytechnic Institute","SUNY New Paltz","University of Vermont","Emerson College","Boston University","Worcester Polytechnic Institute","Northeastern University","Boston College","Brown University","The Colleges of Fenway","Wesleyan University","The New School","Bryant University","Marist University","Bentley University","Berklee College of Music","University of Connecticut","Eastern Connecticut State University","Fordham University","University of Hartford","Hunter College","Roger Williams University","Quinnipiac University","New York University","Columbia University","Pace University","Hofstra University"],
    quarterfinals: [
      {date:"Jan 24",location:"Rensselaer Polytechnic Institute",lat:42.73,lng:-73.68,groups:["A Sharp Arrangement","Duly Noted","Pitch Please","The Potsdam Pitches","The Potsdam Pointercounts","The Rusty Pipes","S#arp Attitude","The Sexy Pitches","Stay Tuned","Viridescent"]},
      {date:"Feb 14",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["Acappellics","Allegrettos","Audiophiles","Distilled Harmony","Dynamics","The Jabberwocks","The Sirens","Treble on Huntington","Triple Major","Unjust Intonation"]},
      {date:"Feb 15",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["The Bostonians","The Bottom Line","The Enharmonics","The Nor'easters","Off The Clock","The Ramifications","Treble Threat","Treblemakers","The Unisons","Upper Structure"]},
      {date:"Mar 7",location:"University of Hartford",lat:41.80,lng:-72.72,groups:["A Minor","East Harmonies","The F Sharps","The Fordham Ramblers","HartAttack","Hawkappella","Hawkward","L'Shir","The Legends","The Vocaholics"]},
      {date:"Mar 7",location:"NY Society for Ethical Culture",lat:40.77,lng:-73.97,groups:["The Clefhangers","The Cleftomaniacs","Frequency","The Hofbeats","Makin' Treble","The Mixtapes","N'Harmonics","Sigma'cappella","Tonal Recall","Vocollision"]},
    ],
    semifinal:{date:"Mar 28",location:"Berklee College of Music",lat:42.35,lng:-71.09},
  },
  South: {
    color: "#E76F51", accent: "#FF9F7F",
    schools: ["North Carolina State University","University of Mount Olive","University of South Carolina","University of Georgia","Georgia Institute of Technology","High Point University","University of North Carolina at Chapel Hill","University of Florida","University of Miami","University of Central Florida","Florida International University","University of South Florida","East Tennessee State University","Belmont University","University of Tennessee","Vanderbilt University","Emory University","University of North Carolina At Greensboro","Wake Forest University","Appalachian State University","Duke University","Florida State University","Pearl River Community College","East Central Community College","University of Southern Mississippi","Mississippi State University","University of Alabama"],
    quarterfinals: [
      {date:"Jan 24",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Acappology","Carolina Sound","Chordination","Cockappella","Noteworthy","Nothin' But Treble","Offbeats","Tar Heel Voices"]},
      {date:"Jan 31",location:"Trinity Prep HS, Orlando, FL",lat:28.54,lng:-81.38,groups:["Accent","BisCaydence","Gemini Boulevard","HEARTbeats","KeyHarmony","Mixed Mode","The Sedoctaves","Tone Definition","Tones of Gold","Tufaan"]},
      {date:"Feb 7",location:"University of Tennessee",lat:35.95,lng:-83.93,groups:["Ascension","The Belles","The Beltones","Harmonium","Intonations","Prismatics","reVOLution","Spectrum","VOLT"]},
      {date:"Feb 21",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Aural Pleasure","The Chariots","Demon Divas","Ear Candy","Grains of Time","Harmonic Notion","Ladies In Red","Rhythm & Blue","VoiceMale","Wolfgang"]},
      {date:"Mar 7",location:"IMPAC, Biloxi, MS",lat:30.40,lng:-88.89,groups:["AcaBelles","All-Night Yahtzee","Currents","Dooley Noted","EC Listening","Reverb","Spirit of Southern","TrebullDawgs","Tune In","The Voices"]},
    ],
    semifinal:{date:"Mar 28",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90},
  },
  Southwest: {
    color: "#D62828", accent: "#FF4D4D",
    schools: ["University of Texas at Austin","Texas Tech University","University of Houston","Texas A&M University","University of Texas at Dallas","Dallas-Fort Worth","University of Texas at Arlington","Baylor University","University of Nebraska","University of Denver","University of Colorado Boulder","Colorado State University","Oklahoma City University","University of California, San Diego","University of California, Irvine","San Diego State University","University of Arizona","Northern Arizona University","Grand Canyon University","Arizona State University","The Claremont Colleges","Mt. San Antonio College"],
    quarterfinals: [
      {date:"Jan 31",location:"MacArthur High School",lat:29.55,lng:-98.37,groups:["Beauties and the Beat","Empire","Final Measure","HardChord DynaMix","Noteworthy","Novis","RISE","Star Struck","Trillium","VirtuOSO"]},
      {date:"Feb 7",location:"Rococo Theatre, Lincoln, NE",lat:40.81,lng:-96.70,groups:["The Bathtub Dogs","Boots & Cats","Exit 205","Extreme Measures","Mainstreet","Pitch Please","The Red Keys","Take Note","Tonal Eclipse"]},
      {date:"Feb 7",location:"UC San Diego",lat:32.88,lng:-117.23,groups:["Acamazing","Clair de Lune","The Daughters of Triton","Morse Coda","NOVA","Sitaare","SoundWave","The Trebles","The Tritones","Vermillion Vocalists"]},
      {date:"Feb 21",location:"Scottsdale, AZ",lat:33.49,lng:-111.93,groups:["Amplified","The Axecidentals","Canyon Crescendos","Devil Clefs","Enharmonics","Meow or Never","Noteriety","The Pitchforks","Priority Male","The TEMPEtations"]},
      {date:"Feb 28",location:"Claremont University, CA",lat:34.10,lng:-117.71,groups:["Aerodynamix","Claremont Shades","Earth Tones","Elevation","Haath","The Highlanders","Midnight Echo","Nu Aria","Uniting Voices","VocaLotus"]},
    ],
    semifinal:{date:"Mar 15",location:"Scottsdale, AZ",lat:33.49,lng:-111.93},
  },
  West: {
    color: "#264653", accent: "#4A8FA8",
    schools: ["University of Washington","Gonzaga University","University of British Columbia","University of British Columbia, Okanagan","Western Washington University","Oregon State University","Southern Oregon University","Portland State University","Willamette University","University of Oregon","Montana State University","University of Utah","University of California, Los Angeles","Chapman University","California State University, Fullerton","Moorpark College","University of California, Santa Barbara","University of Southern California","California State University, Northridge","University of California, Santa Cruz","University of California, Davis","UC Berkeley","Stanford University","Diablo Valley College","San Jose State University"],
    quarterfinals: [
      {date:"Jan 24",location:"Tacoma Armory",lat:47.25,lng:-122.44,groups:["Awaaz","Big Bing Theory","Eh? Cappella","For Good Measure","Furmata","The Northwest Collective","Pacific Note West","Trebled Acaholics","The Trill Seekers"]},
      {date:"Jan 31",location:"The Elsinore Theatre",lat:44.94,lng:-123.04,groups:["Divine","Dulcet","The Green Note","Headband","Mind the Gap","Power Chord","Rhapsody","Salt Flats","Tandem","Up Top"]},
      {date:"Jan 31",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Bruin Harmony","Chapman SoundCheck","The Dissonants","The FullerTones","MoorHarmony","Naked Voices","Naya Zamaana","Reverse Osmosis","ScatterTones"]},
      {date:"Feb 21",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Acasola","Awaken","The ChapTones","Cloud 9","Pitch, Please!","Random Voices","Resonance","Simply Vocale","Vocal Percussion Radio (VPR)"]},
      {date:"Feb 28",location:"Fox Theatre",lat:38.58,lng:-121.50,groups:["The Cleftomaniacs","Drawn to Scale","The Golden Overtones","Jhankaar","The Liquid Hotplates","The Lounge Lizards","The Mendicants","The pH Scale","The Spartones","The Spokes"]},
    ],
    semifinal:{date:"Mar 21",location:"Fox Theatre",lat:38.58,lng:-121.50},
  }
};

const QF_SCHOOLS = {"Central-0": ["Ithaca College", "Binghamton University", "Syracuse University", "Cornell University", "Lehigh University"], "Central-1": ["Toronto Metropolitan University", "University of Waterloo", "Western University", "University of Toronto", "McMaster University"], "Central-2": ["Queen's University", "Rochester Institute of Technology", "Nazareth University", "Wilfrid Laurier University", "University of Rochester", "Monroe Community College", "SUNY Fredonia"], "Central-3": ["University of Pittsburgh", "Carnegie Mellon University"], "Central-4": ["Penn State University", "Duquesne University", "Millersville University", "Indiana University of Pennsylvania", "Lehigh University"], "Great Lakes-0": ["Columbia College Chicago", "Northwestern University", "Eastern Illinois University", "University of Wisconsin - Parkside", "University of Illinois", "University of Chicago", "University of Wisconsin - Madison", "North Central College"], "Great Lakes-1": ["University of Wisconsin - Stevens Point", "Marquette University", "University of Minnesota", "University of Wisconsin - Eau Claire", "University of Wisconsin - Madison"], "Great Lakes-2": ["Northwestern University", "Loyola University - Chicago", "Central Michigan University", "Wayne State University", "Michigan State University", "Grand Valley State University", "Oakland University", "University of Michigan"], "Great Lakes-3": ["Western Michigan University", "University of Michigan", "Macomb Community College", "Michigan State University"], "Great Lakes-4": ["Illinois State University", "University Of Wisconsin - Milwaukee", "University of Illinois", "Northern Illinois University"], "Mid-Atlantic-0": ["University of Maryland", "The College of New Jersey", "Rowan University", "Rutgers University", "Westminster Choir College"], "Mid-Atlantic-1": ["University of Maryland Eastern Shore", "University of Maryland", "Villanova University", "University of Pennsylvania", "Drexel University", "Georgetown University", "Temple University"], "Mid-Atlantic-2": ["Towson University", "University of Maryland Baltimore County", "George Washington University", "Salisbury University", "Johns Hopkins University"], "Mid-Atlantic-3": ["Southern Virginia University", "Virginia Commonwealth University", "George Mason University", "William & Mary", "James Madison University", "Christopher Newport University", "Washington and Lee University"], "Mid-Atlantic-4": ["University of Delaware", "Lafayette College", "West Chester University", "Stockton University"], "Midwest-0": ["Kent State University", "Indiana University Indianapolis", "Purdue University", "Bowling Green State University", "Miami University", "Indiana University", "Washington University in St. Louis", "University of Dayton"], "Midwest-1": ["University of Notre Dame", "Saint Louis University", "Missouri University of Science and Technology", "University of Missouri", "University of Cincinnati", "Washington University in St. Louis"], "Midwest-2": ["University of Kansas", "Saint Louis University", "Iowa State University", "Missouri State University", "Truman State University", "Murray State University", "Washington University in St. Louis"], "Midwest-3": ["Case Western Reserve University", "The Ohio State University", "Bowling Green State University", "University of Dayton", "Baldwin Wallace University"], "Midwest-4": ["Case Western Reserve University", "Ohio University", "University of Kentucky", "The Ohio State University", "The University of Akron", "Baldwin Wallace University"], "Northeast-0": ["University of Vermont", "SUNY Potsdam", "SUNY New Paltz", "Rensselaer Polytechnic Institute", "University at Albany", "University of Massachusetts Amherst"], "Northeast-1": ["Boston University", "The Colleges of Fenway", "The New School", "Northeastern University", "Wesleyan University", "Emerson College", "Boston College", "Brown University", "Worcester Polytechnic Institute"], "Northeast-2": ["Boston University", "Berklee College of Music", "Suffolk University", "Bryant University", "Northeastern University", "Boston College", "Marist University", "Bentley University"], "Northeast-3": ["University of Hartford", "Hunter College", "Roger Williams University", "Fordham University", "University of Connecticut", "Eastern Connecticut State University", "Quinnipiac University", "New York University"], "Northeast-4": ["Pace University", "Hofstra University", "Columbia University", "New York University"], "South-0": ["University of Mount Olive", "North Carolina State University", "University of Georgia", "Georgia Institute of Technology", "University of North Carolina at Chapel Hill", "University of South Carolina", "High Point University"], "South-1": ["Florida International University", "University of Miami", "University of Central Florida", "University of Florida", "University of South Florida"], "South-2": ["Belmont University", "East Tennessee State University", "University of Tennessee", "Vanderbilt University"], "South-3": ["Vanderbilt University", "North Carolina State University", "Wake Forest University", "Emory University", "Appalachian State University", "Duke University", "University of North Carolina At Greensboro"], "South-4": ["University of Southern Mississippi", "Pearl River Community College", "Florida State University", "Mississippi State University", "East Central Community College", "University of Alabama", "Emory University"], "Southwest-0": ["University of Houston", "Baylor University", "Texas A&M University", "University of Texas at Arlington", "Texas Tech University", "University of Texas at Austin", "University of Texas at Dallas", "Dallas-Fort Worth"], "Southwest-1": ["University of Denver", "Colorado State University", "University of Nebraska", "Oklahoma City University", "University of Colorado Boulder"], "Southwest-2": ["University of California, San Diego", "University of California, Irvine", "San Diego State University"], "Southwest-3": ["Grand Canyon University", "Arizona State University", "Northern Arizona University", "University of Arizona"], "Southwest-4": ["Mt. San Antonio College", "The Claremont Colleges", "Northern Arizona University", "University of California, Irvine"], "United Kingdom-0": ["University of Cambridge", "University of Aberdeen", "University of St Andrews", "University of Stirling", "University of Edinburgh"], "United Kingdom-1": ["University of Warwick", "University of Nottingham", "University of Leeds", "University of Sheffield", "University of York", "University of Birmingham"], "United Kingdom-2": ["University of Bath", "University of Exeter", "University of Bristol", "Cardiff University", "Royal Welsh College of Music and Drama"], "United Kingdom-3": ["University of Warwick", "University of Oxford", "Cardiff University", "Lancaster University", "Newcastle University", "Durham University", "University of Manchester", "University of Birmingham"], "United Kingdom-4": ["University of Nottingham", "University College London", "King's College London", "Imperial College London", "London School of Economics", "University of Reading"], "West-0": ["University of British Columbia", "Gonzaga University", "Western Washington University", "University of Washington", "University of British Columbia, Okanagan"], "West-1": ["University of Utah", "Oregon State University", "Portland State University", "University of Oregon", "Southern Oregon University", "Montana State University", "Willamette University"], "West-2": ["University of Southern California", "Chapman University", "University of California, Santa Barbara", "University of California, Los Angeles", "California State University, Fullerton", "Moorpark College"], "West-3": ["Chapman University", "California State University, Northridge", "University of California, Los Angeles", "University of California, Santa Cruz"], "West-4": ["San Jose State University", "Diablo Valley College", "UC Berkeley", "Stanford University", "University of California, Davis"]};
const SCHOOL_COORDS = {
  "Cornell University":[42.45,-76.47],"Lehigh University":[40.61,-75.38],"Binghamton University":[42.09,-75.97],"Ithaca College":[42.42,-76.50],"Syracuse University":[43.04,-76.14],"University of Waterloo":[43.47,-80.54],"Western University":[43.01,-81.27],"McMaster University":[43.26,-79.92],"Toronto Metropolitan University":[43.66,-79.38],"University of Toronto":[43.66,-79.40],"Rochester Institute of Technology":[43.08,-77.67],"Queen's University":[44.23,-76.50],"Nazareth University":[43.10,-77.51],"SUNY Fredonia":[42.45,-79.33],"Wilfrid Laurier University":[43.47,-80.53],"Monroe Community College":[43.08,-77.62],"University of Rochester":[43.13,-77.63],"University of Pittsburgh":[40.44,-79.96],"Carnegie Mellon University":[40.44,-79.94],"Penn State University":[40.80,-77.86],"Millersville University":[39.99,-76.35],"Indiana University of Pennsylvania":[40.62,-79.15],"Duquesne University":[40.44,-79.99],
  "Eastern Illinois University":[39.48,-88.18],"University of Chicago":[41.79,-87.60],"North Central College":[41.77,-88.15],"University of Wisconsin - Madison":[43.08,-89.41],"Columbia College Chicago":[41.87,-87.62],"University of Wisconsin - Parkside":[42.64,-87.85],"Northwestern University":[42.06,-87.68],"University of Minnesota":[44.97,-93.23],"University of Wisconsin - Stevens Point":[44.53,-89.57],"Marquette University":[43.04,-87.93],"University of Wisconsin - Eau Claire":[44.80,-91.50],"Loyola University - Chicago":[41.99,-87.66],"Grand Valley State University":[42.96,-85.89],"University of Michigan":[42.28,-83.74],"Oakland University":[42.67,-83.22],"Wayne State University":[42.36,-83.07],"Central Michigan University":[43.59,-84.77],"Michigan State University":[42.73,-84.48],"Macomb Community College":[42.67,-82.95],"Western Michigan University":[42.28,-85.61],"Illinois State University":[40.51,-88.99],"Northern Illinois University":[41.93,-88.77],"University of Illinois":[40.10,-88.23],"University Of Wisconsin - Milwaukee":[43.08,-87.88],
  "Rutgers University":[40.50,-74.45],"University of Maryland":[38.99,-76.94],"Westminster Choir College":[40.35,-74.66],"Rowan University":[39.71,-75.12],"The College of New Jersey":[40.27,-74.78],"Drexel University":[39.96,-75.19],"Temple University":[39.98,-75.16],"University of Maryland Eastern Shore":[38.39,-75.67],"University of Pennsylvania":[39.95,-75.19],"Georgetown University":[38.91,-77.07],"Villanova University":[40.04,-75.34],"Johns Hopkins University":[39.33,-76.62],"University of Maryland Baltimore County":[39.25,-76.71],"George Washington University":[38.90,-77.05],"Towson University":[39.39,-76.61],"Salisbury University":[38.37,-75.60],"Southern Virginia University":[37.78,-79.44],"Christopher Newport University":[37.06,-76.49],"Washington and Lee University":[37.79,-79.44],"James Madison University":[38.43,-78.87],"William & Mary":[37.27,-76.71],"George Mason University":[38.83,-77.31],"Virginia Commonwealth University":[37.55,-77.43],"Lafayette College":[40.70,-75.21],"University of Delaware":[39.68,-75.75],"West Chester University":[39.95,-75.60],"Stockton University":[39.48,-74.54],
  "Purdue University":[40.42,-86.92],"Bowling Green State University":[41.38,-83.64],"Washington University in St. Louis":[38.65,-90.31],"University of Dayton":[39.74,-84.18],"Indiana University":[39.17,-86.52],"Miami University":[39.51,-84.73],"Indiana University Indianapolis":[39.77,-86.17],"Kent State University":[41.15,-81.34],"University of Cincinnati":[39.13,-84.52],"Saint Louis University":[38.64,-90.23],"University of Notre Dame":[41.70,-86.24],"University of Missouri":[38.95,-92.33],"Missouri University of Science and Technology":[37.96,-91.77],"Missouri State University":[37.21,-93.28],"Iowa State University":[42.03,-93.65],"University of Kansas":[38.96,-95.24],"Murray State University":[36.62,-88.33],"Truman State University":[40.19,-92.58],"Case Western Reserve University":[41.50,-81.61],"The Ohio State University":[39.99,-83.01],"Baldwin Wallace University":[41.37,-81.85],"University of Kentucky":[38.04,-84.50],"Ohio University":[39.32,-82.10],"The University of Akron":[41.08,-81.51],
  "SUNY Potsdam":[44.67,-74.98],"University of Massachusetts Amherst":[42.39,-72.53],"University at Albany":[42.69,-73.82],"Rensselaer Polytechnic Institute":[42.73,-73.68],"SUNY New Paltz":[41.74,-74.09],"University of Vermont":[44.48,-73.20],"Emerson College":[42.35,-71.07],"Boston University":[42.35,-71.10],"Worcester Polytechnic Institute":[42.27,-71.81],"Northeastern University":[42.34,-71.09],"Boston College":[42.34,-71.17],"Brown University":[41.83,-71.40],"The Colleges of Fenway":[42.34,-71.10],"Wesleyan University":[41.56,-72.66],"The New School":[40.74,-73.99],"Bryant University":[41.87,-71.46],"Marist University":[41.72,-73.93],"Bentley University":[42.39,-71.22],"Berklee College of Music":[42.35,-71.09],"Suffolk University":[42.36,-71.06],"University of Connecticut":[41.81,-72.25],"Eastern Connecticut State University":[41.72,-72.23],"Fordham University":[40.86,-73.88],"University of Hartford":[41.80,-72.72],"Hunter College":[40.77,-73.96],"Roger Williams University":[41.64,-71.26],"Quinnipiac University":[41.42,-72.89],"New York University":[40.73,-73.99],"Columbia University":[40.81,-73.96],"Pace University":[40.71,-74.00],"Hofstra University":[40.72,-73.60],
  "North Carolina State University":[35.79,-78.68],"University of Mount Olive":[35.20,-78.07],"University of South Carolina":[33.99,-81.02],"University of Georgia":[33.95,-83.37],"Georgia Institute of Technology":[33.77,-84.40],"High Point University":[35.97,-80.01],"University of North Carolina at Chapel Hill":[35.91,-79.05],"University of Florida":[29.64,-82.35],"University of Miami":[25.72,-80.28],"University of Central Florida":[28.60,-81.20],"Florida International University":[25.76,-80.37],"University of South Florida":[28.06,-82.41],"East Tennessee State University":[36.30,-82.37],"Belmont University":[36.13,-86.79],"University of Tennessee":[35.95,-83.93],"Vanderbilt University":[36.15,-86.80],"Emory University":[33.79,-84.32],"University of North Carolina At Greensboro":[36.07,-79.81],"Wake Forest University":[36.13,-80.28],"Appalachian State University":[36.22,-81.69],"Duke University":[36.00,-78.94],"Florida State University":[30.44,-84.30],"Pearl River Community College":[30.77,-89.57],"East Central Community College":[32.35,-89.12],"University of Southern Mississippi":[31.33,-89.33],"Mississippi State University":[33.45,-88.79],"University of Alabama":[33.21,-87.54],
  "University of Texas at Austin":[30.28,-97.74],"Texas Tech University":[33.58,-101.85],"University of Houston":[29.72,-95.34],"Texas A&M University":[30.62,-96.34],"University of Texas at Dallas":[32.99,-96.75],"Dallas-Fort Worth":[32.78,-96.80],"University of Texas at Arlington":[32.73,-97.11],"Baylor University":[31.55,-97.12],"University of Nebraska":[40.82,-96.70],"University of Denver":[39.68,-104.96],"University of Colorado Boulder":[40.01,-105.27],"Colorado State University":[40.57,-105.08],"Oklahoma City University":[35.47,-97.52],"University of California, San Diego":[32.88,-117.23],"University of California, Irvine":[33.64,-117.84],"San Diego State University":[32.77,-117.07],"University of Arizona":[32.23,-110.95],"Northern Arizona University":[35.19,-111.65],"Grand Canyon University":[33.51,-112.13],"Arizona State University":[33.42,-111.93],"The Claremont Colleges":[34.10,-117.71],"Mt. San Antonio College":[34.05,-117.84],
  "University of Washington":[47.65,-122.30],"Gonzaga University":[47.67,-117.40],"University of British Columbia":[49.26,-123.25],"University of British Columbia, Okanagan":[49.94,-119.40],"Western Washington University":[48.73,-122.49],"Oregon State University":[44.56,-123.28],"Southern Oregon University":[42.34,-122.71],"Portland State University":[45.51,-122.68],"Willamette University":[44.94,-123.03],"University of Oregon":[44.04,-123.07],"Montana State University":[45.67,-111.05],"University of Utah":[40.76,-111.84],"University of California, Los Angeles":[34.07,-118.44],"Chapman University":[33.79,-117.85],"California State University, Fullerton":[33.88,-117.89],"Moorpark College":[34.28,-118.88],"University of California, Santa Barbara":[34.41,-119.85],"University of Southern California":[34.02,-118.29],"California State University, Northridge":[34.24,-118.53],"University of California, Santa Cruz":[36.99,-122.06],"University of California, Davis":[38.54,-121.76],"UC Berkeley":[37.87,-122.26],"Stanford University":[37.43,-122.17],"Diablo Valley College":[37.95,-122.06],"San Jose State University":[37.34,-121.88],
  "Alverno College":[42.99,-87.97],
  "Amherst College":[42.37,-72.52],
  "Augsburg University":[44.97,-93.24],
  "Ball State University":[40.20,-85.41],
  "Bates College":[44.11,-70.20],
  "Brandeis University":[42.37,-71.26],
  "Brigham Young University":[40.25,-111.65],
  "Bryn Mawr College":[40.03,-75.31],
  "Butler Community College":[37.69,-96.98],
  "California Institute of Technology":[34.14,-118.12],
  "California Polytechnic State University, San Luis Obispo":[35.30,-120.66],
  "Cardiff University":[51.49,-3.18],
  "Carthage College":[42.62,-87.82],
  "Central Connecticut State University":[41.69,-72.78],
  "Central Washington University":[46.96,-120.54],
  "Champlain College":[44.47,-73.20],
  "Clarkson University":[44.66,-75.00],
  "Clayton State University":[33.54,-84.36],
  "Clemson University":[34.68,-82.84],
  "Colgate University":[42.82,-75.54],
  "College of Wooster":[40.81,-81.93],
  "College of the Holy Cross":[42.24,-71.81],
  "Collin College":[33.10,-96.67],
  "Connecticut College":[41.38,-72.10],
  "Corban University":[44.93,-123.00],
  "Creighton University":[41.26,-95.95],
  "Dickinson College":[40.20,-77.20],
  "Durham University":[54.77,-1.57],
  "Eastern Michigan University":[42.25,-83.62],
  "Eastman School of Music":[43.16,-77.60],
  "Elizabethtown College":[40.15,-76.60],
  "Elon University":[36.10,-79.50],
  "Emmanuel College":[42.34,-71.10],
  "Georgia College and State University":[33.08,-83.23],
  "Guildhall School of Music and Drama":[51.52,-0.09],
  "Harvard University":[42.37,-71.12],
  "Hastings College":[40.59,-98.39],
  "Haverford College":[40.01,-75.30],
  "Illinois Institute of Technology":[41.83,-87.63],
  "Illinois Wesleyan University":[40.49,-88.99],
  "Imperial College London":[51.50,-0.18],
  "Indiana University-Purdue University Indianapolis":[39.77,-86.17],
  "Kansas State University":[39.19,-96.58],
  "Kenyon College":[40.38,-82.40],
  "King's College London":[51.51,-0.12],
  "Lancaster University":[54.01,-2.78],
  "Linn-Benton Community College":[44.57,-123.24],
  "Macaulay Honors College at CUNY":[40.75,-73.98],
  "Manhattanville College":[41.05,-73.73],
  "Massachusetts College of Liberal Arts":[42.70,-73.11],
  "Massachusetts Institute of Technology":[42.36,-71.09],
  "Middlebury College":[44.01,-73.18],
  "Millikin University":[39.84,-88.95],
  "Monmouth University":[40.28,-74.00],
  "Mount Marty College":[42.78,-97.39],
  "Mount St. Joseph University":[39.15,-84.64],
  "Newcastle University":[54.98,-1.62],
  "Northern Michigan University":[46.56,-87.40],
  "Nova Southeastern University":[26.08,-80.25],
  "Oberlin College":[41.29,-82.22],
  "Ohio Wesleyan University":[40.30,-83.07],
  "Olin College of Engineering":[42.29,-71.26],
  "Otterbein University":[40.08,-82.93],
  "Pacific Lutheran University":[47.15,-122.45],
  "Plymouth State University":[43.76,-71.69],
  "Princeton University":[40.35,-74.66],
  "Queens College":[40.74,-73.82],
  "Radcliffe College":[42.37,-71.13],
  "Ramapo College of New Jersey":[41.08,-74.18],
  "Rice University":[29.72,-95.40],
  "Rider University":[40.28,-74.75],
  "Roanoke College":[37.29,-79.95],
  "Royal Welsh College of Music and Drama":[51.49,-3.18],
  "Ryerson University":[43.66,-79.38],
  "SUNY Geneseo":[42.80,-77.82],
  "SUNY Oneonta":[42.47,-75.06],
  "SUNY Purchase":[41.05,-73.70],
  "SUNY Stony Brook":[40.91,-73.12],
  "SUNY at Buffalo":[42.99,-78.79],
  "Salem State University":[42.52,-70.90],
  "Sandra Day O'Connor College of Law":[33.42,-111.93],
  "Siena Heights University":[41.93,-83.99],
  "Simmons College":[42.34,-71.10],
  "Simmons University":[42.34,-71.10],
  "Skidmore College":[43.10,-73.79],
  "Smith College":[42.32,-72.64],
  "Southeast Missouri State University":[37.31,-89.56],
  "Springfield College":[42.11,-72.58],
  "St. Mary's College of Maryland":[38.19,-76.43],
  "Stephen F. Austin State University":[31.62,-94.65],
  "Susquehanna University":[40.95,-76.86],
  "Tecnol√≥gico de Monterrey":[25.65,-100.29],
  "Texas Christian University":[32.71,-97.36],
  "The Catholic University of America":[38.94,-76.99],
  "The College of Saint Rose":[42.66,-73.78],
  "The University of Manchester":[53.47,-2.23],
  "Trinity College Dublin":[53.34,-6.25],
  "Tulane University":[29.94,-90.12],
  "United States Air Force Academy":[38.99,-104.86],
  "University College London":[51.52,-0.13],
  "University of Aberdeen":[57.17,-2.10],
  "University of Alabama at Birmingham":[33.50,-86.80],
  "University of Bath":[51.38,-2.33],
  "University of Birmingham":[52.45,-1.93],
  "University of Bristol":[51.46,-2.60],
  "University of California, Berkeley":[37.87,-122.26],
  "University of California, Riverside":[33.97,-117.33],
  "University of Cambridge":[52.20,0.12],
  "University of Central Missouri":[38.76,-93.74],
  "University of Edinburgh":[55.94,-3.19],
  "University of Exeter":[50.74,-3.53],
  "University of Illinois at Chicago":[41.87,-87.65],
  "University of Iowa":[41.66,-91.54],
  "University of Leeds":[53.81,-1.55],
  "University of Maine":[44.90,-68.67],
  "University of Manchester":[53.47,-2.23],
  "University of Mary Washington":[38.30,-77.47],
  "University of Massachusetts Lowell":[42.65,-71.32],
  "University of Memphis":[35.12,-89.94],
  "University of New Hampshire":[43.14,-70.93],
  "University of North Carolina at Charlotte":[35.31,-80.73],
  "University of North Texas":[33.21,-97.15],
  "University of Northern Colorado":[40.41,-104.70],
  "University of Nottingham":[52.94,-1.19],
  "University of Oxford":[51.75,-1.25],
  "University of Reading":[51.44,-0.95],
  "University of Richmond":[37.57,-77.54],
  "University of Sheffield":[53.38,-1.49],
  "University of South Dakota":[42.79,-96.93],
  "University of St. Andrews":[56.34,-2.79],
  "University of Stirling":[56.15,-3.92],
  "University of Sussex":[50.87,-0.09],
  "University of Tampa":[27.95,-82.46],
  "University of Texas at San Antonio":[29.58,-98.62],
  "University of Virginia":[38.03,-78.51],
  "University of Warwick":[52.38,-1.56],
  "University of Western Ontario":[43.01,-81.27],
  "Utah Valley University":[40.28,-111.71],
  "Vassar College":[41.69,-73.90],
  "Virginia Tech":[37.23,-80.42],
  "Wagner College":[40.61,-74.10],
  "Washington & Lee University":[37.79,-79.44],
  "Wellesley College":[42.30,-71.31],
  "Western Carolina University":[35.31,-83.19],
  "Western Oregon University":[44.85,-123.24],
  "Wheaton College":[41.87,-71.19],
  "Wichita State University":[37.72,-97.30],
  "William Paterson University":[40.95,-74.20],
  "Yale University":[41.31,-72.92],
  "York College of Pennsylvania":[39.96,-76.73],"Baldwin-Wallace University":[41.37,-81.85],"Loyola University Chicago":[41.99,-87.66],"The College of William & Mary":[37.27,-76.71],"The George Washington University":[38.90,-77.05],"The University of Tennessee":[35.95,-83.93],"The University of Tennessee, Knoxville":[35.95,-83.93],"University of Akron":[41.08,-81.51],"University of British Columbia Okanagan":[49.94,-119.40],"University of Colorado":[40.01,-105.27],"University of Illinois Urbana-Champaign":[40.10,-88.23],"University of Maryland, College Park":[38.99,-76.94],"University of Minnesota Twin Cities":[44.97,-93.23],"University of North Carolina at Greensboro":[36.07,-79.81],"University of Wisconsin":[43.08,-89.41],"University of Wisconsin Eau Claire":[44.80,-91.50],"University of Wisconsin Madison":[43.08,-89.41],"University of Wisconsin Milwaukee":[43.08,-87.88],"University of Wisconsin Parkside":[42.64,-87.85],"University of Wisconsin Stevens Point":[44.53,-89.57],"University of Wisconsin-Madison":[43.08,-89.41],"West Chester University of Pennsylvania":[39.95,-75.60]
};

const SCHOOL_GROUPS = {"Cornell University": ["The Chordials", "The Class Notes"], "Lehigh University": ["Echoes", "Off the Record", "A Whole Step Up", "The Melismatics"], "Binghamton University": ["The Harpur Harpeggios", "Rhythm Method"], "Ithaca College": ["Ithacappella", "Tone Cold", "Voicestream"], "Syracuse University": ["Otto Tunes"], "University of Waterloo": ["The AcaBellas", "The Unaccompanied Minors", "The Water Boys"], "Western University": ["Equivox"], "McMaster University": ["The MacaFellas", "Macappella", "PitchSlapped"], "Toronto Metropolitan University": ["On That Note", "RESONATE"], "University of Toronto": ["Tunes. Beats. Awesome."], "Rochester Institute of Technology": ["The Brick City Singers", "Encore", "Vocal Accent"], "Queen's University": ["The Caledonias"], "Nazareth University": ["Call4Backup"], "SUNY Fredonia": ["Dynamic Intonation"], "Wilfrid Laurier University": ["Hawkapella"], "Monroe Community College": ["Tributones"], "University of Rochester": ["Vocal Point", "YellowJackets"], "University of Pittsburgh": ["C Flat Run", "Pitches & Tones", "The Pitt Pendulums", "Sargam", "The Songburghs", "Sounds Like Treble"], "Carnegie Mellon University": ["C Sharp Singers", "Counterpoint", "The Originals", "The Treblemakers"], "Millersville University": ["Chromatic", "VilleHarmonics"], "Penn State University": ["The Coda Conduct", "Fanaa", "None of the Above", "The Statesmen"], "Indiana University of Pennsylvania": ["Crimson Chords"], "Duquesne University": ["Mic Drop"], "Eastern Illinois University": ["Blue Fusion"], "University of Chicago": ["Cadenza", "The Ransom Notes"], "North Central College": ["Final Cut", "Sonata Problem"], "University of Wisconsin - Madison": ["Fundamentally Sound", "Pitches & Notes", "Under A-Rest"], "Columbia College Chicago": ["Horizon"], "University of Wisconsin - Parkside": ["Parkside Range"], "Northwestern University": ["Undertones", "The Treblemakers"], "University of Minnesota": ["7Days", "The Enchantments", "Urban Sound", "Vocal U"], "University of Wisconsin - Stevens Point": ["CounterPoint"], "Marquette University": ["Gold 'n Blues", "The Naturals"], "University of Wisconsin - Eau Claire": ["Impromptu"], "Loyola University - Chicago": ["Counterpoint"], "Grand Valley State University": ["Euphoria"], "University of Michigan": ["Gimble", "Maize Mirchi", "Sopranos", "58 Greene", "DJs", "The G-Men", "The Harmonettes", "Amazin' Blue"], "Oakland University": ["Gold Vibrations"], "Wayne State University": ["Melodytroit"], "Central Michigan University": ["On The Rox"], "Michigan State University": ["State of Fifths", "The Accafellas", "Capital Green", "Ladies First"], "Macomb Community College": ["The Expressions"], "Western Michigan University": ["Radio Treble"], "Illinois State University": ["The Acafellaz", "Clef Hangers", "On the Brink of Normal", "Secondary Dominance"], "Northern Illinois University": ["The Harmelodics"], "University of Illinois": ["No Comment", "No Strings Attached", "The Rip Chords", "The Xtension Chords", "Illini Awaaz"], "University Of Wisconsin - Milwaukee": ["Public Hearing"], "Rutgers University": ["Casual Harmony", "The OrphanSporks", "RAAG", "ShockWave"], "University of Maryland": ["DaCadence", "Faux Paz"], "Westminster Choir College": ["The Deaftones"], "Rowan University": ["Profecy", "Rowan Vocals"], "The College of New Jersey": ["The Trentones"], "Drexel University": ["The Cleftomaniacs", "The TrebleMakers"], "Temple University": ["LiaChorus", "Owlcappella", "Pitch, Please"], "University of Maryland Eastern Shore": ["The Muses"], "University of Pennsylvania": ["Penny Loafers"], "Georgetown University": ["Superfood"], "Villanova University": ["The Supernovas"], "Johns Hopkins University": ["The AllNighters", "The Notes of Ranvier", "The Vocal Chords"], "University of Maryland Baltimore County": ["Cleftomaniacs", "The Stilettos"], "George Washington University": ["The GW Vibes", "Sons of Pitch"], "Towson University": ["Off Track", "UNTITLED"], "Salisbury University": ["Squawkappella"], "Southern Virginia University": ["Accolade"], "Christopher Newport University": ["Extreme Measures", "Take Note", "University Sounds"], "Washington and Lee University": ["General Admission"], "James Madison University": ["Low Key", "Purple Reign"], "William & Mary": ["No Ceiling"], "George Mason University": ["Noteworthy"], "Virginia Commonwealth University": ["The Ramifications"], "Lafayette College": ["Cadence", "The Chorduroys", "The Mar-Keys", "Soulfege"], "University of Delaware": ["The Golden Blues", "The MelUDees", "Vocal Point"], "West Chester University": ["High Street Harmonix", "Under A Rest"], "Stockton University": ["Stockapella"], "Purdue University": ["Acabellas", "Soundtracks"], "Bowling Green State University": ["AcousChicks", "Retrograde", "Ten40!", "Tonal Eclipse"], "Washington University in St. Louis": ["After Dark", "The Sensasians", "Reverb"], "University of Dayton": ["Audio Pilots", "The Flying Solos", "Remedy", "Underscore"], "Indiana University": ["The Bloomingtones", "Resting Pitch Face"], "Miami University": ["Just Duet"], "Indiana University Indianapolis": ["On A Side Note"], "Kent State University": ["Vocal Intensity"], "University of Cincinnati": ["Avocalypse", "The Vocaholics"], "Saint Louis University": ["The Bare Naked Statues", "Beyond All Reason", "Decadence", "Astha"], "University of Notre Dame": ["The Echoes"], "University of Missouri": ["Forte", "The Naturelles"], "Missouri University of Science and Technology": ["Miner Key"], "Missouri State University": ["A Cub Bella", "The Beartones", "The Hibernotes"], "Iowa State University": ["Count Me In", "Mezzo Forte"], "University of Kansas": ["Crimson and Blues"], "Murray State University": ["EQ Blu"], "Truman State University": ["Minor Detail"], "Case Western Reserve University": ["Case in Point", "Dhamakapella"], "The Ohio State University": ["Scarlet and Grace Notes", "The Ohio State of Mind", "Buck That!", "Majors & minors", "Sound of Science"], "Baldwin Wallace University": ["S\u014cL", "Cosmos"], "University of Kentucky": ["AcoUstiKats"], "Ohio University": ["Dynamics", "New Chords on the Block", "The Tempo Tantrums"], "The University of Akron": ["Rhythm & Roos"], "SUNY Potsdam": ["A Sharp Arrangement", "The Potsdam Pitches", "The Potsdam Pointercounts", "Stay Tuned"], "University of Massachusetts Amherst": ["Duly Noted", "S#arp Attitude"], "University at Albany": ["Pitch Please"], "Rensselaer Polytechnic Institute": ["The Rusty Pipes"], "SUNY New Paltz": ["The Sexy Pitches"], "University of Vermont": ["Viridescent"], "Emerson College": ["Acappellics"], "Boston University": ["Allegrettos", "Treblemakers"], "Worcester Polytechnic Institute": ["Audiophiles"], "Northeastern University": ["Distilled Harmony", "Treble on Huntington", "The Nor'easters", "The Unisons"], "Boston College": ["Dynamics", "The Bostonians"], "Brown University": ["The Jabberwocks"], "The Colleges of Fenway": ["The Sirens"], "Wesleyan University": ["Triple Major"], "The New School": ["Unjust Intonation"], "Bryant University": ["The Bottom Line"], "Marist University": ["The Enharmonics"], "Bentley University": ["Off The Clock"], "Suffolk University": ["The Ramifications"], "Berklee College of Music": ["Treble Threat", "Upper Structure"], "University of Connecticut": ["A Minor"], "Eastern Connecticut State University": ["East Harmonies"], "Fordham University": ["The F Sharps", "The Fordham Ramblers"], "University of Hartford": ["HartAttack", "L'Shir"], "Hunter College": ["Hawkappella"], "Roger Williams University": ["Hawkward"], "Quinnipiac University": ["The Legends"], "New York University": ["The Vocaholics", "The Cleftomaniacs", "The Mixtapes", "N'Harmonics", "Vocollision"], "Columbia University": ["The Clefhangers"], "Pace University": ["Frequency", "Tonal Recall"], "Hofstra University": ["The Hofbeats", "Makin' Treble", "Sigma'cappella"], "North Carolina State University": ["Acappology", "Chordination", "Grains of Time", "Ladies In Red", "Wolfgang"], "University of Mount Olive": ["Carolina Sound"], "University of South Carolina": ["Cockappella"], "University of Georgia": ["Noteworthy"], "Georgia Institute of Technology": ["Nothin' But Treble"], "High Point University": ["Offbeats"], "University of North Carolina at Chapel Hill": ["Tar Heel Voices"], "University of Florida": ["Accent", "The Sedoctaves", "Tone Definition"], "University of Miami": ["BisCaydence", "Tufaan"], "University of Central Florida": ["Gemini Boulevard", "KeyHarmony", "Mixed Mode"], "Florida International University": ["HEARTbeats"], "University of South Florida": ["Tones of Gold"], "East Tennessee State University": ["Ascension", "Harmonium"], "Belmont University": ["The Belles", "The Beltones", "Intonations", "Prismatics"], "University of Tennessee": ["reVOLution", "VOLT"], "Vanderbilt University": ["Spectrum", "Harmonic Notion"], "Emory University": ["Aural Pleasure", "Dooley Noted"], "University of North Carolina At Greensboro": ["The Chariots"], "Wake Forest University": ["Demon Divas"], "Appalachian State University": ["Ear Candy", "VoiceMale"], "Duke University": ["Rhythm & Blue"], "Florida State University": ["AcaBelles", "All-Night Yahtzee", "Reverb"], "Pearl River Community College": ["Currents", "The Voices"], "East Central Community College": ["EC Listening"], "University of Southern Mississippi": ["Spirit of Southern"], "Mississippi State University": ["TrebullDawgs"], "University of Alabama": ["Tune In"], "University of Texas at Austin": ["Beauties and the Beat", "Noteworthy"], "Texas Tech University": ["Empire"], "University of Houston": ["Final Measure", "Star Struck"], "Texas A&M University": ["HardChord DynaMix"], "University of Texas at Dallas": ["Novis"], "Dallas-Fort Worth": ["Trillium"], "University of Texas at Arlington": ["RISE"], "Baylor University": ["VirtuOSO"], "University of Nebraska": ["The Bathtub Dogs", "Boots & Cats", "Pitch Please", "The Red Keys", "Take Note"], "University of Denver": ["Exit 205"], "University of Colorado Boulder": ["Extreme Measures"], "Colorado State University": ["Mainstreet"], "Oklahoma City University": ["Tonal Eclipse"], "University of California, San Diego": ["Acamazing", "The Daughters of Triton", "Sitaare", "The Trebles", "The Tritones"], "University of California, Irvine": ["Clair de Lune", "Morse Coda", "NOVA", "Vermillion Vocalists", "Aerodynamix", "Haath", "Uniting Voices", "VocaLotus"], "San Diego State University": ["SoundWave"], "University of Arizona": ["Amplified", "Enharmonics", "Meow or Never", "Noteriety"], "Northern Arizona University": ["The Axecidentals", "Elevation", "The Highlanders"], "Grand Canyon University": ["Canyon Crescendos"], "Arizona State University": ["Devil Clefs", "The Pitchforks", "Priority Male", "The TEMPEtations"], "The Claremont Colleges": ["Claremont Shades", "Earth Tones", "Midnight Echo"], "Mt. San Antonio College": ["Nu Aria"], "University of Aberdeen": ["Aberpella", "Killer Quines"], "University of St Andrews": ["The Accidentals", "The Alleycats", "The Hummingbirds"], "University of Cambridge": ["Cadenza"], "University of Edinburgh": ["Cloud IX", "Licence To Trill", "Tone Up"], "University of Stirling": ["Stirling Stellars"], "University of Birmingham": ["AbraCappella", "The Uptone Girls"], "University of Nottingham": ["Aca-Pocalypse", "Firecracappella", "RadioOctave", "Echotones"], "University of Warwick": ["The Leamingtones", "OffScore"], "University of Leeds": ["The Songsmiths"], "University of Sheffield": ["Steelworks"], "University of York": ["VOX"], "University of Bristol": ["Academy", "The Bristol Suspensions", "Pitch Fight"], "University of Bath": ["Aquapella"], "Royal Welsh College of Music and Drama": ["Aurum Voices"], "Cardiff University": ["DeciBelles", "Vox", "The Acappellads"], "University of Exeter": ["The Illuminations", "Sweet Nothings"], "Durham University": ["Northern Lights"], "University of Oxford": ["The Oxford Commas"], "Lancaster University": ["Roselution"], "University of Manchester": ["The Skylarks"], "Newcastle University": ["Tune Army"], "University College London": ["The Eustones"], "London School of Economics": ["The Houghtones"], "Imperial College London": ["The Imperielles", "Nth Harmonic", "The Scopes"], "King's College London": ["Kadence", "The Rolling Tones"], "University of Reading": ["RACA"], "University of Washington": ["Awaaz", "Furmata"], "Gonzaga University": ["Big Bing Theory"], "University of British Columbia": ["Eh? Cappella", "The Northwest Collective"], "University of British Columbia, Okanagan": ["Trebled Acaholics", "The Trill Seekers"], "Western Washington University": ["For Good Measure", "Pacific Note West"], "Oregon State University": ["Divine", "Power Chord"], "Southern Oregon University": ["Dulcet"], "Portland State University": ["The Green Note"], "Willamette University": ["Headband", "Tandem", "Up Top"], "University of Oregon": ["Mind the Gap"], "Montana State University": ["Rhapsody"], "University of Utah": ["Salt Flats"], "University of California, Los Angeles": ["Bruin Harmony", "Naya Zamaana", "ScatterTones", "Awaken", "Pitch, Please!", "Random Voices", "Resonance"], "Chapman University": ["Chapman SoundCheck", "The Dissonants", "The ChapTones", "Simply Vocale"], "California State University, Fullerton": ["The FullerTones"], "Moorpark College": ["MoorHarmony"], "University of California, Santa Barbara": ["Naked Voices"], "University of Southern California": ["Reverse Osmosis"], "California State University, Northridge": ["Acasola", "Vocal Percussion Radio (VPR)"], "University of California, Santa Cruz": ["Cloud 9"], "University of California, Davis": ["The Cleftomaniacs", "Jhankaar", "The Liquid Hotplates", "The Lounge Lizards", "The Spokes"], "UC Berkeley": ["Drawn to Scale", "The Golden Overtones"], "Stanford University": ["The Mendicants"], "Diablo Valley College": ["The pH Scale"], "San Jose State University": ["The Spartones"]};

const STATE_REGION = {
  "New York":"Central","Pennsylvania":"Central",
  "Minnesota":"Great Lakes","Wisconsin":"Great Lakes","Illinois":"Great Lakes","Michigan":"Great Lakes",
  "New Jersey":"Mid-Atlantic","Maryland":"Mid-Atlantic","Delaware":"Mid-Atlantic","Virginia":"Mid-Atlantic","West Virginia":"Mid-Atlantic","District of Columbia":"Mid-Atlantic",
  "Indiana":"Midwest","Ohio":"Midwest","Missouri":"Midwest","Kentucky":"Midwest","Kansas":"Midwest","Iowa":"Midwest","North Dakota":"Midwest","South Dakota":"Midwest",
  "Connecticut":"Northeast","Rhode Island":"Northeast","Massachusetts":"Northeast","Vermont":"Northeast","New Hampshire":"Northeast","Maine":"Northeast",
  "Tennessee":"South","North Carolina":"South","South Carolina":"South","Georgia":"South","Florida":"South","Alabama":"South","Mississippi":"South","Arkansas":"South","Louisiana":"South",
  "Texas":"Southwest","Nebraska":"Southwest","Colorado":"Southwest","Oklahoma":"Southwest","Arizona":"Southwest","New Mexico":"Southwest","Nevada":"Southwest",
  "Washington":"West","Oregon":"West","California":"West","Idaho":"West","Montana":"West","Wyoming":"West","Utah":"West",
};


const ORIG_STATE_REGION = Object.assign({}, STATE_REGION);
const ORIG_SCHOOL_GROUPS = JSON.parse(JSON.stringify(SCHOOL_GROUPS));
const ORIG_SCHOOL_COORDS = JSON.parse(JSON.stringify(SCHOOL_COORDS));
function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
function esc(s) { return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let data = deepClone(REGIONS);
encodeGroups(data);
let unassigned = []; // groups not assigned to any QF (also encoded)
let regionGroups = {}; // {regionName: [encoded groups]} ‚Äî groups assigned to region but not in a QF
let undoStack = [];
let undoLabels = [];
let isDirty = false;
let openRegions = {};
let openQFs = {};
let selectedRegionName = null;
let viewMode = true;
let highlightedQF = null; // QF index for view mode highlighting
let compareMode = false; // Compare with base 2026 data
let interstateMode = false; // Interstate overlay (code present, UI hidden)

// Rebuild STATE_REGION from current data by locating schools in state polygons
function rebuildStateRegions() {
  for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
  if (!usTopoData) return;

  // Build state features once
  const stateFeatures = topojson.feature(usTopoData, usTopoData.objects.states).features;

  // For each school in current data, find its state via point-in-polygon
  // schoolState: { schoolName ‚Üí stateName }
  const schoolState = {};
  for (const [sc, coords] of Object.entries(SCHOOL_COORDS)) {
    if (!coords || coords.length < 2) continue;
    const pt = [coords[1], coords[0]]; // [lng, lat] for d3.geoContains
    for (const feat of stateFeatures) {
      if (d3.geoContains(feat, pt)) {
        schoolState[sc] = feat.properties.name;
        break;
      }
    }
  }

  // Vote: for each state, which region has the most schools in current data?
  const stateVotes = {}; // { stateName: { regionName: count } }
  for (const [rn, rd] of Object.entries(data)) {
    for (const sc of (rd.schools || [])) {
      const st = schoolState[sc];
      if (!st) continue;
      if (!stateVotes[st]) stateVotes[st] = {};
      stateVotes[st][rn] = (stateVotes[st][rn] || 0) + 1;
    }
  }

  // Assign each state to the region with the most schools
  for (const [st, votes] of Object.entries(stateVotes)) {
    let bestRn = null, bestCount = 0;
    for (const [rn, cnt] of Object.entries(votes)) {
      if (cnt > bestCount) { bestCount = cnt; bestRn = rn; }
    }
    if (bestRn) STATE_REGION[st] = bestRn;
  }
}
let currentZoom = null;

// ‚îÄ‚îÄ‚îÄ DIRTY STATE ‚îÄ‚îÄ‚îÄ
window.addEventListener('beforeunload', function(e) {
  if (isDirty) { e.preventDefault(); e.returnValue = ''; }
});
function markDirty() { isDirty = true; updateDirtyIndicator(); }
function markClean() { isDirty = false; updateDirtyIndicator(); }
function updateDirtyIndicator() {
  const el = document.getElementById('dirty-dot');
  if (el) el.style.display = isDirty ? 'inline-block' : 'none';
}

// ‚îÄ‚îÄ‚îÄ UNDO ‚îÄ‚îÄ‚îÄ
function saveUndo(label) {
  undoStack.push({ d: deepClone(data), u: [...unassigned], sr: Object.assign({}, STATE_REGION), rg: JSON.parse(JSON.stringify(regionGroups)) });
  undoLabels.push(label || 'change');
  if (undoStack.length > 40) { undoStack.shift(); undoLabels.shift(); }
  markDirty();
}
function undoAction() {
  if (!undoStack.length) return;
  const label = undoLabels.pop();
  const prev = undoStack.pop();
  data = prev.d; unassigned = prev.u;
  for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
  Object.assign(STATE_REGION, prev.sr);
  regionGroups = prev.rg || {};
  renderEditor(); renderMap();
  // Flash undo label
  const btn = document.getElementById('undo-btn');
  if (btn) {
    btn.textContent = '\u21a9 ' + label;
    btn.style.minWidth = btn.offsetWidth + 'px';
    clearTimeout(btn._timer);
    btn._timer = setTimeout(() => {
      btn.textContent = undoStack.length ? '\u21a9 Undo (' + undoStack.length + ')' : '\u21a9 Undo';
      btn.style.minWidth = '';
    }, 1500);
  }
  if (!undoStack.length) markClean();
}

// ‚îÄ‚îÄ‚îÄ COMPUTED ‚îÄ‚îÄ‚îÄ
function countGroups(r) { return r.quarterfinals.reduce((s, q) => s + q.groups.length, 0); }

function getQFSchools(regionName, qfIdx) {
  if (!regionName || qfIdx == null || !data[regionName]) return null;
  const qf = data[regionName].quarterfinals[qfIdx];
  if (!qf) return null;
  const schools = new Set();
  for (const g of qf.groups) {
    const s = schoolOf(g);
    if (s) schools.add(s);
  }
  return schools;
}
function totalStats() {
  let r=0,g=0,s=0;
  for (const v of Object.values(data)) { r++; s+=v.schools.length; g+=countGroups(v); }
  return {r,g,s};
}

// Find which school a group belongs to
// Group names stored as "GroupName@SchoolName" internally
// Display helpers strip the @suffix
function displayName(g) { const i = g.lastIndexOf('@'); return i > 0 ? g.substring(0, i) : g; }
function schoolOf(g) { const i = g.lastIndexOf('@'); return i > 0 ? g.substring(i + 1) : null; }

// Encode all groups at init using QF_SCHOOLS as authoritative school mapping
function encodeGroups(regionData) {
  // Build group->school from QF_SCHOOLS: "RegionName-qfIdx" -> [schools]
  // For each QF, we know exactly which schools are in it
  const qfSchoolMap = {}; // "regionName|qfIdx" -> Set of schools
  for (const [key, schools] of Object.entries(QF_SCHOOLS)) {
    qfSchoolMap[key] = new Set(schools);
  }

  // Build global reverse map: groupName -> [school1, school2, ...]
  const groupToSchools = {};
  for (const [school, groups] of Object.entries(SCHOOL_GROUPS)) {
    for (const g of groups) {
      if (!groupToSchools[g]) groupToSchools[g] = [];
      groupToSchools[g].push(school);
    }
  }

  for (const [rn, rd] of Object.entries(regionData)) {
    rd.quarterfinals.forEach((qf, qi) => {
      // Get authoritative school list for this QF
      const qfKey = rn + '-' + qi;
      const authSchools = qfSchoolMap[qfKey];

      qf.groups = qf.groups.map(g => {
        if (g.includes('@')) return g;
        const candidates = groupToSchools[g];
        if (!candidates || !candidates.length) return g;
        if (candidates.length === 1) return g + '@' + candidates[0];
        // Use authoritative QF_SCHOOLS to disambiguate
        if (authSchools) {
          const inAuth = candidates.find(s => authSchools.has(s));
          if (inAuth) return g + '@' + inAuth;
        }
        return g + '@' + candidates[0];
      });
    });
  }
}

// Legacy wrapper for pool/no-context
function findSchoolForGroup(groupName) {
  // If already encoded
  const s = schoolOf(groupName);
  if (s) return s;
  for (const [school, groups] of Object.entries(SCHOOL_GROUPS)) {
    if (groups.includes(groupName)) return school;
  }
  return null;
}

// Get groups for a school from current data (not static 2026 SCHOOL_GROUPS)
function activeGroupsForSchool(school) {
  const groups = [];
  for (const rd of Object.values(data)) {
    for (const qf of rd.quarterfinals) {
      for (const g of qf.groups) {
        if (schoolOf(g) === school) groups.push(displayName(g));
      }
    }
  }
  for (const rgs of Object.values(regionGroups)) {
    for (const g of rgs) {
      if (schoolOf(g) === school) groups.push(displayName(g));
    }
  }
  for (const g of unassigned) {
    if (schoolOf(g) === school) groups.push(displayName(g));
  }
  return groups;
}

// Rebuild schools list from QF group assignments
function rebuildSchools(regionName) {
  const region = data[regionName];
  const schoolSet = new Set();
  region.quarterfinals.forEach((qf, qi) => {
    for (const group of qf.groups) {
      const school = schoolOf(group) || findSchoolForGroup(displayName(group));
      if (school) schoolSet.add(school);
    }
  });
  // Also include schools from regionGroups
  for (const group of (regionGroups[regionName] || [])) {
    const school = schoolOf(group) || findSchoolForGroup(displayName(group));
    if (school) schoolSet.add(school);
  }
  region.schools = Array.from(schoolSet).sort();
}

// ‚îÄ‚îÄ‚îÄ REGION OPS ‚îÄ‚îÄ‚îÄ
function addRegion() {
  showModal('New Region', `
    <div class="modal-label">Region Name</div>
    <input class="modal-input" id="m-name" placeholder="e.g. Pacific Northwest" autofocus>
    <div class="modal-label">Color</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="color" class="color-picker" id="m-color" value="#6C8EBF">
      <span style="font-size:11px;color:#888" id="m-color-lbl">#6C8EBF</span>
    </div>
  `, () => {
    const name = document.getElementById('m-name').value.trim();
    const color = document.getElementById('m-color').value;
    if (!name) return;
    saveUndo('add region');
    data[name] = { color, accent: color, schools: [], quarterfinals: [], semifinal:{date:"",location:"",lat:null,lng:null} };
    openRegions[name] = true;
    renderEditor(); renderMap();
  });
  document.getElementById('m-color').oninput = function() { document.getElementById('m-color-lbl').textContent = this.value; };
}

function renameRegion(oldName) {
  showModal('Rename Region', `
    <div class="modal-label">New Name</div>
    <input class="modal-input" id="m-name" value="${esc(oldName)}" autofocus>
  `, () => {
    const nn = document.getElementById('m-name').value.trim();
    if (!nn || nn === oldName) return;
    if (data[nn]) { alert('Region name already exists.'); return; }
    saveUndo('rename region');
    // Preserve all data including color
    data[nn] = data[oldName];
    delete data[oldName];
    if (openRegions[oldName]) { openRegions[nn] = true; delete openRegions[oldName]; }
    if (selectedRegionName === oldName) selectedRegionName = nn;
    // Update STATE_REGION references
    for (const [st, rn] of Object.entries(STATE_REGION)) {
      if (rn === oldName) STATE_REGION[st] = nn;
    }
    renderEditor(); renderMap();
  });
}

function editRegionColor(name) {
  const current = data[name].color;
  const paletteHtml = REGION_PALETTE.map(c =>
    `<div onclick="document.getElementById('m-color').value='${c}';this.parentElement.querySelectorAll('div').forEach(d=>d.style.outline='');this.style.outline='2px solid #fff'" style="width:28px;height:28px;border-radius:6px;background:${c};cursor:pointer;${c===current?'outline:2px solid #fff':'outline:1px solid rgba(255,255,255,0.15)'}"></div>`
  ).join('');
  showModal('Edit Region Color', `
    <div class="modal-label">Region: ${esc(name)}</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0">${paletteHtml}</div>
    <div style="display:flex;gap:12px;align-items:center;margin:12px 0">
      <div>
        <div class="modal-label" style="font-size:10px">Custom</div>
        <input type="color" id="m-color" value="${current}" style="width:50px;height:30px;border:none;background:none;cursor:pointer">
      </div>
    </div>
  `, () => {
    saveUndo('recolor region');
    data[name].color = document.getElementById('m-color').value;
    renderEditor(); renderMap();
  });
}

function deleteRegion(name) {
  const gc = countGroups(data[name]);
  const msg = gc ? `Delete "${name}"? Its ${gc} groups will move to the unassigned pool.` : `Delete "${name}"?`;
  customConfirm(msg, () => {
    saveUndo('edit QF');
    for (const qf of data[name].quarterfinals) { unassigned.push(...qf.groups); }
    delete data[name];
    for (const [st, rn] of Object.entries(STATE_REGION)) { if (rn === name) delete STATE_REGION[st]; }
    if (selectedRegionName === name) selectedRegionName = null;
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ QF OPS ‚îÄ‚îÄ‚îÄ
function assignStateRegion(stateName) {
  const current = STATE_REGION[stateName] || '';
  const opts = ['<option value="">‚Äî None ‚Äî</option>'].concat(
    Object.keys(data).map(rn => `<option value="${esc(rn)}"${rn===current?' selected':''}>${rn}</option>`)
  ).join('');
  showModal(`Assign State: ${stateName}`, `
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${opts}</select>
    <div style="font-size:10px;color:#555;margin-top:-8px">Currently: ${current || 'unassigned'}</div>
  `, () => {
    const rn = document.getElementById('m-region').value;
    saveUndo('assign state');
    if (rn) { STATE_REGION[stateName] = rn; }
    else { delete STATE_REGION[stateName]; }
    renderMap();
  });
}

// Wire up location autocomplete on m-loc input to fill m-lat/m-lng from SCHOOL_COORDS
function wireLocationAutocomplete() {
  const locInput = document.getElementById('m-loc');
  const latInput = document.getElementById('m-lat');
  const lngInput = document.getElementById('m-lng');
  if (!locInput) return;
  // Build searchable list: all schools + existing QF venues
  const items = [];
  for (const [school, coords] of Object.entries(SCHOOL_COORDS)) {
    items.push({name: school, lat: coords[0], lng: coords[1], type: 'school'});
  }
  for (const rd of Object.values(data)) {
    for (const qf of rd.quarterfinals) {
      if (qf.location && qf.lat) {
        if (!items.find(i => i.name === qf.location)) {
          items.push({name: qf.location, lat: qf.lat, lng: qf.lng, type: 'venue'});
        }
      }
    }
  }

  let dropdown = null, activeIdx = -1;
  function removeDropdown() { if (dropdown) { dropdown.remove(); dropdown = null; } activeIdx = -1; }
  function showResults(query) {
    removeDropdown();
    if (!query || query.length < 2) return;
    const q = query.toLowerCase();
    const matches = items.filter(i => i.name.toLowerCase().includes(q)).slice(0, 8);
    if (!matches.length) return;
    dropdown = document.createElement('div');
    dropdown.className = 'loc-autocomplete';
    const rect = locInput.getBoundingClientRect();
    const parent = locInput.parentElement;
    parent.style.position = 'relative';
    dropdown.style.top = (locInput.offsetTop + locInput.offsetHeight) + 'px';
    dropdown.style.left = locInput.offsetLeft + 'px';
    matches.forEach((m, i) => {
      const div = document.createElement('div');
      div.className = 'loc-autocomplete-item';
      div.innerHTML = m.name + `<small>${m.lat.toFixed(1)}, ${m.lng.toFixed(1)}</small>`;
      div.addEventListener('mousedown', (e) => {
        e.preventDefault();
        locInput.value = m.name;
        if (latInput) latInput.value = m.lat.toFixed(2);
        if (lngInput) lngInput.value = m.lng.toFixed(2);
        removeDropdown();
      });
      dropdown.appendChild(div);
    });
    parent.appendChild(dropdown);
  }

  locInput.addEventListener('input', () => showResults(locInput.value));
  locInput.addEventListener('blur', () => setTimeout(removeDropdown, 150));
  locInput.addEventListener('keydown', (e) => {
    if (!dropdown) return;
    const items = dropdown.querySelectorAll('.loc-autocomplete-item');
    if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx + 1, items.length - 1); items.forEach((it,i) => it.classList.toggle('active', i === activeIdx)); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx - 1, 0); items.forEach((it,i) => it.classList.toggle('active', i === activeIdx)); }
    else if (e.key === 'Enter' && activeIdx >= 0) { e.preventDefault(); e.stopPropagation(); items[activeIdx].dispatchEvent(new MouseEvent('mousedown')); }
    else if (e.key === 'Escape') { removeDropdown(); }
  });
}

function addQF() {
  if (!Object.keys(data).length) { alert('Create a region first.'); return; }
  const opts = Object.keys(data).map(n => `<option value="${esc(n)}"${selectedRegionName===n?' selected':''}>${n}</option>`).join('');
  showModal('Add Quarterfinal', `
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${opts}</select>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-loc" placeholder="e.g. University of Rochester">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" placeholder="Feb 14"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" placeholder="43.13"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" placeholder="-77.63"></div>
    </div>
    <div id="m-autofill-hint" style="font-size:10px;color:#555;margin-top:4px"></div>
  `, () => {
    const rn = document.getElementById('m-region').value;
    saveUndo('change');
    data[rn].quarterfinals.push({
      date: document.getElementById('m-date').value.trim(),
      location: document.getElementById('m-loc').value.trim(),
      lat: parseFloat(document.getElementById('m-lat').value) || null,
      lng: parseFloat(document.getElementById('m-lng').value) || null,
      groups: []
    });
    openRegions[rn] = true;
    renderEditor(); renderMap();
  });
  // Wire up autofill on region change
  setTimeout(() => {
    const sel = document.getElementById('m-region');
    function autofillFromRegion() {
      const rn = sel.value;
      const center = regionCentroid(rn);
      if (center) {
        document.getElementById('m-lat').placeholder = center.lat.toFixed(2);
        document.getElementById('m-lng').placeholder = center.lng.toFixed(2);
        if (!document.getElementById('m-lat').value) document.getElementById('m-lat').value = center.lat.toFixed(2);
        if (!document.getElementById('m-lng').value) document.getElementById('m-lng').value = center.lng.toFixed(2);
        if (center.nearestSchool && !document.getElementById('m-loc').value) {
          document.getElementById('m-loc').value = center.nearestSchool;
        }
        document.getElementById('m-autofill-hint').textContent = 'Auto-filled from region centroid' + (center.nearestSchool ? ' (nearest: ' + center.nearestSchool + ')' : '');
      }
    }
    sel.addEventListener('change', () => {
      document.getElementById('m-lat').value = '';
      document.getElementById('m-lng').value = '';
      document.getElementById('m-loc').value = '';
      autofillFromRegion();
    });
    autofillFromRegion();
    wireLocationAutocomplete();
  }, 50);
}

function regionCentroid(regionName) {
  const rd = data[regionName];
  if (!rd) return null;
  const coords = [];
  for (const school of (rd.schools || [])) {
    const c = SCHOOL_COORDS[school];
    if (c) coords.push({lat: c[0], lng: c[1], name: school});
  }
  if (!coords.length) return null;
  const avgLat = coords.reduce((s,c) => s + c.lat, 0) / coords.length;
  const avgLng = coords.reduce((s,c) => s + c.lng, 0) / coords.length;
  // Find nearest school to centroid
  let nearest = null, nearestCoord = null, minDist = Infinity;
  for (const c of coords) {
    const d = Math.hypot(c.lat - avgLat, c.lng - avgLng);
    if (d < minDist) { minDist = d; nearest = c.name; nearestCoord = c; }
  }
  return {lat: nearestCoord.lat, lng: nearestCoord.lng, nearestSchool: nearest};
}

function editQF(regionName, qfIdx) {
  const qf = data[regionName].quarterfinals[qfIdx];
  const allRegions = Object.keys(data).map(n => `<option value="${esc(n)}"${n===regionName?' selected':''}>${n}</option>`).join('');
  showModal(`Edit QF${qfIdx+1} ‚Äî ${esc(regionName)}`, `
    <div class="modal-label">Assigned Region</div>
    <select class="modal-input" id="m-region">${allRegions}</select>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-loc" value="${esc(qf.location)}">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" value="${esc(qf.date)}"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" value="${qf.lat||''}"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" value="${qf.lng||''}"></div>
    </div>
  `, () => {
    const newRegion = document.getElementById('m-region').value;
    saveUndo('edit QF');
    qf.location = document.getElementById('m-loc').value.trim();
    qf.date = document.getElementById('m-date').value.trim();
    qf.lat = parseFloat(document.getElementById('m-lat').value) || null;
    qf.lng = parseFloat(document.getElementById('m-lng').value) || null;
    // Move QF to new region if changed
    if (newRegion !== regionName) {
      data[regionName].quarterfinals.splice(qfIdx, 1);
      data[newRegion].quarterfinals.push(qf);
      rebuildSchools(regionName);
      rebuildSchools(newRegion);
      openRegions[newRegion] = true;
    }
    renderEditor(); renderMap();
  });
  setTimeout(wireLocationAutocomplete, 50);
}

function deleteQF(rn, idx) {
  const qf = data[rn].quarterfinals[idx];
  const msg = qf.groups.length ? `Delete QF at "${qf.location}"? Its ${qf.groups.length} groups will move to ${rn} ungrouped.` : `Delete QF at "${qf.location}"?`;
  customConfirm(msg, () => {
    saveUndo('edit QF');
    if (!regionGroups[rn]) regionGroups[rn] = [];
    regionGroups[rn].push(...qf.groups);
    data[rn].quarterfinals.splice(idx, 1);
    rebuildSchools(rn);
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ GROUP OPS ‚îÄ‚îÄ‚îÄ
function addGroup() {
  const opts = buildAssignSelect('__pool__');
  const schoolNames = Object.keys(SCHOOL_COORDS).sort();
  const datalist = schoolNames.map(s => `<option value="${esc(s)}">`).join('');

  showModal('Add Group', `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" placeholder="e.g. Midnight Ramblers" autofocus>
    <div class="modal-label">School (for map coordinates)</div>
    <input class="modal-input" id="m-school" list="school-list" placeholder="Start typing school name...">
    <datalist id="school-list">${datalist}</datalist>
    <div class="modal-label">Assign to</div>
    <select class="modal-input" id="m-target">${opts}</select>
    <div style="font-size:10px;color:#555;margin-top:-8px">
      If the school isn't in the list, add coordinates below:
    </div>
    <div class="modal-row" style="margin-top:8px">
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" placeholder="43.13"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" placeholder="-77.63"></div>
    </div>
  `, () => {
    const groupName = document.getElementById('m-group').value.trim();
    const schoolName = document.getElementById('m-school').value.trim();
    const target = document.getElementById('m-target').value;
    const lat = parseFloat(document.getElementById('m-lat').value);
    const lng = parseFloat(document.getElementById('m-lng').value);
    if (!groupName) return;
    saveUndo('add group');
    // Register school/group mapping if provided
    if (schoolName) {
      if (!SCHOOL_GROUPS[schoolName]) SCHOOL_GROUPS[schoolName] = [];
      if (!SCHOOL_GROUPS[schoolName].includes(groupName)) SCHOOL_GROUPS[schoolName].push(groupName);
      if (!SCHOOL_COORDS[schoolName] && !isNaN(lat) && !isNaN(lng)) {
        SCHOOL_COORDS[schoolName] = [lat, lng];
      }
    } else if (!isNaN(lat) && !isNaN(lng)) {
      const pseudoSchool = groupName + " (school)";
      SCHOOL_COORDS[pseudoSchool] = [lat, lng];
      SCHOOL_GROUPS[pseudoSchool] = [groupName];
    }
    // Assign to pool or QF (encode with @school)
    const encoded = schoolName ? groupName + '@' + schoolName : groupName;
    if (target === '__pool__') {
      unassigned.push(encoded);
    } else {
      const [rn, qi] = target.split('|');
      data[rn].quarterfinals[parseInt(qi)].groups.push(encoded);
      rebuildSchools(rn);
    }
    renderEditor(); renderMap();
  });
}

function editGroup(regionName, qfIdx, groupName) {
  const school = schoolOf(groupName) || findSchoolForGroup(displayName(groupName));
  const dn = displayName(groupName);
  const coords = school ? SCHOOL_COORDS[school] : null;
  const opts = buildAssignSelect(regionName + '|' + qfIdx);
  showModal(`Edit Group`, `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" value="${esc(dn)}">
    <div class="modal-label">School</div>
    <input class="modal-input" id="m-school" value="${esc(school||'')}" list="school-list-edit">
    <datalist id="school-list-edit">${Object.keys(SCHOOL_COORDS).sort().map(s=>`<option value="${esc(s)}">`).join('')}</datalist>
    <div class="modal-label">Assigned to</div>
    <select class="modal-input" id="m-target">${opts}</select>
    ${coords ? `<div style="font-size:10px;color:#666;margin-top:-8px">üìç ${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}</div>` : '<div style="font-size:10px;color:#ff6b6b;margin-top:-8px">‚ö† No coordinates ‚Äî school not on map</div>'}
  `, () => {
    const newName = document.getElementById('m-group').value.trim();
    const newSchool = document.getElementById('m-school').value.trim();
    const target = document.getElementById('m-target').value;
    if (!newName) return;
    saveUndo('add group');

    // Remove from old location (uses full encoded string)
    const oldGroups = data[regionName].quarterfinals[qfIdx].groups;
    const idx = oldGroups.indexOf(groupName);
    if (idx !== -1) oldGroups.splice(idx, 1);

    // Update SCHOOL_GROUPS
    const finalSchool = newSchool || school || '';
    if (newName !== dn && school) {
      const gs = SCHOOL_GROUPS[school];
      if (gs) { const gi = gs.indexOf(dn); if (gi !== -1) gs[gi] = newName; }
    }
    if (finalSchool && finalSchool !== school) {
      if (school && SCHOOL_GROUPS[school]) {
        const gi = SCHOOL_GROUPS[school].indexOf(newName !== dn ? newName : dn);
        if (gi !== -1) SCHOOL_GROUPS[school].splice(gi, 1);
      }
      if (!SCHOOL_GROUPS[finalSchool]) SCHOOL_GROUPS[finalSchool] = [];
      if (!SCHOOL_GROUPS[finalSchool].includes(newName)) SCHOOL_GROUPS[finalSchool].push(newName);
    }

    // Build encoded name and assign
    const encoded = finalSchool ? newName + '@' + finalSchool : newName;
    if (target === '__pool__') {
      unassigned.push(encoded);
    } else {
      const [newRn, newQi] = target.split('|');
      data[newRn].quarterfinals[parseInt(newQi)].groups.push(encoded);
      rebuildSchools(newRn);
    }

    rebuildSchools(regionName);
    renderEditor(); renderMap();
  });
}

// Edit a pool group (similar but source is pool)
function editPoolGroup(groupName) {
  const school = schoolOf(groupName) || findSchoolForGroup(displayName(groupName));
  const dn = displayName(groupName);
  const coords = school ? SCHOOL_COORDS[school] : null;
  const opts = buildAssignSelect('__pool__');
  showModal(`Edit Group`, `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" value="${esc(dn)}">
    <div class="modal-label">School</div>
    <input class="modal-input" id="m-school" value="${esc(school||'')}" list="school-list-edit2">
    <datalist id="school-list-edit2">${Object.keys(SCHOOL_COORDS).sort().map(s=>`<option value="${esc(s)}">`).join('')}</datalist>
    <div class="modal-label">Assign to</div>
    <select class="modal-input" id="m-target">${opts}</select>
    ${coords ? `<div style="font-size:10px;color:#666;margin-top:-8px">üìç ${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}</div>` : '<div style="font-size:10px;color:#ff6b6b;margin-top:-8px">‚ö† No coordinates ‚Äî school not on map</div>'}
  `, () => {
    const newName = document.getElementById('m-group').value.trim();
    const newSchool = document.getElementById('m-school').value.trim();
    const target = document.getElementById('m-target').value;
    if (!newName) return;
    saveUndo('add group');

    const idx = unassigned.indexOf(groupName);
    if (idx !== -1) unassigned.splice(idx, 1);

    const finalSchool = newSchool || school || '';
    if (newName !== dn && school) {
      const gs = SCHOOL_GROUPS[school];
      if (gs) { const gi = gs.indexOf(dn); if (gi !== -1) gs[gi] = newName; }
    }
    if (finalSchool && finalSchool !== school) {
      if (school && SCHOOL_GROUPS[school]) {
        const gi = SCHOOL_GROUPS[school].indexOf(newName !== dn ? newName : dn);
        if (gi !== -1) SCHOOL_GROUPS[school].splice(gi, 1);
      }
      if (!SCHOOL_GROUPS[finalSchool]) SCHOOL_GROUPS[finalSchool] = [];
      if (!SCHOOL_GROUPS[finalSchool].includes(newName)) SCHOOL_GROUPS[finalSchool].push(newName);
    }

    const encoded = finalSchool ? newName + '@' + finalSchool : newName;
    if (target === '__pool__') {
      unassigned.push(encoded);
    } else {
      const [newRn, newQi] = target.split('|');
      data[newRn].quarterfinals[parseInt(newQi)].groups.push(encoded);
      rebuildSchools(newRn);
    }
    renderEditor(); renderMap();
  });
}

function removeGroupFromAll(g) {
  const dn = displayName(g), sc = schoolOf(g);
  // Remove from unassigned pool
  for (let i = unassigned.length - 1; i >= 0; i--) {
    if (displayName(unassigned[i]) === dn && (schoolOf(unassigned[i]) === sc || !schoolOf(unassigned[i]))) unassigned.splice(i, 1);
  }
  // Remove from all QFs
  for (const rd of Object.values(data)) {
    for (const qf of rd.quarterfinals) {
      for (let i = qf.groups.length - 1; i >= 0; i--) {
        if (displayName(qf.groups[i]) === dn && (schoolOf(qf.groups[i]) === sc || !schoolOf(qf.groups[i]))) qf.groups.splice(i, 1);
      }
    }
  }
  // Remove from all regionGroups
  for (const rgs of Object.values(regionGroups)) {
    for (let i = rgs.length - 1; i >= 0; i--) {
      if (displayName(rgs[i]) === dn && (schoolOf(rgs[i]) === sc || !schoolOf(rgs[i]))) rgs.splice(i, 1);
    }
  }
}

function removeGroup(rn, qi, g) {
  saveUndo('remove group');
  removeGroupFromAll(g);
  if (!regionGroups[rn]) regionGroups[rn] = [];
  regionGroups[rn].push(g);
  rebuildSchools(rn);
  renderEditor(); renderMap();
}

function deletePoolGroup(g) {
  saveUndo('delete group');
  const idx = unassigned.indexOf(g);
  if (idx !== -1) unassigned.splice(idx, 1);
  renderEditor();
}

// ‚îÄ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ
let dragData = null;
let dragType = 'group'; // 'group' or 'qf'

function onDragStart(e, rn, qi, g) {
  dragData = {rn, qi, g}; dragType = 'group';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', g);
}
function onDragStartPool(e, g) {
  dragData = {rn: '__pool__', qi: -1, g}; dragType = 'group';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', g);
}
function onDragStartQF(e, rn, qi) {
  dragData = {rn, qi}; dragType = 'qf';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', 'qf:' + rn + ':' + qi);
}
function onDragStartRegionGroup(e, rn, gi) {
  const g = regionGroups[rn][gi];
  dragData = {rn, gi, g, source: 'region'}; dragType = 'group';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', 'rg:' + rn + ':' + gi);
}
function onDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}
function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect='move'; e.currentTarget.classList.add('drag-over'); }
function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function onDragOverRegion(e) {
  if (dragType === 'qf' || dragType === 'group') {
    e.preventDefault(); e.dataTransfer.dropEffect='move'; e.currentTarget.classList.add('drag-over');
  }
}
function onDropToQF(e, targetRn, targetQi) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if (!dragData || dragType !== 'group') return;
  saveUndo('move group');
  // Remove from source
  if (dragData.source === 'region') {
    const idx = regionGroups[dragData.rn].indexOf(dragData.g);
    if (idx !== -1) regionGroups[dragData.rn].splice(idx, 1);
  } else if (dragData.rn === '__pool__') {
    const idx = unassigned.indexOf(dragData.g);
    if (idx !== -1) unassigned.splice(idx, 1);
  } else {
    if (dragData.rn === targetRn && dragData.qi === targetQi) return;
    const src = data[dragData.rn].quarterfinals[dragData.qi].groups;
    const idx = src.indexOf(dragData.g);
    if (idx !== -1) src.splice(idx, 1);
    rebuildSchools(dragData.rn);
  }
  // Add to target QF
  data[targetRn].quarterfinals[targetQi].groups.push(dragData.g);
  rebuildSchools(targetRn);
  dragData = null;
  renderEditor(); renderMap();
}
function onDropToPool(e) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if (!dragData) return;
  if (dragType === 'qf') {
    // Dissolve QF: move all its groups to region ungrouped
    saveUndo('dissolve QF');
    const qf = data[dragData.rn].quarterfinals[dragData.qi];
    if (!regionGroups[dragData.rn]) regionGroups[dragData.rn] = [];
    regionGroups[dragData.rn].push(...qf.groups);
    data[dragData.rn].quarterfinals.splice(dragData.qi, 1);
    rebuildSchools(dragData.rn);
    dragData = null;
    renderEditor(); renderMap();
  } else if (dragType === 'group') {
    if (dragData.rn === '__pool__' && !dragData.source) return;
    saveUndo('drag & drop');
    if (dragData.source === 'region') {
      const idx = regionGroups[dragData.rn].indexOf(dragData.g);
      if (idx !== -1) regionGroups[dragData.rn].splice(idx, 1);
    } else {
      const src = data[dragData.rn].quarterfinals[dragData.qi].groups;
      const idx = src.indexOf(dragData.g);
      if (idx !== -1) src.splice(idx, 1);
      rebuildSchools(dragData.rn);
    }
    unassigned.push(dragData.g);
    dragData = null;
    renderEditor(); renderMap();
  }
}
function onDropToRegion(e, targetRn) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if (!dragData) return;
  if (dragType === 'qf') {
    // Move entire QF to target region
    if (dragData.rn === targetRn) return;
    saveUndo('drag & drop');
    const qf = data[dragData.rn].quarterfinals.splice(dragData.qi, 1)[0];
    data[targetRn].quarterfinals.push(qf);
    rebuildSchools(dragData.rn);
    rebuildSchools(targetRn);
    openRegions[targetRn] = true;
    dragData = null;
    renderEditor(); renderMap();
  } else if (dragType === 'group') {
    // Drop group into region's ungrouped list
    saveUndo('move to region');
    if (dragData.source === 'region') {
      if (dragData.rn === targetRn) return;
      const idx = regionGroups[dragData.rn].indexOf(dragData.g);
      if (idx !== -1) regionGroups[dragData.rn].splice(idx, 1);
    } else if (dragData.rn === '__pool__') {
      const idx = unassigned.indexOf(dragData.g);
      if (idx !== -1) unassigned.splice(idx, 1);
    } else {
      const src = data[dragData.rn].quarterfinals[dragData.qi].groups;
      const idx = src.indexOf(dragData.g);
      if (idx !== -1) src.splice(idx, 1);
      rebuildSchools(dragData.rn);
    }
    if (!regionGroups[targetRn]) regionGroups[targetRn] = [];
    regionGroups[targetRn].push(dragData.g);
    openRegions[targetRn] = true;
    rebuildSchools(targetRn);
    dragData = null;
    renderEditor(); renderMap();
  }
}

// ‚îÄ‚îÄ‚îÄ ASSIGN TARGET BUILDER ‚îÄ‚îÄ‚îÄ
function buildAssignSelect(currentTarget) {
  let h = '<optgroup label="Unassigned"><option value="__pool__"';
  if (currentTarget === '__pool__') h += ' selected';
  h += '>‚Äî Unassigned Pool ‚Äî</option></optgroup>';
  for (const [rn, rd] of Object.entries(data)) {
    h += `<optgroup label="${rn}">`;
    if (rd.quarterfinals.length > 0) {
      rd.quarterfinals.forEach((qf, i) => {
        const val = rn + '|' + i;
        const sel = currentTarget === val ? ' selected' : '';
        h += `<option value="${esc(val)}"${sel}>QF${i+1} ‚Äî ${qf.location||'(no location)'}</option>`;
      });
    } else {
      h += `<option value="${esc(rn)}|new">+ Create new QF</option>`;
    }
    h += '</optgroup>';
  }
  return h;
}

// ‚îÄ‚îÄ‚îÄ SCHOOL MODAL (from map click) ‚îÄ‚îÄ‚îÄ
function showSchoolModal(school) {
  const coords = SCHOOL_COORDS[school];
  const allGroups = activeGroupsForSchool(school);
  // Fallback to SCHOOL_GROUPS if no active groups found (shouldn't happen normally)
  if (!allGroups.length) { const sg = SCHOOL_GROUPS[school]; if (sg) allGroups.push(...sg); }

  function findGroupLocation(groupName) {
    // Check QFs
    for (const [rn, rd] of Object.entries(data)) {
      for (let i = 0; i < rd.quarterfinals.length; i++) {
        if (rd.quarterfinals[i].groups.some(g => displayName(g) === groupName && schoolOf(g) === school)) {
          return { rn, qi: i, type: 'qf' };
        }
      }
    }
    // Check regionGroups
    for (const [rn, rgs] of Object.entries(regionGroups)) {
      if (rgs.some(g => displayName(g) === groupName && schoolOf(g) === school)) {
        return { rn, qi: -1, type: 'region' };
      }
    }
    // Fallback: QF match without school check
    for (const [rn, rd] of Object.entries(data)) {
      for (let i = 0; i < rd.quarterfinals.length; i++) {
        if (rd.quarterfinals[i].groups.some(g => displayName(g) === groupName)) return { rn, qi: i, type: 'qf' };
      }
    }
    if (unassigned.some(u => displayName(u) === groupName && (schoolOf(u) === school || !schoolOf(u)))) return { rn: '__pool__', qi: -1, type: 'pool' };
    return null;
  }

  let groupRows = '';
  allGroups.forEach(g => {
    const loc = findGroupLocation(g);
    let locLabel = '<span style="color:#ff6b6b">Not placed</span>';
    let curTarget = '__pool__';
    if (loc) {
      if (loc.type === 'pool') {
        locLabel = '<span style="color:#888">Unassigned</span>';
      } else if (loc.type === 'region') {
        locLabel = `<span style="color:${data[loc.rn].color}">${loc.rn}</span> ‚Ä∫ Ungrouped`;
        curTarget = loc.rn + '|0';
      } else {
        locLabel = `<span style="color:${data[loc.rn].color}">${loc.rn}</span> ‚Ä∫ QF${loc.qi+1}`;
        curTarget = loc.rn + '|' + loc.qi;
      }
    }
    groupRows += `
      <div style="margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <span style="font-weight:600;font-size:13px">${g}</span>
          <span style="font-size:10px">${locLabel}</span>
        </div>
        <select class="modal-input group-assign-select" data-group="${esc(g)}" style="margin-bottom:0">
          ${buildAssignSelect(curTarget)}
        </select>
      </div>`;
  });

  const coordsInfo = coords ? `üìç ${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}` : '‚ö† No coordinates';

  showModal(school, `
    <div style="font-size:10px;color:#666;margin:-8px 0 12px">${coordsInfo}</div>
    <div class="modal-label">Groups (${allGroups.length})</div>
    <div style="max-height:300px;overflow-y:auto">
      ${groupRows || '<div style="font-size:12px;color:#555;padding:8px">No groups registered</div>'}
    </div>
  `, () => {
    const selects = document.querySelectorAll('.group-assign-select');
    saveUndo('add group');
    selects.forEach(sel => {
      const group = sel.dataset.group; // raw group name from SCHOOL_GROUPS
      const target = sel.value;
      const encoded = group + '@' + school; // we know the school context
      // Remove from everywhere
      removeGroupFromAll(encoded);
      // Assign
      if (target === '__pool__') {
        unassigned.push(encoded);
      } else {
        const [rn, qi] = target.split('|');
        if (qi === 'new') {
          data[rn].quarterfinals.push({date:'',location:'',lat:null,lng:null,groups:[encoded]});
        } else {
          data[rn].quarterfinals[parseInt(qi)].groups.push(encoded);
        }
      }
    });
    for (const rn of Object.keys(data)) rebuildSchools(rn);
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ QF DETAIL MODAL (from map diamond click) ‚îÄ‚îÄ‚îÄ
function showQFDetailModal(regionName, qfIdx) {
  const qf = data[regionName].quarterfinals[qfIdx];
  const rd = data[regionName];

  let groupList = '';
  qf.groups.forEach(g => {
    const school = schoolOf(g);
    const gd = displayName(g);
    groupList += `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.04)">
        <div>
          <span style="font-weight:500" data-group-tip="${esc(gd)}" data-group-ctx="${esc(regionName)}|${qfIdx}">${gd}</span>
          ${school ? `<span style="font-size:10px;color:#666;margin-left:6px">${school}</span>` : ''}
        </div>
        <button class="region-action-btn del" onclick="event.stopPropagation();removeGroupFromQFModal('${esc(regionName)}',${qfIdx},'${esc(g)}')" title="Unassign to pool">‚úï</button>
      </div>`;
  });

  const allRegions = Object.keys(data).map(rn =>
    `<option value="${esc(rn)}"${rn===regionName?' selected':''}>${rn}</option>`
  ).join('');

  showModal(`QF${qfIdx+1} ‚Äî ${qf.location || 'No location'}`, `
    <div style="display:flex;gap:8px;font-size:10px;color:#666;margin:-8px 0 12px">
      <span style="color:${rd.color}">‚óè ${regionName}</span>
      ${qf.date ? `<span>üìÖ ${qf.date}</span>` : ''}
      ${qf.lat ? `<span>üìç ${qf.lat.toFixed(2)}, ${qf.lng.toFixed(2)}</span>` : ''}
    </div>
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Location</div><input class="modal-input" id="m-loc" value="${esc(qf.location)}"></div>
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" value="${esc(qf.date)}"></div>
    </div>
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${allRegions}</select>
    <div class="modal-label">Groups (${qf.groups.length})</div>
    <div style="max-height:200px;overflow-y:auto;background:rgba(255,255,255,0.02);border-radius:6px;border:1px solid rgba(255,255,255,0.06);margin-bottom:4px">
      ${groupList || '<div style="font-size:11px;color:#555;padding:10px">No groups assigned</div>'}
    </div>
  `, () => {
    const newRegion = document.getElementById('m-region').value;
    saveUndo('edit QF');
    qf.location = document.getElementById('m-loc').value.trim();
    qf.date = document.getElementById('m-date').value.trim();
    if (newRegion !== regionName) {
      data[regionName].quarterfinals.splice(qfIdx, 1);
      data[newRegion].quarterfinals.push(qf);
      rebuildSchools(regionName);
      rebuildSchools(newRegion);
      openRegions[newRegion] = true;
    }
    renderEditor(); renderMap();
  });
}

function removeGroupFromQFModal(rn, qi, g) {
  saveUndo('edit QF');
  removeGroupFromAll(g);
  if (!regionGroups[rn]) regionGroups[rn] = [];
  regionGroups[rn].push(g);
  rebuildSchools(rn);
  renderEditor(); renderMap();
  showQFDetailModal(rn, qi);
}

// ‚îÄ‚îÄ‚îÄ SEMIFINAL MODAL (from map star click) ‚îÄ‚îÄ‚îÄ
function showSFModal(regionName) {
  const rd = data[regionName];
  const sf = rd.semifinal || {date:'',location:'',lat:null,lng:null};

  showModal(`Semifinal ‚Äî ${regionName}`, `
    <div style="font-size:10px;color:${rd.color};margin:-8px 0 12px">‚óè ${regionName} ¬∑ ‚òÖ Semifinal</div>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-loc" value="${esc(sf.location||'')}">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" value="${esc(sf.date||'')}"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" value="${sf.lat||''}"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" value="${sf.lng||''}"></div>
    </div>
  `, () => {
    saveUndo('generate SF');
    rd.semifinal = {
      location: document.getElementById('m-loc').value.trim(),
      date: document.getElementById('m-date').value.trim(),
      lat: parseFloat(document.getElementById('m-lat').value) || null,
      lng: parseFloat(document.getElementById('m-lng').value) || null
    };
    renderEditor(); renderMap();
  });
  setTimeout(wireLocationAutocomplete, 50);
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
function showModal(title, body, onConfirm) {
  const overlay = document.getElementById('modal-overlay');
  const modal = document.getElementById('modal');
  modal.innerHTML = `<h3>${title}</h3>${body}
    <div class="modal-actions">
      <button class="tb-btn" onclick="closeModal()">Cancel</button>
      <button class="tb-btn primary" id="modal-ok">Confirm</button>
    </div>`;
  overlay.classList.add('active');
  document.getElementById('modal-ok').onclick = () => { onConfirm(); closeModal(); };
  setTimeout(() => {
    const inp = modal.querySelector('input');
    if (inp) inp.focus();
    else document.getElementById('modal-ok').focus();
  }, 50);
  modal.onkeydown = (e) => { if (e.key==='Enter' && e.target.tagName!=='SELECT') { onConfirm(); closeModal(); } };
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

function customConfirm(msg, onYes) {
  showModal('Confirm', `<div style="font-size:13px;color:#ccc;margin-bottom:4px">${msg}</div>`, onYes);
  // Restyle confirm button as danger
  const btn = document.getElementById('modal-ok');
  btn.textContent = 'Delete';
  btn.className = 'tb-btn danger';
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
function exportJSON() {
  const exportData = deepClone(data);
  for (const rd of Object.values(exportData)) {
    rd.quarterfinals.forEach(qf => { qf.groups = qf.groups.map(g => displayName(g)); });
  }
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'icca-regions.json'; a.click();
  markClean();
}

function exportImage() {
  const W = 1080, H = 1920;
  const canvas = document.createElement('canvas');
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');

  if (!ctx.roundRect) {
    ctx.roundRect = function(x, y, w, h, r) {
      if (typeof r === 'number') r = [r,r,r,r];
      r = r.map(v => Math.min(v, w/2, h/2));
      this.moveTo(x+r[0], y);
      this.arcTo(x+w, y, x+w, y+h, r[1]);
      this.arcTo(x+w, y+h, x, y+h, r[2]);
      this.arcTo(x, y+h, x, y, r[3]);
      this.arcTo(x, y, x+w, y, r[0]);
    };
  }

  // Fixed layout
  const headerH = 100;
  const mapH = 750;
  const regionCount = Object.keys(data).length || 1;
  const regionZoneTop = headerH + mapH;
  const regionZoneH = H - regionZoneTop;
  const cardGap = 4;
  const cardPad = 20;
  const regionCardH = Math.floor((regionZoneH - cardPad * 2 - cardGap * (regionCount - 1)) / regionCount);

  // Background
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#0d0d1a');
  grad.addColorStop(0.35, '#161628');
  grad.addColorStop(1, '#0d0d1a');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  // --- Render map directly onto canvas using d3 projection ---
  const mapPad = -110;
  const mapW = W + 220;
  const mapInnerH = mapH + 220;
  const proj = d3.geoAlbersUsa().fitSize([mapW, mapInnerH], {type: "Sphere"});
  proj.translate([W / 2, headerH + mapH / 2]);
  const path = d3.geoPath().projection(proj);

  // Draw states
  if (usTopoData) {
    const states = topojson.feature(usTopoData, usTopoData.objects.states);
    for (const feat of states.features) {
      const sn = feat.properties.name;
      const rn = STATE_REGION[sn];
      const rd = rn ? data[rn] : null;

      // State fill
      ctx.beginPath();
      const p2d = new Path2D(path(feat));
      if (rd) {
        ctx.fillStyle = rd.color + '18';
      } else {
        ctx.fillStyle = 'rgba(255,255,255,0.02)';
      }
      ctx.fill(p2d);

      // State stroke
      if (rd) {
        ctx.strokeStyle = rd.color + '50';
        ctx.lineWidth = 1;
      } else {
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 0.5;
      }
      ctx.stroke(p2d);
    }
  }

  // Draw group dots
  for (const [rn, rd] of Object.entries(data)) {
    const color = rd.color || '#888';
    for (const sc of (rd.schools || [])) {
      const coords = SCHOOL_COORDS[sc];
      if (!coords) continue;
      const pt = proj([coords[1], coords[0]]);
      if (!pt) continue;
      ctx.beginPath();
      ctx.arc(pt[0], pt[1], 3.5, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.fill();
    }
  }

  // Draw QF diamonds
  for (const [rn, rd] of Object.entries(data)) {
    const color = rd.color || '#888';
    for (const qf of rd.quarterfinals) {
      if (!qf.location) continue;
      const loc = SCHOOL_COORDS[qf.location];
      if (!loc) continue;
      const pt = proj([loc[1], loc[0]]);
      if (!pt) continue;
      ctx.save();
      ctx.translate(pt[0], pt[1]);
      ctx.rotate(Math.PI / 4);
      ctx.fillStyle = color + '60';
      ctx.fillRect(-4, -4, 8, 8);
      ctx.restore();
    }
  }

  // Draw SF stars
  for (const [rn, rd] of Object.entries(data)) {
    if (!rd.semifinal || !rd.semifinal.location) continue;
    const color = rd.color || '#888';
    const loc = SCHOOL_COORDS[rd.semifinal.location];
    if (!loc) continue;
    const pt = proj([loc[1], loc[0]]);
    if (!pt) continue;
    // Simple star shape
    ctx.beginPath();
    for (let s = 0; s < 5; s++) {
      const angle = -Math.PI / 2 + s * Math.PI * 2 / 5;
      const r = 6;
      ctx.lineTo(pt[0] + Math.cos(angle) * r, pt[1] + Math.sin(angle) * r);
      const angle2 = angle + Math.PI / 5;
      ctx.lineTo(pt[0] + Math.cos(angle2) * r * 0.4, pt[1] + Math.sin(angle2) * r * 0.4);
    }
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
  }

  // Edge fades on map zone
  let f1 = ctx.createLinearGradient(0, headerH, 0, headerH + 40);
  f1.addColorStop(0, 'rgba(13,13,26,0.8)'); f1.addColorStop(1, 'rgba(13,13,26,0)');
  ctx.fillStyle = f1; ctx.fillRect(0, headerH, W, 40);
  let f2 = ctx.createLinearGradient(0, headerH + mapH - 40, 0, headerH + mapH);
  f2.addColorStop(0, 'rgba(13,13,26,0)'); f2.addColorStop(1, 'rgba(13,13,26,0.8)');
  ctx.fillStyle = f2; ctx.fillRect(0, headerH + mapH - 40, W, 40);

  // --- Header ---
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 44px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('My ICCA Regions', W / 2, 52);
  ctx.fillStyle = '#777';
  ctx.font = '18px -apple-system, BlinkMacSystemFont, sans-serif';
  const totalR = Object.keys(data).length;
  const totalG = Object.entries(data).reduce((s, [rn, rd]) => s + countGroups(rd) + (regionGroups[rn] || []).length, 0);
  const totalS = new Set(Object.values(data).flatMap(rd => rd.schools || [])).size;
  ctx.fillText(totalR + ' Regions \u00b7 ' + totalG + ' Groups \u00b7 ' + totalS + ' Schools', W / 2, 82);

  // --- Region cards ---
  ctx.textAlign = 'left';
  const regionEntries = Object.entries(data).sort((a, b) => {
    const ga = countGroups(a[1]) + (regionGroups[a[0]] || []).length;
    const gb = countGroups(b[1]) + (regionGroups[b[0]] || []).length;
    return gb - ga;
  });

  const cardX = cardPad;
  const cardW = W - cardPad * 2;

  for (let i = 0; i < regionEntries.length; i++) {
    const [rn, rd] = regionEntries[i];
    const cy = regionZoneTop + cardPad + i * (regionCardH + cardGap);
    const gc = countGroups(rd) + (regionGroups[rn] || []).length;
    const sc = (rd.schools || []).length;
    const qc = rd.quarterfinals.length;

    // Card bg
    ctx.fillStyle = 'rgba(255,255,255,0.035)';
    ctx.beginPath(); ctx.roundRect(cardX, cy, cardW, regionCardH, 8); ctx.fill();

    // Color accent
    ctx.fillStyle = rd.color || '#555';
    const accPad = Math.max(6, regionCardH * 0.15);
    ctx.fillRect(cardX, cy + accPad, 4, regionCardH - accPad * 2);

    // Text
    const mid = cy + regionCardH / 2;
    const nameSize = Math.min(20, Math.max(14, regionCardH * 0.35));
    const statSize = Math.min(13, Math.max(10, regionCardH * 0.22));

    ctx.fillStyle = '#eee';
    ctx.font = 'bold ' + Math.round(nameSize) + 'px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.fillText(rn, cardX + 18, mid + (regionCardH > 60 ? -4 : 1));

    if (regionCardH > 45) {
      ctx.fillStyle = '#777';
      ctx.font = Math.round(statSize) + 'px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.fillText(sc + ' schools \u00b7 ' + gc + ' groups \u00b7 ' + qc + ' QFs', cardX + 18, mid + nameSize * 0.75);
    }

    // Pill
    const pillW = 46, pillH = Math.min(24, regionCardH * 0.45);
    const pillX = cardX + cardW - pillW - 12, pillY = mid - pillH / 2;
    ctx.fillStyle = rd.color + '30';
    ctx.beginPath(); ctx.roundRect(pillX, pillY, pillW, pillH, pillH / 2); ctx.fill();
    ctx.fillStyle = rd.color;
    ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(gc + 'g', pillX + pillW / 2, pillY + pillH / 2 + 5);
    ctx.textAlign = 'left';
  }

  // Download
  const now = new Date();
  canvas.toBlob(function(blob) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'icca-regions-' + now.toISOString().slice(0, 10) + '.png';
    a.click();
    URL.revokeObjectURL(a.href);
  }, 'image/png');
}




function importJSON() { document.getElementById('file-import').click(); }
function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const imported = JSON.parse(ev.target.result);
      if (typeof imported !== 'object' || !Object.keys(imported).length) throw new Error('Invalid format');
      saveUndo('import');
      data = imported;
      encodeGroups(data);
      unassigned = [];
      openRegions = {};
      selectedRegionName = null;
      renderEditor(); renderMap();
    } catch(err) { alert('Import failed: ' + err.message); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ‚îÄ‚îÄ‚îÄ HISTORY SYSTEM ‚îÄ‚îÄ‚îÄ
const HISTORY = {}; // { year: { raw: originalJSON, regions: convertedEditorData, meta: {season, source, finals, notes} } }

// ‚îÄ‚îÄ‚îÄ EMBEDDED HISTORICAL DATA ‚îÄ‚îÄ‚îÄ
const HISTORY_RAW = {
  1996: {"year":1996,"season":"1995-1996","source":"1996 NCCA Tournament results PDF. Contains placements, scores, and awards for all rounds. This predates the ICCA name \u2014 the competition was called the National Championship of Collegiate A Cappella (NCCA).","regions":{"Mason-Dixon":{"schools":["University of North Carolina at Chapel Hill","University of Pennsylvania","The College of William & Mary","University of Maryland, College Park","Johns Hopkins University","Princeton University"],"quarterfinals":[{"name":"Mason-Dixon QF1","location":"University of North Carolina at Chapel Hill, Chapel Hill, NC","date":null,"groups":[{"name":"Gentlemen of the College","school":"The College of William & Mary"},{"name":"Loreleis","school":"University of North Carolina at Chapel Hill"},{"name":"Generics","school":"University of Maryland, College Park"},{"name":"Clef Hangers","school":"University of North Carolina at Chapel Hill"},{"name":"Off the Beat","school":"University of Pennsylvania"}]},{"name":"Mason-Dixon QF2","location":"Drew University, Madison, NJ","date":null,"groups":[{"name":"AllNighters","school":"Johns Hopkins University"},{"name":"Treble Makers","school":"University of Maryland, College Park"},{"name":"Katzenjammers","school":"Princeton University"},{"name":"Six-5000","school":"University of Pennsylvania"}]}],"semifinal":{"location":"Johns Hopkins University, Baltimore, MD","date":null}},"Midwest":{"schools":["University of Illinois Urbana-Champaign","University of Colorado Boulder"],"quarterfinals":[{"name":"Midwest QF1","location":"University of Illinois Urbana-Champaign, Champaign, IL","date":null,"groups":[{"name":"The Other Guys","school":"University of Illinois Urbana-Champaign"},{"name":"Xtension Chords","school":"University of Illinois Urbana-Champaign"},{"name":"In the Buff","school":"University of Colorado Boulder"}]}],"semifinal":null},"New England":{"schools":["Massachusetts Institute of Technology","Brown University","Bates College","Boston College","Yale University","Connecticut College"],"quarterfinals":[{"name":"New England QF1","location":"Boston College, Chestnut Hill, MA","date":null,"groups":[{"name":"Chorallaries","school":"Massachusetts Institute of Technology"},{"name":"Bostonians","school":"Boston College"},{"name":"Deansmen","school":"Bates College"},{"name":"Heightsmen","school":"Boston College"}]},{"name":"New England QF2","location":"Brown University, Providence, RI","date":null,"groups":[{"name":"Jabberwocks","school":"Brown University"},{"name":"Duke's Men","school":"Yale University"},{"name":"Brown Derbies","school":"Brown University"},{"name":"Chattertocks","school":"Brown University"},{"name":"Co Co Beaux","school":"Connecticut College"}]}],"semifinal":{"location":"Wellesley College, Wellesley, MA","date":null}},"Northeast":{"schools":["Binghamton University","Cornell University","University of Rochester","Colgate University","Smith College","Amherst College","Skidmore College","Wheaton College"],"quarterfinals":[{"name":"Northeast QF1","location":"Cornell University, Ithaca, NY","date":null,"groups":[{"name":"Binghamton Crosbys","school":"Binghamton University"},{"name":"Hangovers","school":"Cornell University"},{"name":"YellowJackets","school":"University of Rochester"},{"name":"Swingin' Gates","school":"Colgate University"}]},{"name":"Northeast QF2","location":null,"date":null,"groups":[{"name":"Noteables","school":"Smith College"},{"name":"Zumbyes","school":"Amherst College"},{"name":"Bandersnatchers","school":"Skidmore College"},{"name":"Gentlemen Callers","school":"Wheaton College"}]}],"semifinal":{"location":"Mount Holyoke College, South Hadley, MA","date":null}},"West":{"schools":["Stanford University"],"quarterfinals":[{"name":"West QF1","location":"University of California, Berkeley, Berkeley, CA","date":null,"groups":[{"name":"Fleet Street Singers","school":"Stanford University"},{"name":"Talisman","school":"Stanford University"},{"name":"Harmonics","school":"Stanford University"}]}],"semifinal":null}},"finals":{"location":"Alice Tully Hall, Lincoln Center, Manhattan, NY","date":null},"notes":"This is from the NCCA (National Championship of Collegiate A Cappella) era, before the competition was renamed to ICCA. No specific dates are given in the PDF \u2014 only '1996' for all events. Key observations: (1) The Midwest region only has semifinal results (3 groups: The Other Guys, Xtension Chords, In the Buff) with no QF breakdown \u2014 QFs may not have existed for this region or the data is missing. Schools derived from semifinal participants only. (2) The West region only has semifinal results (3 groups: Fleet Street Singers, Talisman, Harmonics \u2014 all from Stanford). No QF data available. (3) Cornell University Hangovers appear in both the New England semifinal and the Northeast QF1 \u2014 Cornell is listed under Northeast for QF purposes. Cornell appears in New England semifinal but competed in Northeast QFs; added Cornell to New England schools since Hangovers were a semifinalist there. Actually, looking more carefully: the New England semifinal lists Hangovers as a semifinalist but they competed in Northeast QF1. This likely means the New England and Northeast semifinalists are drawn from different QF pools. Cornell is placed in Northeast (where they had their QF). (4) Yale Duke's Men appear in both New England QF2 and the Northeast semifinal \u2014 they competed in New England QF2 but the Northeast semifinal result places them there. This is confusing \u2014 it appears Duke's Men competed in New England QFs but advanced to the Northeast semifinal, OR the PDF has some cross-region semifinal structure. Preserved as found. Actually re-reading: Duke's Men are in the New England QF2 results, but the Northeast semifinal result only shows them at the finals level. The New England semifinal does NOT list Duke's Men. So Duke's Men competed in New England QF2, placed 2nd, but since the top 2 from New England QFs advanced to the New England semifinal (where they're not listed), something doesn't add up. The most likely explanation: Yale placed 2nd in QF2 but the top finishers from QFs went to the semifinal. Yale is listed as a finalist at the national level but their semifinal path is unclear from this PDF. I've placed them in New England QF2 as printed. (5) Wheaton College appears in both New England (Wheaton, MA) and Northeast (Wheaton, MA for Gentlemen Callers) \u2014 these are likely different Wheaton Colleges but both are in MA, so it's actually the same school (Wheaton College in Norton, MA). Added to both region school lists since groups from there competed in both. (6) Drew University listed as QF2 venue for Mason-Dixon but no Drew groups competed. (7) Group counts are very small by modern standards \u2014 this was only the tournament's first year. SCHEMA NOTE: Midwest and West had no quarterfinals in the original tournament \u2014 their semifinal groups have been mapped to quarterfinals per schema convention (quarterfinals = first round of group assignment)."},
  2005: {"year":2005,"season":"2004-2005","source":"2005 ICCA Tournament results PDF. Contains full results for all QFs, semifinals, regional finals, and national finals.","regions":{"Mid-Atlantic":{"schools":["Skidmore College","Rutgers University","Lafayette College","University of Rochester","Ithaca College","SUNY Potsdam","Syracuse University","University of Delaware","SUNY at Buffalo","University of Pennsylvania","University of Maryland, College Park","Johns Hopkins University"],"quarterfinals":[{"name":"Mid-Atlantic QF1","location":"Rutgers University, New Brunswick, NJ","date":null,"groups":[{"name":"Sonneteers","school":"Skidmore College"},{"name":"Casual Harmony","school":"Rutgers University"},{"name":"Quintessence","school":"Lafayette College"}]},{"name":"Mid-Atlantic QF2","location":"Rochester Institute of Technology, Rochester, NY","date":null,"groups":[{"name":"Midnight Ramblers","school":"University of Rochester"},{"name":"Ithacappella","school":"Ithaca College"},{"name":"Cadence","school":"Lafayette College"},{"name":"The Potsdam Pointercounts","school":"SUNY Potsdam"}]},{"name":"Mid-Atlantic QF3","location":"University of Pittsburgh, Pittsburgh, PA","date":null,"groups":[{"name":"Mandarins","school":"Syracuse University"},{"name":"Deltones","school":"University of Delaware"},{"name":"Vocal Point","school":"University of Rochester"},{"name":"Buffalo Chips","school":"SUNY at Buffalo"}]},{"name":"Mid-Atlantic QF4","location":"Johns Hopkins University, Baltimore, MD","date":null,"groups":[{"name":"Counterparts","school":"University of Pennsylvania"},{"name":"Generics","school":"University of Maryland, College Park"},{"name":"Faux Paz","school":"University of Maryland, College Park"},{"name":"AllNighters","school":"Johns Hopkins University"}]}],"semifinal":{"location":"Cornell University, Ithaca, NY","date":null}},"Midwest":{"schools":["University of Illinois Urbana-Champaign","University of Nebraska","Michigan State University","Washington University in St. Louis","Truman State University","Missouri State University","Indiana University","Penn State University","Oberlin College","University of Wisconsin Eau Claire","University of Wisconsin-Madison","University of Michigan"],"quarterfinals":[{"name":"Midwest QF1","location":"Michigan State University, East Lansing, MI","date":null,"groups":[{"name":"Xtension Chords","school":"University of Illinois Urbana-Champaign"},{"name":"Bathtub Dogs","school":"University of Nebraska"},{"name":"Accafellas","school":"Michigan State University"},{"name":"Capital Green","school":"Michigan State University"}]},{"name":"Midwest QF2","location":"University of Illinois Urbana-Champaign, Champaign, IL","date":null,"groups":[{"name":"No Strings Attached","school":"University of Illinois Urbana-Champaign"},{"name":"After Dark","school":"Washington University in St. Louis"},{"name":"True Men","school":"Truman State University"},{"name":"A Cub Bella","school":"Missouri State University"}]},{"name":"Midwest QF3","location":"Penn State University, State College, PA","date":null,"groups":[{"name":"Straight No Chaser","school":"Indiana University"},{"name":"Pennharmonics","school":"Penn State University"},{"name":"None of the Above","school":"Penn State University"},{"name":"Ladies First","school":"Indiana University"},{"name":"Obertones","school":"Oberlin College"}]},{"name":"Midwest QF4","location":"Millikin University, Decatur, IL","date":null,"groups":[{"name":"Fifth Element","school":"University of Wisconsin Eau Claire"},{"name":"Tangled Up In Blue","school":"University of Wisconsin-Madison"},{"name":"Amazin' Blue","school":"University of Michigan"}]}],"semifinal":{"location":"University of Wisconsin-Madison, Madison, WI","date":null}},"New England":{"schools":["University of Maine","University of New Hampshire","University of Vermont","Middlebury College","Yale University","University of Hartford","New York University","Fordham University","Binghamton University"],"quarterfinals":[{"name":"New England QF1","location":"Bates College, Lewiston, ME","date":null,"groups":[{"name":"Steiners","school":"University of Maine"},{"name":"Alabaster Blue","school":"University of New Hampshire"},{"name":"Cat's Meow","school":"University of Vermont"},{"name":"Stuck in the Middle","school":"Middlebury College"}]},{"name":"New England QF2","location":"Immanuel Congregational Church, Hartford, CT","date":null,"groups":[{"name":"Duke's Men","school":"Yale University"},{"name":"L'Shir","school":"University of Hartford"},{"name":"Not Too Sharp","school":"University of New Hampshire"},{"name":"APC Rhythm","school":"New York University"}]},{"name":"New England QF3","location":"Fordham University, The Bronx, NY","date":null,"groups":[{"name":"Men In Black","school":"University of Hartford"},{"name":"Binghamton Crosbys","school":"Binghamton University"},{"name":"Satin Dolls","school":"Fordham University"},{"name":"Harpur Harpeggios","school":"Binghamton University"}]}],"semifinal":{"location":"Yale University, New Haven, CT","date":null}},"Northeast":{"schools":["University of Massachusetts Amherst","Plymouth State University","Amherst College","Smith College","Boston University","Harvard University","Brandeis University","Wellesley College","University of Connecticut","Wesleyan University"],"quarterfinals":[{"name":"Northeast QF1","location":"Worcester Polytechnic Institute, Worcester, MA","date":null,"groups":[{"name":"Vocal Suspects","school":"University of Massachusetts Amherst"},{"name":"Vocal Order","school":"Plymouth State University"},{"name":"Bluestockings","school":"Amherst College"},{"name":"Smithereens","school":"Smith College"}]},{"name":"Northeast QF2","location":"Boston University, Boston, MA","date":null,"groups":[{"name":"The Dear Abbeys","school":"Boston University"},{"name":"Harvard LowKeys","school":"Harvard University"},{"name":"Allegrettos","school":"Boston University"}]},{"name":"Northeast QF3","location":"Wheaton College, Wheaton, MA","date":null,"groups":[{"name":"Starving Artists","school":"Brandeis University"},{"name":"Widows","school":"Wellesley College"},{"name":"Tupelos","school":"Wellesley College"}]},{"name":"Northeast QF4","location":"The College of Our Lady of the Elms, Chicopee, MA","date":null,"groups":[{"name":"A Completely Different Note","school":"University of Connecticut"},{"name":"In Achord","school":"Boston University"},{"name":"Cardinal Sinners","school":"Wesleyan University"},{"name":"Chordials","school":"University of Connecticut"}]}],"semifinal":{"location":"Massachusetts Institute of Technology, Cambridge, MA","date":null}},"South":{"schools":["University of North Carolina at Chapel Hill","Appalachian State University","University of South Carolina","University of Georgia","Clemson University","Florida State University","James Madison University","The College of William & Mary","University of Virginia","Virginia Tech"],"quarterfinals":[{"name":"South QF1","location":"Clemson University, Clemson, SC","date":null,"groups":[{"name":"Achordants","school":"University of North Carolina at Chapel Hill"},{"name":"Higher Ground","school":"Appalachian State University"},{"name":"Cocktails","school":"University of South Carolina"}]},{"name":"South QF2","location":"Florida State University, Tallahassee, FL","date":null,"groups":[{"name":"Loreleis","school":"University of North Carolina at Chapel Hill"},{"name":"Accidentals","school":"University of Georgia"},{"name":"TakeNote","school":"Clemson University"},{"name":"All-Night Yahtzee","school":"Florida State University"}]},{"name":"South QF3","location":"Virginia Tech, Blacksburg, VA","date":null,"groups":[{"name":"The Madison Project","school":"James Madison University"},{"name":"DoubleTake","school":"The College of William & Mary"},{"name":"New Dominions","school":"University of Virginia"},{"name":"Soulstice","school":"Virginia Tech"}]}],"semifinal":{"location":"The College of William & Mary, Williamsburg, VA","date":null}},"West":{"schools":["Mt. San Antonio College","University of Southern California","University of California, San Diego","Brigham Young University","University of Arizona","University of Colorado Boulder","University of California, Berkeley","Stanford University","The Claremont Colleges","California Institute of Technology","University of Oregon","Oregon State University"],"quarterfinals":[{"name":"West QF1","location":"University of Southern California, Los Angeles, CA","date":null,"groups":[{"name":"Fermata Nowhere","school":"Mt. San Antonio College"},{"name":"Reverse Osmosis","school":"University of Southern California"},{"name":"TriTones","school":"University of California, San Diego"},{"name":"diSChord","school":"University of Southern California"}]},{"name":"West QF2","location":"University of Colorado Boulder, Boulder, CO","date":null,"groups":[{"name":"Vocal Point","school":"Brigham Young University"},{"name":"Noteworthy","school":"Brigham Young University"},{"name":"Vocal Ease","school":"University of Arizona"},{"name":"EveryMan Jack & Jill","school":"University of Arizona"},{"name":"Extreme Measures","school":"University of Colorado Boulder"}]},{"name":"West QF3","location":"University of California, Berkeley, Berkeley, CA","date":null,"groups":[{"name":"Golden Overtones","school":"University of California, Berkeley"},{"name":"Fleet Street Singers","school":"Stanford University"},{"name":"The Claremont Shades","school":"The Claremont Colleges"},{"name":"Out of Context","school":"California Institute of Technology"}]},{"name":"West QF4","location":"South Eugene High School, Eugene, OR","date":null,"groups":[{"name":"Divisi","school":"University of Oregon"},{"name":"Six in the City","school":"University of California, Berkeley"},{"name":"Everyday People","school":"Stanford University"},{"name":"Outspoken","school":"Oregon State University"},{"name":"DeCadence","school":"University of California, Berkeley"},{"name":"Jazz Choir","school":"University of California, Berkeley"}]}],"semifinal":{"location":"Stanford University, Palo Alto, CA","date":null}}},"finals":{"location":"Alice Tully Hall, Lincoln Center, Manhattan, NY","date":null},"notes":"This was the 9th ICCA season. The PDF is a results document \u2014 no specific dates are given, only '2005' for all events. The regional structure used 'Finals' (not 'Semifinals') as the top regional round in some regions, with a 'Semifinal' round below that. The Mid-Atlantic and Midwest used a three-tier structure: QF \u2192 Semifinal \u2192 Regional Final. The New England, Northeast, and South regions used QF \u2192 Semifinal (labeled 'Final'). Key observations: (1) No specific dates provided for any events. (2) The results PDF only lists placed groups and quarterfinalists \u2014 groups that competed but did not place or receive mention may be missing. The QF group lists represent the minimum known participants. (3) 'Harpur College' is listed for 'Harpur Harpeggios' \u2014 Harpur College is a college within Binghamton University. Mapped to Binghamton University. (4) 'Claremont College' and 'Claremont Colleges' both appear \u2014 mapped to 'The Claremont Colleges'. (5) 'Virginia Polytechnic Institute' mapped to 'Virginia Tech' as the common name. (6) Penn State listed as 'Pennsylvania State University' in PDF \u2014 mapped to 'Penn State University'. (7) Harvard listed as 'Harvard College' in PDF \u2014 mapped to 'Harvard University'. (8) The West QF4 lists two UC Berkeley groups (DeCadence and Jazz Choir) as 'University of California' without the Berkeley campus specified \u2014 context makes clear these are UC Berkeley groups. (9) College of Our Lady of the Elms was the venue for Northeast QF4 \u2014 included in schools list as a venue school even though no Elms groups competed. Actually, no Elms groups competed, so removing from schools list. (10) Worcester Polytechnic Institute and Wheaton College hosted QFs but had no competing groups \u2014 they are NOT in the schools list. (11) Bates College hosted New England QF1 but had no competing groups \u2014 NOT in schools list."},
  2015: {"year":2015,"season":"2014-2015","source":"2015 ICCA Tournament results PDF. Contains full results (placements, scores, awards) for all QFs, semifinals, wild card, and finals. Group assignments extracted from result listings.","regions":{"Great Lakes":{"schools":["Bowling Green State University","Michigan State University","Kent State University","Baldwin-Wallace University","Kenyon College","Ohio Wesleyan University","Otterbein University","University of Waterloo","University of Michigan","Indiana University","Siena Heights University","Grand Valley State University","Central Michigan University","Northern Michigan University","Western Michigan University","The Ohio State University","University of Dayton","Miami University","University of Cincinnati","University of Pittsburgh","Carnegie Mellon University","Oakland University"],"quarterfinals":[{"name":"Great Lakes QF1","location":"Bowling Green High School, Bowling Green, OH","date":"2015-01-31","groups":[{"name":"Ten40","school":"Bowling Green State University"},{"name":"State of Fifths","school":"Michigan State University"},{"name":"Kent Clarks","school":"Kent State University"},{"name":"S\u014cL","school":"Baldwin-Wallace University"},{"name":"The Ransom Notes","school":"Kenyon College"},{"name":"Pitch Black","school":"Ohio Wesleyan University"},{"name":"Ottertuned","school":"Otterbein University"},{"name":"The Committee","school":"University of Waterloo"},{"name":"The Water Boys","school":"University of Waterloo"},{"name":"The Unaccompanied Minors","school":"University of Waterloo"}]},{"name":"Great Lakes QF2","location":"Skyline High School, Ann Arbor, MI","date":"2015-02-06","groups":[{"name":"Amazin' Blue","school":"University of Michigan"},{"name":"The Michigan G-Men","school":"University of Michigan"},{"name":"Maize Mirchi","school":"University of Michigan"},{"name":"Crimson Cadence","school":"Indiana University"},{"name":"Acapelicans","school":"Siena Heights University"},{"name":"Compulsive Lyres","school":"University of Michigan"},{"name":"The Dicks and Janes","school":"University of Michigan"},{"name":"The Harmonettes","school":"University of Michigan"}]},{"name":"Great Lakes QF3","location":"Pasant Theatre, Michigan State University, East Lansing, MI","date":"2015-02-07","groups":[{"name":"Capital Green","school":"Michigan State University"},{"name":"Accafellas","school":"Michigan State University"},{"name":"GV GrooVe!","school":"Grand Valley State University"},{"name":"Central Harmony","school":"Central Michigan University"},{"name":"Euphoria","school":"Grand Valley State University"},{"name":"Ladies First","school":"Michigan State University"},{"name":"Northern Lights","school":"Northern Michigan University"},{"name":"RCAHppella","school":"Michigan State University"},{"name":"The Broncords","school":"Western Michigan University"}]},{"name":"Great Lakes QF4","location":"Centerville High School, Centerville, OH","date":"2015-02-28","groups":[{"name":"Buck That!","school":"The Ohio State University"},{"name":"Remedy","school":"University of Dayton"},{"name":"Soul2Soul","school":"Miami University"},{"name":"Hooshir","school":"Indiana University"},{"name":"Just Duet","school":"Miami University"},{"name":"Dynamic Contrast","school":"The Ohio State University"},{"name":"New Chords on the Block","school":"The Ohio State University"},{"name":"The Ohio State of Mind","school":"The Ohio State University"},{"name":"UC Junoon","school":"University of Cincinnati"},{"name":"UC Vocaholics","school":"University of Cincinnati"}]},{"name":"Great Lakes QF5","location":"McConomy Auditorium, Carnegie Mellon University, Pittsburgh, PA","date":"2015-02-28","groups":[{"name":"Pittch Please","school":"University of Pittsburgh"},{"name":"The Originals","school":"Carnegie Mellon University"},{"name":"The Treblemakers","school":"Carnegie Mellon University"},{"name":"Counterpoint","school":"Carnegie Mellon University"},{"name":"Gold Vibrations","school":"Oakland University"},{"name":"C Flat Run","school":"University of Pittsburgh"},{"name":"Pitches & Tones","school":"University of Pittsburgh"},{"name":"Sounds Like Treble","school":"University of Pittsburgh"},{"name":"The Pitt Pendulums","school":"University of Pittsburgh"},{"name":"VoKols","school":"University of Pittsburgh"}]}],"semifinal":{"location":"Rackham Auditorium, University of Michigan, Ann Arbor, MI","date":"2015-03-21"}},"Mid-Atlantic":{"schools":["University of Pennsylvania","Georgetown University","West Chester University of Pennsylvania","Bryn Mawr College","Drexel University","Lehigh University","Towson University","University of Rochester","Johns Hopkins University","Rutgers University","Eastman School of Music","Monroe Community College","Rochester Institute of Technology","SUNY Geneseo","Syracuse University","Penn State University","Elizabethtown College","Dickinson College","York College of Pennsylvania","Stockton University","Westminster Choir College","Monmouth University","Ramapo College of New Jersey","The College of New Jersey","St. Mary's College of Maryland","University of Maryland Baltimore County","Haverford College","University of Maryland, College Park","University of Delaware","Salisbury University"],"quarterfinals":[{"name":"Mid-Atlantic QF1","location":"Main Auditorium, Drexel University, Philadelphia, PA","date":"2015-01-31","groups":[{"name":"Off The Beat","school":"University of Pennsylvania"},{"name":"Superfood","school":"Georgetown University"},{"name":"High Street Harmonix","school":"West Chester University of Pennsylvania"},{"name":"Extreme Keys","school":"Bryn Mawr College"},{"name":"Treblemakers","school":"Drexel University"},{"name":"A Whole Step Up","school":"Lehigh University"},{"name":"Off the Record","school":"Lehigh University"},{"name":"The Echoes","school":"Lehigh University"},{"name":"Purrrfect Pitch","school":"Towson University"}]},{"name":"Mid-Atlantic QF2","location":"Hendricks Chapel, Syracuse University, Syracuse, NY","date":"2015-01-31","groups":[{"name":"After Hours","school":"University of Rochester"},{"name":"Octopodes","school":"Johns Hopkins University"},{"name":"OrphanSporks","school":"Rutgers University"},{"name":"COLLIDE","school":"Eastman School of Music"},{"name":"The Melismatics","school":"Lehigh University"},{"name":"The Tributones","school":"Monroe Community College"},{"name":"Encore","school":"Rochester Institute of Technology"},{"name":"Exit 8","school":"SUNY Geneseo"},{"name":"Groovestand","school":"Syracuse University"},{"name":"Oy Cappella","school":"Syracuse University"}]},{"name":"Mid-Atlantic QF3","location":"Pennsylvania State University Center for the Performing Arts, State College, PA","date":"2015-02-07","groups":[{"name":"The Coda Conduct","school":"Penn State University"},{"name":"Pennharmonics","school":"Penn State University"},{"name":"Melica","school":"Elizabethtown College"},{"name":"Dtones!","school":"Dickinson College"},{"name":"Infernos","school":"Dickinson College"},{"name":"Phalanx","school":"Elizabethtown College"},{"name":"Vocalign","school":"Elizabethtown College"},{"name":"None of the Above","school":"Penn State University"},{"name":"Ulterior Motive","school":"Penn State University"},{"name":"Rhapsody","school":"York College of Pennsylvania"}]},{"name":"Mid-Atlantic QF4","location":"Stockton University Performing Arts Center, Galloway, NJ","date":"2015-02-14","groups":[{"name":"Casual Harmony","school":"Rutgers University"},{"name":"The Deaftones","school":"Westminster Choir College"},{"name":"Stockapella","school":"Stockton University"},{"name":"The Outskirts","school":"Haverford College"},{"name":"Sea Sharps","school":"Monmouth University"},{"name":"4GotteN SuitCase","school":"Ramapo College of New Jersey"},{"name":"Deep Treble","school":"Rutgers University"},{"name":"InterChorus","school":"St. Mary's College of Maryland"},{"name":"The Trentones","school":"The College of New Jersey"},{"name":"The Stilettos","school":"University of Maryland Baltimore County"}]},{"name":"Mid-Atlantic QF5","location":"Shriver Hall, Johns Hopkins University, Baltimore, MD","date":"2015-02-21","groups":[{"name":"Faux Paz","school":"University of Maryland, College Park"},{"name":"Vocal Point","school":"University of Delaware"},{"name":"Squawkappella","school":"Salisbury University"},{"name":"AllNighters","school":"Johns Hopkins University"},{"name":"Vocal Chords","school":"Johns Hopkins University"},{"name":"MelUDees","school":"University of Delaware"},{"name":"Mama's Boys","school":"University of Maryland Baltimore County"},{"name":"The Cleftomaniacs","school":"University of Maryland Baltimore County"},{"name":"Anokha","school":"University of Maryland, College Park"},{"name":"DaCadence","school":"University of Maryland, College Park"}]}],"semifinal":{"location":"Main Auditorium, Drexel University, Philadelphia, PA","date":"2015-03-28"}},"Midwest":{"schools":["University of Illinois Urbana-Champaign","Northern Illinois University","Ball State University","Illinois State University","Loyola University Chicago","Truman State University","University of Chicago","Washington University in St. Louis","Saint Louis University","University of Kansas","Marquette University","University of Minnesota Twin Cities","Illinois Wesleyan University","Mount Marty College","University of Wisconsin-Madison","Missouri State University","University of Missouri","Hastings College","University of Central Missouri","Wheaton College","Northwestern University","University of Nebraska"],"quarterfinals":[{"name":"Midwest QF1","location":"Mandell Hall, University of Chicago, Chicago, IL","date":"2015-01-24","groups":[{"name":"No Comment","school":"University of Illinois Urbana-Champaign"},{"name":"Huskie Hunks","school":"Northern Illinois University"},{"name":"Sedoctave","school":"Ball State University"},{"name":"Ladies' Choice","school":"Ball State University"},{"name":"Note to Self","school":"Ball State University"},{"name":"Unexpected Resolution","school":"Ball State University"},{"name":"ISU Acafellaz","school":"Illinois State University"},{"name":"Counterpoint","school":"Loyola University Chicago"},{"name":"True Men","school":"Truman State University"},{"name":"The Ransom Notes","school":"University of Chicago"}]},{"name":"Midwest QF2","location":"560 Music Center, Washington University in St. Louis, St. Louis, MO","date":"2015-01-31","groups":[{"name":"The Stereotypes","school":"Washington University in St. Louis"},{"name":"The Amateurs","school":"Washington University in St. Louis"},{"name":"Bare Naked Statues","school":"Saint Louis University"},{"name":"Astha","school":"Saint Louis University"},{"name":"Beyond All Reason","school":"Saint Louis University"},{"name":"Decadence","school":"Saint Louis University"},{"name":"No Strings Attached","school":"University of Illinois Urbana-Champaign"},{"name":"Genuine Imitation","school":"University of Kansas"},{"name":"After Dark","school":"Washington University in St. Louis"},{"name":"Mosaic Whispers","school":"Washington University in St. Louis"}]},{"name":"Midwest QF3","location":"George L. Moss Humanities Building, University of Wisconsin-Madison, Madison, WI","date":"2015-02-14","groups":[{"name":"Voices In Your Head","school":"University of Chicago"},{"name":"Naturals","school":"Marquette University"},{"name":"Vocal U","school":"University of Minnesota Twin Cities"},{"name":"Secondary Dominance","school":"Illinois State University"},{"name":"Silence Interrupted","school":"Illinois Wesleyan University"},{"name":"Touch of Class","school":"Illinois Wesleyan University"},{"name":"Smooth Benediction","school":"Mount Marty College"},{"name":"Xtension Chords","school":"University of Illinois Urbana-Champaign"},{"name":"Pitches & Notes","school":"University of Wisconsin-Madison"}]},{"name":"Midwest QF4","location":"Central High School, Springfield, MO","date":"2015-02-28","groups":[{"name":"The Beartones","school":"Missouri State University"},{"name":"Naturelles","school":"University of Missouri"},{"name":"The Hibernotes","school":"Missouri State University"},{"name":"1-2-5","school":"Hastings College"},{"name":"A Cub Bella","school":"Missouri State University"},{"name":"Mulez II Men","school":"University of Central Missouri"},{"name":"Add9","school":"University of Missouri"},{"name":"Mizzou Forte","school":"University of Missouri"},{"name":"Minor Detail","school":"Truman State University"},{"name":"Thundertones","school":"Wheaton College"}]},{"name":"Midwest QF5","location":"DeKalb High School, DeKalb, IL","date":"2015-03-07","groups":[{"name":"Undertones","school":"Northwestern University"},{"name":"Fundamentally Sound","school":"University of Wisconsin-Madison"},{"name":"The Sensasians","school":"Washington University in St. Louis"},{"name":"Northern Sound","school":"Northern Illinois University"},{"name":"Illinois Rip Chords","school":"University of Illinois Urbana-Champaign"},{"name":"The ILL Harmonic","school":"University of Illinois Urbana-Champaign"},{"name":"Bathtub Dogs","school":"University of Nebraska"},{"name":"Rocktavo","school":"University of Nebraska"}]}],"semifinal":{"location":"560 Music Center, Washington University in St. Louis, St. Louis, MO","date":"2015-03-14"}},"Northeast":{"schools":["Berklee College of Music","Harvard University","Ithaca College","Northeastern University","Plymouth State University","University of Hartford","University of Massachusetts Amherst","Macaulay Honors College at CUNY","Hofstra University","New York University","Columbia University","Fordham University","Queens College","SUNY Stony Brook","Emerson College","Boston University","Emmanuel College","Massachusetts College of Liberal Arts","Radcliffe College","SUNY Potsdam","SUNY Purchase","Clarkson University","Cornell University","Rensselaer Polytechnic Institute","University at Albany","Vassar College","Massachusetts Institute of Technology","Olin College of Engineering","Salem State University","Simmons College","Suffolk University"],"quarterfinals":[{"name":"Northeast QF1","location":"Berklee College of Music Performance Center, Boston, MA","date":"2015-02-07","groups":[{"name":"The CharlieChords","school":"Berklee College of Music"},{"name":"Harvard Opportunes","school":"Harvard University"},{"name":"Ithacappella","school":"Ithaca College"},{"name":"Treble on Huntington","school":"Northeastern University"},{"name":"Mixed Emotions","school":"Plymouth State University"},{"name":"L'Shir","school":"University of Hartford"},{"name":"S#arp Attitude","school":"University of Massachusetts Amherst"},{"name":"The Macaulay Triplets","school":"Macaulay Honors College at CUNY"}]},{"name":"Northeast QF2","location":"John Cranford Adams Playhouse, Hofstra University, Hempstead, NY","date":"2015-02-14","groups":[{"name":"Sigma'cappella","school":"Hofstra University"},{"name":"The NYU N'Harmonics","school":"New York University"},{"name":"The Mixtapes","school":"New York University"},{"name":"SHARP","school":"Columbia University"},{"name":"b-Sides","school":"Fordham University"},{"name":"The F#s","school":"Fordham University"},{"name":"The iTones","school":"Queens College"},{"name":"Pipettes","school":"SUNY Stony Brook"}]},{"name":"Northeast QF3","location":"Tsai Performance Center, Boston University, Boston, MA","date":"2015-02-14","groups":[{"name":"Distilled Harmony","school":"Northeastern University"},{"name":"Acappellics Anonymous","school":"Emerson College"},{"name":"UniSons","school":"Northeastern University"},{"name":"BosTones","school":"Boston University"},{"name":"The Dear Abbeys","school":"Boston University"},{"name":"Acapocalypse","school":"Emmanuel College"},{"name":"For Good Measure","school":"Emmanuel College"},{"name":"Allegrettos","school":"Massachusetts College of Liberal Arts"},{"name":"The Downbeats","school":"Northeastern University"},{"name":"The Harvard-Radcliffe Veritones","school":"Radcliffe College"}]},{"name":"Northeast QF4","location":"The Experimental Media & Performing Arts Center, Rensselaer Polytechnic Institute, Troy, NY","date":"2015-02-21","groups":[{"name":"The Potsdam Pointercounts","school":"SUNY Potsdam"},{"name":"Choral Pleasure","school":"SUNY Purchase"},{"name":"The Potsdam Pitches","school":"SUNY Potsdam"},{"name":"Ultravioletones","school":"Clarkson University"},{"name":"The Key Elements","school":"Cornell University"},{"name":"Partial Credit","school":"Rensselaer Polytechnic Institute"},{"name":"Rusty Pipes","school":"Rensselaer Polytechnic Institute"},{"name":"Pitch Please","school":"University at Albany"},{"name":"Serendipity","school":"University at Albany"},{"name":"Stay Tuned","school":"SUNY Potsdam"}]},{"name":"Northeast QF5","location":"Kresge Auditorium, Massachusetts Institute of Technology, Cambridge, MA","date":"2015-02-28","groups":[{"name":"The Nor'easters","school":"Northeastern University"},{"name":"Vassar Devils","school":"Vassar College"},{"name":"Pitch, Please!","school":"Northeastern University"},{"name":"The Touchstones","school":"Cornell University"},{"name":"Chorallaries","school":"Massachusetts Institute of Technology"},{"name":"PowerChords","school":"Olin College of Engineering"},{"name":"SSockapella","school":"Salem State University"},{"name":"Simmons Sirens","school":"Simmons College"},{"name":"Ramifications","school":"Suffolk University"},{"name":"UHarmonies","school":"University of Hartford"}]}],"semifinal":{"location":"Boston Symphony Hall, Boston, MA","date":"2015-03-22"}},"South":{"schools":["University of Central Florida","University of Miami","Florida International University","Nova Southeastern University","University of Texas at Austin","Emory University","University of North Carolina at Greensboro","University of Georgia","Georgia Institute of Technology","Georgia College and State University","Baylor University","Belmont University","James Madison University","Elon University","Roanoke College","Texas A&M University","University of Kentucky","University of North Texas","The University of Tennessee, Knoxville","Vanderbilt University","Florida State University","University of Florida","North Carolina State University","University of North Carolina at Chapel Hill","Christopher Newport University","University of Richmond"],"quarterfinals":[{"name":"South QF1","location":"University High School, Orlando, FL","date":"2015-01-24","groups":[{"name":"Voicebox","school":"University of Central Florida"},{"name":"BisCaydence","school":"University of Miami"},{"name":"Gemini Blvd.","school":"University of Central Florida"},{"name":"HEARTbeats","school":"Florida International University"},{"name":"The Riff Tides","school":"Nova Southeastern University"},{"name":"KeyHarmony","school":"University of Central Florida"},{"name":"Above the Keys","school":"University of Miami"},{"name":"Tufaan","school":"University of Miami"},{"name":"Beauties and the Beat","school":"University of Texas at Austin"},{"name":"Texas Songhorns","school":"University of Texas at Austin"}]},{"name":"South QF2","location":"The Morton Theatre, University of Georgia, Athens, GA","date":"2015-01-31","groups":[{"name":"Aural Pleasure","school":"Emory University"},{"name":"Sapphires","school":"University of North Carolina at Greensboro"},{"name":"Noteworthy","school":"University of Georgia"},{"name":"Dooley Noted","school":"Emory University"},{"name":"The Cat's Meow","school":"Georgia College and State University"},{"name":"Infinite Harmony","school":"Georgia Institute of Technology"},{"name":"Nothin' but Treble","school":"Georgia Institute of Technology"},{"name":"Chariots","school":"University of North Carolina at Greensboro"}]},{"name":"South QF3","location":"Natalie L. Haslam Music Center, University of Tennessee, Knoxville, TN","date":"2015-02-07","groups":[{"name":"VirtuOSO","school":"Baylor University"},{"name":"The Beltones","school":"Belmont University"},{"name":"The BluesTones","school":"James Madison University"},{"name":"Sweet Signatures","school":"Elon University"},{"name":"The RoaNotes","school":"Roanoke College"},{"name":"HardChord DynaMix","school":"Texas A&M University"},{"name":"Paws and Listen","school":"University of Kentucky"},{"name":"The Green Tones","school":"University of North Texas"},{"name":"VOLume","school":"The University of Tennessee, Knoxville"},{"name":"Harmonic Notion","school":"Vanderbilt University"}]},{"name":"South QF4","location":"Curtis M. Phillips Center for the Performing Arts, University of Florida, Gainesville, FL","date":"2015-02-14","groups":[{"name":"Acaphiliacs","school":"Florida State University"},{"name":"All-Night Yahtzee","school":"Florida State University"},{"name":"AcaBelles","school":"Florida State University"},{"name":"Coda","school":"Florida State University"},{"name":"No Southern Accent","school":"University of Florida"},{"name":"Standing Room Only","school":"University of Florida"},{"name":"The Sedoctaves","school":"University of Florida"},{"name":"The Staff","school":"University of Florida"},{"name":"Tone Def","school":"University of Florida"},{"name":"reVOLution","school":"The University of Tennessee, Knoxville"}]},{"name":"South QF5","location":"Baldwin Auditorium, Duke University, Durham, NC","date":"2015-02-21","groups":[{"name":"Grains of Time","school":"North Carolina State University"},{"name":"The UNC Walk-Ons","school":"University of North Carolina at Chapel Hill"},{"name":"Acappology","school":"North Carolina State University"},{"name":"Extreme Measures","school":"Christopher Newport University"},{"name":"The Madison Project","school":"James Madison University"},{"name":"Ladies in Red","school":"North Carolina State University"},{"name":"Wolfgang","school":"North Carolina State University"},{"name":"The Oct\u0101ves","school":"University of Richmond"}]}],"semifinal":{"location":"Curtis M. Phillips Center for the Performing Arts, University of Florida, Gainesville, FL","date":"2015-03-21"}},"United Kingdom":{"schools":["King's College London","University of Exeter","University of St. Andrews","Durham University","Imperial College London","Trinity College Dublin","University of Oxford"],"quarterfinals":[],"semifinal":{"location":"Great Hall, Imperial College London, London","date":"2015-01-24"}},"West":{"schools":["Central Washington University","Pacific Lutheran University","Brigham Young University","Gonzaga University","University of British Columbia","University of Utah","Western Washington University","University of Southern California","University of California, Los Angeles","University of California, San Diego","California Polytechnic State University, San Luis Obispo","Northern Arizona University","San Diego State University","University of California, Riverside","University of Oregon","Western Oregon University","Linn-Benton Community College","Oregon State University","Portland State University","Willamette University","Chapman University","University of California, Santa Cruz","Mt. San Antonio College","Stanford University","University of California, Berkeley","University of California, Davis","University of Arizona","Arizona State University"],"quarterfinals":[{"name":"West QF1","location":"Western Washington University Performing Arts Center, Bellingham, WA","date":"2015-01-24","groups":[{"name":"Boots 'n' Cats","school":"Central Washington University"},{"name":"PLUtonic","school":"Pacific Lutheran University"},{"name":"Beyond Measure","school":"Brigham Young University"},{"name":"Fantastic Forte","school":"Central Washington University"},{"name":"Nada Cantata","school":"Central Washington University"},{"name":"Big Bing Theory","school":"Gonzaga University"},{"name":"Fermata","school":"University of British Columbia"},{"name":"Infrared","school":"University of Utah"},{"name":"Major Treble","school":"Western Washington University"},{"name":"Rebel Clef","school":"Western Washington University"}]},{"name":"West QF2","location":"Mandeville Auditorium, University of California, San Diego, La Jolla, CA","date":"2015-01-31","groups":[{"name":"The SoCal VoCals","school":"University of Southern California"},{"name":"ScatterTones","school":"University of California, Los Angeles"},{"name":"The Beat @ UCSD","school":"University of California, San Diego"},{"name":"That's The Key","school":"California Polytechnic State University, San Luis Obispo"},{"name":"The Axecidentals","school":"Northern Arizona University"},{"name":"Vocal Vixens","school":"San Diego State University"},{"name":"Medleys","school":"University of California, Los Angeles"},{"name":"Not So Sharp","school":"University of California, Riverside"},{"name":"Daughters of Triton","school":"University of California, San Diego"},{"name":"Troy Tones","school":"University of Southern California"}]},{"name":"West QF3","location":"Rolling Hills Community Church, Tualatin, OR","date":"2015-01-31","groups":[{"name":"Mind the Gap","school":"University of Oregon"},{"name":"On the Rocks","school":"University of Oregon"},{"name":"15 Miles West","school":"Western Oregon University"},{"name":"Blue Light Special","school":"Linn-Benton Community College"},{"name":"The Sirens","school":"Linn-Benton Community College"},{"name":"Outspoken","school":"Oregon State University"},{"name":"Power Chord","school":"Oregon State University"},{"name":"The Green Note","school":"Portland State University"},{"name":"Suspended","school":"Western Oregon University"},{"name":"HeadBand","school":"Willamette University"}]},{"name":"West QF4","location":"Wheeler Auditorium, University of California, Berkeley, Berkeley, CA","date":"2015-02-07","groups":[{"name":"SoundCheck","school":"Chapman University"},{"name":"Cloud Nine","school":"University of California, Santa Cruz"},{"name":"Fermata Nowhere","school":"Mt. San Antonio College"},{"name":"Men of Harmony","school":"Chapman University"},{"name":"Simply Vocale","school":"Chapman University"},{"name":"HERmonic","school":"Pacific Lutheran University"},{"name":"Mendicants","school":"Stanford University"},{"name":"Mixed Company","school":"Stanford University"},{"name":"Artists in Resonance","school":"University of California, Berkeley"},{"name":"The Afterglow","school":"University of California, Davis"}]},{"name":"West QF5","location":"Tempe Center for the Arts, Tempe, AZ","date":"2015-02-21","groups":[{"name":"CatCall","school":"University of Arizona"},{"name":"TriTones","school":"University of California, San Diego"},{"name":"Priority Male","school":"Arizona State University"},{"name":"The Pitchforks","school":"Arizona State University"},{"name":"The TEMPEtations","school":"Arizona State University"},{"name":"Elevation","school":"Northern Arizona University"},{"name":"The Highlanders","school":"Northern Arizona University"},{"name":"Amplified","school":"University of Arizona"},{"name":"Dolce Voces","school":"University of Arizona"},{"name":"Noteriety","school":"University of Arizona"}]}],"semifinal":{"location":"Bridges Auditorium, Pomona College, Claremont, CA","date":"2015-03-28"}}},"finals":{"location":"The Beacon Theatre, Manhattan, NY","date":"2015-04-18"},"notes":"Source is a results PDF (not a pre-season lineup), so all data is extracted from competition result listings. This was the 19th ICCA season. Key observations: (1) UK region had no quarterfinals in 2015 \u2014 only a semifinal. UK QFs were not introduced until 2016. Schools are derived from semifinal participants. (2) 'Residential College in the Arts and Humanities RCAHppella' in Great Lakes QF3 \u2014 this is a residential college within Michigan State University. Listed school as Michigan State University since that is the parent institution. (3) 'Radcliffe College' listed for 'The Harvard-Radcliffe Veritones' in Northeast QF3 \u2014 Radcliffe College merged with Harvard in 1999 but the PDF uses the Radcliffe name. Preserved as printed. (4) 'The reen Tones' in South QF3 was a typo in the PDF for 'The Green Tones' (University of North Texas) \u2014 corrected. (5) 'William E. Macaulay Honors College' in Northeast QF1 \u2014 mapped to 'Macaulay Honors College at CUNY' for consistency. (6) Penn State listed as 'Pennsylvania State University' in the PDF \u2014 mapped to 'Penn State University' as the more common name. (7) Several groups appear in both QF results and semifinal/finals results \u2014 only QF assignments are used for the quarterfinals entries. (8) The National Wild Card round is documented in the PDF but not included in the regional structure since it draws from multiple regions. (9) South QF1 includes University of Texas at Austin groups (Beauties and the Beat, Texas Songhorns) \u2014 these Texas groups competed in the South region in 2015. (10) 'SUNY Stony Brook' mapped to school name as printed. (11) Duke University appears in the South schools list because South QF5 was held at Duke, though no Duke groups competed \u2014 removed from schools list since no Duke groups are in any QF. Actually Duke hosted the venue but had no competing groups, so Duke is NOT in the schools list."},
  2020: {"year":2020,"season":"2019-2020","source":"2020 ICCA Lineup PDF, posted November 15, 2019. Varsity Vocals official competitor listing. UK placements included; US placements posted same date.","regions":{"United Kingdom":{"schools":["Cardiff University","Newcastle University","University of Nottingham","University of Sheffield","University of Bristol","University of Exeter","University of St. Andrews","University of Aberdeen","Durham University","University of Edinburgh","University of Leeds","University of Manchester","University of Cambridge","Guildhall School of Music and Drama","Imperial College London","King's College London","University of Oxford"],"quarterfinals":[{"name":"United Kingdom QF1","location":"Nottingham Playhouse","date":"2020-01-19","groups":[{"name":"DeciBelles","school":"Cardiff University"},{"name":"Acappellads","school":"Cardiff University"},{"name":"Vox","school":"Cardiff University"},{"name":"Tune Army","school":"Newcastle University"},{"name":"NuMen","school":"Newcastle University"},{"name":"Angels Of The North","school":"Newcastle University"},{"name":"Unplugged","school":"University of Nottingham"},{"name":"Steelworks","school":"University of Sheffield"}]},{"name":"United Kingdom QF2","location":"Exeter Northcott Theatre","date":"2020-01-26","groups":[{"name":"Academy","school":"University of Bristol"},{"name":"Pitch Fight","school":"University of Bristol"},{"name":"The False Relations","school":"University of Exeter"},{"name":"The Bluebelles","school":"University of Exeter"},{"name":"Illuminations A Cappella","school":"University of Exeter"},{"name":"Semi-Toned","school":"University of Exeter"},{"name":"Sweet Nothings","school":"University of Exeter"},{"name":"RadioOctave","school":"University of Nottingham"}]},{"name":"United Kingdom QF3","location":"Church Hill Theatre","date":"2020-02-01","groups":[{"name":"The Other Guys","school":"University of St. Andrews"},{"name":"Aberpella","school":"University of Aberdeen"},{"name":"Killer Quines","school":"University of Aberdeen"},{"name":"Northern Lights DU A Cappella","school":"Durham University"},{"name":"Cloud Nine","school":"University of Edinburgh"},{"name":"Licence to Trill","school":"University of Edinburgh"},{"name":"Tone Up","school":"University of Edinburgh"},{"name":"The Songsmiths","school":"University of Leeds"},{"name":"The Accidentals","school":"University of St. Andrews"},{"name":"The Alleycats","school":"University of St. Andrews"}]},{"name":"United Kingdom QF4","location":"The Clapham Grand","date":"2020-02-09","groups":[{"name":"Alvarium","school":"University of Manchester"},{"name":"Aca-Pocalypse","school":"University of Nottingham"},{"name":"The Bristol Suspensions","school":"University of Bristol"},{"name":"Cadenza","school":"University of Cambridge"},{"name":"The Conchords","school":"Guildhall School of Music and Drama"},{"name":"The Techtonics","school":"Imperial College London"},{"name":"The Rolling Tones","school":"King's College London"},{"name":"The Oxford Alternotives","school":"University of Oxford"}]}],"semifinal":null},"Central":{"schools":["Binghamton University","SUNY Oneonta","Duquesne University","University of Rochester","Ithaca College","Cornell University","Rensselaer Polytechnic Institute","University at Albany","SUNY at Buffalo","The College of Saint Rose","Clarkson University","University of Pittsburgh","Carnegie Mellon University","Penn State University","SUNY Potsdam","Rochester Institute of Technology","McMaster University","SUNY Fredonia","Monroe Community College","University of Western Ontario","University of Waterloo","Wilfrid Laurier University","Western University","Ryerson University","University of Toronto"],"quarterfinals":[{"name":"Central QF1","location":"Binghamton University","date":"2020-01-25","groups":[{"name":"Harpur Harpeggios","school":"Binghamton University"},{"name":"Hooked On Tonics","school":"SUNY Oneonta"},{"name":"Mic Drop A Cappella","school":"Duquesne University"},{"name":"Midnight Ramblers","school":"University of Rochester"},{"name":"Note to Self","school":"Binghamton University"},{"name":"Pitch Slapped","school":"SUNY Oneonta"},{"name":"Premium Blend","school":"Ithaca College"},{"name":"The Accidentals","school":"Ithaca College"},{"name":"The Class Notes","school":"Cornell University"},{"name":"The Rhythm Method","school":"Binghamton University"}]},{"name":"Central QF2","location":"Rensselaer Polytechnic Institute","date":"2020-01-25","groups":[{"name":"Partial Credit A Cappella","school":"Rensselaer Polytechnic Institute"},{"name":"Pitch Please Acapella","school":"University at Albany"},{"name":"Serendipity","school":"University at Albany"},{"name":"The Buffalo Chips","school":"SUNY at Buffalo"},{"name":"The Girls Next Door","school":"The College of Saint Rose"},{"name":"The Golden Notes","school":"The College of Saint Rose"},{"name":"The Rensselyrics","school":"Rensselaer Polytechnic Institute"},{"name":"The Rusty Pipes","school":"Rensselaer Polytechnic Institute"},{"name":"Understaffed","school":"Clarkson University"}]},{"name":"Central QF3","location":"University of Pittsburgh","date":"2020-02-01","groups":[{"name":"C Flat Run","school":"University of Pittsburgh"},{"name":"Counterpoint","school":"Carnegie Mellon University"},{"name":"None of the Above","school":"Penn State University"},{"name":"Pitches & Tones","school":"University of Pittsburgh"},{"name":"Pittch Please","school":"University of Pittsburgh"},{"name":"Soundbytes","school":"Carnegie Mellon University"},{"name":"Sounds Like Treble","school":"University of Pittsburgh"},{"name":"The Pitt Pendulums","school":"University of Pittsburgh"},{"name":"The Songburghs","school":"University of Pittsburgh"},{"name":"The Treblemakers","school":"Carnegie Mellon University"}]},{"name":"Central QF4","location":"University of Rochester","date":"2020-02-15","groups":[{"name":"A Sharp Arrangement","school":"SUNY Potsdam"},{"name":"Encore","school":"Rochester Institute of Technology"},{"name":"PitchSlapped","school":"McMaster University"},{"name":"Premium Blend","school":"SUNY Fredonia"},{"name":"Proof of Purchase","school":"Rochester Institute of Technology"},{"name":"Stay Tuned","school":"SUNY Potsdam"},{"name":"The MacaFellas","school":"McMaster University"},{"name":"The Potsdam Pitches","school":"SUNY Potsdam"},{"name":"The Potsdam Pointercounts","school":"SUNY Potsdam"},{"name":"Tributones","school":"Monroe Community College"}]},{"name":"Central QF5","location":"University of Waterloo","date":"2020-02-22","groups":[{"name":"Equivox","school":"University of Western Ontario"},{"name":"In Full Colour","school":"University of Waterloo"},{"name":"Noteworthy","school":"Wilfrid Laurier University"},{"name":"Repercussions","school":"Western University"},{"name":"Ryenamics","school":"Ryerson University"},{"name":"Surround Sound","school":"University of Toronto"},{"name":"The AcaBellas","school":"University of Waterloo"},{"name":"The Unaccompanied Minors","school":"University of Waterloo"},{"name":"The Water Boys","school":"University of Waterloo"},{"name":"Tunes Beats Awesome","school":"University of Toronto"}]}],"semifinal":null},"Great Lakes":{"schools":["Central Michigan University","Loyola University Chicago","Oakland University","Michigan State University","Northwestern University","Macomb Community College","University of Chicago","Illinois Institute of Technology","University of Michigan","Grand Valley State University","Wayne State University","Illinois State University","University of Wisconsin-Madison","University of Illinois Urbana-Champaign","Illinois Wesleyan University","University of Illinois at Chicago","University of Illinois","North Central College","Northern Illinois University","Marquette University","University of Minnesota Twin Cities","University of Minnesota","Carthage College","Augsburg University","Alverno College"],"quarterfinals":[{"name":"Great Lakes QF1","location":"University of Chicago","date":"2020-01-25","groups":[{"name":"Central Harmony","school":"Central Michigan University"},{"name":"Counterpoint Acapella","school":"Loyola University Chicago"},{"name":"Gold Vibrations","school":"Oakland University"},{"name":"Ladies First A Cappella","school":"Michigan State University"},{"name":"Purple Haze a Cappella","school":"Northwestern University"},{"name":"State of Fifths","school":"Michigan State University"},{"name":"The Expressions","school":"Macomb Community College"},{"name":"The Ransom Notes","school":"University of Chicago"},{"name":"Unaccompanied Women","school":"University of Chicago"},{"name":"Z minor","school":"Illinois Institute of Technology"}]},{"name":"Great Lakes QF2","location":"University of Michigan","date":"2020-02-08","groups":[{"name":"58 Greene","school":"University of Michigan"},{"name":"Amazin' Blue","school":"University of Michigan"},{"name":"Capital Green","school":"Michigan State University"},{"name":"DJs A Cappella","school":"University of Michigan"},{"name":"Euphoria","school":"Grand Valley State University"},{"name":"Fish N Chips","school":"Central Michigan University"},{"name":"Maize Mirchi A Cappella","school":"University of Michigan"},{"name":"Melodytroit","school":"Wayne State University"},{"name":"RCAHppella","school":"Michigan State University"},{"name":"The Sopranos","school":"University of Michigan"}]},{"name":"Great Lakes QF3","location":"Illinois State University","date":"2020-02-15","groups":[{"name":"Clef Hangers","school":"Illinois State University"},{"name":"Fundamentally Sound","school":"University of Wisconsin-Madison"},{"name":"No Strings Attached","school":"University of Illinois Urbana-Champaign"},{"name":"On the Brink of Normal","school":"Illinois State University"},{"name":"Secondary Dominance","school":"Illinois State University"},{"name":"Silence Interrupted","school":"Illinois Wesleyan University"},{"name":"The Illinois Rip Chords","school":"University of Illinois Urbana-Champaign"},{"name":"The Xtension Chords","school":"University of Illinois Urbana-Champaign"},{"name":"Touch of Class","school":"Illinois Wesleyan University"},{"name":"Voices","school":"University of Chicago"}]},{"name":"Great Lakes QF4","location":"DeKalb, IL","date":"2020-02-22","groups":[{"name":"Acafellaz","school":"Illinois State University"},{"name":"Downtown Voices","school":"University of Illinois at Chicago"},{"name":"No Comment","school":"University of Illinois"},{"name":"One Note Stand","school":"North Central College"},{"name":"Paravox","school":"Northern Illinois University"},{"name":"Sonata Problem","school":"North Central College"},{"name":"The Harmelodics","school":"Northern Illinois University"},{"name":"The Marquette Naturals","school":"Marquette University"},{"name":"The Meladies","school":"Marquette University"},{"name":"The Undertones","school":"Northwestern University"}]},{"name":"Great Lakes QF5","location":"University of Wisconsin","date":"2020-02-29","groups":[{"name":"7 Days A Cappella","school":"University of Minnesota Twin Cities"},{"name":"Basses Wild","school":"University of Minnesota"},{"name":"Carthachords","school":"Carthage College"},{"name":"Convocadence","school":"Augsburg University"},{"name":"Nova","school":"Alverno College"},{"name":"Perfectly Authentic","school":"Carthage College"},{"name":"Pitches & Notes","school":"University of Wisconsin-Madison"},{"name":"The Enchantments","school":"University of Minnesota"},{"name":"Under A-Rest","school":"University of Wisconsin-Madison"},{"name":"Urban Sound A Cappella Ensemble","school":"University of Minnesota Twin Cities"}]}],"semifinal":null},"Mid-Atlantic":{"schools":["Christopher Newport University","George Mason University","The College of William & Mary","Virginia Commonwealth University","The Catholic University of America","The George Washington University","University of Mary Washington","Rutgers University","Lafayette College","Monmouth University","Westminster Choir College","Rider University","The College of New Jersey","William Paterson University","University of Maryland Baltimore County","James Madison University","University of Delaware","University of Maryland, College Park","Salisbury University","Johns Hopkins University","Millersville University","Susquehanna University","West Chester University","Lehigh University","York College of Pennsylvania","Rowan University","Stockton University","Drexel University","Temple University","Elizabethtown College","Villanova University","Towson University"],"quarterfinals":[{"name":"Mid-Atlantic QF1","location":"The George Washington University","date":"2020-01-25","groups":[{"name":"Extreme Measures","school":"Christopher Newport University"},{"name":"Mason Some Noise","school":"George Mason University"},{"name":"No Ceiling","school":"The College of William & Mary"},{"name":"Patriot Pitches","school":"George Mason University"},{"name":"Ramifications","school":"Virginia Commonwealth University"},{"name":"Take Note","school":"Christopher Newport University"},{"name":"Take Note A Cappella","school":"The Catholic University of America"},{"name":"The GW Pitches","school":"The George Washington University"},{"name":"The GW Vibes","school":"The George Washington University"},{"name":"The One Note Stand","school":"University of Mary Washington"}]},{"name":"Mid-Atlantic QF2","location":"The College of New Jersey","date":"2020-02-01","groups":[{"name":"Casual Harmony","school":"Rutgers University"},{"name":"Lafayette Chorduroys","school":"Lafayette College"},{"name":"Rutgers RAAG","school":"Rutgers University"},{"name":"Sea Sharps","school":"Monmouth University"},{"name":"Soulfege A Cappella","school":"Lafayette College"},{"name":"The Deaftones","school":"Westminster Choir College"},{"name":"The Rolling Tones","school":"Rider University"},{"name":"The Trentones","school":"The College of New Jersey"},{"name":"Til Further Notes","school":"Rider University"},{"name":"WillHarmonics","school":"William Paterson University"}]},{"name":"Mid-Atlantic QF3","location":"Johns Hopkins University","date":"2020-02-08","groups":[{"name":"Cleftomaniacs","school":"University of Maryland Baltimore County"},{"name":"Exit 245","school":"James Madison University"},{"name":"Mama's Boys","school":"University of Maryland Baltimore County"},{"name":"MelUDees","school":"University of Delaware"},{"name":"PandemoniUM a Cappella","school":"University of Maryland, College Park"},{"name":"Squawkappella","school":"Salisbury University"},{"name":"The Octopodes","school":"Johns Hopkins University"},{"name":"The Stilettos","school":"University of Maryland Baltimore County"},{"name":"The Treblemakers","school":"University of Maryland, College Park"},{"name":"Vocal Chords","school":"Johns Hopkins University"}]},{"name":"Mid-Atlantic QF4","location":"West Chester University","date":"2020-02-15","groups":[{"name":"Chromatic Expansion","school":"Millersville University"},{"name":"Harmonic Combustion","school":"Susquehanna University"},{"name":"High Street Harmonix","school":"West Chester University"},{"name":"Lehigh Melismatics","school":"Lehigh University"},{"name":"Lehigh's Off The Record","school":"Lehigh University"},{"name":"Rhapsody","school":"York College of Pennsylvania"},{"name":"Rowan Vocals (RoVo)","school":"Rowan University"},{"name":"Stockapella","school":"Stockton University"},{"name":"The YChromes","school":"University of Delaware"},{"name":"Under A Rest","school":"West Chester University"}]},{"name":"Mid-Atlantic QF5","location":"Drexel University","date":"2020-02-23","groups":[{"name":"8 to the Bar","school":"Drexel University"},{"name":"Drexel Cleftomaniacs","school":"Drexel University"},{"name":"Drexel TrebleMakers","school":"Drexel University"},{"name":"LiaChorus","school":"Temple University"},{"name":"Melica","school":"Elizabethtown College"},{"name":"Pitch, Please","school":"Temple University"},{"name":"Singchronize","school":"Temple University"},{"name":"The Supernovas","school":"Villanova University"},{"name":"Untitled","school":"Towson University"},{"name":"Vocal Point","school":"University of Delaware"}]}],"semifinal":null},"Midwest":{"schools":["Bowling Green State University","The Ohio State University","Case Western Reserve University","Kent State University","Ohio University","College of Wooster","Baldwin-Wallace University","Saint Louis University","Millikin University","Washington University in St. Louis","University of Central Missouri","Truman State University","Miami University","Eastern Illinois University","Indiana University-Purdue University Indianapolis","Purdue University","Ball State University","University of Cincinnati","University of Dayton","Kenyon College","University of Akron","Missouri State University","Missouri University of Science and Technology","University of Missouri","Southeast Missouri State University"],"quarterfinals":[{"name":"Midwest QF1","location":"Case Western Reserve University","date":"2020-01-25","groups":[{"name":"AcousChicks","school":"Bowling Green State University"},{"name":"Buck That!","school":"The Ohio State University"},{"name":"Case in Point","school":"Case Western Reserve University"},{"name":"Dhamakapella","school":"Case Western Reserve University"},{"name":"Flash Harmony","school":"Kent State University"},{"name":"New Chords on the Block","school":"Ohio University"},{"name":"Scots In Harmony","school":"College of Wooster"},{"name":"S\u014cL","school":"Baldwin-Wallace University"},{"name":"Ten40 Acappella","school":"Bowling Green State University"},{"name":"The Kent Clarks","school":"Kent State University"}]},{"name":"Midwest QF2","location":"Washington University in St. Louis","date":"2020-02-08","groups":[{"name":"Astha A Cappella","school":"Saint Louis University"},{"name":"Bare Naked Statues","school":"Saint Louis University"},{"name":"Beyond All Reason","school":"Saint Louis University"},{"name":"Decadence A Cappella","school":"Saint Louis University"},{"name":"Dissonance","school":"Millikin University"},{"name":"Mosaic Whispers","school":"Washington University in St. Louis"},{"name":"RainbowTones","school":"University of Central Missouri"},{"name":"Six Eight Christian A Cappella","school":"Saint Louis University"},{"name":"Sur Taal Laya A Cappella","school":"Washington University in St. Louis"},{"name":"Sweet Nothings","school":"Truman State University"}]},{"name":"Midwest QF3","location":"Ball State University","date":"2020-02-22","groups":[{"name":"Eastern Euphonics","school":"Eastern Illinois University"},{"name":"Just Duet","school":"Miami University"},{"name":"Miami University TrebleMakers","school":"Miami University"},{"name":"Note to Self","school":"Ball State University"},{"name":"On a Side Note","school":"Indiana University-Purdue University Indianapolis"},{"name":"Purdue Soundtracks Acapella","school":"Purdue University"},{"name":"Sedoctave","school":"Ball State University"},{"name":"The Parallels A Cappella","school":"Ball State University"},{"name":"UC Avocalypse","school":"University of Cincinnati"},{"name":"UC Vocaholics","school":"University of Cincinnati"}]},{"name":"Midwest QF4","location":"Centerville High School","date":"2020-02-22","groups":[{"name":"Audio Pilots","school":"University of Dayton"},{"name":"Flying Solos","school":"University of Dayton"},{"name":"Majors & Minors","school":"The Ohio State University"},{"name":"Ransom Notes","school":"Kenyon College"},{"name":"Remedy","school":"University of Dayton"},{"name":"Rhythm & Roos A Cappella","school":"University of Akron"},{"name":"Scarlet and Grace Notes","school":"The Ohio State University"},{"name":"Sound of Science A Cappella","school":"The Ohio State University"},{"name":"The Ohio State of Mind","school":"The Ohio State University"},{"name":"Underscore","school":"University of Dayton"}]},{"name":"Midwest QF5","location":"Missouri State University","date":"2020-02-29","groups":[{"name":"A Cub Bella","school":"Missouri State University"},{"name":"After Dark","school":"Washington University in St. Louis"},{"name":"Miner Key","school":"Missouri University of Science and Technology"},{"name":"Minor Detail","school":"Truman State University"},{"name":"Mizzou Forte","school":"University of Missouri"},{"name":"Redhawk Rhythm","school":"Southeast Missouri State University"},{"name":"The Beartones","school":"Missouri State University"},{"name":"The Hibernotes","school":"Missouri State University"},{"name":"The Naturelles","school":"University of Missouri"},{"name":"The Sensasians","school":"Washington University in St. Louis"}]}],"semifinal":null},"Northeast":{"schools":["Yale University","University of Hartford","Roger Williams University","University of Connecticut","Champlain College","Central Connecticut State University","Quinnipiac University","Wesleyan University","Springfield College","Emerson College","University of New Hampshire","Boston University","Northeastern University","Berklee College of Music","Harvard University","University of Massachusetts Lowell","Emmanuel College","Olin College of Engineering","Massachusetts Institute of Technology","Simmons University","New York University","Pace University","Hunter College","Worcester Polytechnic Institute","Fordham University","Macaulay Honors College at CUNY","SUNY New Paltz","Manhattanville College","Hofstra University","College of the Holy Cross","Wagner College"],"quarterfinals":[{"name":"Northeast QF1","location":"University of Hartford","date":"2020-02-08","groups":[{"name":"Cadence of Yale","school":"Yale University"},{"name":"HartAttack A Cappella","school":"University of Hartford"},{"name":"Hawkward","school":"Roger Williams University"},{"name":"L'Shir A Cappella","school":"University of Hartford"},{"name":"Notes Over Storrs","school":"University of Connecticut"},{"name":"Purposeful Dissonance","school":"Champlain College"},{"name":"The AcaBellas","school":"Central Connecticut State University"},{"name":"The Legends A Cappella","school":"Quinnipiac University"},{"name":"Triple Major","school":"Wesleyan University"},{"name":"Vocal Pride","school":"Springfield College"}]},{"name":"Northeast QF2","location":"Berklee College of Music","date":"2020-02-15","groups":[{"name":"Acappellics Anonymous","school":"Emerson College"},{"name":"Alabaster Blue","school":"University of New Hampshire"},{"name":"Boston University Allegrettos","school":"Boston University"},{"name":"Distilled Harmony","school":"Northeastern University"},{"name":"Pitch, Please!","school":"Northeastern University"},{"name":"The CharlieChords","school":"Berklee College of Music"},{"name":"The Dear Abbeys","school":"Boston University"},{"name":"The Harvard-Radcliffe Veritones","school":"Harvard University"},{"name":"The Hawkettes","school":"University of Massachusetts Lowell"},{"name":"Treble Threat","school":"Berklee College of Music"}]},{"name":"Northeast QF3","location":"Berklee College of Music","date":"2020-02-29","groups":[{"name":"Boston University Treblemakers","school":"Boston University"},{"name":"BosTones","school":"Boston University"},{"name":"FenHarmonics","school":"Emmanuel College"},{"name":"Hawkapella","school":"University of Massachusetts Lowell"},{"name":"On The Vox","school":"Berklee College of Music"},{"name":"PowerChords","school":"Olin College of Engineering"},{"name":"The Chorallaries of MIT","school":"Massachusetts Institute of Technology"},{"name":"The Harvard LowKeys","school":"Harvard University"},{"name":"The Sirens","school":"Simmons University"},{"name":"The Unisons","school":"Northeastern University"}]},{"name":"Northeast QF4","location":"New York Society for Ethical Culture","date":"2020-03-07","groups":[{"name":"Cleftomaniacs","school":"New York University"},{"name":"FREQUENCY","school":"Pace University"},{"name":"Hawkappella","school":"Hunter College"},{"name":"The Audiophiles","school":"Worcester Polytechnic Institute"},{"name":"The F Sharps","school":"Fordham University"},{"name":"The Macaulay Triplets","school":"Macaulay Honors College at CUNY"},{"name":"The Mixtapes","school":"New York University"},{"name":"The Vocaholics","school":"New York University"},{"name":"Tonal Recall","school":"Pace University"},{"name":"Vocollision","school":"New York University"}]},{"name":"Northeast QF5","location":"Hofstra University","date":"2020-03-14","groups":[{"name":"Absolut A Cappella","school":"SUNY New Paltz"},{"name":"Knightingales","school":"Manhattanville College"},{"name":"Makin' Treble","school":"Hofstra University"},{"name":"Satin Dolls","school":"Fordham University"},{"name":"Sigma'cappella","school":"Hofstra University"},{"name":"Sons of Pitches","school":"College of the Holy Cross"},{"name":"The CrescendBros","school":"Manhattanville College"},{"name":"The Fordham Hot Notes","school":"Fordham University"},{"name":"The Hofbeats","school":"Hofstra University"},{"name":"Vocal Synergy","school":"Wagner College"}]}],"semifinal":null},"South":{"schools":["East Tennessee State University","University of Memphis","The University of Tennessee, Knoxville","North Carolina State University","High Point University","Duke University","University of North Carolina at Chapel Hill","Elon University","University of Alabama at Birmingham","University of North Carolina at Charlotte","Washington and Lee University","Vanderbilt University","Clayton State University","Georgia Institute of Technology","Belmont University","University of Georgia","Tulane University","Florida State University","University of South Carolina","University of Central Florida","Florida International University","University of Miami","University of South Florida","University of Florida","University of Tampa","Nova Southeastern University"],"quarterfinals":[{"name":"South QF1","location":"The University of Tennessee","date":"2020-01-25","groups":[{"name":"Ascension","school":"East Tennessee State University"},{"name":"ETSU Swashbucklers","school":"East Tennessee State University"},{"name":"Greyscale","school":"East Tennessee State University"},{"name":"Harmonium","school":"East Tennessee State University"},{"name":"Resonance","school":"University of Memphis"},{"name":"The Volatiles","school":"The University of Tennessee, Knoxville"},{"name":"UT Singers","school":"The University of Tennessee, Knoxville"},{"name":"VOLT","school":"The University of Tennessee, Knoxville"},{"name":"VOLume","school":"The University of Tennessee, Knoxville"}]},{"name":"South QF2","location":"The Carolina Theater","date":"2020-02-01","groups":[{"name":"Acappology","school":"North Carolina State University"},{"name":"Grains of Time","school":"North Carolina State University"},{"name":"Ladies in Red","school":"North Carolina State University"},{"name":"Offbeats","school":"High Point University"},{"name":"Rhythm & Blue","school":"Duke University"},{"name":"Tar Heel Voices","school":"University of North Carolina at Chapel Hill"},{"name":"The Tarpeggios","school":"University of North Carolina at Chapel Hill"},{"name":"Toccatatones","school":"High Point University"},{"name":"Vital Signs","school":"Elon University"},{"name":"Wolfgang A Cappella","school":"North Carolina State University"}]},{"name":"South QF3","location":"The Morton Theatre","date":"2020-02-08","groups":[{"name":"Beyond Measures A Cappella","school":"University of Alabama at Birmingham"},{"name":"Codachrome","school":"University of North Carolina at Charlotte"},{"name":"General Admission","school":"Washington and Lee University"},{"name":"Harmonic Notion","school":"Vanderbilt University"},{"name":"Lochs & Keys","school":"Clayton State University"},{"name":"Nothin' but Treble","school":"Georgia Institute of Technology"},{"name":"Pitchmen","school":"Belmont University"},{"name":"The Accidentals","school":"University of Georgia"},{"name":"The Beltones","school":"Belmont University"},{"name":"reVOLution","school":"The University of Tennessee, Knoxville"}]},{"name":"South QF4","location":null,"date":null,"groups":[{"name":"[wavelength]","school":"Tulane University"},{"name":"All-Night Yahtzee","school":"Florida State University"},{"name":"Cockappella","school":"University of South Carolina"},{"name":"Gemini Blvd.","school":"University of Central Florida"},{"name":"HEARTbeats","school":"Florida International University"},{"name":"KeyHarmony","school":"University of Central Florida"},{"name":"Mixed Mode","school":"University of Central Florida"},{"name":"No Southern Accent","school":"University of Florida"},{"name":"Phoenyx","school":"University of Miami"},{"name":"Rocky's Angels","school":"University of South Florida"},{"name":"Scarlette Fever","school":"University of Tampa"},{"name":"Standing Room Only","school":"University of Florida"},{"name":"Tampa Tones","school":"University of Tampa"},{"name":"The Acaphiliacs","school":"Florida State University"},{"name":"The EnsemBull","school":"University of South Florida"},{"name":"The Riff Tides","school":"Nova Southeastern University"},{"name":"The Sedoctaves","school":"University of Florida"},{"name":"Tone Def A Cappella","school":"University of Florida"},{"name":"Tones of Gold","school":"University of South Florida"},{"name":"Vox","school":"Florida State University"}]}],"semifinal":null},"Southwest":{"schools":["Kansas State University","University of Nebraska","Creighton University","University of Kansas","United States Air Force Academy","Wichita State University","University of Arizona","Arizona State University","Grand Canyon University","Sandra Day O'Connor College of Law","University of Texas at Austin","Texas Tech University","Texas A&M University","Texas Christian University","Collin College","University of Texas at San Antonio","University of Texas at Arlington","Stephen F. Austin State University","University of California, San Diego","San Diego State University","Brigham Young University","University of Utah","University of South Dakota","University of Colorado Boulder","University of Northern Colorado","Utah Valley University","Various"],"quarterfinals":[{"name":"Southwest QF1","location":"University of Nebraska","date":"2020-01-25","groups":[{"name":"Audacity A Cappella","school":"Kansas State University"},{"name":"Bathtub Dogs","school":"University of Nebraska"},{"name":"Boots & Cats","school":"University of Nebraska"},{"name":"Cadence A Cappella","school":"Kansas State University"},{"name":"Creightones","school":"Creighton University"},{"name":"Crimson and Blues","school":"University of Kansas"},{"name":"In the Stairwell","school":"United States Air Force Academy"},{"name":"Pitch Please","school":"University of Nebraska"},{"name":"Shockappella","school":"Wichita State University"},{"name":"The Red Keys","school":"University of Nebraska"}]},{"name":"Southwest QF2","location":"Scottsdale Center for Performing Arts","date":"2020-02-02","groups":[{"name":"Amplified","school":"University of Arizona"},{"name":"ASU Pitchforks","school":"Arizona State University"},{"name":"CatCall a Cappella","school":"University of Arizona"},{"name":"Devil Clefs","school":"Arizona State University"},{"name":"Enharmonics A Cappella","school":"University of Arizona"},{"name":"Harmonic Thunder","school":"Grand Canyon University"},{"name":"Law Cappella","school":"Sandra Day O'Connor College of Law"},{"name":"Noteriety","school":"University of Arizona"},{"name":"Priority Male","school":"Arizona State University"},{"name":"The TEMPEtations","school":"Arizona State University"}]},{"name":"Southwest QF3","location":"University of Texas at Austin","date":"2020-02-08","groups":[{"name":"Beauties and the Beat","school":"University of Texas at Austin"},{"name":"Empire A Cappella","school":"Texas Tech University"},{"name":"Fuse A Cappella","school":"University of Texas at Austin"},{"name":"HardChord DynaMix","school":"Texas A&M University"},{"name":"Here Comes Treble","school":"Texas Christian University"},{"name":"Noteworthy A Cappella","school":"University of Texas at Austin"},{"name":"One Note Stand A Cappella","school":"University of Texas at Austin"},{"name":"OneSound","school":"Collin College"},{"name":"Overly Chromatic","school":"University of Texas at San Antonio"},{"name":"RISE","school":"University of Texas at Arlington"},{"name":"Techtones A Cappella","school":"Texas Tech University"},{"name":"Texas Songhorns","school":"University of Texas at Austin"},{"name":"The Horned Tones","school":"Texas Christian University"},{"name":"The Purple Pitches","school":"Stephen F. Austin State University"}]},{"name":"Southwest QF4","location":"Coronado High School","date":"2020-02-29","groups":[{"name":"Daughters of Triton","school":"University of California, San Diego"},{"name":"Duly Noted","school":"University of California, San Diego"},{"name":"SoundWave","school":"San Diego State University"},{"name":"The Beat @ UCSD","school":"University of California, San Diego"},{"name":"The Tritones","school":"University of California, San Diego"}]},{"name":"Southwest QF5","location":"Utah Valley University","date":"2020-02-15","groups":[{"name":"Beyond Measure","school":"Brigham Young University"},{"name":"Business Casual A Cappella","school":"University of Utah"},{"name":"The High Howlers","school":"University of South Dakota"},{"name":"In the Buff","school":"University of Colorado Boulder"},{"name":"Legacy","school":"Various"},{"name":"One Note Stand","school":"University of Colorado Boulder"},{"name":"Rifftide","school":"Brigham Young University"},{"name":"Vocal Iron","school":"University of Northern Colorado"},{"name":"VOX","school":"Utah Valley University"},{"name":"VoiceLine","school":"Utah Valley University"}]}],"semifinal":null},"West":{"schools":["Linn-Benton Community College","Oregon State University","University of Oregon","Willamette University","Corban University","Portland State University","University of California, Los Angeles","Mt. San Antonio College","University of California, Riverside","California Polytechnic State University, San Luis Obispo","University of California, Davis","San Jose State University","University of Southern California","Gonzaga University","University of British Columbia","University of Washington","Pacific Lutheran University","Western Washington University","University of British Columbia Okanagan","University of California, Berkeley","University of California, Santa Cruz","Diablo Valley College","Stanford University","University of California, Irvine","Moorpark College","Chapman University","California State University, Northridge"],"quarterfinals":[{"name":"West QF1","location":"Elsinore Theater","date":"2020-01-25","groups":[{"name":"Blue Light Special","school":"Linn-Benton Community College"},{"name":"Divine","school":"Oregon State University"},{"name":"Divisi","school":"University of Oregon"},{"name":"Headband","school":"Willamette University"},{"name":"Hilltop Harmony","school":"Corban University"},{"name":"Outspoken","school":"Oregon State University"},{"name":"Power Chord","school":"Oregon State University"},{"name":"The Green Note","school":"Portland State University"},{"name":"The Sirens","school":"Linn-Benton Community College"},{"name":"Up Top","school":"Willamette University"}]},{"name":"West QF2","location":"Pomona College","date":"2020-02-01","groups":[{"name":"AweChords A Cappella","school":"University of California, Los Angeles"},{"name":"Fermata Nowhere","school":"Mt. San Antonio College"},{"name":"Not So Sharp Acapella","school":"University of California, Riverside"},{"name":"Pitch, Please!","school":"University of California, Los Angeles"},{"name":"Random Voices","school":"University of California, Los Angeles"},{"name":"Resonance","school":"University of California, Los Angeles"},{"name":"That's the Key","school":"California Polytechnic State University, San Luis Obispo"},{"name":"The Cleftomaniacs","school":"University of California, Davis"},{"name":"The Spartones at SJSU","school":"San Jose State University"},{"name":"UnderSCore A Cappella","school":"University of Southern California"}]},{"name":"West QF3","location":"Rialto Theater","date":"2020-02-08","groups":[{"name":"Big Bing Theory","school":"Gonzaga University"},{"name":"Eh? Cappella","school":"University of British Columbia"},{"name":"Furmata","school":"University of Washington"},{"name":"HERmonic","school":"Pacific Lutheran University"},{"name":"Pacific Note West","school":"Western Washington University"},{"name":"PLUtonic","school":"Pacific Lutheran University"},{"name":"The Northwest Collective","school":"University of British Columbia"},{"name":"The Trill Seekers","school":"University of British Columbia Okanagan"},{"name":"Trebled Acaholics","school":"University of British Columbia Okanagan"}]},{"name":"West QF4","location":"Fox Theater","date":"2020-02-22","groups":[{"name":"Artists in Resonance","school":"University of California, Berkeley"},{"name":"Cloud 9","school":"University of California, Santa Cruz"},{"name":"Dil Se","school":"University of California, Berkeley"},{"name":"Drawn to Scale","school":"University of California, Berkeley"},{"name":"Fortefied","school":"Diablo Valley College"},{"name":"Men's Octet","school":"University of California, Berkeley"},{"name":"Mouth Noise","school":"Diablo Valley College"},{"name":"Stanford Mendicants","school":"Stanford University"},{"name":"The Liquid Hotplates","school":"University of California, Davis"},{"name":"The Spokes","school":"University of California, Davis"}]},{"name":"West QF5","location":null,"date":null,"groups":[{"name":"Aerodynamix Acappella","school":"University of California, Irvine"},{"name":"Circle of Fifths","school":"University of California, Irvine"},{"name":"Clair de Lune A Cappella","school":"University of California, Irvine"},{"name":"Dynamix","school":"Moorpark College"},{"name":"Queercappella","school":"Chapman University"},{"name":"Simply Vocale","school":"Chapman University"},{"name":"The ChapTones","school":"Chapman University"},{"name":"Uniting Voices","school":"University of California, Irvine"},{"name":"Vermillion Vocalists","school":"University of California, Irvine"},{"name":"Vocal Percussion Radio (VPR)","school":"California State University, Northridge"}]}],"semifinal":null}},"finals":{"location":"The Town Hall, New York City","date":null},"notes":"This was the 24th ICCA season. The season was ultimately disrupted by COVID-19 (March 2020), so semifinals and finals likely did not take place, though the PDF only contains QF assignments. Semifinal dates/locations are not listed in the PDF for any region. Notable structural details: (1) South QF4 was listed as 'Dates TBA, 2 Florida Area Quarterfinals (2/1 Orlando and 2nd show TBA)' \u2014 all 20 Florida-area groups are combined into one QF entry here since the PDF does not separate them into two shows. The PDF indicates two shows were planned but does not assign groups to specific shows. (2) Southwest region had special rules this year: 11-minute sets (vs normal 12), two Texas QFs on the same day (matinee and evening with 7 groups each), a smaller San Diego QF (1 group advances), and a Nebraska QF. The PDF lists the Texas groups under one heading dated Feb 8 at UT Austin without splitting into matinee/evening. (3) Southwest QF4 (San Diego) has only 5 groups with only 1 advancing to semifinals. (4) Southwest QF5 includes 'Legacy' affiliated with 'Various' \u2014 appears to be a multi-school or community group. (5) 'VoiceLine' in Southwest QF5 is listed oddly in PDF as 'Utah Valley University | VoiceLine' (reversed from other entries). (6) West QF5 listed as 'Date TBA, Southern California' with no specific venue. (7) 'The Tritones' in Southwest QF4 listed as 'UCSD' \u2014 mapped to University of California, San Diego. (8) Carnegie Mellon University is spelled 'Carnegie Mellon Univeristy' in the PDF (typo). (9) 'Universiy of Central Missouri' is a typo in PDF for University of Central Missouri. (10) 'Cal Poly, San Luis Obispo' mapped to 'California Polytechnic State University, San Luis Obispo'. (11) Several school names in this PDF use abbreviations or informal names \u2014 preserved the PDF's group name verbatim but used canonical school names. (12) 'On a Side Note' in Midwest QF3 listed as 'Indiana-University-Purdue-University-Indianapolis' in PDF \u2014 mapped to 'Indiana University' as the school field since IUPUI was consolidated into Indiana University, but this may need review. (13) 'SUNY Albany' appears for Serendipity while 'University at Albany (SUNY)' appears for Pitch Please \u2014 both mapped to 'University at Albany' in schools list. (14) PDF notes UK applications were still pending at time of posting but UK QFs are included."},
  2025: {"year":2025,"season":"2024-2025","source":"2025 ICCA Lineup PDF, posted November 15, 2024 (UK Region November 26). Varsity Vocals official competitor listing.","regions":{"Central":{"schools":["University of Waterloo","University of Western Ontario","Wilfrid Laurier University","McMaster University","Toronto Metropolitan University","Binghamton University","Cornell University","University of Rochester","University of Pittsburgh","Ithaca College","University of Toronto","Penn State University","SUNY Fredonia","Rochester Institute of Technology","Western University","Monroe Community College","Carnegie Mellon University","Indiana University of Pennsylvania","Syracuse University","Lehigh University","Lafayette College"],"quarterfinals":[{"name":"Central QF1","location":"University of Waterloo","date":"2025-01-18","groups":[{"name":"AcaBellas","school":"University of Waterloo"},{"name":"Equivox","school":"University of Western Ontario"},{"name":"Hawkappella","school":"Wilfrid Laurier University"},{"name":"MacaFellas","school":"McMaster University"},{"name":"Macappella","school":"McMaster University"},{"name":"Noteworthy","school":"Wilfrid Laurier University"},{"name":"On That Note","school":"Toronto Metropolitan University"},{"name":"PitchSlapped","school":"McMaster University"},{"name":"Unaccompanied Minors","school":"University of Waterloo"},{"name":"Water Boys","school":"University of Waterloo"}]},{"name":"Central QF2","location":"Binghamton University","date":"2025-01-25","groups":[{"name":"Binghamtonics","school":"Binghamton University"},{"name":"Chordials","school":"Cornell University"},{"name":"Midnight Ramblers","school":"University of Rochester"},{"name":"Note to Self","school":"Binghamton University"},{"name":"Premium Blend","school":"Ithaca College"},{"name":"Sargam","school":"University of Pittsburgh"},{"name":"Surround Sound","school":"University of Toronto"},{"name":"Tone Cold","school":"Ithaca College"},{"name":"Treblemakers","school":"Binghamton University"},{"name":"Voicestream","school":"Ithaca College"}]},{"name":"Central QF3","location":"The Theater at Innovation Square","date":"2025-02-01","groups":[{"name":"Coda Conduct","school":"Penn State University"},{"name":"Dynamic Intonation","school":"SUNY Fredonia"},{"name":"Eight Beat Measure","school":"Rochester Institute of Technology"},{"name":"Kaminari","school":"Rochester Institute of Technology"},{"name":"Repercussions","school":"Western University"},{"name":"RESONATE","school":"Toronto Metropolitan University"},{"name":"Trebellious","school":"University of Rochester"},{"name":"Tributones","school":"Monroe Community College"},{"name":"Tunes. Beats. Awesome.","school":"University of Toronto"},{"name":"YellowJackets","school":"University of Rochester"}]},{"name":"Central QF4","location":"Soldiers and Sailors Hall, Pittsburgh, PA","date":"2025-02-08","groups":[{"name":"C Sharp Singers","school":"Carnegie Mellon University"},{"name":"C Flat Run","school":"University of Pittsburgh"},{"name":"Counterpoint","school":"Carnegie Mellon University"},{"name":"Crimson Chords","school":"Indiana University of Pennsylvania"},{"name":"GrooveStand","school":"Syracuse University"},{"name":"Pitt Pendulums","school":"University of Pittsburgh"},{"name":"Songburghs","school":"University of Pittsburgh"},{"name":"Soundbytes","school":"Carnegie Mellon University"},{"name":"Tonal Disruption","school":"University of Pittsburgh"},{"name":"Treblemakers","school":"Carnegie Mellon University"}]},{"name":"Central QF5","location":"Penn State University","date":"2025-03-01","groups":[{"name":"A Whole Step Up","school":"Lehigh University"},{"name":"Cadence","school":"Lafayette College"},{"name":"Chorduroys","school":"Lafayette College"},{"name":"Echoes","school":"Lehigh University"},{"name":"Mar-Keys","school":"Lafayette College"},{"name":"Melismatics","school":"Lehigh University"},{"name":"None of the Above","school":"Penn State University"},{"name":"Off The Record","school":"Lehigh University"},{"name":"Soulfege","school":"Lafayette College"},{"name":"Statesmen","school":"Penn State University"}]}],"semifinal":{"location":"University at Buffalo","date":"2025-03-22"}},"Great Lakes":{"schools":["Eastern Illinois University","Loyola University Chicago","University of Illinois at Chicago","University of Wisconsin","Northern Illinois University","University of Chicago","University of Wisconsin Milwaukee","North Central College","Illinois State University","Marquette University","University of Illinois","Michigan State University","Grand Valley State University","Macomb Community College","University of Michigan","Wayne State University","Northwestern University","Central Michigan University","Eastern Michigan University","Oakland University","University of Minnesota Twin Cities","University of Wisconsin Stevens Point","University of Wisconsin Eau Claire","University of Wisconsin Parkside","University of Wisconsin Madison"],"quarterfinals":[{"name":"Great Lakes QF1","location":"University of Chicago","date":"2025-01-25","groups":[{"name":"Blue Fusion","school":"Eastern Illinois University"},{"name":"Counterpoint","school":"Loyola University Chicago"},{"name":"Downtown Voices","school":"University of Illinois at Chicago"},{"name":"Fundamentally Sound","school":"University of Wisconsin"},{"name":"Harmelodics","school":"Northern Illinois University"},{"name":"Medusa","school":"University of Chicago"},{"name":"Public Hearing","school":"University of Wisconsin Milwaukee"},{"name":"Ransom Notes","school":"University of Chicago"},{"name":"Run for Cover","school":"University of Chicago"},{"name":"Sonata Problem","school":"North Central College"}]},{"name":"Great Lakes QF2","location":"Illinois State University","date":"2025-02-01","groups":[{"name":"Acafellaz","school":"Illinois State University"},{"name":"Clef Hangers","school":"Illinois State University"},{"name":"Final Cut","school":"North Central College"},{"name":"Naturals","school":"Marquette University"},{"name":"No Strings Attached","school":"University of Illinois"},{"name":"On the Brink of Normal","school":"Illinois State University"},{"name":"Secondary Dominance","school":"Illinois State University"},{"name":"Xtension Chords","school":"University of Illinois"},{"name":"Voices in Your Head","school":"University of Chicago"}]},{"name":"Great Lakes QF3","location":"Jenison Center for the Arts","date":"2025-02-08","groups":[{"name":"Accafellas","school":"Michigan State University"},{"name":"Capital Green","school":"Michigan State University"},{"name":"Euphoria","school":"Grand Valley State University"},{"name":"Expressions","school":"Macomb Community College"},{"name":"G-Men","school":"University of Michigan"},{"name":"GV GrooVe","school":"Grand Valley State University"},{"name":"Ladies First","school":"Michigan State University"},{"name":"Melodytroit","school":"Wayne State University"},{"name":"Purple Haze","school":"Northwestern University"},{"name":"State of Fifths","school":"Michigan State University"}]},{"name":"Great Lakes QF4","location":"University of Michigan","date":"2025-02-22","groups":[{"name":"Central Harmony","school":"Central Michigan University"},{"name":"Compulsive Lyres","school":"University of Michigan"},{"name":"DJs","school":"University of Michigan"},{"name":"Emerald Harmony","school":"Eastern Michigan University"},{"name":"Evergreen","school":"Eastern Michigan University"},{"name":"Harmonettes","school":"University of Michigan"},{"name":"Gold Vibrations","school":"Oakland University"},{"name":"Maize Mirchi","school":"University of Michigan"},{"name":"On The Rox","school":"Central Michigan University"},{"name":"Sopranos","school":"University of Michigan"}]},{"name":"Great Lakes QF5","location":"University of Wisconsin","date":"2025-03-01","groups":[{"name":"7 Days","school":"University of Minnesota Twin Cities"},{"name":"CounterPoint","school":"University of Wisconsin Stevens Point"},{"name":"Enchantments","school":"University of Minnesota Twin Cities"},{"name":"Impromptu","school":"University of Wisconsin Eau Claire"},{"name":"Parkside Range","school":"University of Wisconsin Parkside"},{"name":"Pitches & Notes","school":"University of Wisconsin Madison"},{"name":"Under A-Rest","school":"University of Wisconsin Madison"},{"name":"Vocal U","school":"University of Minnesota Twin Cities"},{"name":"Waale","school":"University of Wisconsin Madison"}]}],"semifinal":{"location":"Pabst Theater","date":"2025-03-29"}},"Mid-Atlantic":{"schools":["Westminster Choir College","Rutgers University","Towson University","Rowan University","Salisbury University","Stockton University","The College of New Jersey","Johns Hopkins University","Virginia Tech","University of Maryland Baltimore County","Elizabethtown College","James Madison University","Christopher Newport University","Temple University","Drexel University","University of Maryland","University of Maryland, College Park","University of Pennsylvania","Villanova University","Washington & Lee University","The George Washington University","The College of William & Mary","Virginia Commonwealth University","University of Richmond","Millersville University","University of Delaware","West Chester University of Pennsylvania","St. Mary's College of Maryland","University of Maryland Eastern Shore"],"quarterfinals":[{"name":"Mid-Atlantic QF1","location":"The College of New Jersey","date":"2025-02-01","groups":[{"name":"Deaftones","school":"Westminster Choir College"},{"name":"Deep Treble","school":"Rutgers University"},{"name":"Off Track","school":"Towson University"},{"name":"Profecy","school":"Rowan University"},{"name":"RAAG","school":"Rutgers University"},{"name":"Rowan Vocals","school":"Rowan University"},{"name":"Shockwave","school":"Rutgers University"},{"name":"Squawkappella","school":"Salisbury University"},{"name":"Stockapella","school":"Stockton University"},{"name":"Trentones","school":"The College of New Jersey"}]},{"name":"Mid-Atlantic QF2","location":"Johns Hopkins University","date":"2025-02-15","groups":[{"name":"AllNighters","school":"Johns Hopkins University"},{"name":"Juxtaposition","school":"Virginia Tech"},{"name":"Mama's Boys","school":"University of Maryland Baltimore County"},{"name":"Melica","school":"Elizabethtown College"},{"name":"Note-oriety","school":"James Madison University"},{"name":"Notes of Ranvier","school":"Johns Hopkins University"},{"name":"Octopodes","school":"Johns Hopkins University"},{"name":"Take Note","school":"Christopher Newport University"},{"name":"UMBC Cleftomaniacs","school":"University of Maryland Baltimore County"}]},{"name":"Mid-Atlantic QF3","location":"Drexel University","date":"2025-02-22","groups":[{"name":"Broad Street Line","school":"Temple University"},{"name":"Casual Harmony","school":"Rutgers University"},{"name":"Drexel Cleftomaniacs","school":"Drexel University"},{"name":"Drexel Treblemakers","school":"Drexel University"},{"name":"Faux Paz","school":"University of Maryland"},{"name":"LiaChorus","school":"Temple University"},{"name":"PandemoniUM","school":"University of Maryland, College Park"},{"name":"Penny Loafers","school":"University of Pennsylvania"},{"name":"Supernovas","school":"Villanova University"},{"name":"UNTITLED","school":"Towson University"}]},{"name":"Mid-Atlantic QF4","location":"Oakton High School, Vienna, VA","date":"2025-03-01","groups":[{"name":"Extreme Measures","school":"Christopher Newport University"},{"name":"General Admission","school":"Washington & Lee University"},{"name":"GW Pitches","school":"The George Washington University"},{"name":"No Ceiling","school":"The College of William & Mary"},{"name":"Notochords","school":"Virginia Commonwealth University"},{"name":"Ramifications","school":"Virginia Commonwealth University"},{"name":"Oct\u0101ves","school":"University of Richmond"},{"name":"Sons of Pitch","school":"The George Washington University"},{"name":"University Sounds","school":"Christopher Newport University"}]},{"name":"Mid-Atlantic QF5","location":"West Chester University","date":"2025-03-01","groups":[{"name":"Chromatic","school":"Millersville University"},{"name":"Golden Blues","school":"University of Delaware"},{"name":"High Street Harmonix","school":"West Chester University of Pennsylvania"},{"name":"Interchorus","school":"St. Mary's College of Maryland"},{"name":"MelUDees","school":"University of Delaware"},{"name":"Muses","school":"University of Maryland Eastern Shore"},{"name":"Under A Rest","school":"West Chester University of Pennsylvania"},{"name":"VilleHarmonics","school":"Millersville University"},{"name":"Vocal Point","school":"University of Delaware"}]}],"semifinal":{"location":"The Grand","date":"2025-03-22"}},"Midwest":{"schools":["Saint Louis University","University of Notre Dame","Murray State University","Missouri University of Science and Technology","Washington University in St. Louis","Bowling Green State University","Purdue University","Indiana University","University of Dayton","Missouri State University","University of Kansas","Truman State University","University of Missouri","University of Cincinnati","The Ohio State University","Ohio University","Mount St. Joseph University","Case Western Reserve University","Miami University","University of Akron","College of Wooster","Baldwin-Wallace University","Kent State University"],"quarterfinals":[{"name":"Midwest QF1","location":"Washington University in St. Louis","date":"2025-01-25","groups":[{"name":"Astha A Cappella","school":"Saint Louis University"},{"name":"Decadence","school":"Saint Louis University"},{"name":"The Echoes","school":"University of Notre Dame"},{"name":"EQ Blu","school":"Murray State University"},{"name":"Miner Key","school":"Missouri University of Science and Technology"},{"name":"Mosaic Whispers","school":"Washington University in St. Louis"},{"name":"Reverb","school":"Washington University in St. Louis"},{"name":"Sensasians","school":"Washington University in St. Louis"},{"name":"Six Eight","school":"Saint Louis University"},{"name":"Ten40!","school":"Bowling Green State University"}]},{"name":"Midwest QF2","location":"Warren Central High School, Indianapolis, IN","date":"2025-02-08","groups":[{"name":"Acabellas","school":"Purdue University"},{"name":"Bare Naked Statues","school":"Saint Louis University"},{"name":"Bloomingtones","school":"Indiana University"},{"name":"On A Side Note","school":"Indiana University"},{"name":"Purdue Soundtracks","school":"Purdue University"},{"name":"Remedy","school":"University of Dayton"},{"name":"Resting Pitch Face","school":"Indiana University"},{"name":"Retrograde","school":"Bowling Green State University"},{"name":"Tonal Eclipse","school":"Bowling Green State University"},{"name":"Underscore","school":"University of Dayton"}]},{"name":"Midwest QF3","location":"Liberty High School, Kansas City, MO","date":"2025-02-15","groups":[{"name":"A Cub Bella","school":"Missouri State University"},{"name":"Beartones","school":"Missouri State University"},{"name":"Beyond All Reason","school":"Saint Louis University"},{"name":"Crimson & Blues","school":"University of Kansas"},{"name":"Hibernotes","school":"Missouri State University"},{"name":"Minor Detail","school":"Truman State University"},{"name":"Mizzou Forte","school":"University of Missouri"},{"name":"Naturelles","school":"University of Missouri"},{"name":"Sweet Nothings","school":"Truman State University"},{"name":"True Men","school":"Truman State University"}]},{"name":"Midwest QF4","location":"Hilliard Bradley High School, Hilliard, OH","date":"2025-02-22","groups":[{"name":"Avocalypse","school":"University of Cincinnati"},{"name":"Buck That!","school":"The Ohio State University"},{"name":"Dynamics","school":"Ohio University"},{"name":"Majors & minors","school":"The Ohio State University"},{"name":"New Chords on the Block","school":"Ohio University"},{"name":"Scarlet and Grace Notes","school":"The Ohio State University"},{"name":"Tempo Tantrums","school":"Ohio University"},{"name":"Vocaholics","school":"University of Cincinnati"},{"name":"Voices of Gold","school":"Mount St. Joseph University"}]},{"name":"Midwest QF5","location":"Case Western Reserve University","date":"2025-03-01","groups":[{"name":"AcousChicks","school":"Bowling Green State University"},{"name":"Case in Point","school":"Case Western Reserve University"},{"name":"Dhamakapella","school":"Case Western Reserve University"},{"name":"Flying Solos","school":"University of Dayton"},{"name":"Just Duet","school":"Miami University"},{"name":"Rhythm and Roos","school":"University of Akron"},{"name":"Scots in Harmony","school":"College of Wooster"},{"name":"S\u014cL","school":"Baldwin-Wallace University"},{"name":"The TrebleMakers","school":"Miami University"},{"name":"Vocal Intensity","school":"Kent State University"}]}],"semifinal":{"location":"Hilliard Bradley High School, Hilliard, OH","date":"2025-03-22"}},"Northeast":{"schools":["Bryant University","University of Hartford","Roger Williams University","Hofstra University","Quinnipiac University","Wesleyan University","University of Connecticut","SUNY Potsdam","Boston University","Worcester Polytechnic Institute","Rensselaer Polytechnic Institute","University at Albany","University of Vermont","Northeastern University","University of Massachusetts Lowell","Brown University","Bentley University","Suffolk University","Emerson College","Massachusetts Institute of Technology","Harvard University","Berklee College of Music","New York University","Columbia University","Fordham University","Pace University","Hunter College","The New School"],"quarterfinals":[{"name":"Northeast QF1","location":"University of Hartford","date":"2025-02-01","groups":[{"name":"The Bottom Line","school":"Bryant University"},{"name":"HartAttack A Cappella","school":"University of Hartford"},{"name":"Hawkward","school":"Roger Williams University"},{"name":"The Hofbeats","school":"Hofstra University"},{"name":"L'Shir","school":"University of Hartford"},{"name":"Legends","school":"Quinnipiac University"},{"name":"Makin' Treble","school":"Hofstra University"},{"name":"Notes Over Storrs","school":"University of Connecticut"},{"name":"Sigma'cappella","school":"Hofstra University"},{"name":"Triple Major","school":"Wesleyan University"}]},{"name":"Northeast QF2","location":"Rensselaer Polytechnic Institute","date":"2025-02-08","groups":[{"name":"A Sharp Arrangement","school":"SUNY Potsdam"},{"name":"Allegrettos","school":"Boston University"},{"name":"Audiophiles","school":"Worcester Polytechnic Institute"},{"name":"Partial Credit","school":"Rensselaer Polytechnic Institute"},{"name":"Pitch Please","school":"University at Albany"},{"name":"Potsdam Pitches","school":"SUNY Potsdam"},{"name":"Potsdam Pointercounts","school":"SUNY Potsdam"},{"name":"Rusty Pipes","school":"Rensselaer Polytechnic Institute"},{"name":"Stay Tuned","school":"SUNY Potsdam"},{"name":"Viridescent","school":"University of Vermont"}]},{"name":"Northeast QF3","location":"Berklee College of Music","date":"2025-02-15","groups":[{"name":"Distilled Harmony","school":"Northeastern University"},{"name":"Hawkapella","school":"University of Massachusetts Lowell"},{"name":"The Hawkettes","school":"University of Massachusetts Lowell"},{"name":"Jabberwocks","school":"Brown University"},{"name":"Off the Clock","school":"Bentley University"},{"name":"Pitch, Please!","school":"Northeastern University"},{"name":"Ramifications","school":"Suffolk University"},{"name":"Treblemakers","school":"Boston University"}]},{"name":"Northeast QF4","location":"Berklee College of Music","date":"2025-02-16","groups":[{"name":"Acappellics","school":"Emerson College"},{"name":"Chorallaries","school":"Massachusetts Institute of Technology"},{"name":"Downbeats","school":"Northeastern University"},{"name":"Harvard Callbacks","school":"Harvard University"},{"name":"Harvard Opportunes","school":"Harvard University"},{"name":"Nor'easters","school":"Northeastern University"},{"name":"One Voice","school":"Boston University"},{"name":"On The Vox","school":"Berklee College of Music"},{"name":"Treble Threat","school":"Berklee College of Music"}]},{"name":"Northeast QF5","location":"New York Society for Ethical Culture","date":"2025-02-22","groups":[{"name":"Cleftomaniacs","school":"New York University"},{"name":"Clefhangers","school":"Columbia University"},{"name":"F Sharps","school":"Fordham University"},{"name":"Frequency","school":"Pace University"},{"name":"Hawkappella","school":"Hunter College"},{"name":"Mixtapes","school":"New York University"},{"name":"Tonal Recall","school":"Pace University"},{"name":"Unjust Intonation","school":"The New School"},{"name":"Vocollision","school":"New York University"},{"name":"Vocaholics","school":"New York University"}]}],"semifinal":{"location":"Berklee College of Music","date":"2025-03-30"}},"South":{"schools":["University of South Carolina","Appalachian State University","Vanderbilt University","University of Georgia","North Carolina State University","University of North Carolina at Chapel Hill","Belmont University","The University of Tennessee","The University of Tennessee, Knoxville","East Tennessee State University","University of Florida","Florida State University","Emory University","Pearl River Community College","East Central Community College","Georgia Institute of Technology","University of Southern Mississippi","Mississippi State University","University of Miami","University of Central Florida","Florida International University","University of South Florida","University of North Carolina at Greensboro","Wake Forest University","Clemson University","Western Carolina University"],"quarterfinals":[{"name":"South QF1","location":"The Carolina Theater, Durham, NC","date":"2025-01-25","groups":[{"name":"Cockappella","school":"University of South Carolina"},{"name":"Ear Candy","school":"Appalachian State University"},{"name":"Harmonic Notion","school":"Vanderbilt University"},{"name":"Kalakaar","school":"University of Georgia"},{"name":"Ladies in Red","school":"North Carolina State University"},{"name":"Tar Heel Voices","school":"University of North Carolina at Chapel Hill"},{"name":"Treble Attraction","school":"Appalachian State University"},{"name":"VoiceMale","school":"Appalachian State University"},{"name":"Walk-ons","school":"University of North Carolina at Chapel Hill"},{"name":"Wolfgang","school":"North Carolina State University"}]},{"name":"South QF2","location":"University of Tennessee","date":"2025-02-08","groups":[{"name":"The Belles","school":"Belmont University"},{"name":"Beltones","school":"Belmont University"},{"name":"Intonations","school":"Belmont University"},{"name":"Pitchmen","school":"Belmont University"},{"name":"Prismatics","school":"Belmont University"},{"name":"Spectrum","school":"Vanderbilt University"},{"name":"UT Singers","school":"The University of Tennessee"},{"name":"VOLT","school":"The University of Tennessee, Knoxville"},{"name":"Harmonium","school":"East Tennessee State University"}]},{"name":"South QF3","location":"Pearl River Community College","date":"2025-02-08","groups":[{"name":"Accent","school":"University of Florida"},{"name":"All-Night Yahtzee","school":"Florida State University"},{"name":"Aural Pleasure","school":"Emory University"},{"name":"Currents","school":"Pearl River Community College"},{"name":"Dooley Noted","school":"Emory University"},{"name":"EC Listening","school":"East Central Community College"},{"name":"Infinite Harmony","school":"Georgia Institute of Technology"},{"name":"Sedoctaves","school":"University of Florida"},{"name":"Spirit of Southern","school":"University of Southern Mississippi"},{"name":"TrebullDawgs","school":"Mississippi State University"}]},{"name":"South QF4","location":"Cypress Lake High School Center for the Arts","date":"2025-02-15","groups":[{"name":"BisCaydence","school":"University of Miami"},{"name":"Crescendudes","school":"University of Central Florida"},{"name":"HEARTbeats","school":"Florida International University"},{"name":"KeyHarmony","school":"University of Central Florida"},{"name":"Mixed Mode","school":"University of Central Florida"},{"name":"Phoenyx","school":"University of Miami"},{"name":"Rocky's Angels","school":"University of South Florida"},{"name":"Tones of Gold","school":"University of South Florida"},{"name":"Voicebox","school":"University of Central Florida"}]},{"name":"South QF5","location":"The Carolina Theater","date":"2025-02-15","groups":[{"name":"Acappology","school":"North Carolina State University"},{"name":"Ascension","school":"East Tennessee State University"},{"name":"Chariots","school":"University of North Carolina at Greensboro"},{"name":"Chordination","school":"North Carolina State University"},{"name":"Demon Divas","school":"Wake Forest University"},{"name":"Dynamix","school":"Clemson University"},{"name":"Grains of Time","school":"North Carolina State University"},{"name":"PawCappella","school":"Western Carolina University"},{"name":"reVOLution","school":"The University of Tennessee"},{"name":"Tarpeggios","school":"University of North Carolina at Chapel Hill"}]}],"semifinal":{"location":"The Carolina Theater","date":"2025-03-08"}},"Southwest":{"schools":["University of Nebraska","Butler Community College","Iowa State University","University of Iowa","Wichita State University","University of Texas at Austin","Texas Tech University","University of Houston","Texas A&M University","Texas Christian University","University of Texas at San Antonio","Rice University","University of Texas at Arlington","United States Air Force Academy","University of Colorado","University of Denver","Colorado State University","University of Colorado Boulder","Montana State University","University of Utah","Oklahoma City University","University of Arizona","Northern Arizona University","Arizona State University","University of California, San Diego","Grand Canyon University","Chapman University","San Diego State University","Dallas-Fort Worth"],"quarterfinals":[{"name":"Southwest QF1","location":"Rococo Theatre, Lincoln, NE","date":"2025-02-01","groups":[{"name":"Bathtub Dogs","school":"University of Nebraska"},{"name":"Boots & Cats","school":"University of Nebraska"},{"name":"Butler A Cappella","school":"Butler Community College"},{"name":"Count Me In","school":"Iowa State University"},{"name":"Hawkapellas","school":"University of Iowa"},{"name":"Mezzo Forte","school":"Iowa State University"},{"name":"Pitch Please","school":"University of Nebraska"},{"name":"Red Keys","school":"University of Nebraska"},{"name":"Shockappella","school":"Wichita State University"},{"name":"Take Note","school":"University of Nebraska"}]},{"name":"Southwest QF2","location":"MacArthur High School","date":"2025-02-01","groups":[{"name":"Beauties and the Beat","school":"University of Texas at Austin"},{"name":"Empire","school":"Texas Tech University"},{"name":"Final Measure","school":"University of Houston"},{"name":"Hardchord DynaMix","school":"Texas A&M University"},{"name":"License to Trill","school":"Texas Christian University"},{"name":"Noteworthy","school":"University of Texas at Austin"},{"name":"Overly Chromatic","school":"University of Texas at San Antonio"},{"name":"Philharmonics","school":"Rice University"},{"name":"RISE","school":"University of Texas at Arlington"},{"name":"Trillium","school":"Dallas-Fort Worth"}]},{"name":"Southwest QF3","location":"University of Colorado Colorado Springs","date":"2025-02-08","groups":[{"name":"Aerodynamics","school":"United States Air Force Academy"},{"name":"Extreme Measures","school":"University of Colorado"},{"name":"Exit 205","school":"University of Denver"},{"name":"In The Buff","school":"University of Colorado"},{"name":"In The Stairwell","school":"United States Air Force Academy"},{"name":"Mainstreet A Cappella","school":"Colorado State University"},{"name":"One Note Stand","school":"University of Colorado Boulder"},{"name":"Rhapsody","school":"Montana State University"},{"name":"Salt Flats","school":"University of Utah"},{"name":"Tonal Eclipse","school":"Oklahoma City University"}]},{"name":"Southwest QF4","location":"Scottsdale Center for the Performing Arts","date":"2025-02-22","groups":[{"name":"Amplified","school":"University of Arizona"},{"name":"Axecidentals","school":"Northern Arizona University"},{"name":"Devil Clefs","school":"Arizona State University"},{"name":"Elevation","school":"Northern Arizona University"},{"name":"Enharmonics","school":"University of Arizona"},{"name":"Meow or Never","school":"University of Arizona"},{"name":"Noteriety","school":"University of Arizona"},{"name":"Pitchforks","school":"Arizona State University"},{"name":"Priority Male","school":"Arizona State University"},{"name":"TEMPEtations","school":"Arizona State University"}]},{"name":"Southwest QF5","location":"University of California, San Diego","date":"2025-02-22","groups":[{"name":"Acamazing","school":"University of California, San Diego"},{"name":"The Beat","school":"University of California, San Diego"},{"name":"Canyon Crescendos","school":"Grand Canyon University"},{"name":"The ChapTones","school":"Chapman University"},{"name":"Duly Noted","school":"University of California, San Diego"},{"name":"Simply Vocale","school":"Chapman University"},{"name":"Sitaare","school":"University of California, San Diego"},{"name":"SoundCheck","school":"Chapman University"},{"name":"SoundWave","school":"San Diego State University"},{"name":"Trebles","school":"University of California, San Diego"}]}],"semifinal":{"location":"Scottsdale Center for the Performing Arts","date":"2025-03-08"}},"West":{"schools":["Gonzaga University","University of Oregon","Oregon State University","Linn-Benton Community College","Portland State University","Willamette University","University of Washington","University of British Columbia","Western Washington University","Pacific Lutheran University","University of California, Los Angeles","University of California, Irvine","California State University, Fullerton","University of Southern California","Tecnol\u00f3gico de Monterrey","University of California, Santa Cruz","University of California, Berkeley","University of California, Davis","Stanford University","Diablo Valley College","California State University, Northridge","University of California, Santa Barbara","Mt. San Antonio College","San Jose State University","The Claremont Colleges"],"quarterfinals":[{"name":"West QF1","location":"The Elsinore Theatre","date":"2025-01-25","groups":[{"name":"Big Bing Theory","school":"Gonzaga University"},{"name":"Divisi","school":"University of Oregon"},{"name":"Divine","school":"Oregon State University"},{"name":"Formal Houseparty","school":"Linn-Benton Community College"},{"name":"Green Note","school":"Portland State University"},{"name":"Headband","school":"Willamette University"},{"name":"Outspoken","school":"Oregon State University"},{"name":"Power Chord","school":"Oregon State University"},{"name":"Tandem","school":"Willamette University"},{"name":"Up Top","school":"Willamette University"}]},{"name":"West QF2","location":"Rialto Theater","date":"2025-02-01","groups":[{"name":"Awaaz","school":"University of Washington"},{"name":"Eh? Cappella","school":"University of British Columbia"},{"name":"For Good Measure","school":"Western Washington University"},{"name":"Furmata","school":"University of Washington"},{"name":"Gold Rush","school":"Pacific Lutheran University"},{"name":"Northwest Collective","school":"University of British Columbia"},{"name":"Pacific Note West","school":"Western Washington University"},{"name":"PLUtonic","school":"Pacific Lutheran University"},{"name":"Trebled Acaholics","school":"University of British Columbia"},{"name":"Trill Seekers","school":"University of British Columbia"}]},{"name":"West QF3","location":"Downey Theater","date":"2025-02-01","groups":[{"name":"Awaken","school":"University of California, Los Angeles"},{"name":"Circle of Fifths","school":"University of California, Irvine"},{"name":"Clair de Lune","school":"University of California, Irvine"},{"name":"FullerTones","school":"California State University, Fullerton"},{"name":"Morse Coda","school":"University of California, Irvine"},{"name":"Pitch, Please!","school":"University of California, Los Angeles"},{"name":"Resonance","school":"University of California, Los Angeles"},{"name":"Reverse Osmosis","school":"University of Southern California"},{"name":"Vermillion Vocalists","school":"University of California, Irvine"},{"name":"VOXEM","school":"Tecnol\u00f3gico de Monterrey"}]},{"name":"West QF4","location":"Fox Theatre","date":"2025-02-08","groups":[{"name":"Cloud 9","school":"University of California, Santa Cruz"},{"name":"Drawn to Scale","school":"University of California, Berkeley"},{"name":"Golden Overtones","school":"University of California, Berkeley"},{"name":"Jhankaar","school":"University of California, Davis"},{"name":"Liquid Hotplates","school":"University of California, Davis"},{"name":"Lounge Lizards","school":"University of California, Davis"},{"name":"Mendicants","school":"Stanford University"},{"name":"Mixed Company","school":"Stanford University"},{"name":"O-Tone","school":"Stanford University"},{"name":"pH Scale","school":"Diablo Valley College"},{"name":"Spokes","school":"University of California, Davis"}]},{"name":"West QF5","location":"Pomona College","date":"2025-02-22","groups":[{"name":"Acasola","school":"California State University, Northridge"},{"name":"Aerodynamix","school":"University of California, Irvine"},{"name":"Bruin Harmony","school":"University of California, Los Angeles"},{"name":"Davis Cleftomaniacs","school":"University of California, Davis"},{"name":"Naked Voices","school":"University of California, Santa Barbara"},{"name":"Naya Zamaana","school":"University of California, Los Angeles"},{"name":"Nu Aria","school":"Mt. San Antonio College"},{"name":"Spartones","school":"San Jose State University"},{"name":"VocaLotus","school":"University of California, Irvine"},{"name":"Claremont Shades","school":"The Claremont Colleges"}]}],"semifinal":{"location":"Fox Theatre","date":"2025-03-22"}},"United Kingdom":{"schools":["University of Sussex","University College London","King's College London","Imperial College London","University of Oxford","University of Reading","Durham University","Lancaster University","University of Sheffield","University of Birmingham","University of Warwick","University of Leeds","The University of Manchester","University of Nottingham","University of St. Andrews","University of Aberdeen","University of Edinburgh","Newcastle University","University of Stirling","University of Bath","University of Bristol","Royal Welsh College of Music and Drama","Cardiff University","University of Exeter"],"quarterfinals":[{"name":"United Kingdom QF1","location":"Theatre Royal Stratford East","date":"2025-01-25","groups":[{"name":"Sussinct","school":"University of Sussex"},{"name":"The Eustones","school":"University College London"},{"name":"Kadence","school":"King's College London"},{"name":"Nth Harmonic","school":"Imperial College London"},{"name":"The Rolling Tones","school":"King's College London"},{"name":"The Scopes","school":"Imperial College London"},{"name":"The Techtonics","school":"Imperial College London"},{"name":"The Oxford Gargoyles","school":"University of Oxford"},{"name":"RACA","school":"University of Reading"},{"name":"Northern Lights","school":"Durham University"},{"name":"Roselution","school":"Lancaster University"}]},{"name":"United Kingdom QF2","location":"Squire Performing Arts Centre, Nottingham","date":"2025-01-26","groups":[{"name":"Steelworks","school":"University of Sheffield"},{"name":"Abra Cappella","school":"University of Birmingham"},{"name":"The Uptone Girls","school":"University of Birmingham"},{"name":"OffScore","school":"University of Warwick"},{"name":"The Leamingtones","school":"University of Warwick"},{"name":"The Songsmiths","school":"University of Leeds"},{"name":"The Skylarks","school":"The University of Manchester"},{"name":"Aca-Pocalypse","school":"University of Nottingham"},{"name":"Echotones","school":"University of Nottingham"},{"name":"Firecracappella","school":"University of Nottingham"},{"name":"RadioOctave","school":"University of Nottingham"}]},{"name":"United Kingdom QF3","location":"Church Hill Theatre, Edinburgh","date":"2025-02-09","groups":[{"name":"The Other Guys","school":"University of St. Andrews"},{"name":"The Hummingbirds","school":"University of St. Andrews"},{"name":"The Alleycats","school":"University of St. Andrews"},{"name":"Aberpella","school":"University of Aberdeen"},{"name":"Killer Quines","school":"University of Aberdeen"},{"name":"Cloud IX","school":"University of Edinburgh"},{"name":"Licence to Trill","school":"University of Edinburgh"},{"name":"Tone Up","school":"University of Edinburgh"},{"name":"Angels of the North","school":"Newcastle University"},{"name":"Tune Army","school":"Newcastle University"},{"name":"SYE","school":"University of Stirling"}]},{"name":"United Kingdom QF4","location":"Exeter Northcott Theatre","date":"2025-02-16","groups":[{"name":"Aquapella","school":"University of Bath"},{"name":"Academy","school":"University of Bristol"},{"name":"Pitch Fight","school":"University of Bristol"},{"name":"The Bristol Suspensions","school":"University of Bristol"},{"name":"Aurum Voices","school":"Royal Welsh College of Music and Drama"},{"name":"Acappellads","school":"Cardiff University"},{"name":"Vox","school":"Cardiff University"},{"name":"The DeciBelles","school":"Cardiff University"},{"name":"Illuminations","school":"University of Exeter"},{"name":"Sweet Nothings","school":"University of Exeter"}]}],"semifinal":{"location":"London","date":"2025-03-15"}}},"finals":{"location":"The Town Hall, New York, NY","date":"2025-04-26"},"notes":"PDF posted Nov 15, 2024 (UK Nov 26) and noted as subject to change. Several anomalies: (1) 'Drexel Treblemakers' in Mid-Atlantic QF3 lists school as 'Drexel Treblemakers' in the PDF rather than 'Drexel University' \u2014 likely a PDF typo, corrected to 'Drexel University' here. (2) 'Trillium' in Southwest QF2 is listed with 'Dallas-Fort Worth' as affiliation \u2014 no university specified in the PDF; this may be a community group or the school name was omitted. (3) South semifinal date in PDF reads 'March 8th, 2024' \u2014 likely typo for 2025. Similarly, Southwest semifinal reads '2024' \u2014 corrected to 2025 here. Northeast semifinal reads 'March 30th, 2024' \u2014 also corrected to 2025. (4) The PDF says the Nottingham QF2 venue is 'The University of Nottingham' in the group listing but 'Squire Performing Arts Centre, Nottingham' for the location \u2014 used the venue name. (5) The University of Colorado appears as both 'University of Colorado' (Extreme Measures, In The Buff) and 'University of Colorado Boulder' (One Note Stand) \u2014 preserved as printed since these may be distinct campus references. (6) 'The University of Tennessee' and 'The University of Tennessee, Knoxville' both appear \u2014 preserved as printed. (7) 'University of Maryland' and 'University of Maryland, College Park' both appear (Mid-Atlantic QF3) \u2014 preserved as printed. (8) UK region has 4 quarterfinals (not 5 like US regions), with a different advancement structure including wildcards, as noted in the PDF. (9) West QF4 has 11 groups (not the usual 9-10). (10) The PDF formatting sometimes runs venue names into group names (e.g. 'UniversityBinghamtonics') \u2014 these were separated based on context."}
};

function importHistoryJSON() { document.getElementById('file-history-import').click(); }

function handleHistoryImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const raw = JSON.parse(ev.target.result);
      // Validate it's a history file
      if (!raw.year || !raw.regions) throw new Error('Not a valid history file. Expected {year, regions, ...}');

      const year = raw.year;
      const season = raw.season || (year - 1) + '-' + year;

      // Convert to editor format
      const editorData = convertHistoryToEditor(raw);

      // Store in HISTORY
      HISTORY[year] = {
        raw: raw,
        regions: editorData,
        meta: { season: season, source: raw.source || '', finals: raw.finals || null, notes: raw.notes || '' }
      };

      // Count stats
      let totalGroups = 0, totalSchools = 0;
      for (const rd of Object.values(editorData)) {
        totalGroups += rd.quarterfinals.reduce((s, qf) => s + qf.groups.length, 0);
        totalSchools += (rd.schools || []).length;
      }
      const regionCount = Object.keys(editorData).length;

      // Show modal with options
      showModal('Historical Year Loaded', `
        <div style="font-size:12px;color:#ccc;line-height:1.7;margin-bottom:12px">
          <strong style="color:#fff;font-size:14px">${year} Season</strong><br>
          ${regionCount} regions ¬∑ ${totalGroups} groups ¬∑ ${totalSchools} schools
          ${raw.source ? '<br><span style="color:#888">' + esc(raw.source.substring(0, 100)) + '</span>' : ''}
          ${raw.notes ? '<br><span style="color:#888;font-style:italic">' + esc(raw.notes.substring(0, 150)) + '</span>' : ''}
        </div>
        <div style="font-size:11px;color:#888;margin-bottom:16px">
          Years in memory: <strong style="color:#aaa">${Object.keys(HISTORY).sort().join(', ')}</strong>
        </div>
        <div class="modal-label">What do you want to do?</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button class="tb-btn primary" style="text-align:left;padding:8px 12px" onclick="loadHistoryYear(${year});closeModal()">
            <strong>Load as working data</strong><br><span style="font-weight:normal;font-size:10px;color:#aaa">Replace current editor with ${year} data (undoable)</span>
          </button>
          <button class="tb-btn" style="text-align:left;padding:8px 12px" onclick="closeModal()">
            <strong>Just store it</strong><br><span style="font-weight:normal;font-size:10px;color:#aaa">Keep in memory for later use via History dropdown</span>
          </button>
        </div>
      `, null);
      // Remove the default OK button since we have custom buttons
      const modal = document.getElementById('modal');
      const actions = modal.querySelector('.modal-actions');
      if (actions) actions.remove();

    } catch(err) { alert('History import failed: ' + err.message); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function convertHistoryToEditor(raw) {
  const palette = ['#E8B4B8','#CE9178','#B5CEA8','#9CDCFE','#C586C0','#DCDCAA','#D16969','#4EC9B0',
                    '#569CD6','#D7BA7D','#7B8CDE','#C3E88D','#F78C6C','#82AAFF','#F07178','#FFE082'];
  const editorData = {};
  let colorIdx = 0;

  // Helper to resolve location string to coordinates
  function resolveCoords(locStr) {
    if (!locStr) return {};
    // Direct match in SCHOOL_COORDS
    if (SCHOOL_COORDS[locStr]) return { lat: SCHOOL_COORDS[locStr][0], lng: SCHOOL_COORDS[locStr][1] };
    // Fuzzy: check if location contains a school name or vice versa
    for (const [sc, coords] of Object.entries(SCHOOL_COORDS)) {
      if (locStr.includes(sc) || sc.includes(locStr)) return { lat: coords[0], lng: coords[1] };
    }
    return {};
  }

  for (const [regionName, rd] of Object.entries(raw.regions)) {
    const color = palette[colorIdx++ % palette.length];
    const schools = rd.schools || [];
    const quarterfinals = (rd.quarterfinals || []).map(qf => {
      const groups = (qf.groups || []).map(g => {
        // Handle both group objects {name, school} and plain strings
        if (typeof g === 'object' && g.name) {
          const school = g.school || '';
          if (school && !SCHOOL_GROUPS[school]) SCHOOL_GROUPS[school] = [];
          if (school && !SCHOOL_GROUPS[school].includes(g.name)) SCHOOL_GROUPS[school].push(g.name);
          return school ? g.name + '@' + school : g.name;
        }
        // Plain string ‚Äî try to encode with existing SCHOOL_GROUPS
        if (typeof g === 'string' && !g.includes('@')) {
          for (const [sc, grps] of Object.entries(SCHOOL_GROUPS)) {
            if (grps.includes(g) && schools.includes(sc)) return g + '@' + sc;
          }
        }
        return g;
      });
      const coords = resolveCoords(qf.location);
      return {
        location: qf.location || null,
        lat: coords.lat || null,
        lng: coords.lng || null,
        groups: groups
      };
    });

    // Resolve semifinal coordinates
    let semifinal = rd.semifinal ? { ...rd.semifinal } : null;
    if (semifinal && semifinal.location && !semifinal.lat) {
      const sfCoords = resolveCoords(semifinal.location);
      if (sfCoords.lat) { semifinal.lat = sfCoords.lat; semifinal.lng = sfCoords.lng; }
    }

    editorData[regionName] = {
      color: color,
      schools: schools,
      quarterfinals: quarterfinals,
      semifinal: semifinal
    };
  }

  return editorData;
}

function loadHistoryYear(year) {
  const h = HISTORY[year];
  if (!h) return;
  saveUndo('load ' + h.meta.season);
  data = deepClone(h.regions);
  unassigned = [];
  regionGroups = {};
  openRegions = {};
  selectedRegionName = null;

  rebuildStateRegions();
  renderEditor(); renderMap();
  markDirty();
}

function compareHistoryYear(year) {
  const h = HISTORY[year];
  if (!h) return;
  // Store as the comparison target and activate compare mode
  HISTORY._compareYear = year;
  compareMode = true;
  const btn = document.getElementById('compare-btn');
  const banner = document.getElementById('compare-banner');
  btn.classList.add('active');
  btn.textContent = '‚ü∑ ' + year;
  banner.textContent = 'COMPARING WITH ' + year.toUpperCase();
  banner.classList.add('active');
  renderMap();
  updateMapStats();
}

function showAbout() {
  const modal = document.getElementById('modal');
  const overlay = document.getElementById('modal-overlay');
  modal.innerHTML = `<h3>About</h3>
    <div style="font-size:12px;color:#ccc;line-height:1.7;max-height:60vh;overflow-y:auto;padding-right:8px">
      <p style="margin:0 0 16px;color:#999;font-style:italic">Website created by <a href="https://brycedav.is" target="_blank" style="color:#7B8CDE">Bryce Davis</a> using Claude Opus 4.6. Feel free to email with bug reports or feature suggestions: <a href="mailto:bryce@brycedav.is" style="color:#7B8CDE">bryce@brycedav.is</a></p>

      <h4 style="margin:0 0 8px;font-size:13px;color:#fff;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:4px">ICCA Region Assignment Editor</h4>
      <p style="margin:0 0 12px">An interactive sandbox for experimenting with ICCA region restructuring and quarterfinal group assignments. Built for the people who stare at the bracket and think "what if we moved them there instead?"</p>

      <h4 style="margin:16px 0 8px;font-size:12px;color:#aaa">Core Editing</h4>
      <p style="margin:0 0 8px">Drag-and-drop groups between QFs within and across regions. Add, rename, and delete regions, quarterfinals, and groups. Edit group name, school, and QF assignment via modal. Move groups to/from an unassigned pool. Lasso-select school dots on the map to bulk-assign groups. 30-level undo stack (Ctrl/Cmd+Z). One-click reset to official 2026 data.</p>

      <h4 style="margin:16px 0 8px;font-size:12px;color:#aaa">Map</h4>
      <p style="margin:0 0 8px">Full US map with states colored by region, powered by D3.js and TopoJSON. Ontario province outline for Canadian schools. School dots colored by region ‚Äî every dot follows its groups when reassigned. QF venue markers (diamonds) and semifinal markers (stars). Co-located QFs indicated with a + pip and tabbed popups for switching between them. Zoom and pan with scaled dot sizes.</p>

      <h4 style="margin:16px 0 8px;font-size:12px;color:#aaa">View Mode / Edit Mode</h4>
      <p style="margin:0 0 8px">View mode for exploring the current structure with QF highlighting, venue popups, and stats bar. Edit mode for full drag-and-drop, lasso selection, and modals. Defaults to view mode on load.</p>

      <h4 style="margin:16px 0 8px;font-size:12px;color:#aaa">Import / Export</h4>
      <p style="margin:0 0 8px">Export or import full region configs as JSON. Export all groups as CSV (Group, School, Region, QF, Location, Date). Import groups from CSV with flexible placement ‚Äî provide Region + QF for exact placement, Region only to default to QF1, or just Group + School to add to the unassigned pool.</p>

      <h4 style="margin:16px 0 8px;font-size:12px;color:#aaa">Keyboard Shortcuts</h4>
      <p style="margin:0 0 4px"><span style="color:#fff;font-family:'Space Mono',monospace;font-size:11px">Ctrl/Cmd+Z</span> ‚Äî Undo</p>
      <p style="margin:0 0 4px"><span style="color:#fff;font-family:'Space Mono',monospace;font-size:11px">Enter</span> ‚Äî Confirm modal or dialog</p>
      <p style="margin:0 0 4px"><span style="color:#fff;font-family:'Space Mono',monospace;font-size:11px">Escape</span> ‚Äî Close modal or popup</p>
    </div>
    <div class="modal-actions">
      <button class="tb-btn primary" onclick="closeModal()">Close</button>
    </div>`;
  overlay.classList.add('active');
}

function showBulkRegionPicker(action, title, description, execute) {
  const regions = Object.keys(data);
  if (!regions.length) { alert('No regions exist.'); return; }
  let checkboxes = regions.map(rn => {
    const rd = data[rn];
    const gc = countGroups(rd) + (regionGroups[rn] || []).length;
    const qfc = rd.quarterfinals.length;
    return `<label style="display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:12px;color:#ccc;background:rgba(255,255,255,0.02)">
      <input type="checkbox" class="bulk-region-cb" data-region="${esc(rn)}" checked>
      <div class="region-swatch" style="background:${rd.color};width:10px;height:10px;border-radius:3px;flex-shrink:0"></div>
      <span style="flex:1">${rn}</span>
      <span style="font-size:10px;color:#666">${gc}g ¬∑ ${qfc}qf</span>
    </label>`;
  }).join('');

  showModal(title, `
    <div style="font-size:12px;color:#999;margin-bottom:10px">${description}</div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="tb-btn" style="font-size:10px;padding:3px 10px" onclick="document.querySelectorAll('.bulk-region-cb').forEach(c=>c.checked=true)">Select All</button>
      <button class="tb-btn" style="font-size:10px;padding:3px 10px" onclick="document.querySelectorAll('.bulk-region-cb').forEach(c=>c.checked=false)">Select None</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:4px;max-height:250px;overflow-y:auto">
      ${checkboxes}
    </div>
  `, () => {
    const selected = Array.from(document.querySelectorAll('.bulk-region-cb:checked')).map(cb => cb.dataset.region);
    if (!selected.length) return;
    execute(selected);
  });
  // Restyle confirm button
  const btn = document.getElementById('modal-ok');
  btn.textContent = action;
  btn.className = 'tb-btn danger';
}

function bulkDeleteAllQFs() {
  showBulkRegionPicker('Dissolve QFs', 'Dissolve Quarterfinals',
    'QFs in selected regions will be dissolved. Groups move to region ungrouped.',
    (selected) => {
      saveUndo('dissolve QFs');
      for (const rn of selected) {
        const rd = data[rn];
        if (!regionGroups[rn]) regionGroups[rn] = [];
        for (const qf of rd.quarterfinals) {
          regionGroups[rn].push(...qf.groups);
        }
        rd.quarterfinals = [];
        rebuildSchools(rn);
      }
      renderEditor(); renderMap();
    });
}

function bulkDeleteAllRegions() {
  showBulkRegionPicker('Delete Regions', 'Delete Regions',
    'Selected regions will be deleted. All groups move to the unassigned pool.',
    (selected) => {
      saveUndo('dissolve QFs');
      for (const rn of selected) {
        for (const qf of data[rn].quarterfinals) unassigned.push(...qf.groups);
        if (regionGroups[rn]) { unassigned.push(...regionGroups[rn]); delete regionGroups[rn]; }
        delete data[rn];
        for (const [st, r] of Object.entries(STATE_REGION)) { if (r === rn) delete STATE_REGION[st]; }
        if (selectedRegionName === rn) selectedRegionName = null;
      }
      renderEditor(); renderMap();
    });
}

function bulkClearAllGroups() {
  showBulkRegionPicker('Remove Groups', 'Remove All Groups',
    'All groups in selected regions will be removed. Regions and QFs remain.',
    (selected) => {
      saveUndo('clear groups');
      for (const rn of selected) {
        for (const qf of data[rn].quarterfinals) qf.groups = [];
        if (regionGroups[rn]) regionGroups[rn] = [];
        data[rn].schools = [];
      }
      renderEditor(); renderMap();
    });
}

function autoGenerateSF(regionName) {
  const rd = data[regionName];
  if (!rd) return;
  const schools = rd.schools || [];
  const coords = schools.map(sc => ({lat: SCHOOL_COORDS[sc]?.[0], lng: SCHOOL_COORDS[sc]?.[1], name: sc})).filter(c => c.lat);
  if (!coords.length) { alert('No schools with coordinates in this region.'); return; }
  const avgLat = coords.reduce((s,c) => s + c.lat, 0) / coords.length;
  const avgLng = coords.reduce((s,c) => s + c.lng, 0) / coords.length;
  let nearest = null, nearestC = null, minD = Infinity;
  for (const c of coords) {
    const d = Math.hypot(c.lat - avgLat, c.lng - avgLng);
    if (d < minD) { minD = d; nearest = c.name; nearestC = c; }
  }
  saveUndo('generate SF');
  rd.semifinal = {date:'', location: nearest || '', lat: nearestC.lat, lng: nearestC.lng};
  renderEditor(); renderMap();
}

function bulkGenerateSFs() {
  showBulkRegionPicker('Generate SFs', 'Generate Semifinals',
    'Auto-generate semifinal venues at the geographic center of each selected region.',
    (selected) => {
      saveUndo('generate SF');
      for (const rn of selected) {
        const rd = data[rn];
        const schools = rd.schools || [];
        const coords = schools.map(sc => ({lat: SCHOOL_COORDS[sc]?.[0], lng: SCHOOL_COORDS[sc]?.[1], name: sc})).filter(c => c.lat);
        if (!coords.length) continue;
        const avgLat = coords.reduce((s,c) => s + c.lat, 0) / coords.length;
        const avgLng = coords.reduce((s,c) => s + c.lng, 0) / coords.length;
        let nearest = null, nearestC = null, minD = Infinity;
        for (const c of coords) {
          const d = Math.hypot(c.lat - avgLat, c.lng - avgLng);
          if (d < minD) { minD = d; nearest = c.name; nearestC = c; }
        }
        rd.semifinal = {date:'', location: nearest || '', lat: nearestC.lat, lng: nearestC.lng};
      }
      renderEditor(); renderMap();
    });
}

function bulkGenerateQFs() {
  showBulkRegionPicker('Generate QFs', 'Generate Quarterfinals',
    'Auto-generate QFs from ungrouped groups in each selected region (~10 groups per QF, geographic clustering).',
    (selected) => {
      saveUndo('generate QFs');
      let generated = 0;
      for (const rn of selected) {
        if ((regionGroups[rn] || []).length) {
          generateQFsForRegion(rn);
          generated++;
        }
      }
      if (!generated) alert('No regions had ungrouped groups to cluster.');
      for (const rn of Object.keys(data)) rebuildSchools(rn);
      renderEditor(); renderMap();
    });
}

// ‚îÄ‚îÄ‚îÄ REBALANCE REGIONS ‚îÄ‚îÄ‚îÄ
function rebalanceRegions() {
  const regions = Object.keys(data);
  if (regions.length < 2) { alert('Need at least 2 regions to rebalance.'); return; }

  const gCounts = regions.map(rn => countGroups(data[rn]) + (regionGroups[rn] || []).length);
  const totalGroups = gCounts.reduce((a,b) => a+b, 0);
  const idealG = totalGroups / regions.length;
  const maxG = Math.max(...gCounts), minG = Math.min(...gCounts);
  const ratioG = maxG / Math.max(1, minG);

  showModal('Rebalance Regions', `
    <div style="font-size:12px;color:#ccc;line-height:1.7;margin-bottom:12px">
      Move schools (with all their groups) from oversized regions to nearest undersized regions.
      Balances by <strong style="color:#fff">group count</strong>, not just school count.
    </div>
    <div style="font-size:12px;color:#999;margin-bottom:12px">
      Current: <strong style="color:#fff">${totalGroups}</strong> groups across <strong style="color:#fff">${regions.length}</strong> regions.
      Ideal: ~<strong style="color:#fff">${Math.round(idealG)}</strong> groups/region.
      Range: ${minG}‚Äì${maxG} (${ratioG.toFixed(1)}:1 ratio).
    </div>
    <div class="modal-row" style="margin-bottom:12px">
      <div style="flex:1">
        <div class="modal-label">Max allowed ratio (largest:smallest)</div>
        <input class="modal-input" id="m-rebal-ratio" type="number" min="1.1" max="3.0" step="0.1" value="1.3">
      </div>
    </div>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-rebal-states" checked> Reassign states after rebalancing
    </label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-rebal-qfs"> Regenerate QFs after rebalancing
    </label>
  `, () => {
    const targetRatio = parseFloat(document.getElementById('m-rebal-ratio').value) || 1.3;
    const regenStates = document.getElementById('m-rebal-states').checked;
    const regenQFs = document.getElementById('m-rebal-qfs').checked;
    executeRebalance(targetRatio, regenStates, regenQFs);
  });
}

function executeRebalance(targetRatio, regenStates, regenQFs) {
  const regions = Object.keys(data);
  const allLats = [];
  for (const rn of regions) {
    for (const sc of (data[rn].schools || [])) {
      if (SCHOOL_COORDS[sc]) allLats.push(SCHOOL_COORDS[sc][0]);
    }
  }
  const meanLat = allLats.length ? allLats.reduce((a,b) => a+b, 0) / allLats.length : 40;
  const lngScale = Math.cos(meanLat * Math.PI / 180);
  const geoDist = (a, b) => Math.hypot(a[0] - b[0], (a[1] - b[1]) * lngScale);

  saveUndo('rebalance regions');

  // Build mutable school sets per region
  const rSchools = {};
  for (const rn of regions) {
    rSchools[rn] = new Set((data[rn].schools || []).filter(sc => SCHOOL_COORDS[sc]));
  }

  // Count groups per region (this is what we balance on)
  const groupCountOf = (rn) => {
    let count = data[rn].quarterfinals.reduce((s, qf) => s + qf.groups.length, 0);
    count += (regionGroups[rn] || []).length;
    return count;
  };

  // Count groups for a specific school within a region
  const schoolGroupCount = (sc) => (SCHOOL_GROUPS[sc] || []).length;

  const centroidOf = (rn) => {
    const schools = Array.from(rSchools[rn]);
    if (!schools.length) return [0, 0];
    const lat = schools.reduce((s, sc) => s + SCHOOL_COORDS[sc][0], 0) / schools.length;
    const lng = schools.reduce((s, sc) => s + SCHOOL_COORDS[sc][1], 0) / schools.length;
    return [lat, lng];
  };

  for (let pass = 0; pass < 500; pass++) {
    // Use GROUP counts for balance, not school counts
    const gCounts = {};
    for (const rn of regions) gCounts[rn] = groupCountOf(rn);
    const sizes = regions.map(rn => gCounts[rn]);
    const maxSize = Math.max(...sizes), minSize = Math.max(1, Math.min(...sizes));
    if (maxSize / minSize <= targetRatio) break;

    const bigRn = regions[sizes.indexOf(maxSize)];
    const smallRn = regions[sizes.indexOf(minSize)];
    const bigCentroid = centroidOf(bigRn);
    const smallCentroid = centroidOf(smallRn);

    // Find school in bigRn that is furthest from its centroid AND nearest to smallRn centroid
    // Prefer schools with fewer groups (smaller disruption)
    let bestSc = null, bestScore = -Infinity;
    for (const sc of rSchools[bigRn]) {
      const coord = SCHOOL_COORDS[sc];
      const geoScore = geoDist(coord, bigCentroid) - geoDist(coord, smallCentroid);
      // Only move if school is geographically closer to target than current (geoScore > 0)
      // or if the imbalance is severe enough to justify it
      const imbalanceSeverity = (maxSize - minSize) / maxSize;
      if (geoScore <= 0 && imbalanceSeverity < 0.3) continue;
      const score = geoScore + imbalanceSeverity * 5;
      if (score > bestScore) { bestScore = score; bestSc = sc; }
    }

    if (!bestSc) break;

    // Move school and all its groups from bigRn to smallRn
    rSchools[bigRn].delete(bestSc);
    rSchools[smallRn].add(bestSc);

    // Move groups: check QFs and regionGroups
    const groupsOfSchool = (SCHOOL_GROUPS[bestSc] || []).map(g => {
      // Find encoded version
      const encoded = g.includes('@') ? g : g + '@' + bestSc;
      return encoded;
    });

    // Search all QFs in bigRn for these groups
    for (const qf of data[bigRn].quarterfinals) {
      for (let i = qf.groups.length - 1; i >= 0; i--) {
        if (schoolOf(qf.groups[i]) === bestSc) {
          const g = qf.groups.splice(i, 1)[0];
          if (!regionGroups[smallRn]) regionGroups[smallRn] = [];
          regionGroups[smallRn].push(g);
        }
      }
    }
    // Check regionGroups
    if (regionGroups[bigRn]) {
      for (let i = regionGroups[bigRn].length - 1; i >= 0; i--) {
        if (schoolOf(regionGroups[bigRn][i]) === bestSc) {
          const g = regionGroups[bigRn].splice(i, 1)[0];
          if (!regionGroups[smallRn]) regionGroups[smallRn] = [];
          regionGroups[smallRn].push(g);
        }
      }
    }
  }

  // Update school lists
  for (const rn of regions) {
    data[rn].schools = Array.from(rSchools[rn]);
  }

  // Reassign states BEFORE rebuildSchools overwrites school lists
  if (regenStates) {
    rebuildStateRegions();
  }

  // Now rebuild school lists from QF/regionGroup contents
  for (const rn of regions) rebuildSchools(rn);

  // Regenerate QFs if requested
  if (regenQFs) {
    const totalGroups = regions.reduce((s, rn) => {
      return s + (regionGroups[rn] || []).length + data[rn].quarterfinals.reduce((s2, qf) => s2 + qf.groups.length, 0);
    }, 0);
    // Dissolve existing QFs first
    for (const rn of regions) {
      for (const qf of data[rn].quarterfinals) {
        if (!regionGroups[rn]) regionGroups[rn] = [];
        regionGroups[rn].push(...qf.groups);
      }
      data[rn].quarterfinals = [];
    }
    const totalQFs = Math.max(regions.length, Math.round(totalGroups / 10));
    const qfsPerRegion = Math.max(1, Math.round(totalQFs / regions.length));
    for (const rn of regions) {
      if (regionGroups[rn] && regionGroups[rn].length) generateQFsForRegion(rn, qfsPerRegion);
    }
  }

  renderEditor(); renderMap();
  const gCounts = regions.map(rn => {
    return data[rn].quarterfinals.reduce((s, qf) => s + qf.groups.length, 0) + (regionGroups[rn] || []).length;
  });
  const ratio = Math.max(...gCounts) / Math.max(1, Math.min(...gCounts));
  alert(`Rebalanced! Groups/region: ${Math.min(...gCounts)}‚Äì${Math.max(...gCounts)} (${ratio.toFixed(1)}:1 ratio)`);
}

// ‚îÄ‚îÄ‚îÄ SEED FROM 2026 ‚îÄ‚îÄ‚îÄ
function seedFrom2026() {
  const baseRegions = Object.keys(REGIONS);
  if (!baseRegions.length) { alert('No base 2026 data available.'); return; }

  // Check if there are unassigned groups to work with
  const poolGroups = [...unassigned];
  for (const rgs of Object.values(regionGroups)) poolGroups.push(...rgs);
  const totalGroups = poolGroups.length + Object.values(data).reduce((s, rd) => s + rd.quarterfinals.reduce((s2, qf) => s2 + qf.groups.length, 0), 0);

  showModal('Seed from 2026', `
    <div style="font-size:12px;color:#ccc;line-height:1.7;margin-bottom:12px">
      Use the 2026 base region centroids as starting points for k-means clustering, then rebalance.
      Preserves the general geographic structure while allowing size equalization.
    </div>
    <div style="font-size:12px;color:#999;margin-bottom:12px">
      Base 2026 has <strong style="color:#fff">${baseRegions.length}</strong> regions.
      Current data has <strong style="color:#fff">${totalGroups}</strong> total groups.
    </div>
    <div class="modal-row" style="margin-bottom:12px">
      <div style="flex:1">
        <div class="modal-label">Number of regions</div>
        <input class="modal-input" id="m-seed-k" type="number" min="2" max="30" value="${baseRegions.length}">
      </div>
    </div>
    <div style="font-size:10px;color:#555;margin:-6px 0 12px">Set equal to or less than base region count (${baseRegions.length}) to use base centroids. Higher values add random seeds.</div>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-seed-qfs" checked> Generate QFs
    </label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-seed-sfs" checked> Generate semifinals
    </label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-seed-states" checked> Auto-assign states
    </label>
  `, () => {
    const k = parseInt(document.getElementById('m-seed-k').value) || baseRegions.length;
    const genQFs = document.getElementById('m-seed-qfs').checked;
    const genSFs = document.getElementById('m-seed-sfs').checked;
    const genStates = document.getElementById('m-seed-states').checked;
    executeSeedFrom2026(k, genQFs, genSFs, genStates);
  });
}

function executeSeedFrom2026(k, genQFs, genSFs, genStates) {
  // Collect all schools into pool
  const poolSchools = new Set();
  // Dissolve everything into unassigned first
  for (const [rn, rd] of Object.entries(data)) {
    for (const qf of rd.quarterfinals) unassigned.push(...qf.groups);
    if (regionGroups[rn]) { unassigned.push(...regionGroups[rn]); delete regionGroups[rn]; }
  }
  // Clear data
  for (const rn of Object.keys(data)) delete data[rn];
  regionGroups = {};

  for (const g of unassigned) {
    const sc = schoolOf(g);
    if (sc && SCHOOL_COORDS[sc]) poolSchools.add(sc);
  }

  if (!poolSchools.size) { alert('No groups with coordinates.'); return; }

  // Compute base 2026 region centroids (excluding UK for US clustering)
  const baseCentroids = [];
  for (const rn of Object.keys(REGIONS)) {
    const rd = REGIONS[rn];
    const schools = (rd.schools || []).filter(sc => SCHOOL_COORDS[sc]);
    if (!schools.length) continue;
    const lat = schools.reduce((s, sc) => s + SCHOOL_COORDS[sc][0], 0) / schools.length;
    const lng = schools.reduce((s, sc) => s + SCHOOL_COORDS[sc][1], 0) / schools.length;
    baseCentroids.push({lat, lng, name: rn});
  }

  // Use base centroids as seeds, add more via k-means++ if k > base count
  // Pass to executeGenerateRegions with pre-seeded centroids
  executeGenerateRegions(Array.from(poolSchools), k, genQFs, genSFs, genStates, baseCentroids);
}

// ‚îÄ‚îÄ‚îÄ AUDIT ‚îÄ‚îÄ‚îÄ
function runAudit() {
  const issues = [];

  // 1. Groups in QFs without school encoding
  let noSchool = 0;
  for (const [rn, rd] of Object.entries(data)) {
    for (const qf of rd.quarterfinals) {
      for (const g of qf.groups) {
        if (!schoolOf(g)) noSchool++;
      }
    }
  }
  if (noSchool) issues.push(`‚ö† <strong>${noSchool}</strong> groups without school affiliation`);

  // 2. Groups appearing in multiple QFs/regions
  const groupLocations = {};
  for (const [rn, rd] of Object.entries(data)) {
    for (let qi = 0; qi < rd.quarterfinals.length; qi++) {
      for (const g of rd.quarterfinals[qi].groups) {
        if (!groupLocations[g]) groupLocations[g] = [];
        groupLocations[g].push(`${rn} QF${qi+1}`);
      }
    }
    for (const g of (regionGroups[rn] || [])) {
      if (!groupLocations[g]) groupLocations[g] = [];
      groupLocations[g].push(`${rn} ungrouped`);
    }
  }
  for (const g of unassigned) {
    if (!groupLocations[g]) groupLocations[g] = [];
    groupLocations[g].push('unassigned');
  }
  const dupes = Object.entries(groupLocations).filter(([g, locs]) => locs.length > 1);
  if (dupes.length) {
    issues.push(`‚ö† <strong>${dupes.length}</strong> groups in multiple locations:`);
    for (const [g, locs] of dupes.slice(0, 5)) {
      issues.push(`&nbsp;&nbsp;‚Ä¢ ${displayName(g)} ‚Üí ${locs.join(', ')}`);
    }
    if (dupes.length > 5) issues.push(`&nbsp;&nbsp;‚Ä¢ ...and ${dupes.length - 5} more`);
  }

  // 3. Schools in SCHOOL_GROUPS without coords (non-UK)
  const ukSchools = new Set(Object.keys(SCHOOL_GROUPS).filter(sc => {
    // Heuristic: UK schools
    return sc.includes('University of Aberdeen') || sc.includes('St Andrews') || sc.includes('Cambridge') ||
      sc.includes('Edinburgh') || sc.includes('Stirling') || sc.includes('Birmingham') ||
      sc.includes('Nottingham') || sc.includes('Warwick') || sc.includes('Leeds') ||
      sc.includes('Sheffield') || sc.includes('York') || sc.includes('Bristol') ||
      sc.includes('Bath') || sc.includes('Royal Welsh') || sc.includes('Cardiff') ||
      sc.includes('Exeter') || sc.includes('Durham') || sc.includes('Oxford') ||
      sc.includes('Lancaster') || sc.includes('Manchester') || sc.includes('Newcastle') ||
      sc.includes('University College London') || sc.includes('London School') ||
      sc.includes('Imperial College') || sc.includes("King's College") || sc.includes('Reading');
  }));
  const missingCoords = Object.keys(SCHOOL_GROUPS).filter(sc =>
    !SCHOOL_COORDS[sc] && SCHOOL_GROUPS[sc].length > 0 && !ukSchools.has(sc)
  );
  if (missingCoords.length) {
    issues.push(`‚ö† <strong>${missingCoords.length}</strong> non-UK schools without coordinates:`);
    for (const sc of missingCoords.slice(0, 5)) issues.push(`&nbsp;&nbsp;‚Ä¢ ${sc}`);
    if (missingCoords.length > 5) issues.push(`&nbsp;&nbsp;‚Ä¢ ...and ${missingCoords.length - 5} more`);
  }

  // 4. Empty QFs
  let emptyQFs = 0;
  for (const [rn, rd] of Object.entries(data)) {
    for (const qf of rd.quarterfinals) { if (!qf.groups.length) emptyQFs++; }
  }
  if (emptyQFs) issues.push(`‚ö† <strong>${emptyQFs}</strong> empty quarterfinals`);

  // 5. States not assigned
  const unassignedStates = Object.keys(ORIG_STATE_REGION).filter(st => !STATE_REGION[st]);
  if (unassignedStates.length) {
    issues.push(`‚ö† <strong>${unassignedStates.length}</strong> states without region assignment: ${unassignedStates.slice(0, 8).join(', ')}${unassignedStates.length > 8 ? '...' : ''}`);
  }

  // 6. QF count variance
  const qfCounts = Object.values(data).map(rd => rd.quarterfinals.length).filter(n => n > 0);
  if (qfCounts.length > 1) {
    const minQF = Math.min(...qfCounts), maxQF = Math.max(...qfCounts);
    if (maxQF > minQF) {
      issues.push(`‚Ñπ QF count varies: ${minQF}‚Äì${maxQF} per region (affects bracket balance)`);
    }
  }

  // 7. Region size variance
  const regionSizes = Object.values(data).map(rd => (rd.schools || []).length);
  if (regionSizes.length > 1) {
    const minR = Math.min(...regionSizes), maxR = Math.max(...regionSizes);
    const ratio = maxR / Math.max(1, minR);
    if (ratio > 1.5) {
      issues.push(`‚Ñπ Region sizes vary significantly: ${minR}‚Äì${maxR} schools (${ratio.toFixed(1)}:1 ratio)`);
    }
  }

  // 8. Groups in unassigned pool
  if (unassigned.length) {
    issues.push(`‚Ñπ <strong>${unassigned.length}</strong> groups in unassigned pool`);
  }

  // Display
  const html = issues.length
    ? issues.map(i => `<div style="padding:4px 0;font-size:12px;color:#ccc;line-height:1.5">${i}</div>`).join('')
    : '<div style="padding:12px 0;font-size:13px;color:#82B366;text-align:center">‚úì All checks passed!</div>';

  const modal = document.getElementById('modal');
  const overlay = document.getElementById('modal-overlay');
  modal.innerHTML = `<h3>Data Audit</h3>
    <div style="max-height:60vh;overflow-y:auto;padding-right:8px">${html}</div>
    <div class="modal-actions">
      <button class="tb-btn primary" onclick="closeModal()">Close</button>
    </div>`;
  overlay.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ GENERATE REGIONS ‚îÄ‚îÄ‚îÄ
const REGION_PALETTE = ['#6C8EBF','#82B366','#D4A03C','#B85450','#9673A6','#D6836E','#5BA4CF','#C9A227','#6BAF7B','#CC7A9E','#7E9BB0','#A8B95A','#D48C4E','#8C7DBB','#4FA8AA'];

function generateRegions() {
  // Collect schools from unassigned pool AND regionGroups (if regions are being rebuilt)
  const poolSchools = new Set();
  const poolGroups = [...unassigned];
  for (const rgs of Object.values(regionGroups)) poolGroups.push(...rgs);
  for (const g of poolGroups) {
    const sc = schoolOf(g);
    if (sc && SCHOOL_COORDS[sc]) poolSchools.add(sc);
  }
  if (!poolSchools.size && !Object.keys(data).length) { alert('No unassigned groups with coordinates to cluster. Use Bulk ‚Üí Dissolve QFs and/or Delete Regions first.'); return; }

  const totalGroups = poolGroups.length;
  const autoK = Math.max(2, Math.round(poolSchools.size / 20));

  // Show existing regions as lockable
  const existingRegions = Object.keys(data);
  let lockSection = '';
  if (existingRegions.length) {
    const lockItems = existingRegions.map(rn => {
      const rd = data[rn];
      const gc = countGroups(rd) + (regionGroups[rn] || []).length;
      return `<label style="display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:12px;color:#ccc;background:rgba(255,255,255,0.02)">
        <input type="checkbox" class="lock-region-cb" data-region="${esc(rn)}" checked>
        <div style="background:${rd.color};width:10px;height:10px;border-radius:3px;flex-shrink:0"></div>
        <span style="flex:1">${rn}</span>
        <span style="font-size:10px;color:#666">${gc}g</span>
      </label>`;
    }).join('');
    lockSection = `
      <div class="modal-label" style="margin-top:8px">Lock existing regions (unchecked = dissolve into pool)</div>
      <div style="display:flex;gap:6px;margin-bottom:4px">
        <button class="tb-btn" style="font-size:10px;padding:2px 8px" onclick="document.querySelectorAll('.lock-region-cb').forEach(c=>c.checked=true)">Lock All</button>
        <button class="tb-btn" style="font-size:10px;padding:2px 8px" onclick="document.querySelectorAll('.lock-region-cb').forEach(c=>c.checked=false)">Unlock All</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;max-height:150px;overflow-y:auto;margin-bottom:12px">${lockItems}</div>
    `;
  }

  const poolLabel = poolSchools.size
    ? `Create regions by geographically clustering <strong style="color:#fff">${poolSchools.size}</strong> schools (<strong style="color:#fff">${totalGroups}</strong> groups) from the unassigned pool.`
    : `No unassigned groups. Unlock existing regions above to redistribute their schools.`;

  showModal('Generate Regions', `
    <div style="font-size:12px;color:#999;margin-bottom:12px">${poolLabel}</div>
    ${lockSection}
    <div class="modal-row" style="margin-bottom:12px">
      <div style="flex:1">
        <div class="modal-label">Number of NEW regions to create</div>
        <input class="modal-input" id="m-k" type="number" min="1" max="30" value="${poolSchools.size ? autoK : 4}">
      </div>
      <div style="flex:1">
        <div class="modal-label">Or target schools/region</div>
        <input class="modal-input" id="m-target-size" type="number" min="5" max="100" placeholder="${poolSchools.size ? Math.round(poolSchools.size / autoK) : ''}">
      </div>
    </div>
    <div style="font-size:10px;color:#555;margin:-6px 0 12px">Fill one or the other. Target size overrides region count.</div>
    <div class="modal-label">Options</div>
    <div class="modal-row" style="margin-bottom:8px">
      <div style="flex:1">
        <div class="modal-label">Balance strictness</div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:10px;color:#666">Geography</span>
          <input type="range" id="m-balance" min="0" max="2" value="1" style="flex:1">
          <span style="font-size:10px;color:#666">Equal size</span>
        </div>
        <div style="font-size:10px;color:#555;margin-top:2px">Low = compact regions (unequal groups). High = equal groups (wider regions).</div>
      </div>
    </div>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-gen-qfs" checked> Also generate QFs within each region (~10 groups per QF)
    </label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-gen-sfs" checked> Generate semifinal venues (region centroid)
    </label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#ccc;padding:4px 0;cursor:pointer">
      <input type="checkbox" id="m-gen-states" checked> Auto-assign states to regions
    </label>
  `, () => {
    // Dissolve unlocked regions into the pool
    const lockedRegions = new Set(Array.from(document.querySelectorAll('.lock-region-cb:checked')).map(cb => cb.dataset.region));
    for (const rn of existingRegions) {
      if (!lockedRegions.has(rn)) {
        for (const qf of data[rn].quarterfinals) unassigned.push(...qf.groups);
        if (regionGroups[rn]) { unassigned.push(...regionGroups[rn]); delete regionGroups[rn]; }
        for (const [st, r] of Object.entries(STATE_REGION)) { if (r === rn) delete STATE_REGION[st]; }
        delete data[rn];
      }
    }

    // Recalculate pool schools after dissolving
    const newPoolSchools = new Set();
    const allPoolGroups = [...unassigned];
    for (const rgs of Object.values(regionGroups)) allPoolGroups.push(...rgs);
    for (const g of allPoolGroups) {
      const sc = schoolOf(g);
      if (sc && SCHOOL_COORDS[sc]) newPoolSchools.add(sc);
    }

    const targetSize = parseInt(document.getElementById('m-target-size').value);
    let newK = parseInt(document.getElementById('m-k').value) || autoK;
    if (targetSize && targetSize > 0) newK = Math.max(1, Math.round(newPoolSchools.size / targetSize));
    newK = Math.min(newK, newPoolSchools.size);
    const genQFs = document.getElementById('m-gen-qfs').checked;
    const genSFs = document.getElementById('m-gen-sfs').checked;
    const genStates = document.getElementById('m-gen-states').checked;
    const balanceLevel = parseInt(document.getElementById('m-balance').value) || 1;

    if (newPoolSchools.size) {
      executeGenerateRegions(Array.from(newPoolSchools), newK, genQFs, genSFs, genStates, null, balanceLevel);
    } else {
      renderEditor(); renderMap();
    }
  });

  // Sync inputs
  setTimeout(() => {
    const kInput = document.getElementById('m-k');
    const sizeInput = document.getElementById('m-target-size');
    kInput.addEventListener('input', () => { sizeInput.value = ''; });
    sizeInput.addEventListener('input', () => {
      const sz = parseInt(sizeInput.value);
      if (sz > 0) kInput.value = Math.max(2, Math.round(poolSchools.size / sz));
    });
  }, 50);
}

function executeGenerateRegions(schools, k, genQFs, genSFs, genStates, seedCentroids, balanceLevel) {
  balanceLevel = balanceLevel || 1; // 0=geography, 1=balanced, 2=strict equal
  // First, consolidate all region-level ungrouped groups into the unassigned pool
  for (const [rn, rgs] of Object.entries(regionGroups)) {
    unassigned.push(...rgs);
  }
  regionGroups = {};

  // Build coordinate items WITH group weight
  const items = schools.map(sc => {
    const c = SCHOOL_COORDS[sc];
    const weight = (SCHOOL_GROUPS[sc] || []).length || 1;
    return {school: sc, lat: c[0], lng: c[1], weight};
  });

  // Longitude scale factor for true geographic distance
  const avgLat = items.reduce((s, it) => s + it.lat, 0) / items.length;
  const lngScale = Math.cos(avgLat * Math.PI / 180);
  const geoDist = (a, b) => Math.hypot(a.lat - b.lat, (a.lng - b.lng) * lngScale);

  // Initialize centroids: use seeds if provided, otherwise k-means++
  const centroids = [];
  if (seedCentroids && seedCentroids.length) {
    // Use up to k seed centroids, sorted by distance spread for best coverage
    const seeds = seedCentroids.slice(0, k);
    for (const s of seeds) centroids.push({lat: s.lat, lng: s.lng});
    // Fill remaining with k-means++ from items
    while (centroids.length < k) {
      let maxDist = -1, best = null;
      for (const item of items) {
        let minD = Infinity;
        for (const c of centroids) { const d = geoDist(item, c); if (d < minD) minD = d; }
        if (minD > maxDist) { maxDist = minD; best = item; }
      }
      if (best) centroids.push({lat: best.lat, lng: best.lng});
      else break;
    }
  } else {
    // K-means++ initialization
    centroids.push({lat: items[0].lat, lng: items[0].lng});
    for (let ci = 1; ci < k; ci++) {
      let maxDist = -1, best = null;
      for (const item of items) {
        let minD = Infinity;
        for (const c of centroids) { const d = geoDist(item, c); if (d < minD) minD = d; }
        if (minD > maxDist) { maxDist = minD; best = item; }
      }
      centroids.push({lat: best.lat, lng: best.lng});
    }
  }

  // Standard k-means iteration (30 rounds)
  let assignments = new Array(items.length).fill(0);
  for (let iter = 0; iter < 30; iter++) {
    let changed = false;
    for (let i = 0; i < items.length; i++) {
      let minD = Infinity, best = 0;
      for (let ci = 0; ci < k; ci++) { const d = geoDist(items[i], centroids[ci]); if (d < minD) { minD = d; best = ci; } }
      if (assignments[i] !== best) { changed = true; assignments[i] = best; }
    }
    if (!changed) break;
    for (let ci = 0; ci < k; ci++) {
      const members = items.filter((_, i) => assignments[i] === ci);
      if (members.length) {
        centroids[ci].lat = members.reduce((s, m) => s + m.lat, 0) / members.length;
        centroids[ci].lng = members.reduce((s, m) => s + m.lng, 0) / members.length;
      }
    }
  }

  // Build clusters
  const clusters = [];
  for (let ci = 0; ci < k; ci++) clusters.push([]);
  for (let i = 0; i < items.length; i++) clusters[assignments[i]].push(items[i]);

  // Swap-based balancing: use GROUP COUNTS not school counts
  const totalGroups = items.reduce((s, it) => s + it.weight, 0);
  const idealGroupSize = totalGroups / k;

  // Weighted size of a cluster
  const clusterGroupCount = (ci) => clusters[ci].reduce((s, it) => s + it.weight, 0);

  // Recalculate centroids from current clusters
  const recomputeCentroids = () => {
    for (let ci = 0; ci < k; ci++) {
      if (!clusters[ci].length) continue;
      centroids[ci].lat = clusters[ci].reduce((s, m) => s + m.lat, 0) / clusters[ci].length;
      centroids[ci].lng = clusters[ci].reduce((s, m) => s + m.lng, 0) / clusters[ci].length;
    }
  };

  // Progressive balance tightening ‚Äî strictness depends on balanceLevel
  // Level 0 (Geography): loose ceiling, no floor ‚Äî compact regions, unequal sizes
  // Level 1 (Balanced): moderate ceiling + floor ‚Äî reasonable compromise
  // Level 2 (Equal size): tight ceiling + high floor ‚Äî near-equal groups, wider regions
  const thresholdSets = [
    [[1.8, 1.0]], // geography: single loose pass
    [[1.5, 1.0], [1.3, 0.7], [1.15, 0.4]], // balanced: 3 passes
    [[1.4, 0.8], [1.2, 0.5], [1.1, 0.2], [1.05, 0.1]], // strict: 4 tight passes
  ];
  const floorPcts = [0, 0.5, 0.75]; // min % of ideal group count
  const passes = thresholdSets[balanceLevel];
  const minGroupSize = Math.floor(idealGroupSize * floorPcts[balanceLevel]);
  for (let ti2 = 0; ti2 < passes.length; ti2++) {
    const [thresh, geoWeight] = passes[ti2];
    const curMaxGroups = Math.ceil(idealGroupSize * thresh);
    for (let pass = 0; pass < 300; pass++) {
      recomputeCentroids();

      // Find the most oversized cluster BY GROUP COUNT
      let bigIdx = -1, bigGroups = 0;
      for (let ci = 0; ci < k; ci++) {
        const gc = clusterGroupCount(ci);
        if (gc > bigGroups) { bigGroups = gc; bigIdx = ci; }
      }
      if (bigGroups <= curMaxGroups) break;

      // Find the best school to move: furthest from big centroid, closest to ANY undersized cluster
      // Prefer moving schools with fewer groups (less disruption per move)
      let bestItem = -1, bestTarget = -1, bestScore = -Infinity;
      for (let j = 0; j < clusters[bigIdx].length; j++) {
        const item = clusters[bigIdx][j];
        const distFromBig = geoDist(item, centroids[bigIdx]);
        for (let ti = 0; ti < k; ti++) {
          if (ti === bigIdx || clusterGroupCount(ti) >= curMaxGroups) continue;
          // Don't move if it would make target bigger than current big
          if (clusterGroupCount(ti) + item.weight > bigGroups) continue;
          const distToTarget = geoDist(item, centroids[ti]);
          const score = distFromBig - distToTarget * geoWeight;
          if (score > bestScore) { bestScore = score; bestItem = j; bestTarget = ti; }
        }
      }

      if (bestItem >= 0 && bestTarget >= 0 && bestScore > -Infinity) {
        clusters[bestTarget].push(clusters[bigIdx].splice(bestItem, 1)[0]);
      } else break;
    }
  }

  // Floor enforcement: pull schools from nearest NEIGHBOR into undersized clusters
  // (skipped at balanceLevel 0 ‚Äî geography mode has no floor)
  if (minGroupSize > 0) {
  for (let floorPass = 0; floorPass < 300; floorPass++) {
    recomputeCentroids();
    // Find the most undersized cluster
    let smallIdx = -1, smallGroups = Infinity;
    for (let ci = 0; ci < k; ci++) {
      const gc = clusterGroupCount(ci);
      if (gc < smallGroups) { smallGroups = gc; smallIdx = ci; }
    }
    if (smallGroups >= minGroupSize) break;

    // Find the nearest cluster that has more groups than this one
    let nearestBig = -1, nearestDist = Infinity;
    for (let ci = 0; ci < k; ci++) {
      if (ci === smallIdx || clusterGroupCount(ci) <= smallGroups) continue;
      const d = geoDist(centroids[smallIdx], centroids[ci]);
      if (d < nearestDist) { nearestDist = d; nearestBig = ci; }
    }
    if (nearestBig === -1) break;

    // Find the school in nearestBig that is closest to smallIdx's centroid
    let bestJ = -1, bestD = Infinity;
    for (let j = 0; j < clusters[nearestBig].length; j++) {
      const d = geoDist(clusters[nearestBig][j], centroids[smallIdx]);
      if (d < bestD) { bestD = d; bestJ = j; }
    }
    if (bestJ >= 0) {
      clusters[smallIdx].push(clusters[nearestBig].splice(bestJ, 1)[0]);
    } else break;
  }
  } // end if (minGroupSize > 0)

  // Name regions by geographic center
  const usedColors = new Set(Object.values(data).map(rd => rd.color));
  saveUndo('generate regions');

  for (let ci = 0; ci < clusters.length; ci++) {
    if (!clusters[ci].length) continue;
    const clusterSchools = clusters[ci].map(it => it.school);
    const name = generateRegionName(clusters[ci]);

    // Pick unused color
    let color = REGION_PALETTE.find(c => !usedColors.has(c)) || REGION_PALETTE[ci % REGION_PALETTE.length];
    usedColors.add(color);

    // Compute SF from cluster centroid
    let sfData = {date:'', location:'', lat:null, lng:null};
    if (genSFs && clusterSchools.length) {
      const coords = clusterSchools.map(sc => ({lat: SCHOOL_COORDS[sc][0], lng: SCHOOL_COORDS[sc][1], name: sc})).filter(c => c.lat);
      if (coords.length) {
        const avgLat = coords.reduce((s,c) => s + c.lat, 0) / coords.length;
        const avgLng = coords.reduce((s,c) => s + c.lng, 0) / coords.length;
        let nearest = null, nearestC = null, minD = Infinity;
        for (const c of coords) {
          const d = Math.hypot(c.lat - avgLat, c.lng - avgLng);
          if (d < minD) { minD = d; nearest = c.name; nearestC = c; }
        }
        sfData = {date:'', location: nearest || '', lat: nearestC.lat, lng: nearestC.lng};
      }
    }

    data[name] = {
      color, accent: color, schools: clusterSchools, quarterfinals: [],
      semifinal: sfData
    };
    regionGroups[name] = [];

    // Move groups from unassigned pool to regionGroups
    for (let i = unassigned.length - 1; i >= 0; i--) {
      const sc = schoolOf(unassigned[i]);
      if (sc && clusterSchools.includes(sc)) {
        regionGroups[name].push(unassigned[i]);
        unassigned.splice(i, 1);
      }
    }

    // Groups moved to regionGroups; QFs generated uniformly after all regions created

    openRegions[name] = true;
  }

  // Compute uniform QF count: total groups / (k * ~10), same for all regions
  if (genQFs) {
    const totalGroupsInRegions = Object.values(regionGroups).reduce((s, rgs) => s + rgs.length, 0);
    const totalQFs = Math.max(k, Math.round(totalGroupsInRegions / 10));
    const qfsPerRegion = Math.max(1, Math.round(totalQFs / Object.keys(data).length));

    for (const rn of Object.keys(data)) {
      if (regionGroups[rn] && regionGroups[rn].length) {
        generateQFsForRegion(rn, qfsPerRegion);
      }
    }
  }

  // Auto-assign states
  if (genStates) {
    rebuildStateRegions();
  }

  // Now rebuild school lists from actual QF/regionGroup contents
  for (const rn of Object.keys(data)) rebuildSchools(rn);

  renderEditor(); renderMap();
}

function generateQFsForRegion(regionName, targetQFs) {
  const rgs = regionGroups[regionName] || [];
  if (!rgs.length) return;

  const items = rgs.map(g => {
    const sc = schoolOf(g);
    const c = sc ? SCHOOL_COORDS[sc] : null;
    return {group: g, lat: c ? c[0] : null, lng: c ? c[1] : null};
  });
  const withCoords = items.filter(i => i.lat !== null);
  const allItems = items;

  const k = targetQFs || Math.max(1, Math.round(rgs.length / 10));
  if (k === 1 || withCoords.length < 2) {
    // Single QF with all groups
    const center = chunkCentroid(rgs);
    data[regionName].quarterfinals.push({
      date: '', location: center.nearestSchool || '',
      lat: center.lat, lng: center.lng, groups: [...rgs]
    });
    regionGroups[regionName] = [];
    rebuildSchools(regionName);
    return;
  }

  // Longitude scale factor for true geographic distance
  const qfAvgLat = withCoords.reduce((s, it) => s + it.lat, 0) / withCoords.length;
  const qfLngScale = Math.cos(qfAvgLat * Math.PI / 180);
  const qfGeoDist = (a, b) => Math.hypot(a.lat - b.lat, (a.lng - b.lng) * qfLngScale);

  // K-means++ for QF centroids
  const centroids = [{lat: withCoords[0].lat, lng: withCoords[0].lng}];
  for (let ci = 1; ci < k; ci++) {
    let maxDist = -1, best = null;
    for (const item of withCoords) {
      let minD = Infinity;
      for (const c of centroids) { const d = qfGeoDist(item, c); if (d < minD) minD = d; }
      if (minD > maxDist) { maxDist = minD; best = item; }
    }
    centroids.push({lat: best.lat, lng: best.lng});
  }

  // Standard k-means iteration
  let asgn = new Array(withCoords.length).fill(0);
  for (let iter = 0; iter < 20; iter++) {
    let changed = false;
    for (let i = 0; i < withCoords.length; i++) {
      let minD = Infinity, best = 0;
      for (let ci = 0; ci < k; ci++) { const d = qfGeoDist(withCoords[i], centroids[ci]); if (d < minD) { minD = d; best = ci; } }
      if (asgn[i] !== best) { changed = true; asgn[i] = best; }
    }
    if (!changed) break;
    for (let ci = 0; ci < k; ci++) {
      const members = withCoords.filter((_, i) => asgn[i] === ci);
      if (members.length) {
        centroids[ci].lat = members.reduce((s, m) => s + m.lat, 0) / members.length;
        centroids[ci].lng = members.reduce((s, m) => s + m.lng, 0) / members.length;
      }
    }
  }

  // Build clusters from k-means
  const clusters = [];
  for (let ci = 0; ci < k; ci++) clusters.push([]);
  for (let i = 0; i < withCoords.length; i++) clusters[asgn[i]].push(withCoords[i]);
  // Distribute items without coords to smallest cluster
  const noCoords = allItems.filter(i => i.lat === null);
  noCoords.forEach((item) => {
    let smallest = 0;
    for (let ci = 1; ci < k; ci++) { if (clusters[ci].length < clusters[smallest].length) smallest = ci; }
    clusters[smallest].push(item);
  });

  // Swap-based balancing for QFs
  const qfIdeal = allItems.length / k;
  const qfMax = Math.ceil(qfIdeal * 1.3);
  const qfMin = Math.max(2, Math.floor(qfIdeal * 0.4));

  const recomputeQfCentroids = () => {
    for (let ci = 0; ci < k; ci++) {
      const wc = clusters[ci].filter(m => m.lat !== null);
      if (wc.length) {
        centroids[ci].lat = wc.reduce((s, m) => s + m.lat, 0) / wc.length;
        centroids[ci].lng = wc.reduce((s, m) => s + m.lng, 0) / wc.length;
      }
    }
  };

  for (let pass = 0; pass < 100; pass++) {
    recomputeQfCentroids();
    let bigIdx = -1, bigSize = 0;
    for (let ci = 0; ci < k; ci++) { if (clusters[ci].length > bigSize) { bigSize = clusters[ci].length; bigIdx = ci; } }
    if (bigSize <= qfMax) break;

    let smallIdx = -1, smallSize = Infinity;
    for (let ci = 0; ci < k; ci++) { if (ci !== bigIdx && clusters[ci].length < smallSize) { smallSize = clusters[ci].length; smallIdx = ci; } }
    if (smallIdx === -1) break;

    let bestIdx = -1, bestScore = -Infinity;
    for (let j = 0; j < clusters[bigIdx].length; j++) {
      const item = clusters[bigIdx][j];
      if (item.lat === null) continue;
      const score = qfGeoDist(item, centroids[bigIdx]) - qfGeoDist(item, centroids[smallIdx]);
      if (score > bestScore) { bestScore = score; bestIdx = j; }
    }
    if (bestIdx >= 0 && bestScore > 0) {
      clusters[smallIdx].push(clusters[bigIdx].splice(bestIdx, 1)[0]);
    } else break;
  }

  // Dissolve tiny QF clusters into nearest neighbors
  for (let ci = 0; ci < clusters.length; ci++) {
    if (clusters[ci].length > 0 && clusters[ci].length < qfMin) {
      recomputeQfCentroids();
      for (const item of clusters[ci]) {
        let bestTarget = -1, bestD = Infinity;
        for (let ti = 0; ti < k; ti++) {
          if (ti === ci || !clusters[ti].length) continue;
          if (item.lat === null) { bestTarget = ti; break; }
          const d = qfGeoDist(item, centroids[ti]);
          if (d < bestD) { bestD = d; bestTarget = ti; }
        }
        if (bestTarget >= 0) clusters[bestTarget].push(item);
      }
      clusters[ci] = [];
    }
  }

  // Extract group names from cluster items
  for (const chunk of clusters) {
    const groups = chunk.map(it => it.group);
    if (!groups.length) continue;
    const center = chunkCentroid(groups);
    data[regionName].quarterfinals.push({
      date: '', location: center.nearestSchool || '',
      lat: center.lat, lng: center.lng, groups: groups
    });
  }
  regionGroups[regionName] = [];
  rebuildSchools(regionName);
}

function generateRegionName(cluster) {
  // Compute center of cluster
  const avgLat = cluster.reduce((s, c) => s + c.lat, 0) / cluster.length;
  const avgLng = cluster.reduce((s, c) => s + c.lng, 0) / cluster.length;

  // Geographic name pool: coordinate-based names FIRST, state-contingent names SECOND
  // State names require the state to be a MAJOR component of the cluster (>= 30% of schools)
  const stateShare = (st) => {
    let count = 0;
    for (const item of cluster) {
      for (const [s, rn] of Object.entries(ORIG_STATE_REGION)) {
        if (s !== st) continue;
        const origRd = REGIONS[rn];
        if (origRd && origRd.schools && origRd.schools.includes(item.school)) count++;
      }
    }
    return count / cluster.length;
  };

  // Primary: coordinate-based names (no state dependency)
  const coordNames = [
    {name: 'Cascadia', test: () => avgLat > 44 && avgLng < -120},
    {name: 'Pacific Northwest', test: () => avgLat > 42 && avgLng < -115},
    {name: 'Northern California', test: () => avgLat > 36 && avgLat < 42 && avgLng < -119},
    {name: 'Southern California', test: () => avgLat < 36 && avgLng < -115 && avgLng > -120},
    {name: 'California', test: () => avgLng < -115 && avgLng > -125 && avgLat > 32 && avgLat < 42},
    {name: 'Desert Southwest', test: () => avgLat < 36 && avgLng > -115 && avgLng < -105},
    {name: 'Rocky Mountain', test: () => avgLng < -103 && avgLng > -112 && avgLat > 37},
    {name: 'Mountain West', test: () => avgLng < -105 && avgLng > -115 && avgLat > 35},
    {name: 'Great Plains', test: () => avgLng > -103 && avgLng < -95 && avgLat > 37},
    {name: 'Upper Midwest', test: () => avgLat > 43 && avgLng > -95 && avgLng < -85},
    {name: 'Chicagoland', test: () => avgLat > 40 && avgLat < 43 && avgLng > -90 && avgLng < -86},
    {name: 'Great Lakes', test: () => avgLat > 41 && avgLng > -90 && avgLng < -80},
    {name: 'Ohio Valley', test: () => avgLat > 38 && avgLat < 42 && avgLng > -86 && avgLng < -80},
    {name: 'Heartland', test: () => avgLng > -95 && avgLng < -85 && avgLat > 37 && avgLat < 42},
    {name: 'Chesapeake', test: () => avgLat > 37 && avgLat < 40 && avgLng > -78 && avgLng < -74},
    {name: 'Mid-Atlantic', test: () => avgLat > 38 && avgLat < 41 && avgLng > -78 && avgLng < -73},
    {name: 'Appalachian', test: () => avgLat > 35 && avgLat < 40 && avgLng > -84 && avgLng < -78},
    {name: 'Metro NYC', test: () => avgLat > 40 && avgLat < 41.5 && avgLng > -75 && avgLng < -73},
    {name: 'Tri-State', test: () => avgLat > 39 && avgLat < 42 && avgLng > -76 && avgLng < -73},
    {name: 'New England', test: () => avgLat > 41 && avgLng > -73 && avgLng < -69},
    {name: 'Finger Lakes', test: () => avgLat > 42 && avgLat < 44 && avgLng > -78 && avgLng < -75},
    {name: 'Upstate', test: () => avgLat > 42 && avgLng > -80 && avgLng < -73},
    {name: 'Northeast', test: () => avgLat > 40 && avgLng > -76 && avgLng < -70},
    {name: 'Atlantic', test: () => avgLng > -77 && avgLng < -73 && avgLat > 38 && avgLat < 41},
    {name: 'Piedmont', test: () => avgLat > 34 && avgLat < 37 && avgLng > -84 && avgLng < -78},
    {name: 'Southeast', test: () => avgLat < 36 && avgLat > 30 && avgLng > -88 && avgLng < -78},
    {name: 'Deep South', test: () => avgLat < 34 && avgLng > -92 && avgLng < -82},
    {name: 'Gulf Coast', test: () => avgLat < 32 && avgLng > -92 && avgLng < -80},
    {name: 'Ontario', test: () => avgLat > 43 && avgLng > -81 && avgLng < -75},
    {name: 'United Kingdom', test: () => avgLng > -8 && avgLng < 2},
  ];

  // Secondary: state-contingent names (only if state is >= 30% of cluster)
  const stateNames = [
    {name: 'Lone Star', test: () => stateShare('Texas') >= 0.3},
    {name: 'Michigan', test: () => stateShare('Michigan') >= 0.3},
    {name: 'Capital', test: () => stateShare('District of Columbia') >= 0.1 || (stateShare('Virginia') >= 0.2 && stateShare('Maryland') >= 0.2)},
    {name: 'Keystone', test: () => stateShare('Pennsylvania') >= 0.3},
    {name: 'Carolina', test: () => (stateShare('North Carolina') + stateShare('South Carolina')) >= 0.3},
    {name: 'Volunteer', test: () => stateShare('Tennessee') >= 0.3},
    {name: 'Sunshine', test: () => stateShare('Florida') >= 0.3},
    {name: 'Arizona', test: () => stateShare('Arizona') >= 0.3},
  ];

  // Try coordinate names first, then state names
  const coordMatches = coordNames.filter(e => e.test()).map(e => e.name);
  const stateMatches = stateNames.filter(e => e.test()).map(e => e.name);
  const allMatches = [...coordMatches, ...stateMatches];

  for (const name of allMatches) {
    if (!data[name]) return name;
  }

  // All matching names taken ‚Äî try directional fallback names
  const ns = avgLat > 42 ? 'North' : avgLat > 37 ? 'Central' : 'South';
  const ew = avgLng < -105 ? 'West' : avgLng < -90 ? 'Midwest' : avgLng < -75 ? 'East' : 'Atlantic';
  const fallbacks = [ns + ' ' + ew, ns, ew, 'Region'];
  for (const fb of fallbacks) {
    if (!data[fb]) return fb;
  }

  // Last resort: numbered
  let n = 2;
  while (data['Region ' + n]) n++;
  return 'Region ' + n;
}

function resetToDefault() {
  if (!confirm('Reset all changes to the default 2026 data?')) return;
  saveUndo('reset to default');
  // Restore all mutable globals
  for (const k of Object.keys(SCHOOL_GROUPS)) delete SCHOOL_GROUPS[k];
  Object.assign(SCHOOL_GROUPS, JSON.parse(JSON.stringify(ORIG_SCHOOL_GROUPS)));
  for (const k of Object.keys(SCHOOL_COORDS)) delete SCHOOL_COORDS[k];
  Object.assign(SCHOOL_COORDS, JSON.parse(JSON.stringify(ORIG_SCHOOL_COORDS)));
  for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
  Object.assign(STATE_REGION, ORIG_STATE_REGION);
  data = deepClone(REGIONS);
  encodeGroups(data);
  unassigned = [];
  regionGroups = {};
  openRegions = {}; openQFs = {}; selectedRegionName = null; highlightedQF = null;
  renderEditor(); renderMap();
}
function exportGroupsCSV() {
  const rows = [['Group','School','Region','QF','Location','Date']];
  for (const [rn, rd] of Object.entries(data)) {
    rd.quarterfinals.forEach((qf, qi) => {
      for (const g of qf.groups) {
        rows.push([displayName(g), schoolOf(g)||'', rn, 'QF'+(qi+1), qf.location||'', qf.date||'']);
      }
    });
  }
  for (const [rn, rgs] of Object.entries(regionGroups)) {
    for (const g of rgs) {
      rows.push([displayName(g), schoolOf(g)||'', rn, 'Ungrouped', '', '']);
    }
  }
  for (const g of unassigned) {
    rows.push([displayName(g), schoolOf(g)||'', 'Unassigned', '', '', '']);
  }
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'icca-groups.csv'; a.click();
}

function importGroupsCSV() {
  showModal('Import Groups (CSV)', `
    <div class="modal-label">Paste CSV</div>
    <textarea class="modal-input" id="m-groups-csv" rows="8" style="font-family:'Space Mono',monospace;font-size:11px;resize:vertical" placeholder="Group,School,Region,QF,Location,Date
Midnight Ramblers,University of Rochester,Central,QF3,Rochester NY,Feb 14
New Ensemble,Stanford University"></textarea>
    <div style="font-size:10px;color:#666;margin-top:4px">
      Columns: <code>Group, School, Region, QF, Location, Date</code>. Only Group is required.<br>
      With Region + QF ‚Üí placed in that QF. With Region only ‚Üí first QF in that region. Otherwise ‚Üí pool.
    </div>
  `, () => {
    const raw = document.getElementById('m-groups-csv').value.trim();
    if (!raw) return;
    const lines = raw.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return;

    function parseCSVLine(line) {
      const fields = [];
      let cur = '', inQuote = false;
      for (let c = 0; c < line.length; c++) {
        const ch = line[c];
        if (inQuote) {
          if (ch === '"' && line[c+1] === '"') { cur += '"'; c++; }
          else if (ch === '"') inQuote = false;
          else cur += ch;
        } else {
          if (ch === '"') inQuote = true;
          else if (ch === ',') { fields.push(cur.trim()); cur = ''; }
          else cur += ch;
        }
      }
      fields.push(cur.trim());
      return fields;
    }

    // Detect and skip header
    const firstLower = lines[0].toLowerCase().replace(/[" ]/g,'');
    const hasHeader = firstLower.startsWith('group') || firstLower.startsWith('name');
    const start = hasHeader ? 1 : 0;

    saveUndo('edit group');
    let placed = 0, pooled = 0, skipped = 0;
    for (let i = start; i < lines.length; i++) {
      const f = parseCSVLine(lines[i]);
      const name = (f[0] || '').trim();
      const school = (f[1] || '').trim();
      const region = (f[2] || '').trim();
      const qfStr = (f[3] || '').trim();
      if (!name) { skipped++; continue; }

      // Register school
      if (school) {
        if (!SCHOOL_GROUPS[school]) SCHOOL_GROUPS[school] = [];
        if (!SCHOOL_GROUPS[school].includes(name)) SCHOOL_GROUPS[school].push(name);
      }
      const encoded = school ? name + '@' + school : name;

      // Try to place in region/QF
      if (region && region !== 'Unassigned' && data[region]) {
        const qfIdx = qfStr ? parseInt(qfStr.replace(/\D/g,'')) - 1 : -1;
        if (qfIdx >= 0 && data[region].quarterfinals[qfIdx]) {
          data[region].quarterfinals[qfIdx].groups.push(encoded);
          placed++;
        } else if (data[region].quarterfinals.length > 0) {
          data[region].quarterfinals[0].groups.push(encoded);
          placed++;
        } else {
          unassigned.push(encoded);
          pooled++;
        }
        rebuildSchools(region);
      } else {
        unassigned.push(encoded);
        pooled++;
      }
    }
    renderEditor(); renderMap();
    let msg = '';
    if (placed) msg += placed + ' placed in QFs. ';
    if (pooled) msg += pooled + ' added to pool. ';
    if (skipped) msg += skipped + ' skipped.';
    alert(msg.trim() || 'No groups imported.');
  });
  setTimeout(() => document.getElementById('m-groups-csv').focus(), 50);
}

function toggleDropdown() {
  document.getElementById('bulk-dropdown').classList.remove('open');
  document.getElementById('history-dropdown').classList.remove('open');
  document.getElementById('json-dropdown').classList.toggle('open');
}
function toggleBulkDropdown() {
  document.getElementById('json-dropdown').classList.remove('open');
  document.getElementById('history-dropdown').classList.remove('open');
  document.getElementById('bulk-dropdown').classList.toggle('open');
}
function toggleHistoryDropdown() {
  document.getElementById('json-dropdown').classList.remove('open');
  document.getElementById('bulk-dropdown').classList.remove('open');
  renderHistoryYearList();
  document.getElementById('history-dropdown').classList.toggle('open');
}
function renderHistoryYearList() {
  const el = document.getElementById('history-year-list');
  const years = Object.keys(HISTORY).filter(k => k !== '_compareYear').sort((a,b) => b - a);
  if (!years.length) {
    el.innerHTML = '<div style="padding:8px 12px;font-size:11px;color:#666;font-style:italic">No historical years loaded yet.<br>Use "Load Year from JSON" below.</div>';
    return;
  }
  el.innerHTML = years.map(y => {
    const h = HISTORY[y];
    const m = h.meta;
    const regionCount = Object.keys(h.regions).length;
    let gc = 0;
    for (const rd of Object.values(h.regions)) gc += rd.quarterfinals.reduce((s,qf) => s + qf.groups.length, 0);
    const isCompare = false;
    return `<button style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:8px 12px;background:none;border:none;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;color:#ccc;font-size:12px;text-align:left" onclick="loadHistoryYear(${y});this.closest('.dropdown-menu').classList.remove('open')" onmouseenter="this.style.background='rgba(255,255,255,0.05)'" onmouseleave="this.style.background='none'">
      <strong style="color:#fff">${y}</strong>
      <span style="color:#666;font-size:10px">${regionCount}R ¬∑ ${gc}G</span>
    </button>`;
  }).join('');
}
// Close dropdowns on outside click
document.addEventListener('click', function(e) {
  const wrap = e.target.closest('.dropdown-wrap');
  const jsonDD = document.getElementById('json-dropdown');
  const bulkDD = document.getElementById('bulk-dropdown');
  const histDD = document.getElementById('history-dropdown');
  if (!wrap) { jsonDD.classList.remove('open'); bulkDD.classList.remove('open'); histDD.classList.remove('open'); return; }
  if (!wrap.contains(jsonDD)) jsonDD.classList.remove('open');
  if (!wrap.contains(bulkDD)) bulkDD.classList.remove('open');
  if (!wrap.contains(histDD)) histDD.classList.remove('open');
});

// ‚îÄ‚îÄ‚îÄ RENDER EDITOR ‚îÄ‚îÄ‚îÄ
function renderEditor() {
  const body = document.getElementById('editor-body');
  const st = totalStats();
  document.getElementById('editor-stats').textContent = `${st.r}R ¬∑ ${st.g}G ¬∑ ${st.s}S`;

  let h = '';
  const vm = viewMode;
  for (const [rn, rd] of Object.entries(data)) {
    const isOpen = openRegions[rn];
    const gc = countGroups(rd) + (regionGroups[rn] || []).length;
    h += `<div class="region-block" data-region-block="${esc(rn)}">`;
    h += `<div class="region-header" onclick="toggleRegion('${esc(rn)}')"${vm?'':` ondragover="onDragOverRegion(event)" ondragleave="onDragLeave(event)" ondrop="onDropToRegion(event,'${esc(rn)}')"`}>`;
    h += `<span class="region-chevron ${isOpen?'open':''}">‚ñ∂</span>`;
    h += `<div class="region-swatch" style="background:${rd.color}"${vm?'':` onclick="event.stopPropagation();editRegionColor('${esc(rn)}')" title="Edit color"`}></div>`;
    h += `<span class="region-name">${rn}</span>`;
    h += `<span class="region-meta">${rd.schools.length}s ¬∑ ${gc}g ¬∑ ${rd.quarterfinals.length}qf</span>`;
    if (!vm) {
      h += `<div class="region-actions">`;
      h += `<button class="region-action-btn" onclick="event.stopPropagation();renameRegion('${esc(rn)}')" title="Rename">‚úé</button>`;
      h += `<button class="region-action-btn del" onclick="event.stopPropagation();deleteRegion('${esc(rn)}')" title="Delete">‚úï</button>`;
      h += `</div>`;
    }
    h += `</div>`;

    if (isOpen) {
      h += `<div class="region-body">`;
      // Semifinal row
      const sf = rd.semifinal || {};
      const hasSF = sf.location || sf.date;
      h += `<div style="margin:4px 10px 6px;display:flex;align-items:center;gap:8px;font-size:11px">`;
      h += `<span style="color:${rd.color};font-size:10px;font-weight:700">‚òÖ SF</span>`;
      if (hasSF) {
        h += `<span style="color:#aaa">${sf.location || 'No location'}</span>`;
        if (sf.date) h += `<span style="color:#666">¬∑ ${sf.date}</span>`;
      } else {
        h += `<span style="color:#555;font-style:italic">Not set</span>`;
      }
      if (!vm) {
        h += `<div style="margin-left:auto;display:flex;gap:2px">`;
        if (!hasSF) h += `<button class="region-action-btn" onclick="event.stopPropagation();autoGenerateSF('${esc(rn)}')" title="Auto-generate SF from centroid" style="font-size:10px;padding:1px 5px">‚ö°</button>`;
        h += `<button class="region-action-btn" onclick="event.stopPropagation();showSFModal('${esc(rn)}')" title="Edit Semifinal" style="font-size:10px;padding:1px 5px">‚úé</button>`;
        h += `</div>`;
      }
      h += `</div>`;
      // Region-level groups (not yet in a QF)
      const rgs = regionGroups[rn] || [];
      if (rgs.length) {
        h += `<div class="region-groups-section" style="margin:4px 10px 8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;border:1px dashed rgba(255,255,255,0.08)">`;
        h += `<div style="font-size:10px;color:#666;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">`;
        h += `<span>${rgs.length} ungrouped</span>`;
        if (!vm) h += `<button class="region-action-btn" onclick="generateQFs('${esc(rn)}')" title="Generate QFs from ungrouped" style="font-size:12px;padding:2px 6px">‚ö°</button>`;
        h += `</div>`;
        h += `<div class="group-list" style="gap:3px">`;
        rgs.forEach((g, gi) => {
          h += `<span class="group-tag" title="${esc(schoolOf(g)||'')}"${vm?'':` draggable="true" ondragstart="onDragStartRegionGroup(event,'${esc(rn)}',${gi})" ondragend="onDragEnd(event)"`}>${displayName(g)}</span>`;
        });
        h += `</div></div>`;
      }
      rd.quarterfinals.forEach((qf, i) => {
        const qfKey = rn + '|' + i;
        const qfOpen = openQFs[qfKey] !== false;
        h += `<div class="qf-block" data-region="${esc(rn)}" data-qf-idx="${i}">`;
        h += `<div class="qf-header"${vm?'':` draggable="true" ondragstart="onDragStartQF(event,'${esc(rn)}',${i})" ondragend="onDragEnd(event)"`} onclick="toggleQF('${esc(rn)}',${i})">`;
        h += `<span class="region-chevron ${qfOpen?'open':''}" style="font-size:8px">‚ñ∂</span>`;
        h += `<span class="qf-label" style="color:${rd.color}">QF${i+1}</span>`;
        h += `<span class="qf-location">${qf.location||'No location'}</span>`;
        h += `<span class="qf-count">${qf.groups.length}</span>`;
        if (!vm) {
          h += `<div class="qf-actions">`;
          h += `<button class="region-action-btn" onclick="event.stopPropagation();editQF('${esc(rn)}',${i})" title="Edit QF">‚úé</button>`;
          h += `<button class="region-action-btn del" onclick="event.stopPropagation();deleteQF('${esc(rn)}',${i})" title="Delete QF">‚úï</button>`;
          h += `</div>`;
        }
        h += `</div>`;
        if (qfOpen) {
          h += `<div class="qf-groups"${vm?'':` ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDropToQF(event,'${esc(rn)}',${i})"`}>`;
          qf.groups.forEach(g => {
            if (vm) {
              h += `<span class="group-tag" data-group-tip="${esc(displayName(g))}" data-group-ctx="${esc(rn)}|${i}">${displayName(g)}</span>`;
            } else {
              h += `<span class="group-tag" data-group-tip="${esc(displayName(g))}" data-group-ctx="${esc(rn)}|${i}" draggable="true" ondragstart="onDragStart(event,'${esc(rn)}',${i},'${esc(g)}')" ondragend="onDragEnd(event)" onclick="editGroup('${esc(rn)}',${i},'${esc(g)}')" title="Click to edit">`;
              h += `${displayName(g)}<span class="remove-group" onclick="event.stopPropagation();removeGroup('${esc(rn)}',${i},'${esc(g)}')" title="Remove">‚úï</span></span>`;
            }
          });
          if (!qf.groups.length) h += `<span style="font-size:10px;color:#444;padding:4px">${vm?'Empty':'Drop groups here'}</span>`;
          h += `</div>`;
        }
        h += `</div>`;
      });
      h += `</div>`;
    }
    h += `</div>`;
  }

  // Unassigned pool
  h += `<div class="pool-section">`;
  h += `<div class="pool-header"><span class="pool-label">Unassigned Groups</span><span class="region-meta">${unassigned.length}</span></div>`;
  h += `<div class="qf-groups pool-drop" style="margin:0 10px 10px;border-radius:6px;border-style:dashed" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDropToPool(event)">`;
  if (unassigned.length) {
    unassigned.forEach(g => {
      h += `<span class="group-tag" data-group-tip="${esc(displayName(g))}" draggable="true" ondragstart="onDragStartPool(event,'${esc(g)}')" ondragend="onDragEnd(event)" onclick="editPoolGroup('${esc(g)}')" title="Click to edit">`;
      h += `${displayName(g)}<span class="remove-group" onclick="event.stopPropagation();deletePoolGroup('${esc(g)}')" title="Delete permanently">‚úï</span></span>`;
    });
  } else {
    h += `<span style="font-size:10px;color:#444;padding:4px">Drag groups or entire QFs here to unassign</span>`;
  }
  h += `</div></div>`;

  body.innerHTML = h;
}

function toggleCompare() {
  compareMode = !compareMode;
  const btn = document.getElementById('compare-btn');
  const banner = document.getElementById('compare-banner');
  if (compareMode) {
    // If no history year selected, default to base 2026
    if (!HISTORY._compareYear) {
      btn.textContent = '‚ü∑ Base';
      banner.textContent = 'VIEWING BASE 2026';
    }
    btn.classList.add('active');
    banner.classList.add('active');
  } else {
    btn.classList.remove('active');
    banner.classList.remove('active');
    btn.textContent = '‚ü∑ Base';
    banner.textContent = 'VIEWING BASE 2026';
    delete HISTORY._compareYear;
  }
  renderMap();
  updateMapStats();
}

function toggleInterstates() {
  interstateMode = !interstateMode;
  const btn = document.getElementById('interstate-btn');
  if (btn) { if (interstateMode) btn.classList.add('active'); else btn.classList.remove('active'); }
  renderMap();
}

function toggleViewMode() {
  viewMode = !viewMode;
  highlightedQF = null;
  closeVenuePopup();
  const btn = document.getElementById('view-toggle');
  if (viewMode) {
    btn.textContent = '‚úé Edit';
    btn.classList.add('primary');
    document.body.classList.add('view-mode');
  } else {
    btn.textContent = 'üëÅ View';
    btn.classList.remove('primary');
    document.body.classList.remove('view-mode');
  }
  updateMapStats();
  renderEditor(); renderMap();
}

function toggleRegion(name) {
  openRegions[name] = !openRegions[name];
  selectedRegionName = openRegions[name] ? name : null;
  highlightedQF = null;
  closeVenuePopup();
  renderEditor(); renderMap();
}

// ‚îÄ‚îÄ‚îÄ ZOOM-BASED DOT SPREADING ‚îÄ‚îÄ‚îÄ
function spreadDots(dots, minDist) {
  const positions = dots.map(d => ({...d, sx: d.x, sy: d.y}));
  for (let iter = 0; iter < 12; iter++) {
    let moved = false;
    for (let i = 0; i < positions.length; i++) {
      for (let j = i + 1; j < positions.length; j++) {
        const dx = positions[j].sx - positions[i].sx;
        const dy = positions[j].sy - positions[i].sy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < minDist) {
          const overlap = (minDist - dist) / 2;
          if (dist > 0) {
            const nx = dx/dist, ny = dy/dist;
            positions[i].sx -= nx*overlap*0.5;
            positions[i].sy -= ny*overlap*0.5;
            positions[j].sx += nx*overlap*0.5;
            positions[j].sy += ny*overlap*0.5;
          } else {
            const angle = (i*2.399) + j;
            positions[i].sx -= Math.cos(angle)*minDist*0.3;
            positions[i].sy -= Math.sin(angle)*minDist*0.3;
            positions[j].sx += Math.cos(angle)*minDist*0.3;
            positions[j].sy += Math.sin(angle)*minDist*0.3;
          }
          moved = true;
        }
      }
    }
    if (!moved) break;
  }
  return positions;
}

function applyZoomSpread(g, k) {
  const spreadFactor = Math.max(0, Math.min(1, (k - 6) / 8));
  if (spreadFactor === 0) {
    g.selectAll(".school-dot").each(function() {
      const el = d3.select(this);
      el.attr("cx", el.attr("data-ox")).attr("cy", el.attr("data-oy"));
    });
    g.selectAll(".school-glow").each(function() {
      const el = d3.select(this);
      el.attr("cx", el.attr("data-ox")).attr("cy", el.attr("data-oy"));
    });
    return;
  }
  const dots = [];
  g.selectAll(".school-dot").each(function() {
    const el = d3.select(this);
    dots.push({ el, ox: +el.attr("data-ox"), oy: +el.attr("data-oy") });
  });
  const minDist = 0.5 + spreadFactor * 0.5;
  const spread = spreadDots(dots.map(d => ({x: d.ox, y: d.oy})), minDist);
  dots.forEach((d, i) => {
    d.el.attr("cx", d.ox + (spread[i].sx - spread[i].x)*spreadFactor);
    d.el.attr("cy", d.oy + (spread[i].sy - spread[i].y)*spreadFactor);
  });
  const glows = [];
  g.selectAll(".school-glow").each(function() { glows.push(d3.select(this)); });
  let gi = 0;
  dots.forEach((d, i) => {
    while (gi < glows.length) {
      const glow = glows[gi];
      if (+glow.attr("data-ox") === d.ox && +glow.attr("data-oy") === d.oy) {
        glow.attr("cx", d.ox + (spread[i].sx - spread[i].x)*spreadFactor);
        glow.attr("cy", d.oy + (spread[i].sy - spread[i].y)*spreadFactor);
        gi++; break;
      }
      gi++;
    }
  });
}

// ‚îÄ‚îÄ‚îÄ VENUE POPUP ‚îÄ‚îÄ‚îÄ
function showVenuePopup(screenX, screenY, qfEntries, activeIdx) {
  // qfEntries: [{qf, qfIdx, regionName, regionData}, ...]
  // activeIdx: index into qfEntries for which tab is active
  const popup = document.getElementById('venue-popup');
  const mapArea = document.querySelector('.map-area');
  const rect = mapArea.getBoundingClientRect();
  let left = screenX - rect.left + 14;
  let top = screenY - rect.top - 10;
  if (left + 330 > rect.width) left = screenX - rect.left - 340;
  if (top + 250 > rect.height) top = rect.height - 260;
  if (top < 10) top = 10;
  if (left < 10) left = 10;
  popup.style.display = 'block';
  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
  popup._qfEntries = qfEntries;
  popup._screenX = screenX;
  popup._screenY = screenY;

  const active = qfEntries[activeIdx];
  const {qf, qfIdx, regionName, regionData} = active;

  let tabsHtml = '';
  if (qfEntries.length > 1) {
    tabsHtml = '<div class="venue-popup-tabs">' + qfEntries.map((e, ti) => {
      const c = e.regionData.accent || e.regionData.color;
      const cls = ti === activeIdx ? 'venue-popup-tab active' : 'venue-popup-tab';
      return `<button class="${cls}" style="--tab-color:${c}" onclick="switchVenueTab(${ti})">QF${e.qfIdx+1} ¬∑ ${e.qf.date||''}</button>`;
    }).join('') + '</div>';
  }

  popup.innerHTML = `
    <div style="width:32px;height:3px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 10px;"></div>
    <div class="venue-popup-header">
      <div>
        <div class="venue-popup-title" style="color:${regionData.accent||regionData.color}">QF${qfIdx+1} ‚Äî ${qf.location||'No location'}</div>
        <div class="venue-popup-meta">${qf.date||''} ¬∑ ${regionName} ¬∑ ${qf.groups.length} groups</div>
      </div>
      <button class="venue-popup-close" onclick="closeVenuePopup()">‚úï</button>
    </div>
    ${tabsHtml}
    <div class="venue-popup-groups">
      ${qf.groups.map(g => `<span class="venue-popup-group" data-group-tip="${displayName(g)}" data-group-ctx="${regionName}|${qfIdx}">${displayName(g)}</span>`).join('')}
    </div>`;
}
function switchVenueTab(tabIdx) {
  const popup = document.getElementById('venue-popup');
  const entries = popup._qfEntries;
  if (!entries || !entries[tabIdx]) return;
  const entry = entries[tabIdx];
  // Update highlighting
  highlightedQF = entry.qfIdx;
  selectedRegionName = entry.regionName;
  showVenuePopup(popup._screenX, popup._screenY, entries, tabIdx);
  renderMap();
  // Re-show popup after renderMap (which may clear it visually)
  const p = document.getElementById('venue-popup');
  p.style.display = 'block';
}
function closeVenuePopup() { document.getElementById('venue-popup').style.display = 'none'; }

// Draggable venue popup
(function() {
  let isDragging = false, startX, startY, startLeft, startTop;
  const popup = document.getElementById('venue-popup');
  popup.addEventListener('mousedown', function(e) {
    if (e.target.closest('.venue-popup-close')) return;
    isDragging = true; popup.classList.add('dragging');
    startX = e.clientX; startY = e.clientY;
    startLeft = parseInt(popup.style.left)||0;
    startTop = parseInt(popup.style.top)||0;
    e.preventDefault();
  });
  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    popup.style.left = (startLeft + e.clientX - startX) + 'px';
    popup.style.top = (startTop + e.clientY - startY) + 'px';
  });
  document.addEventListener('mouseup', function() {
    if (isDragging) { isDragging = false; popup.classList.remove('dragging'); }
  });
})();

// ‚îÄ‚îÄ‚îÄ MAP STATS BAR ‚îÄ‚îÄ‚îÄ
function updateMapStats() {
  const el = document.getElementById('map-stats');
  // If there's an active selection, show selection info instead
  if (lassoSelection && lassoSelection.schools.size) {
    updateSelectionBar();
    return;
  }
  el.classList.remove('selection-active');
  if (compareMode) {
    const compareYear = HISTORY._compareYear;
    const baseData = compareYear && HISTORY[compareYear] ? HISTORY[compareYear].regions : deepClone(REGIONS);
    const label = compareYear && HISTORY[compareYear] ? HISTORY[compareYear].meta.season : 'BASE 2026';
    let bg = 0, bs = new Set();
    for (const rd of Object.values(baseData)) {
      for (const qf of rd.quarterfinals) { bg += qf.groups.length; qf.groups.forEach(g => { const s = typeof g === 'string' ? schoolOf(g) || findSchoolForGroup(g.includes('@') ? g.split('@')[0] : g) : g.school; if (s) bs.add(s); }); }
      (rd.schools || []).forEach(s => bs.add(s));
    }
    el.innerHTML = `<span style="color:#ffd700;font-weight:700">‚ü∑ ${esc(label)}</span>`
      + `<span><span class="map-stat-val">${Object.keys(baseData).length}</span>Regions</span>`
      + `<span><span class="map-stat-val">${bg}</span>Groups</span>`
      + `<span><span class="map-stat-val">${bs.size}</span>Schools</span>`;
    return;
  }
  const st = totalStats();
  el.innerHTML = `<span><span class="map-stat-val">${st.r}</span>Regions</span>`
    + `<span><span class="map-stat-val">${st.g}</span>Groups</span>`
    + `<span><span class="map-stat-val">${st.s}</span>Schools</span>`;
}

// ‚îÄ‚îÄ‚îÄ GLOBAL GROUP TOOLTIP ‚îÄ‚îÄ‚îÄ
(function() {
  const gtt = document.getElementById('group-tooltip');
  let activeEl = null;

  document.addEventListener('mouseover', function(e) {
    const el = e.target.closest('[data-group-tip]');
    if (!el) { if (activeEl) { gtt.classList.remove('visible'); activeEl = null; } return; }
    activeEl = el;
    const groupName = el.getAttribute('data-group-tip');
    const ctx = el.getAttribute('data-group-ctx');
    let school;
    if (ctx) {
      const [rn, qi] = ctx.split('|');
      // Find the encoded group in the QF to get school
      const rd = data[rn], qf = rd && rd.quarterfinals[parseInt(qi)];
      if (qf) {
        const match = qf.groups.find(g => displayName(g) === groupName);
        school = match ? schoolOf(match) : null;
      }
    }
    if (!school) school = findSchoolForGroup(groupName);
    gtt.textContent = school || 'Unknown school';
    gtt.classList.add('visible');
    gtt.style.left = (e.clientX + 14) + 'px';
    gtt.style.top = (e.clientY - 10) + 'px';
  });

  document.addEventListener('mousemove', function(e) {
    if (!activeEl) return;
    gtt.style.left = (e.clientX + 14) + 'px';
    gtt.style.top = (e.clientY - 10) + 'px';
  });

  document.addEventListener('mouseout', function(e) {
    const el = e.target.closest('[data-group-tip]');
    if (el === activeEl) { gtt.classList.remove('visible'); activeEl = null; }
  });
})();

function toggleQF(rn, qi) {
  const key = rn + '|' + qi;
  openQFs[key] = openQFs[key] === false ? true : false;
  renderEditor();
}

function expandAll() {
  for (const rn of Object.keys(data)) {
    openRegions[rn] = true;
    data[rn].quarterfinals.forEach((_, i) => { openQFs[rn + '|' + i] = true; });
  }
  renderEditor();
}

function collapseAll() {
  for (const rn of Object.keys(data)) {
    openRegions[rn] = false;
    data[rn].quarterfinals.forEach((_, i) => { openQFs[rn + '|' + i] = false; });
  }
  selectedRegionName = null;
  renderEditor(); renderMap();
}

// ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ
let usTopoData = null, mapSvg = null, mapG = null, mapZoom = null;
let mapProjection = null; // stored for lasso

async function loadMapData() {
  try {
    const resp = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
    usTopoData = await resp.json();
  } catch(e) { console.warn("Map load failed:", e); }
  // Rebuild state‚Üíregion mapping using geo point-in-polygon (replaces hardcoded STATE_REGION)
  rebuildStateRegions();
  Object.assign(ORIG_STATE_REGION, STATE_REGION);
  renderMap();
}

function renderMap() {
  // Compare mode: temporarily swap to comparison data
  let _savedData, _savedSR, _savedRG;
  if (compareMode) {
    _savedData = data; _savedSR = Object.assign({}, STATE_REGION); _savedRG = regionGroups;
    const compareYear = HISTORY._compareYear;
    if (compareYear && HISTORY[compareYear]) {
      data = deepClone(HISTORY[compareYear].regions);
    } else {
      data = deepClone(REGIONS); encodeGroups(data);
    }
    // Rebuild state assignments for comparison data
    if (!compareYear) {
      for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
      Object.assign(STATE_REGION, ORIG_STATE_REGION);
    } else {
      rebuildStateRegions();
    }
    regionGroups = {};
  }
  const container = document.getElementById('map-container');
  const w = container.clientWidth, h = container.clientHeight;
  if (!w || !h) return;

  d3.select("#map-container svg").remove();
  const svg = d3.select("#map-container").append("svg").attr("width", w).attr("height", h);

  const defs = svg.append("defs");

  const g = svg.append("g");
  mapSvg = svg; mapG = g;

  const zoom = d3.zoom().scaleExtent([1, 24])
    .filter((ev) => !ev.shiftKey || ev.type === 'wheel')
    .on("zoom", (ev) => {
    g.attr("transform", ev.transform);
    currentZoom = ev.transform;
    const k = ev.transform.k;
    const dotScale = Math.sqrt(k);
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||0.6)/k; });
    g.selectAll(".venue-marker").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||1.5)/dotScale; });
    g.selectAll(".venue-marker-g").each(function() {
      const el = d3.select(this);
      el.attr("transform", `translate(${el.attr("data-tx")},${el.attr("data-ty")}) scale(${1/dotScale})`);
    });
    applyZoomSpread(g, k);
  });
  svg.call(zoom);
  if (currentZoom) svg.call(zoom.transform, currentZoom);
  mapZoom = zoom;

  const projection = d3.geoAlbersUsa().fitSize([w*0.92, h*0.88], {type:"Sphere"});
  projection.translate([w*0.48, h*0.49]);
  mapProjection = projection;

  // States
  if (usTopoData) {
    const states = topojson.feature(usTopoData, usTopoData.objects.states);
    g.append("g").selectAll("path").data(states.features).enter().append("path")
      .attr("d", d3.geoPath().projection(projection))
      .attr("class", "state-path")
      .attr("stroke", function(d) {
        if (!viewMode) return "rgba(255,255,255,0.08)";
        const sn = d.properties.name;
        const rn = STATE_REGION[sn];
        const rd = rn ? data[rn] : null;
        if (!rd) return "rgba(255,255,255,0.04)";
        const isActive = !selectedRegionName || selectedRegionName === rn;
        return isActive ? rd.color + "60" : "rgba(255,255,255,0.06)";
      })
      .attr("stroke-width", function(d) {
        if (!viewMode) return 0.6;
        const rn = STATE_REGION[d.properties.name];
        return selectedRegionName && selectedRegionName === rn ? 1.5 : 0.6;
      })
      .each(function(d) {
        const rn = STATE_REGION[d.properties.name];
        const sw = viewMode && selectedRegionName && selectedRegionName === rn ? 1.5 : 0.6;
        d3.select(this).attr("data-base-sw", sw);
      })
      .attr("fill", function(d) {
        const sn = d.properties.name;
        const rn = STATE_REGION[sn];
        const rd = rn ? data[rn] : null;
        if (!rd) return viewMode ? "rgba(255,255,255,0.02)" : "rgba(255,255,255,0.015)";
        if (viewMode) {
          const isActive = !selectedRegionName || selectedRegionName === rn;
          return rd.color + (isActive ? "20" : "08");
        }
        return rd.color + "10";
      })
      .style("cursor", viewMode ? "pointer" : "pointer")
      .on("click", function(e, d) {
        if (viewMode) {
          const rn = STATE_REGION[d.properties.name];
          if (rn) { toggleRegion(rn); }
          return;
        }
        assignStateRegion(d.properties.name);
      })
      .on("mouseenter", function(e, d) {
        d3.select(this).attr("stroke", "rgba(255,255,255,0.3)");
        const sn = d.properties.name;
        const rn = STATE_REGION[sn];
        ttSchool.textContent = sn;
        ttRegion.textContent = rn ? `Region: ${rn}` : 'No region assigned';
        ttRegion.style.color = rn && data[rn] ? data[rn].color : '#666';
        document.getElementById("tt-groups").style.display = "none";
        tooltip.classList.add("visible");
        tooltip.style.left = (e.clientX - mapRect.left + 14) + "px";
        tooltip.style.top = (e.clientY - mapRect.top - 32) + "px";
      })
      .on("mousemove", function(e) {
        tooltip.style.left = (e.clientX - mapRect.left + 14) + "px";
        tooltip.style.top = (e.clientY - mapRect.top - 32) + "px";
      })
      .on("mouseleave", function() {
        d3.select(this).attr("stroke", function(d2) {
          if (!viewMode) return "rgba(255,255,255,0.08)";
          const rn = STATE_REGION[d2.properties.name];
          const rd = rn ? data[rn] : null;
          if (!rd) return "rgba(255,255,255,0.04)";
          const isActive = !selectedRegionName || selectedRegionName === rn;
          return isActive ? rd.color + "60" : "rgba(255,255,255,0.06)";
        });
        tooltip.classList.remove("visible");
      });
  }

  // ‚îÄ‚îÄ‚îÄ INTERSTATE HIGHWAY OVERLAY ‚îÄ‚îÄ‚îÄ
  if (interstateMode) {
    const ig = g.append("g").attr("class", "interstate-layer");
    const INTERSTATES = {
      'I-5':[[48.78,-122.46],[47.61,-122.33],[46.73,-122.98],[45.52,-122.68],[44.94,-123.03],[42.33,-122.87],[40.58,-122.39],[38.58,-121.49],[37.78,-122.42],[36.97,-122.03],[36.17,-120.09],[35.37,-119.00],[34.95,-118.40],[34.05,-118.24],[33.43,-117.60],[32.72,-117.16]],
      'I-10':[[30.33,-81.66],[30.44,-84.28],[30.41,-87.21],[30.45,-89.10],[30.25,-89.99],[30.00,-90.17],[29.95,-90.07],[30.22,-92.02],[30.07,-93.73],[29.76,-95.37],[29.42,-98.49],[31.76,-106.45],[32.22,-110.93],[33.45,-112.07],[33.93,-116.54],[33.93,-117.39],[34.05,-118.24]],
      'I-15':[[47.50,-115.56],[46.87,-114.00],[45.78,-111.16],[44.52,-112.04],[42.87,-112.44],[40.77,-111.89],[38.57,-109.55],[37.68,-113.06],[36.17,-115.14],[34.13,-117.30],[33.14,-117.02],[32.72,-117.16]],
      'I-20':[[33.45,-84.39],[33.50,-82.01],[34.00,-81.03],[34.23,-77.95]],
      'I-20w':[[33.45,-84.39],[33.38,-86.81],[32.30,-90.18],[32.47,-93.70],[32.75,-96.80],[32.45,-99.73],[31.95,-102.08],[31.76,-106.45]],
      'I-25':[[31.76,-106.45],[32.35,-106.74],[35.08,-106.65],[35.69,-105.94],[36.41,-105.57],[37.23,-104.60],[38.83,-104.82],[39.74,-104.99],[40.59,-105.08],[41.14,-104.82]],
      'I-35':[[29.42,-98.49],[30.27,-97.74],[31.55,-97.15],[32.75,-96.80],[33.21,-97.13],[35.47,-97.52],[37.69,-97.34],[38.97,-94.61],[39.10,-94.58],[41.26,-95.94],[44.98,-93.27]],
      'I-40':[[35.23,-80.84],[35.60,-82.56],[35.96,-83.92],[36.16,-86.78],[35.15,-89.97],[34.75,-92.29],[35.47,-97.52],[35.22,-101.83],[35.08,-106.65],[35.20,-111.65],[34.87,-117.02],[34.05,-118.24]],
      'I-55':[[30.00,-90.17],[31.31,-89.64],[32.30,-90.18],[33.52,-90.19],[34.37,-89.52],[35.15,-89.97],[36.62,-89.58],[37.62,-89.14],[38.63,-90.20],[39.80,-89.65],[41.88,-87.63]],
      'I-64':[[38.63,-90.20],[38.25,-85.76],[38.05,-84.50],[38.35,-81.63],[37.54,-79.44],[37.27,-76.71]],
      'I-65':[[30.69,-88.04],[31.22,-85.39],[33.52,-86.80],[36.16,-86.78],[38.25,-85.76],[39.77,-86.16],[41.67,-87.50]],
      'I-70':[[39.29,-76.61],[39.96,-76.73],[40.44,-79.99],[39.96,-82.99],[39.77,-86.16],[39.10,-94.58],[38.63,-90.20],[38.81,-99.33],[39.74,-104.99],[39.04,-108.55],[38.92,-109.99],[40.23,-111.66]],
      'I-75':[[25.77,-80.19],[26.64,-81.87],[27.95,-82.46],[28.54,-81.38],[30.33,-81.66],[31.58,-83.49],[32.84,-83.63],[33.75,-84.39],[34.87,-84.97],[35.04,-85.31],[36.99,-84.60],[38.05,-84.50],[39.10,-84.51],[40.35,-83.77],[41.50,-83.74],[42.33,-83.05],[43.60,-83.89],[46.50,-84.35]],
      'I-80':[[40.81,-74.07],[40.88,-75.18],[41.24,-77.00],[40.44,-79.99],[41.50,-81.69],[41.50,-83.74],[41.67,-87.50],[41.76,-88.32],[41.60,-93.61],[41.26,-95.94],[40.82,-96.70],[41.14,-102.98],[41.14,-104.82],[40.77,-111.89],[39.52,-119.81],[37.78,-122.42]],
      'I-85':[[37.27,-79.94],[36.07,-79.79],[35.23,-80.84],[34.85,-82.39],[33.75,-84.39],[32.37,-85.00],[32.38,-86.30]],
      'I-90':[[42.36,-71.06],[42.15,-72.53],[42.65,-73.76],[43.05,-76.15],[42.89,-78.88],[41.50,-81.69],[41.67,-87.50],[43.04,-87.91],[43.81,-89.40],[44.98,-93.27],[43.55,-96.73],[44.08,-103.23],[45.78,-108.50],[47.50,-115.56],[47.61,-122.33]],
      'I-94':[[42.33,-83.05],[42.27,-83.74],[41.67,-87.50],[43.04,-87.91],[43.81,-89.40],[44.98,-93.27],[46.88,-96.79],[46.81,-100.78],[48.23,-101.30]],
      'I-95':[[25.77,-80.19],[27.20,-80.25],[29.21,-81.02],[30.33,-81.66],[32.08,-81.09],[33.95,-78.02],[35.23,-80.84],[36.85,-76.29],[37.54,-77.43],[38.90,-77.04],[39.29,-76.61],[39.95,-75.17],[40.22,-74.76],[40.81,-74.07],[41.31,-72.92],[41.82,-71.41],[42.36,-71.06],[43.66,-70.26],[44.80,-68.77]]
    };
    const line = d3.line()
      .x(d => { const p = projection([d[1], d[0]]); return p ? p[0] : 0; })
      .y(d => { const p = projection([d[1], d[0]]); return p ? p[1] : 0; })
      .defined(d => projection([d[1], d[0]]) !== null)
      .curve(d3.curveCatmullRom.alpha(0.5));

    for (const [name, coords] of Object.entries(INTERSTATES)) {
      const valid = coords.filter(c => projection([c[1], c[0]]) !== null);
      if (valid.length < 2) continue;

      // Break into segments at large gaps
      const segments = [];
      let seg = [valid[0]];
      for (let i = 1; i < valid.length; i++) {
        const prev = projection([valid[i-1][1], valid[i-1][0]]);
        const cur = projection([valid[i][1], valid[i][0]]);
        if (prev && cur && Math.hypot(cur[0]-prev[0], cur[1]-prev[1]) > 400) {
          if (seg.length >= 2) segments.push(seg);
          seg = [valid[i]];
        } else {
          seg.push(valid[i]);
        }
      }
      if (seg.length >= 2) segments.push(seg);

      for (const s of segments) {
        ig.append("path").datum(s).attr("d", line)
          .attr("fill", "none")
          .attr("stroke", "rgba(255,200,60,0.18)")
          .attr("stroke-width", 1.5)
          .attr("stroke-dasharray", "6,4")
          .attr("data-base-sw", 1.5)
          .style("pointer-events", "none");
      }

      // Label at midpoint of longest segment
      const longest = segments.reduce((a, b) => a.length > b.length ? a : b, []);
      if (longest.length >= 3) {
        const midPt = longest[Math.floor(longest.length / 2)];
        const mp = projection([midPt[1], midPt[0]]);
        if (mp) {
          const label = name.replace(/[ew]$/, '');
          ig.append("text").attr("x", mp[0]).attr("y", mp[1] - 5)
            .attr("text-anchor", "middle")
            .attr("fill", "rgba(255,200,60,0.35)")
            .attr("font-size", "7px").attr("font-weight", "600")
            .attr("data-base-fs", 7)
            .style("pointer-events", "none").text(label);
        }
      }
    }
  }

  const tooltip = document.getElementById("tooltip");
  const ttSchool = document.getElementById("tt-school");
  const ttRegion = document.getElementById("tt-region");
  const mapRect = document.querySelector(".map-area").getBoundingClientRect();

  // Collect all assigned schools for overlap check
  const assignedSchools = new Set();
  for (const rd of Object.values(data)) {
    for (const s of rd.schools) assignedSchools.add(s);
  }

  // Unassigned group dots (white) ‚Äî drawn first so assigned dots are on top
  const unassignedSchools = new Set();
  for (const g2 of unassigned) {
    const school = schoolOf(g2) || findSchoolForGroup(displayName(g2));
    if (school) unassignedSchools.add(school);
  }
  for (const school of unassignedSchools) {
    if (assignedSchools.has(school)) continue; // skip if also assigned ‚Äî assigned dot takes priority
    const c = SCHOOL_COORDS[school];
    if (!c) continue;
    const p = projection([c[1], c[0]]);
    if (!p) continue;
    const [x, y] = p;
    g.append("circle").attr("cx",x).attr("cy",y).attr("r",8).attr("data-base-r",8)
      .attr("data-ox",x).attr("data-oy",y)
      .attr("fill","rgba(255,255,255,0.06)").attr("class","school-glow");
    const isSel = lassoSelection && lassoSelection.schools.has(school);
    g.append("circle").attr("cx",x).attr("cy",y).attr("r",3.5).attr("data-base-r",3.5)
      .attr("data-ox",x).attr("data-oy",y)
      .attr("fill","#fff").attr("opacity",isSel ? 1 : 0.5)
      .attr("stroke",isSel ? "#fff" : "none").attr("stroke-width",isSel ? 1.5 : 0)
      .attr("class","school-dot").style("cursor", isSel ? "grab" : "pointer")
      .on("mousedown", function(e) { if (isSel && !e.shiftKey && !e.metaKey && !viewMode) { e.preventDefault(); e.stopPropagation(); startDotDrag(e); } })
      .on("click", function(e) { if ((e.shiftKey||e.metaKey)&&!viewMode){e.stopPropagation();toggleSchoolInSelection(school);return;} if (!e.shiftKey && !viewMode && !(lassoSelection && lassoSelection.schools.has(school))) { tooltip.classList.remove("visible"); showSchoolModal(school); } })
      .on("mouseenter", function(e) {
        const k = currentZoom ? currentZoom.k : 1;
        d3.select(this).attr("r", 7/Math.sqrt(k));
        ttSchool.textContent = school;
        ttRegion.textContent = "Unassigned"; ttRegion.style.color = "#888";
        const grps = activeGroupsForSchool(school);
        const ttg = document.getElementById("tt-groups");
        if (grps && grps.length) {
          ttg.innerHTML = grps.map(gg => `<span style="color:#ddd">${gg}</span>`).join(" ¬∑ ");
          ttg.style.display = "block";
        } else ttg.style.display="none";
        tooltip.classList.add("visible");
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      })
      .on("mousemove", function(e) {
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      })
      .on("mouseleave", function() {
        d3.select(this).attr("r", 3.5/Math.sqrt(currentZoom?currentZoom.k:1));
        tooltip.classList.remove("visible");
      });
  }

  // Assigned dots
  const hlSchools = viewMode && highlightedQF !== null ? getQFSchools(selectedRegionName, highlightedQF) : null;
  for (const [rn, rd] of Object.entries(data)) {
    const isActive = !selectedRegionName || selectedRegionName === rn;
    for (const school of rd.schools) {
      const c = SCHOOL_COORDS[school];
      if (!c) continue;
      const p = projection([c[1], c[0]]);
      if (!p) continue;
      const [x, y] = p;

      const isInQF = hlSchools ? hlSchools.has(school) : false;
      const isDimmedByQF = hlSchools && !isInQF;
      const isBrightByQF = hlSchools && isInQF;

      const dotR = isBrightByQF ? 6 : (isActive && selectedRegionName ? 4.5 : 3);
      const dotOp = isDimmedByQF ? 0.08 : (isActive ? (viewMode ? 0.9 : 0.85) : (viewMode ? 0.12 : 0.1));

      if (isActive && selectedRegionName && !isDimmedByQF) {
        g.append("circle").attr("cx",x).attr("cy",y)
          .attr("r", isBrightByQF ? 14 : 10).attr("data-base-r", isBrightByQF ? 14 : 10)
          .attr("data-ox",x).attr("data-oy",y)
          .attr("fill", rd.color + (isBrightByQF ? "25" : "15")).attr("class","school-glow");
      }
      const isSel = lassoSelection && lassoSelection.schools.has(school);
      g.append("circle").attr("cx",x).attr("cy",y).attr("r",dotR).attr("data-base-r",dotR)
        .attr("data-ox",x).attr("data-oy",y)
        .attr("fill",rd.color).attr("opacity",isSel ? 1 : dotOp)
        .attr("stroke",isSel ? "#fff" : "none").attr("stroke-width",isSel ? 1.5 : 0)
        .attr("class","school-dot").style("cursor", isSel ? "grab" : "pointer")
        .on("mousedown", function(e) { if (isSel && !e.shiftKey && !e.metaKey && !viewMode) { e.preventDefault(); e.stopPropagation(); startDotDrag(e); } })
        .on("click", function(e) { if ((e.shiftKey||e.metaKey)&&!viewMode){e.stopPropagation();toggleSchoolInSelection(school);return;} if (!e.shiftKey && !viewMode && !(lassoSelection && lassoSelection.schools.has(school))) { tooltip.classList.remove("visible"); showSchoolModal(school); } })
        .on("mouseenter", function(e) {
          const k = currentZoom ? currentZoom.k : 1;
          d3.select(this).attr("r", 7/Math.sqrt(k));
          ttSchool.textContent = school;
          ttRegion.textContent = rn; ttRegion.style.color = rd.accent||rd.color;
          const grps = activeGroupsForSchool(school);
          const ttg = document.getElementById("tt-groups");
          if (grps && grps.length) { ttg.innerHTML = grps.map(g=>`<span style="color:#ddd">${g}</span>`).join(" ¬∑ "); ttg.style.display="block"; }
          else ttg.style.display="none";
          tooltip.classList.add("visible");
          tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
          tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
        })
        .on("mousemove", function(e) {
          tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
          tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
        })
        .on("mouseleave", function() {
          d3.select(this).attr("r", dotR/Math.sqrt(currentZoom?currentZoom.k:1));
          tooltip.classList.remove("visible");
        });
    }
  }

  // Venue markers for selected region (scaled to match 2026 map)
  if (selectedRegionName && data[selectedRegionName]) {
    const rd = data[selectedRegionName];

    const vg = g.append("g").attr("class","venue-markers");

    if (rd.semifinal && rd.semifinal.lat) {
      const sp = projection([rd.semifinal.lng, rd.semifinal.lat]);
      if (sp) {
        const sg = vg.append("g").attr("class","venue-marker-g").attr("data-tx",sp[0]).attr("data-ty",sp[1]).attr("transform",`translate(${sp[0]},${sp[1]})`);
        const star = d3.symbol().type(d3.symbolStar).size(100);
        sg.append("circle").attr("r",14).attr("fill",rd.color+"15").style("pointer-events","none");
        sg.append("path").attr("d", star()).attr("fill","#FFD700").attr("stroke","#fff").attr("stroke-width",1.5).attr("opacity",0.75)
          .attr("class","venue-marker").attr("data-base-sw",1.5).style("pointer-events","none");
        // Click catcher
        sg.append("circle").attr("r",8).attr("fill","transparent").style("cursor","pointer")
          .on("click", ((rn) => () => { if (!viewMode) { tooltip.classList.remove("visible"); showSFModal(rn); } })(selectedRegionName));
      }
    }

    // Group QFs by location for co-located venues
    const venueGroups = {};
    rd.quarterfinals.forEach((qf, i) => {
      if (!qf.lat) return;
      const key = qf.lat + ',' + qf.lng;
      if (!venueGroups[key]) venueGroups[key] = [];
      venueGroups[key].push({qf, idx: i});
    });

    for (const [key, vqfs] of Object.entries(venueGroups)) {
      const first = vqfs[0];
      const p = projection([first.qf.lng, first.qf.lat]);
      if (!p) continue;
      const hlEntry = vqfs.find(v => viewMode && highlightedQF === v.idx);
      const isHL = !!hlEntry;
      const displayIdx = hlEntry ? hlEntry.idx : first.idx;
      const qg = vg.append("g").attr("class","venue-marker-g")
        .attr("data-tx",p[0]).attr("data-ty",p[1])
        .attr("transform",`translate(${p[0]},${p[1]})`);
      const s = 7;
      const glowR = isHL ? 18 : 14;
      qg.append("circle").attr("r",glowR)
        .attr("fill",rd.color+(isHL?"30":"15")).attr("stroke",isHL?rd.color+"50":"none").attr("stroke-width",isHL?1.5:0)
        .style("pointer-events","none");
      qg.append("path").attr("d",`M0,${-s} L${s},0 L0,${s} L${-s},0 Z`)
        .attr("fill",isHL ? (rd.accent||rd.color) : rd.color).attr("stroke","#fff").attr("stroke-width",isHL?2.5:1.5).attr("opacity",0.75)
        .attr("class","venue-marker").attr("data-base-sw",isHL?2.5:1.5).style("pointer-events","none");
      qg.append("text").attr("x",0).attr("y",0).attr("dy","0.35em").attr("text-anchor","middle")
        .attr("fill","#fff").attr("font-size","8px").attr("font-weight","700").attr("font-family","'Space Mono',monospace")
        .attr("pointer-events","none").text(displayIdx+1);
      // "+" pip for co-located venues
      if (vqfs.length > 1) {
        qg.append("text").attr("x",s-2).attr("y",-s+2).attr("text-anchor","start")
          .attr("fill","#fff").attr("font-size","10px").attr("font-weight","900").attr("font-family","'Space Mono',monospace")
          .attr("pointer-events","none").attr("opacity",0.85).text("+");
      }
      // Click catcher
      const cc = qg.append("circle").attr("r",9).attr("fill","transparent").style("cursor","pointer");
      cc.on("mouseenter", function(e) {
        ttSchool.textContent = first.qf.location||'No location';
        const hoverMeta = vqfs.length > 1
          ? vqfs.map(v => `QF${v.idx+1} (${v.qf.date||''})`).join(' + ')
          : `QF ${first.idx+1} ¬∑ ${first.qf.date||''} ¬∑ ${first.qf.groups.length} groups`;
        ttRegion.textContent = hoverMeta + (viewMode?' ¬∑ click to highlight':'');
        ttRegion.style.color = rd.accent||rd.color;
        document.getElementById("tt-groups").style.display = "none";
        tooltip.classList.add("visible");
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      }).on("mousemove", function(e) {
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      }).on("mouseleave", function() {
        tooltip.classList.remove("visible");
      });
      cc.on("click", ((rn, venueQFs) => (e) => {
        tooltip.classList.remove("visible");
        const entries = venueQFs.map(v => ({
          qf: data[rn].quarterfinals[v.idx], qfIdx: v.idx, regionName: rn, regionData: data[rn]
        }));
        if (viewMode) {
          if (venueQFs.length === 1) {
            highlightedQF = highlightedQF === venueQFs[0].idx ? null : venueQFs[0].idx;
            if (highlightedQF !== null) {
              showVenuePopup(e.clientX, e.clientY, entries, 0);
            } else { closeVenuePopup(); }
          } else {
            // Find currently highlighted tab, default to first
            const curTab = venueQFs.findIndex(v => highlightedQF === v.idx);
            const tab = curTab >= 0 ? curTab : 0;
            highlightedQF = venueQFs[tab].idx;
            showVenuePopup(e.clientX, e.clientY, entries, tab);
          }
          renderMap();
          document.getElementById('venue-popup').style.display = document.getElementById('venue-popup')._qfEntries ? 'block' : 'none';
        } else {
          if (venueQFs.length === 1) {
            showQFDetailModal(rn, venueQFs[0].idx);
          } else {
            showVenuePopup(e.clientX, e.clientY, entries, 0);
          }
        }
      })(selectedRegionName, vqfs));
    }
  }

  // Post-render zoom
  if (currentZoom && currentZoom.k !== 1) {
    const k = currentZoom.k;
    const dotScale = Math.sqrt(k);
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||0.6)/k; });
    g.selectAll(".venue-marker").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||1.5)/dotScale; });
    g.selectAll(".venue-marker-g").each(function() {
      const el = d3.select(this);
      el.attr("transform", `translate(${el.attr("data-tx")},${el.attr("data-ty")}) scale(${1/dotScale})`);
    });
    applyZoomSpread(g, k);
  }

  updateMapStats();
  renderLegend();

  // Restore current data after compare render
  if (compareMode && _savedData) {
    data = _savedData;
    for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
    Object.assign(STATE_REGION, _savedSR);
    regionGroups = _savedRG;
  }
}

function renderLegend() {
  const el = document.getElementById('map-legend');
  let h = '<div class="legend-title">Regions</div>';
  for (const [name, rd] of Object.entries(data)) {
    const active = selectedRegionName === name;
    h += `<div class="legend-item" onclick="toggleRegion('${esc(name)}')" style="${active?'color:#fff;font-weight:600':''}">`;
    h += `<div class="legend-swatch" style="background:${rd.color}${active?'':'88'}"></div>${name}</div>`;
  }
  el.innerHTML = h;
}

window.zoomIn = () => { if (mapSvg&&mapZoom) mapSvg.transition().duration(300).call(mapZoom.scaleBy,1.5); };
window.zoomOut = () => { if (mapSvg&&mapZoom) mapSvg.transition().duration(300).call(mapZoom.scaleBy,1/1.5); };
window.resetZoom = () => { currentZoom=null; if (mapSvg&&mapZoom) mapSvg.transition().duration(500).call(mapZoom.transform,d3.zoomIdentity); };

// Add lasso selection to region's ungrouped list
function addSelectionToRegion(regionName, selection) {
  saveUndo('reset');
  if (!regionGroups[regionName]) regionGroups[regionName] = [];
  // Remove groups from current locations
  for (const grp of selection.groups) {
    const dn = displayName(grp), sc = schoolOf(grp);
    // Check pool
    const poolIdx = unassigned.findIndex(u => displayName(u) === dn && schoolOf(u) === sc);
    if (poolIdx !== -1) { unassigned.splice(poolIdx, 1); }
    else {
      // Check all QFs
      for (const rd of Object.values(data)) {
        let found = false;
        for (const qf of rd.quarterfinals) {
          const gi = qf.groups.findIndex(g => displayName(g) === dn && schoolOf(g) === sc);
          if (gi !== -1) { qf.groups.splice(gi, 1); found = true; break; }
        }
        if (found) break;
      }
    }
    // Check other regionGroups
    for (const [rn, rgs] of Object.entries(regionGroups)) {
      const ri = rgs.findIndex(g => displayName(g) === dn && schoolOf(g) === sc);
      if (ri !== -1) { rgs.splice(ri, 1); break; }
    }
    regionGroups[regionName].push(grp);
  }
  clearLassoSelection();
  openRegions[regionName] = true;
  for (const rn of Object.keys(data)) rebuildSchools(rn);
  renderEditor(); renderMap();
}

// Generate QFs from region's ungrouped groups using geographic clustering
function generateQFs(regionName) {
  const rgs = regionGroups[regionName] || [];
  if (!rgs.length) { alert('No ungrouped groups in ' + regionName); return; }
  saveUndo('generate QFs');
  generateQFsForRegion(regionName);
  openRegions[regionName] = true;
  for (const rn of Object.keys(data)) rebuildSchools(rn);
  renderEditor(); renderMap();
}

function chunkCentroid(groups) {
  const coords = [];
  for (const g of groups) {
    const sc = schoolOf(g);
    const c = sc ? SCHOOL_COORDS[sc] : null;
    if (c) coords.push({lat: c[0], lng: c[1], name: sc});
  }
  if (!coords.length) return {lat: null, lng: null, nearestSchool: null};
  const avgLat = coords.reduce((s, c) => s + c.lat, 0) / coords.length;
  const avgLng = coords.reduce((s, c) => s + c.lng, 0) / coords.length;
  // Find nearest school to centroid and use ITS coords for the QF placement
  let nearest = null, nearestCoord = null, minDist = Infinity;
  for (const c of coords) {
    const d = Math.hypot(c.lat - avgLat, c.lng - avgLng);
    if (d < minDist) { minDist = d; nearest = c.name; nearestCoord = c; }
  }
  return {lat: nearestCoord.lat, lng: nearestCoord.lng, nearestSchool: nearest};
}

// Create new QF from dragged selection, pre-filled with selection centroid
function showNewQFFromSelection(regionName, selection) {
  const { schools, groups } = selection;
  // Compute centroid of selected schools
  const coords = [];
  for (const school of schools) {
    const c = SCHOOL_COORDS[school];
    if (c) coords.push({lat: c[0], lng: c[1], name: school});
  }
  let defLat = '', defLng = '', defLoc = '';
  if (coords.length) {
    const avgLat = coords.reduce((s,c) => s + c.lat, 0) / coords.length;
    const avgLng = coords.reduce((s,c) => s + c.lng, 0) / coords.length;
    defLat = avgLat.toFixed(2);
    defLng = avgLng.toFixed(2);
    // Nearest school to centroid
    let minDist = Infinity;
    for (const c of coords) {
      const d = Math.hypot(c.lat - avgLat, c.lng - avgLng);
      if (d < minDist) { minDist = d; defLoc = c.name; }
    }
  }

  // Group by school for checkbox display
  const bySchool = {};
  for (const g of groups) {
    const s = schoolOf(g) || '(unknown)';
    if (!bySchool[s]) bySchool[s] = [];
    bySchool[s].push(g);
  }
  let listHtml = '';
  for (const [school, gs] of Object.entries(bySchool)) {
    listHtml += `<div style="margin-bottom:6px">
      <label style="font-size:11px;color:#888;cursor:pointer"><input type="checkbox" class="school-toggle" data-school="${esc(school)}" checked style="margin-right:4px">
      <strong style="color:#aaa">${school}</strong> (${gs.length})</label>`;
    for (const g of gs) {
      listHtml += `<label style="display:block;font-size:12px;color:#ccc;padding:1px 0 1px 18px;cursor:pointer">
        <input type="checkbox" class="group-cb" data-group="${esc(g)}" checked style="margin-right:6px">${displayName(g)}</label>`;
    }
    listHtml += '</div>';
  }

  const qfNum = (data[regionName] ? data[regionName].quarterfinals.length : 0) + 1;
  showModal(`New QF${qfNum} in ${regionName}`, `
    <div class="modal-row" style="margin-bottom:10px">
      <div style="flex:2"><div class="modal-label">Location</div><input class="modal-input" id="m-loc" value="${esc(defLoc)}"></div>
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" placeholder="Feb 14"></div>
    </div>
    <div class="modal-row" style="margin-bottom:10px">
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" value="${defLat}"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" value="${defLng}"></div>
    </div>
    <div style="font-size:10px;color:#555;margin-bottom:10px">Coords auto-filled from centroid of ${schools.size} selected school${schools.size !== 1 ? 's' : ''}</div>
    <div class="modal-label">Groups to add</div>
    <div style="max-height:200px;overflow-y:auto;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;margin-bottom:8px">
      ${listHtml}
    </div>
    <div style="font-size:10px;color:#666">Uncheck groups you don't want to include.</div>
  `, () => {
    const checked = Array.from(document.querySelectorAll('.group-cb:checked')).map(cb => cb.dataset.group);
    saveUndo('edit QF');
    const newQF = {
      date: document.getElementById('m-date').value.trim(),
      location: document.getElementById('m-loc').value.trim(),
      lat: parseFloat(document.getElementById('m-lat').value) || null,
      lng: parseFloat(document.getElementById('m-lng').value) || null,
      groups: []
    };
    data[regionName].quarterfinals.push(newQF);
    const newIdx = data[regionName].quarterfinals.length - 1;
    if (checked.length) {
      bulkAssignGroups(checked, regionName + '|' + newIdx);
    }
    clearLassoSelection();
    openRegions[regionName] = true;
    for (const rn of Object.keys(data)) rebuildSchools(rn);
    renderEditor(); renderMap();
  });

  // Wire up school-level toggles and location autocomplete
  setTimeout(() => {
    document.querySelectorAll('.school-toggle').forEach(st => {
      st.addEventListener('change', () => {
        const school = st.dataset.school;
        document.querySelectorAll('.group-cb').forEach(cb => {
          if (schoolOf(cb.dataset.group) === school) cb.checked = st.checked;
        });
      });
    });
    wireLocationAutocomplete();
  }, 50);
}

// ‚îÄ‚îÄ‚îÄ DRAG FROM SELECTED DOTS ‚îÄ‚îÄ‚îÄ
let dotDragActive = false;
function startDotDrag(e) {
  if (!lassoSelection || !lassoSelection.schools.size) return;
  dotDragActive = true;
  const mapArea = document.getElementById('map-area');
  const mapRect = mapArea.getBoundingClientRect();
  const t = currentZoom || d3.zoomIdentity;

  // Create ghost dots at each selected school's screen position
  const ghosts = [];
  for (const school of lassoSelection.schools) {
    const c = SCHOOL_COORDS[school];
    if (!c) continue;
    const p = mapProjection([c[1], c[0]]);
    if (!p) continue;
    const sx = mapRect.left + t.applyX(p[0]);
    const sy = mapRect.top + t.applyY(p[1]);
    const dot = document.createElement('div');
    dot.className = 'drag-ghost-dot';
    dot.style.left = sx + 'px';
    dot.style.top = sy + 'px';
    dot.style.background = '#fff';
    document.body.appendChild(dot);
    ghosts.push({el: dot, origX: sx, origY: sy});
  }

  // Label showing count
  const label = document.createElement('div');
  label.className = 'drag-ghost-label';
  label.textContent = `${lassoSelection.schools.size} schools ¬∑ ${lassoSelection.groups.length} groups`;
  document.body.appendChild(label);

  function onMove(ev) {
    const mx = ev.clientX, my = ev.clientY;
    label.style.left = (mx + 16) + 'px';
    label.style.top = (my - 12) + 'px';
    // Converge dots toward cursor
    for (const g of ghosts) {
      const dx = mx - g.origX, dy = my - g.origY;
      const dist = Math.hypot(dx, dy);
      const pull = Math.min(0.85, dist / 300);
      g.el.style.left = (g.origX + dx * pull) + 'px';
      g.el.style.top = (g.origY + dy * pull) + 'px';
      g.el.style.opacity = 0.5 + pull * 0.5;
    }
    // Highlight QF drop targets
    document.querySelectorAll('.qf-drop-highlight').forEach(el => el.classList.remove('qf-drop-highlight'));
    const target = getQFDropTarget(mx, my);
    if (target) target.el.classList.add('qf-drop-highlight');
  }

  function onUp(ev) {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    dotDragActive = false;
    // Remove ghosts
    for (const g of ghosts) g.el.remove();
    label.remove();
    document.querySelectorAll('.qf-drop-highlight').forEach(el => el.classList.remove('qf-drop-highlight'));
    // Check drop target
    const target = getQFDropTarget(ev.clientX, ev.clientY);
    if (target && lassoSelection) {
      if (target.type === 'qf') {
        showGroupPicker(target.regionName, target.qfIdx, lassoSelection);
      } else if (target.type === 'region') {
        addSelectionToRegion(target.regionName, lassoSelection);
      }
    }
  }

  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

function getQFDropTarget(clientX, clientY) {
  // First check QF blocks (more specific)
  const qfEls = document.querySelectorAll('.qf-block');
  for (const el of qfEls) {
    const r = el.getBoundingClientRect();
    if (clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom) {
      const rn = el.dataset.region;
      const qi = parseInt(el.dataset.qfIdx);
      if (rn && !isNaN(qi)) return { el, regionName: rn, qfIdx: qi, type: 'qf' };
    }
  }
  // Then check region headers (for "new QF" drop)
  const rhEls = document.querySelectorAll('.region-header');
  for (const el of rhEls) {
    const r = el.getBoundingClientRect();
    if (clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom) {
      const block = el.closest('[data-region-block]');
      if (block) return { el, regionName: block.dataset.regionBlock, qfIdx: -1, type: 'region' };
    }
  }
  return null;
}

// ‚îÄ‚îÄ‚îÄ LASSO SELECTION ‚îÄ‚îÄ‚îÄ
(function() {
  const mapArea = document.getElementById('map-area');
  const lassoEl = document.getElementById('lasso-rect');
  const hintEl = document.getElementById('lasso-hint');
  const statsBar = document.getElementById('map-stats');
  let lassoActive = false, lassoStart = null;
  let selBarDragging = false, selBarStart = null;

  // Show/hide hint based on shift key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Shift') hintEl.style.display = 'none';
  });
  document.addEventListener('keyup', (e) => {
    if (e.key === 'Shift' && !lassoActive) hintEl.style.display = '';
  });

  mapArea.addEventListener('mousedown', (e) => {
    if (!e.shiftKey || viewMode) return;
    e.preventDefault();
    e.stopPropagation();
    clearLassoSelection();
    lassoActive = true;
    const rect = mapArea.getBoundingClientRect();
    lassoStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    lassoEl.style.left = lassoStart.x + 'px';
    lassoEl.style.top = lassoStart.y + 'px';
    lassoEl.style.width = '0px';
    lassoEl.style.height = '0px';
    lassoEl.style.display = 'block';
    if (mapSvg && mapZoom) mapSvg.on('.zoom', null);
  });

  document.addEventListener('mousemove', (e) => {
    if (lassoActive) {
      const rect = mapArea.getBoundingClientRect();
      const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
      const x = Math.min(lassoStart.x, cx), y = Math.min(lassoStart.y, cy);
      const w = Math.abs(cx - lassoStart.x), h = Math.abs(cy - lassoStart.y);
      lassoEl.style.left = x + 'px';
      lassoEl.style.top = y + 'px';
      lassoEl.style.width = w + 'px';
      lassoEl.style.height = h + 'px';
      return;
    }
    if (selBarDragging) {
      // Highlight QF blocks on hover
      document.querySelectorAll('.qf-drop-highlight').forEach(el => el.classList.remove('qf-drop-highlight'));
      const target = getQFDropTarget(e.clientX, e.clientY);
      if (target) target.el.classList.add('qf-drop-highlight');
    }
  });

  document.addEventListener('mouseup', (e) => {
    // Handle stats bar drop
    if (selBarDragging) {
      selBarDragging = false;
      statsBar.classList.remove('dragging');
      document.querySelectorAll('.qf-drop-highlight').forEach(el => el.classList.remove('qf-drop-highlight'));
      const target = getQFDropTarget(e.clientX, e.clientY);
      if (target && lassoSelection) {
        if (target.type === 'qf') {
          showGroupPicker(target.regionName, target.qfIdx, lassoSelection);
        } else if (target.type === 'region') {
          addSelectionToRegion(target.regionName, lassoSelection);
        }
      }
      return;
    }

    if (!lassoActive) return;
    lassoActive = false;
    lassoEl.style.display = 'none';
    hintEl.style.display = '';
    if (mapSvg && mapZoom) mapSvg.call(mapZoom);

    const rect = mapArea.getBoundingClientRect();
    const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
    const x1 = Math.min(lassoStart.x, cx), y1 = Math.min(lassoStart.y, cy);
    const x2 = Math.max(lassoStart.x, cx), y2 = Math.max(lassoStart.y, cy);
    if (x2 - x1 < 10 || y2 - y1 < 10) return;

    const t = currentZoom || d3.zoomIdentity;
    const selected = [];
    for (const school of Object.keys(SCHOOL_COORDS)) {
      const c = SCHOOL_COORDS[school];
      if (!c) continue;
      const p = mapProjection([c[1], c[0]]);
      if (!p) continue;
      const sx = t.applyX(p[0]), sy = t.applyY(p[1]);
      if (sx >= x1 && sx <= x2 && sy >= y1 && sy <= y2) selected.push(school);
    }
    if (!selected.length) return;

    const groups = [];
    for (const school of selected) {
      const gs = SCHOOL_GROUPS[school];
      if (gs) groups.push(...gs.map(g => g + '@' + school));
    }
    lassoSelection = { schools: new Set(selected), groups: groups };
    updateSelectionBar();
    renderMap();
  });

  // Stats bar dragging for selection
  statsBar.addEventListener('mousedown', (e) => {
    if (!statsBar.classList.contains('selection-active')) return;
    if (e.target.closest('.sel-close')) return;
    if (e.button === 2) return;
    selBarDragging = true;
    statsBar.classList.add('dragging');
    e.preventDefault();
  });

  // Right-click on stats bar ‚Üí bulk assign modal
  statsBar.addEventListener('contextmenu', (e) => {
    if (!statsBar.classList.contains('selection-active')) return;
    e.preventDefault();
    if (!lassoSelection) return;
    const { schools, groups } = lassoSelection;
    const schoolList = Array.from(schools);
    showModal(`Assign ${schoolList.length} Schools (${groups.length} groups)`, `
      <div style="max-height:120px;overflow-y:auto;font-size:11px;color:#888;margin-bottom:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px">
        ${schoolList.map(s => `<div>${s}</div>`).join('')}
      </div>
      <div class="modal-label">Assign all groups to</div>
      <select class="modal-input" id="m-target">
        ${buildAssignSelect(selectedRegionName ? selectedRegionName + '|0' : '__pool__')}
      </select>
    `, () => {
      const target = document.getElementById('m-target').value;
      saveUndo('clear groups');
      bulkAssignGroups(groups, target);
      clearLassoSelection();
      for (const rn of Object.keys(data)) rebuildSchools(rn);
      renderEditor(); renderMap();
    });
  });
})();

// Clear lasso selection bar
let lassoSelection = null; // {schools: Set, groups: []}
function clearLassoSelection() {
  lassoSelection = null;
  const el = document.getElementById('map-stats');
  el.classList.remove('selection-active', 'dragging');
  updateMapStats();
  renderMap();
}
function updateSelectionBar() {
  const el = document.getElementById('map-stats');
  if (!lassoSelection || !lassoSelection.schools.size) {
    clearLassoSelection();
    return;
  }
  const sc = lassoSelection.schools.size;
  const gc = lassoSelection.groups.length;
  el.classList.add('selection-active');
  el.innerHTML = `<span><span class="map-stat-val">${sc}</span>School${sc !== 1 ? 's' : ''}</span>`
    + `<span><span class="map-stat-val">${gc}</span>Group${gc !== 1 ? 's' : ''}</span>`
    + `<span class="sel-hint">drag to QF ¬∑ right-click for options</span>`
    + `<button class="sel-close" onclick="clearLassoSelection()">‚úï</button>`;
}
function toggleSchoolInSelection(school) {
  if (!lassoSelection) {
    lassoSelection = { schools: new Set(), groups: [] };
  }
  if (lassoSelection.schools.has(school)) {
    lassoSelection.schools.delete(school);
    lassoSelection.groups = lassoSelection.groups.filter(g => schoolOf(g) !== school);
  } else {
    lassoSelection.schools.add(school);
    const gs = SCHOOL_GROUPS[school];
    if (gs) lassoSelection.groups.push(...gs.map(g => g + '@' + school));
  }
  updateSelectionBar();
  renderMap();
}
// Bulk assign encoded groups to a target
function bulkAssignGroups(groups, target) {
  // Remove from current locations
  for (const grp of groups) {
    const dn = displayName(grp), sc = schoolOf(grp);
    const poolIdx = unassigned.findIndex(u => displayName(u) === dn && schoolOf(u) === sc);
    if (poolIdx !== -1) { unassigned.splice(poolIdx, 1); continue; }
    for (const rd of Object.values(data)) {
      let found = false;
      for (const qf of rd.quarterfinals) {
        const gi = qf.groups.findIndex(g => displayName(g) === dn && schoolOf(g) === sc);
        if (gi !== -1) { qf.groups.splice(gi, 1); found = true; break; }
      }
      if (found) break;
    }
  }
  // Assign
  if (target === '__pool__') {
    unassigned.push(...groups);
  } else {
    const [targetRn, targetQi] = target.split('|');
    if (targetQi === 'new') {
      data[targetRn].quarterfinals.push({date:'',location:'',lat:null,lng:null,groups:[...groups]});
    } else {
      data[targetRn].quarterfinals[parseInt(targetQi)].groups.push(...groups);
    }
    openRegions[targetRn] = true;
  }
}

// Group picker modal - shows checkboxes for individual group selection
function showGroupPicker(regionName, qfIdx, selection) {
  const { schools, groups } = selection;
  // Group by school for display
  const bySchool = {};
  for (const g of groups) {
    const s = schoolOf(g) || '(unknown)';
    if (!bySchool[s]) bySchool[s] = [];
    bySchool[s].push(g);
  }
  const qf = data[regionName].quarterfinals[qfIdx];
  let listHtml = '';
  for (const [school, gs] of Object.entries(bySchool)) {
    listHtml += `<div style="margin-bottom:8px">
      <div style="font-size:11px;color:#888;margin-bottom:3px;display:flex;align-items:center;gap:6px">
        <label style="cursor:pointer"><input type="checkbox" class="school-toggle" data-school="${esc(school)}" checked style="margin-right:4px">
        <strong style="color:#aaa">${school}</strong></label>
      </div>`;
    for (const g of gs) {
      listHtml += `<label style="display:block;font-size:12px;color:#ccc;padding:2px 0 2px 18px;cursor:pointer">
        <input type="checkbox" class="group-cb" data-group="${esc(g)}" checked style="margin-right:6px">${displayName(g)}
      </label>`;
    }
    listHtml += '</div>';
  }

  showModal(`Move to QF${qfIdx+1} ‚Äî ${qf.location||'(no location)'}`, `
    <div style="font-size:11px;color:#666;margin-bottom:8px">${regionName} ¬∑ ${qf.date||''}</div>
    <div style="max-height:250px;overflow-y:auto;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;margin-bottom:8px">
      ${listHtml}
    </div>
    <div style="font-size:10px;color:#666">Uncheck groups you don't want to move.</div>
  `, () => {
    const checked = Array.from(document.querySelectorAll('.group-cb:checked')).map(cb => cb.dataset.group);
    if (!checked.length) return;
    saveUndo('clear groups');
    bulkAssignGroups(checked, regionName + '|' + qfIdx);
    clearLassoSelection();
    for (const rn of Object.keys(data)) rebuildSchools(rn);
    renderEditor(); renderMap();
  });

  // Wire up school-level toggle
  setTimeout(() => {
    document.querySelectorAll('.school-toggle').forEach(st => {
      st.addEventListener('change', () => {
        const school = st.dataset.school;
        const checked = st.checked;
        document.querySelectorAll(`.group-cb`).forEach(cb => {
          if (schoolOf(cb.dataset.group) === school) cb.checked = checked;
        });
      });
    });
  }, 50);
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', (e) => {
  // Ctrl+Z / Cmd+Z: Undo
  if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
    e.preventDefault();
    undoAction();
    return;
  }
  // Escape: Close modal or UK popup
  if (e.key === 'Escape') {
    if (lassoSelection && lassoSelection.schools.size) {
      clearLassoSelection();
      return;
    }
    if (document.getElementById('modal-overlay').classList.contains('active')) {
      closeModal();
    } else if (document.querySelector('.uk-popup-overlay')) {
      closeUKPopup();
    }
    return;
  }
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
// Auto-load embedded historical data
for (const [yearStr, raw] of Object.entries(HISTORY_RAW)) {
  const year = parseInt(yearStr);
  const season = raw.season || (year - 1) + '-' + year;
  HISTORY[year] = {
    raw: raw,
    regions: convertHistoryToEditor(raw),
    meta: { season: season, source: raw.source || '', finals: raw.finals || null, notes: raw.notes || '' }
  };
}
renderEditor();
loadMapData();
window.addEventListener('resize', () => renderMap());

</script>
</body>
</html>
