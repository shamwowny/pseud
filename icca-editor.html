<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé§</text></svg>">
<title>ICCA Region Editor</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  min-height: 100vh; background: #0A0A0F;
  font-family: 'Outfit', sans-serif; color: #E8E6E3; overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ‚îÄ */
.toolbar {
  height: 52px; display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.02);
}
.toolbar-left { display: flex; align-items: center; gap: 16px; }
.toolbar-title {
  font-size: 15px; font-weight: 700; letter-spacing: -0.5px;
  background: linear-gradient(135deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.toolbar-subtitle { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; letter-spacing: 2px; }
.toolbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.tb-btn {
  padding: 6px 14px; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px;
  background: rgba(255,255,255,0.04); color: #bbb; font-family: 'Outfit'; font-size: 12px;
  font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; text-decoration: none;
}
.tb-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.25); }
.tb-btn.primary { background: rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.3); color: #FFD700; }
.tb-btn.primary:hover { background: rgba(255,215,0,0.2); }
.tb-btn.danger { border-color: rgba(255,80,80,0.3); color: #ff6b6b; }
.tb-btn.danger:hover { background: rgba(255,80,80,0.12); }
.tb-sep { width: 1px; height: 24px; background: rgba(255,255,255,0.08); margin: 0 4px; }

/* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
.main { display: flex; height: calc(100vh - 52px); }

/* ‚îÄ‚îÄ‚îÄ EDITOR PANEL ‚îÄ‚îÄ‚îÄ */
.editor {
  width: 380px; min-width: 380px; border-right: 1px solid rgba(255,255,255,0.06);
  overflow-y: auto; background: rgba(255,255,255,0.01); display: flex; flex-direction: column;
}
.editor-header {
  padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; background: rgba(10,10,15,0.95); z-index: 5; backdrop-filter: blur(8px);
}
.editor-title { font-size: 11px; font-weight: 600; color: #888; letter-spacing: 1.5px; text-transform: uppercase; }
.editor-stats { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.editor-body { flex: 1; overflow-y: auto; padding: 8px 0; }

/* Region blocks */
.region-block { border-bottom: 1px solid rgba(255,255,255,0.04); }
.region-header {
  display: flex; align-items: center; gap: 8px; padding: 10px 16px;
  cursor: pointer; transition: background 0.2s; user-select: none;
}
.region-header:hover { background: rgba(255,255,255,0.03); }
.region-chevron {
  font-size: 10px; color: #555; transition: transform 0.2s; width: 14px; text-align: center;
}
.region-chevron.open { transform: rotate(90deg); }
.region-swatch {
  width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s;
}
.region-swatch:hover { transform: scale(1.2); }
.region-name { flex: 1; font-size: 13px; font-weight: 600; }
.region-meta { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.region-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
.region-header:hover .region-actions { opacity: 1; }
.region-action-btn {
  width: 22px; height: 22px; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
  background: rgba(255,255,255,0.03); color: #888; font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.region-action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.region-action-btn.del:hover { background: rgba(255,80,80,0.15); color: #ff6b6b; border-color: rgba(255,80,80,0.3); }

/* QF blocks */
.region-body { padding: 0 0 8px; }
.qf-block { margin: 0 10px 6px; }
.qf-header {
  display: flex; align-items: center; gap: 6px; padding: 6px 10px;
  background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 6px 6px 0 0; font-size: 11px; cursor: pointer; user-select: none;
}
.qf-header:hover { background: rgba(255,255,255,0.04); }
.qf-header[draggable="true"] { cursor: grab; }
.qf-header.dragging { opacity: 0.4; }
.region-header.drag-over { background: rgba(255,215,0,0.08); outline: 1px dashed rgba(255,215,0,0.3); }
.qf-label { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 10px; }
.qf-location { flex: 1; color: #888; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.qf-count { font-family: 'Space Mono', monospace; font-size: 10px; color: #555; }
.qf-actions { display: flex; gap: 3px; opacity: 0; transition: opacity 0.2s; }
.qf-header:hover .qf-actions { opacity: 1; }

/* Group tags */
.qf-groups {
  display: flex; flex-wrap: wrap; gap: 0; padding: 6px 8px;
  border: 1px solid rgba(255,255,255,0.06); border-top: none;
  border-radius: 0 0 6px 6px; background: rgba(255,255,255,0.01);
  min-height: 32px; transition: background 0.2s;
}
.qf-groups.drag-over { background: rgba(255,215,0,0.06); border-color: rgba(255,215,0,0.2); }
.group-tag {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 14px; font-size: 11px; margin: 2px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
  cursor: grab; transition: all 0.2s; user-select: none;
}
.group-tag:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
.group-tag.dragging { opacity: 0.4; }
.group-tag .remove-group {
  font-size: 9px; color: #555; cursor: pointer; margin-left: 2px;
  width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; transition: all 0.15s;
}
.group-tag .remove-group:hover { background: rgba(255,80,80,0.2); color: #ff6b6b; }

/* ‚îÄ‚îÄ‚îÄ MAP AREA ‚îÄ‚îÄ‚îÄ */
.map-area { flex: 1; position: relative; overflow: hidden; }
.map-bg {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse 80% 60% at 50% 40%, rgba(255,255,255,0.012) 0%, transparent 70%);
}
#map-container { position: absolute; inset: 0; }
#map-container svg { width: 100%; height: 100%; }
.state-path { transition: fill 0.3s; }
.school-dot { transition: opacity 0.3s; }
.school-glow { transition: opacity 0.3s; }

/* Legend */
.map-legend {
  position: absolute; top: 12px; right: 12px; background: rgba(10,10,15,0.85);
  border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px 16px;
  backdrop-filter: blur(12px); z-index: 10;
}
.legend-title { font-size: 9px; font-weight: 600; color: #555; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; }
.legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; font-size: 11px; color: #aaa; cursor: pointer; }
.legend-item:hover { color: #ddd; }
.legend-swatch { width: 8px; height: 8px; border-radius: 2px; }

/* Tooltip */
.tooltip-box {
  position: absolute; pointer-events: none; background: rgba(10,10,15,0.92); border: 1px solid rgba(255,255,255,0.15);
  padding: 8px 14px; border-radius: 8px; font-size: 12px; z-index: 50; backdrop-filter: blur(12px);
  opacity: 0; transition: opacity 0.15s; max-width: 300px;
}
.tooltip-box.visible { opacity: 1; }
.tt-school { font-weight: 600; }
.tt-region { font-size: 10px; margin-top: 2px; }
.tt-groups { font-size: 10px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); color: #aaa; }

/* Zoom controls */
.zoom-controls {
  position: absolute; bottom: 20px; right: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 10;
}
.zoom-btn {
  width: 30px; height: 30px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.12);
  background: rgba(10,10,15,0.8); color: #aaa; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace;
}
.zoom-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
  display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #14141a; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
  padding: 24px; min-width: 360px; max-width: 480px;
}
.modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
.modal-input {
  width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px; color: #E8E6E3; font-family: 'Outfit'; font-size: 13px; margin-bottom: 12px;
}
.modal-input:focus { outline: none; border-color: rgba(255,255,255,0.3); }
.modal-row { display: flex; gap: 8px; margin-bottom: 12px; }
.modal-label { font-size: 11px; color: #888; margin-bottom: 4px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
.color-picker { width: 40px; height: 32px; border: none; border-radius: 6px; cursor: pointer; background: none; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }

/* Dropdown */
.dropdown-wrap { position: relative; }

/* Lasso selection */
.lasso-rect {
  position: absolute; border: 2px dashed rgba(255,215,0,0.6); background: rgba(255,215,0,0.06);
  pointer-events: none; z-index: 20; display: none; border-radius: 2px;
}
.lasso-hint {
  position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
  background: rgba(10,10,15,0.85); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px; padding: 6px 14px; font-size: 11px; color: #888;
  z-index: 15; pointer-events: none; white-space: nowrap;
  font-family: 'Space Mono', monospace;
}

/* Pool section */
.pool-section { padding: 12px 0 0; border-top: 1px solid rgba(255,255,255,0.06); }
.pool-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 16px 8px; }
.pool-label { font-size: 10px; font-weight: 600; color: #666; letter-spacing: 1.5px; text-transform: uppercase; }
.pool-drop { border-color: rgba(255,255,255,0.1) !important; }

/* ‚îÄ‚îÄ‚îÄ VIEW MODE ‚îÄ‚îÄ‚îÄ */
.view-mode .region-actions,
.view-mode .qf-actions,
.view-mode .remove-group,
.view-mode .lasso-hint,
.view-mode .lasso-rect,
.view-mode .pool-section { display: none !important; }
.view-mode .group-tag { cursor: default; -webkit-user-drag: none; }
.view-mode .region-swatch { pointer-events: none; cursor: default; }
.view-mode .qf-header { cursor: pointer; }
.view-mode .qf-header[draggable] { -webkit-user-drag: none; }

/* Venue popup */
.venue-popup {
  position: absolute; z-index: 40; background: rgba(10,10,15,0.94); border: 1px solid rgba(255,255,255,0.15);
  border-radius: 12px; padding: 16px 18px; backdrop-filter: blur(16px); max-width: 320px;
  pointer-events: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  cursor: grab; user-select: none; animation: fadeIn 0.2s ease;
}
.venue-popup.dragging { cursor: grabbing; opacity: 0.92; }
.venue-popup-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
.venue-popup-title { font-size: 13px; font-weight: 700; }
.venue-popup-meta { font-size: 11px; color: #888; margin-top: 2px; }
.venue-popup-close { background: none; border: none; color: #666; font-size: 16px; cursor: pointer; padding: 0 2px; line-height: 1; }
.venue-popup-close:hover { color: #fff; }
.venue-popup-groups { display: flex; flex-wrap: wrap; gap: 4px; }
.venue-popup-group { font-size: 11px; padding: 3px 10px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); }
.venue-popup-tabs { display: flex; gap: 4px; margin-bottom: 10px; }
.venue-popup-tab { font-size: 11px; padding: 4px 12px; border-radius: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #888; cursor: pointer; transition: all 0.15s; }
.venue-popup-tab:hover { background: rgba(255,255,255,0.1); color: #ccc; }
.venue-popup-tab.active { background: var(--tab-color, rgba(255,255,255,0.15)); border-color: var(--tab-color, rgba(255,255,255,0.3)); color: #fff; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* Map stats bar */
.map-stats {
  position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 15;
  display: none; gap: 16px; align-items: center;
  background: rgba(10,10,15,0.85); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px; padding: 6px 18px; backdrop-filter: blur(12px);
  font-family: 'Space Mono', monospace; font-size: 11px; color: #888;
}
.view-mode .map-stats { display: flex; }
.map-stat-val { color: #aaa; font-weight: 700; margin-right: 3px; }

/* Group hover tooltip */
.group-tooltip {
  position: fixed; z-index: 300; pointer-events: none;
  background: rgba(10,10,15,0.92); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 8px; padding: 5px 11px; backdrop-filter: blur(12px);
  font-family: 'Inter', sans-serif; font-size: 11px; color: #aaa;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  opacity: 0; transition: opacity 0.15s;
  white-space: nowrap;
}
.group-tooltip.visible { opacity: 1; }

/* Mobile disclaimer */
.mobile-disclaimer {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: #0A0A0F; text-align: center;
  padding: 60px 32px; flex-direction: column; align-items: center; justify-content: center;
}
@media (max-width: 900px) {
  .mobile-disclaimer { display: flex; }
}
.dropdown-menu {
  display: none; position: absolute; top: calc(100% + 6px); right: 0; z-index: 50;
  background: #14141a; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px;
  padding: 4px; min-width: 170px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.dropdown-menu.open { display: block; }
.dropdown-menu button {
  display: block; width: 100%; padding: 8px 14px; border: none; border-radius: 5px;
  background: transparent; color: #bbb; font-family: 'Outfit'; font-size: 12px;
  text-align: left; cursor: pointer; transition: all 0.15s;
}
.dropdown-menu button:hover { background: rgba(255,255,255,0.06); color: #fff; }
</style>
</head>
<body class="view-mode">

<div class="toolbar">
  <div class="toolbar-left">
    <button class="tb-btn" onclick="resetToDefault()" style="display:flex;align-items:center;gap:5px">‚ü≤ Reset to 2026</button>
    <div>
      <div class="toolbar-subtitle">ICCA REGION</div>
      <div class="toolbar-title">Assignment Editor</div>
    </div>
  </div>
  <div class="toolbar-right">
    <button class="tb-btn" onclick="addRegion()">+ Region</button>
    <button class="tb-btn" onclick="addQF()">+ Quarterfinal</button>
    <button class="tb-btn" onclick="addGroup()">+ Group</button>
    <span class="tb-sep"></span>
    <button class="tb-btn" onclick="undoAction()">‚Ü© Undo</button>
    <button class="tb-btn primary" id="view-toggle" onclick="toggleViewMode()">‚úé Edit</button>
    <div class="dropdown-wrap">
      <button class="tb-btn primary" onclick="toggleDropdown()">Import / Export ‚ñæ</button>
      <div class="dropdown-menu" id="json-dropdown">
        <button onclick="exportJSON();toggleDropdown()">‚Üì Export Config (JSON)</button>
        <button onclick="importJSON();toggleDropdown()">‚Üë Import Config (JSON)</button>
        <button onclick="exportGroupsCSV();toggleDropdown()">‚Üì Export Groups (CSV)</button>
        <button onclick="importGroupsCSV();toggleDropdown()">‚Üë Import Groups (CSV)</button>
      </div>
    </div>
    <input type="file" id="file-import" accept=".json" style="display:none" onchange="handleImport(event)">
  </div>
</div>

<div class="main">
  <div class="editor">
    <div class="editor-header">
      <span class="editor-title">Structure</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="tb-btn" style="padding:3px 8px;font-size:10px" onclick="expandAll()" title="Expand all">‚ñº</button>
        <button class="tb-btn" style="padding:3px 8px;font-size:10px" onclick="collapseAll()" title="Collapse all">‚ñ≤</button>
        <span class="editor-stats" id="editor-stats"></span>
      </div>
    </div>
    <div class="editor-body" id="editor-body"></div>
  </div>

  <div class="map-area" id="map-area">
    <div class="map-bg"></div>
    <div id="map-container"></div>
    <div class="lasso-rect" id="lasso-rect"></div>
    <div class="lasso-hint" id="lasso-hint">shift + drag to select schools</div>
    <div class="map-stats" id="map-stats"></div>
    <div id="venue-popup" class="venue-popup" style="display:none"></div>
    <div id="group-tooltip" class="group-tooltip"></div>
    <div class="tooltip-box" id="tooltip">
      <div class="tt-school" id="tt-school"></div>
      <div class="tt-region" id="tt-region"></div>
      <div class="tt-groups" id="tt-groups"></div>
    </div>
    <div class="map-legend" id="map-legend"></div>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()">+</button>
      <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
      <button class="zoom-btn" onclick="resetZoom()">‚ü≤</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal"></div>
</div>

<div class="mobile-disclaimer" id="mobile-disclaimer">
  <div style="font-size:32px;margin-bottom:12px">üñ•Ô∏è</div>
  <div style="font-size:15px;font-weight:700;margin-bottom:6px">Desktop Recommended</div>
  <div style="font-size:12px;color:#888;line-height:1.5">The Region Editor uses drag‚Äëand‚Äëdrop, lasso selection, and detailed modals that work best on a larger screen.</div>
  <a href="icca-2026-map.html" class="tb-btn" style="margin-top:16px;display:inline-block">‚Üê View the 2026 Map instead</a>
  <button class="tb-btn" style="margin-top:8px;display:block;width:100%;color:#555" onclick="document.getElementById('mobile-disclaimer').style.display='none'">Continue anyway</button>
</div>

<script>
const REGIONS = {
  Central: {
    color: "#D4A030", accent: "#F0C75E",
    schools: ["Cornell University","Lehigh University","Binghamton University","Ithaca College","Syracuse University","University of Waterloo","Western University","McMaster University","Toronto Metropolitan University","University of Toronto","Rochester Institute of Technology","Queen's University","Nazareth University","SUNY Fredonia","Wilfrid Laurier University","Monroe Community College","University of Rochester","University of Pittsburgh","Carnegie Mellon University","Penn State University","Millersville University","Indiana University of Pennsylvania","Duquesne University"],
    quarterfinals: [
      {date:"Jan 31",location:"Binghamton University, NY",lat:42.09,lng:-75.97,groups:["The Chordials","The Class Notes","Echoes","The Harpur Harpeggios","Ithacappella","Off the Record","Otto Tunes","Rhythm Method","Tone Cold","Voicestream"]},
      {date:"Feb 7",location:"University of Waterloo",lat:43.47,lng:-80.54,groups:["The AcaBellas","Equivox","The MacaFellas","Macappella","On That Note","PitchSlapped","RESONATE","Tunes. Beats. Awesome.","The Unaccompanied Minors","The Water Boys"]},
      {date:"Feb 14",location:"Rochester, NY",lat:43.13,lng:-77.63,groups:["The Brick City Singers","The Caledonias","Call4Backup","Dynamic Intonation","Encore","Hawkapella","Tributones","Vocal Accent","Vocal Point","YellowJackets"]},
      {date:"Feb 21",location:"Pittsburgh, PA",lat:40.44,lng:-79.96,groups:["C Flat Run","C Sharp Singers","Counterpoint","The Originals","Pitches & Tones","The Pitt Pendulums","Sargam","The Songburghs","Sounds Like Treble","The Treblemakers"]},
      {date:"Feb 28",location:"Penn State University, PA",lat:40.80,lng:-77.86,groups:["A Whole Step Up","Chromatic","The Coda Conduct","Crimson Chords","Fanaa","The Melismatics","Mic Drop","None of the Above","The Statesmen","VilleHarmonics"]},
    ],
    semifinal:{date:"Mar 21",location:"University at Buffalo",lat:42.95,lng:-78.82},
  },
  "Great Lakes": {
    color: "#457B9D", accent: "#6BAED6",
    schools: ["Eastern Illinois University","University of Chicago","North Central College","University of Wisconsin - Madison","Columbia College Chicago","University of Illinois Urbana-Champaign","University of Wisconsin - Parkside","Northwestern University","University of Minnesota","University of Wisconsin - Stevens Point","Marquette University","University of Wisconsin - Eau Claire","Loyola University - Chicago","Grand Valley State University","University of Michigan","Oakland University","Wayne State University","Central Michigan University","Michigan State University","Macomb Community College","Western Michigan University","Illinois State University","Northern Illinois University","University of Illinois","University Of Wisconsin - Milwaukee"],
    quarterfinals: [
      {date:"Feb 7",location:"University of Chicago",lat:41.79,lng:-87.60,groups:["Blue Fusion","Cadenza","Final Cut","Fundamentally Sound","Horizon","Illini Awaaz","Parkside Range","The Ransom Notes","Sonata Problem","Undertones"]},
      {date:"Feb 14",location:"University of Wisconsin",lat:43.08,lng:-89.41,groups:["7Days","CounterPoint","The Enchantments","Gold 'n Blues","Impromptu","The Naturals","Pitches & Notes","Under A-Rest","Urban Sound","Vocal U"]},
      {date:"Feb 21",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["Counterpoint","Euphoria","Gimble","Gold Vibrations","Maize Mirchi","Melodytroit","On The Rox","Sopranos","State of Fifths","The Treblemakers"]},
      {date:"Feb 22",location:"University of Michigan",lat:42.28,lng:-83.74,groups:["58 Greene","The Accafellas","Amazin' Blue","Capital Green","DJs","The Expressions","The G-Men","The Harmonettes","Ladies First","Radio Treble"]},
      {date:"Feb 28",location:"Illinois State University",lat:40.51,lng:-88.99,groups:["The Acafellaz","Clef Hangers","The Harmelodics","No Comment","No Strings Attached","On the Brink of Normal","Public Hearing","The Rip Chords","Secondary Dominance","The Xtension Chords"]},
    ],
    semifinal:{date:"Mar 28",location:"Pabst Theater",lat:43.04,lng:-87.92},
  },
  "Mid-Atlantic": {
    color: "#2A9D8F", accent: "#4ECDC4",
    schools: ["Rutgers University","University of Maryland","Westminster Choir College","Rowan University","The College of New Jersey","Drexel University","Temple University","University of Maryland Eastern Shore","University of Pennsylvania","Georgetown University","Villanova University","Johns Hopkins University","University of Maryland Baltimore County","George Washington University","Towson University","Salisbury University","Southern Virginia University","Christopher Newport University","Washington and Lee University","James Madison University","William & Mary","George Mason University","Virginia Commonwealth University","Lafayette College","University of Delaware","West Chester University","Stockton University"],
    quarterfinals: [
      {date:"Jan 31",location:"The College of New Jersey",lat:40.27,lng:-74.78,groups:["Casual Harmony","DaCadence","The Deaftones","The OrphanSporks","Profecy","RAAG","Rowan Vocals","ShockWave","The Trentones"]},
      {date:"Feb 14",location:"Drexel University",lat:39.96,lng:-75.19,groups:["The Cleftomaniacs","Faux Paz","LiaChorus","The Muses","Owlcappella","Penny Loafers","Pitch, Please","Superfood","The Supernovas","The TrebleMakers"]},
      {date:"Feb 21",location:"Towson University",lat:39.39,lng:-76.61,groups:["The AllNighters","Cleftomaniacs","The GW Vibes","The Notes of Ranvier","Off Track","Sons of Pitch","Squawkappella","The Stilettos","UNTITLED","The Vocal Chords"]},
      {date:"Feb 28",location:"Oakton High School, Vienna, VA",lat:38.89,lng:-77.26,groups:["Accolade","Extreme Measures","General Admission","Low Key","No Ceiling","Noteworthy","Purple Reign","The Ramifications","Take Note","University Sounds"]},
      {date:"Feb 28",location:"West Chester University",lat:39.95,lng:-75.60,groups:["Cadence","The Chorduroys","The Golden Blues","High Street Harmonix","The Mar-Keys","The MelUDees","Soulfege","Stockapella","Under A Rest","Vocal Point"]},
    ],
    semifinal:{date:"Mar 21",location:"The Grand, Wilmington, DE",lat:39.75,lng:-75.55},
  },
  Midwest: {
    color: "#F4A261", accent: "#FFD166",
    schools: ["Purdue University","Bowling Green State University","Washington University in St. Louis","University of Dayton","Indiana University","Miami University","Indiana University Indianapolis","Kent State University","University of Cincinnati","Saint Louis University","University of Notre Dame","University of Missouri","Missouri University of Science and Technology","Missouri State University","Iowa State University","University of Kansas","Murray State University","Truman State University","Case Western Reserve University","The Ohio State University","Baldwin Wallace University","University of Kentucky","Ohio University","The University of Akron"],
    quarterfinals: [
      {date:"Jan 24",location:"Indianapolis, IN",lat:39.77,lng:-86.16,groups:["Acabellas","AcousChicks","After Dark","Audio Pilots","The Bloomingtones","Just Duet","On A Side Note","Resting Pitch Face","Soundtracks","Vocal Intensity"]},
      {date:"Jan 31",location:"Washington University in St. Louis",lat:38.65,lng:-90.31,groups:["Avocalypse","The Bare Naked Statues","Beyond All Reason","Decadence","The Echoes","Forte","Miner Key","The Naturelles","The Sensasians","The Vocaholics"]},
      {date:"Feb 14",location:"Missouri State University",lat:37.21,lng:-93.28,groups:["A Cub Bella","Astha","The Beartones","Count Me In","Crimson and Blues","EQ Blu","The Hibernotes","Mezzo Forte","Minor Detail","Reverb"]},
      {date:"Feb 21",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["Case in Point","The Flying Solos","Remedy","Retrograde","Scarlet and Grace Notes","S≈åL","Ten40!","The Ohio State of Mind","Tonal Eclipse","Underscore"]},
      {date:"Feb 28",location:"Hilliard Bradley HS, OH",lat:40.03,lng:-83.16,groups:["AcoUstiKats","Buck That!","Cosmos","Dhamakapella","Dynamics","Majors & minors","New Chords on the Block","Rhythm & Roos","Sound of Science","The Tempo Tantrums"]},
    ],
    semifinal:{date:"Mar 14",location:"Indianapolis, IN",lat:39.77,lng:-86.16},
  },
  Northeast: {
    color: "#9B5DE5", accent: "#C77DFF",
    schools: ["SUNY Potsdam","University of Massachusetts Amherst","University at Albany","Rensselaer Polytechnic Institute","SUNY New Paltz","University of Vermont","Emerson College","Boston University","Worcester Polytechnic Institute","Northeastern University","Boston College","Brown University","The Colleges of Fenway","Wesleyan University","The New School","Bryant University","Marist University","Bentley University","Berklee College of Music","University of Connecticut","Eastern Connecticut State University","Fordham University","University of Hartford","Hunter College","Roger Williams University","Quinnipiac University","New York University","Columbia University","Pace University","Hofstra University"],
    quarterfinals: [
      {date:"Jan 24",location:"Rensselaer Polytechnic Institute",lat:42.73,lng:-73.68,groups:["A Sharp Arrangement","Duly Noted","Pitch Please","The Potsdam Pitches","The Potsdam Pointercounts","The Rusty Pipes","S#arp Attitude","The Sexy Pitches","Stay Tuned","Viridescent"]},
      {date:"Feb 14",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["Acappellics","Allegrettos","Audiophiles","Distilled Harmony","Dynamics","The Jabberwocks","The Sirens","Treble on Huntington","Triple Major","Unjust Intonation"]},
      {date:"Feb 15",location:"Berklee College of Music",lat:42.35,lng:-71.09,groups:["The Bostonians","The Bottom Line","The Enharmonics","The Nor'easters","Off The Clock","The Ramifications","Treble Threat","Treblemakers","The Unisons","Upper Structure"]},
      {date:"Mar 7",location:"University of Hartford",lat:41.80,lng:-72.72,groups:["A Minor","East Harmonies","The F Sharps","The Fordham Ramblers","HartAttack","Hawkappella","Hawkward","L'Shir","The Legends","The Vocaholics"]},
      {date:"Mar 7",location:"NY Society for Ethical Culture",lat:40.77,lng:-73.97,groups:["The Clefhangers","The Cleftomaniacs","Frequency","The Hofbeats","Makin' Treble","The Mixtapes","N'Harmonics","Sigma'cappella","Tonal Recall","Vocollision"]},
    ],
    semifinal:{date:"Mar 28",location:"Berklee College of Music",lat:42.35,lng:-71.09},
  },
  South: {
    color: "#E76F51", accent: "#FF9F7F",
    schools: ["North Carolina State University","University of Mount Olive","University of South Carolina","University of Georgia","Georgia Institute of Technology","High Point University","University of North Carolina at Chapel Hill","University of Florida","University of Miami","University of Central Florida","Florida International University","University of South Florida","East Tennessee State University","Belmont University","University of Tennessee","Vanderbilt University","Emory University","University of North Carolina At Greensboro","Wake Forest University","Appalachian State University","Duke University","Florida State University","Pearl River Community College","East Central Community College","University of Southern Mississippi","Mississippi State University","University of Alabama"],
    quarterfinals: [
      {date:"Jan 24",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Acappology","Carolina Sound","Chordination","Cockappella","Noteworthy","Nothin' But Treble","Offbeats","Tar Heel Voices"]},
      {date:"Jan 31",location:"Trinity Prep HS, Orlando, FL",lat:28.54,lng:-81.38,groups:["Accent","BisCaydence","Gemini Boulevard","HEARTbeats","KeyHarmony","Mixed Mode","The Sedoctaves","Tone Definition","Tones of Gold","Tufaan"]},
      {date:"Feb 7",location:"University of Tennessee",lat:35.95,lng:-83.93,groups:["Ascension","The Belles","The Beltones","Harmonium","Intonations","Prismatics","reVOLution","Spectrum","VOLT"]},
      {date:"Feb 21",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90,groups:["Aural Pleasure","The Chariots","Demon Divas","Ear Candy","Grains of Time","Harmonic Notion","Ladies In Red","Rhythm & Blue","VoiceMale","Wolfgang"]},
      {date:"Mar 7",location:"IMPAC, Biloxi, MS",lat:30.40,lng:-88.89,groups:["AcaBelles","All-Night Yahtzee","Currents","Dooley Noted","EC Listening","Reverb","Spirit of Southern","TrebullDawgs","Tune In","The Voices"]},
    ],
    semifinal:{date:"Mar 28",location:"Carolina Theater, Durham, NC",lat:35.99,lng:-78.90},
  },
  Southwest: {
    color: "#D62828", accent: "#FF4D4D",
    schools: ["University of Texas at Austin","Texas Tech University","University of Houston","Texas A&M University","University of Texas at Dallas","Dallas-Fort Worth","University of Texas at Arlington","Baylor University","University of Nebraska","University of Denver","University of Colorado Boulder","Colorado State University","Oklahoma City University","University of California, San Diego","University of California, Irvine","San Diego State University","University of Arizona","Northern Arizona University","Grand Canyon University","Arizona State University","The Claremont Colleges","Mt. San Antonio College"],
    quarterfinals: [
      {date:"Jan 31",location:"MacArthur High School",lat:29.55,lng:-98.37,groups:["Beauties and the Beat","Empire","Final Measure","HardChord DynaMix","Noteworthy","Novis","RISE","Star Struck","Trillium","VirtuOSO"]},
      {date:"Feb 7",location:"Rococo Theatre, Lincoln, NE",lat:40.81,lng:-96.70,groups:["The Bathtub Dogs","Boots & Cats","Exit 205","Extreme Measures","Mainstreet","Pitch Please","The Red Keys","Take Note","Tonal Eclipse"]},
      {date:"Feb 7",location:"UC San Diego",lat:32.88,lng:-117.23,groups:["Acamazing","Clair de Lune","The Daughters of Triton","Morse Coda","NOVA","Sitaare","SoundWave","The Trebles","The Tritones","Vermillion Vocalists"]},
      {date:"Feb 21",location:"Scottsdale, AZ",lat:33.49,lng:-111.93,groups:["Amplified","The Axecidentals","Canyon Crescendos","Devil Clefs","Enharmonics","Meow or Never","Noteriety","The Pitchforks","Priority Male","The TEMPEtations"]},
      {date:"Feb 28",location:"Claremont University, CA",lat:34.10,lng:-117.71,groups:["Aerodynamix","Claremont Shades","Earth Tones","Elevation","Haath","The Highlanders","Midnight Echo","Nu Aria","Uniting Voices","VocaLotus"]},
    ],
    semifinal:{date:"Mar 15",location:"Scottsdale, AZ",lat:33.49,lng:-111.93},
  },
  West: {
    color: "#264653", accent: "#4A8FA8",
    schools: ["University of Washington","Gonzaga University","University of British Columbia","University of British Columbia, Okanagan","Western Washington University","Oregon State University","Southern Oregon University","Portland State University","Willamette University","University of Oregon","Montana State University","University of Utah","University of California, Los Angeles","Chapman University","California State University, Fullerton","Moorpark College","University of California, Santa Barbara","University of Southern California","California State University, Northridge","University of California, Santa Cruz","University of California, Davis","UC Berkeley","Stanford University","Diablo Valley College","San Jose State University"],
    quarterfinals: [
      {date:"Jan 24",location:"Tacoma Armory",lat:47.25,lng:-122.44,groups:["Awaaz","Big Bing Theory","Eh? Cappella","For Good Measure","Furmata","The Northwest Collective","Pacific Note West","Trebled Acaholics","The Trill Seekers"]},
      {date:"Jan 31",location:"The Elsinore Theatre",lat:44.94,lng:-123.04,groups:["Divine","Dulcet","The Green Note","Headband","Mind the Gap","Power Chord","Rhapsody","Salt Flats","Tandem","Up Top"]},
      {date:"Jan 31",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Bruin Harmony","Chapman SoundCheck","The Dissonants","The FullerTones","MoorHarmony","Naked Voices","Naya Zamaana","Reverse Osmosis","ScatterTones"]},
      {date:"Feb 21",location:"Downey Theater",lat:33.94,lng:-118.13,groups:["Acasola","Awaken","The ChapTones","Cloud 9","Pitch, Please!","Random Voices","Resonance","Simply Vocale","Vocal Percussion Radio (VPR)"]},
      {date:"Feb 28",location:"Fox Theatre",lat:38.58,lng:-121.50,groups:["The Cleftomaniacs","Drawn to Scale","The Golden Overtones","Jhankaar","The Liquid Hotplates","The Lounge Lizards","The Mendicants","The pH Scale","The Spartones","The Spokes"]},
    ],
    semifinal:{date:"Mar 21",location:"Fox Theatre",lat:38.58,lng:-121.50},
  }
};

const QF_SCHOOLS = {"Central-0": ["Ithaca College", "Binghamton University", "Syracuse University", "Cornell University", "Lehigh University"], "Central-1": ["Toronto Metropolitan University", "University of Waterloo", "Western University", "University of Toronto", "McMaster University"], "Central-2": ["Queen's University", "Rochester Institute of Technology", "Nazareth University", "Wilfrid Laurier University", "University of Rochester", "Monroe Community College", "SUNY Fredonia"], "Central-3": ["University of Pittsburgh", "Carnegie Mellon University"], "Central-4": ["Penn State University", "Duquesne University", "Millersville University", "Indiana University of Pennsylvania", "Lehigh University"], "Great Lakes-0": ["Columbia College Chicago", "Northwestern University", "Eastern Illinois University", "University of Wisconsin - Parkside", "University of Illinois Urbana-Champaign", "University of Chicago", "University of Wisconsin - Madison", "North Central College"], "Great Lakes-1": ["University of Wisconsin - Stevens Point", "Marquette University", "University of Minnesota", "University of Wisconsin - Eau Claire", "University of Wisconsin - Madison"], "Great Lakes-2": ["Northwestern University", "Loyola University - Chicago", "Central Michigan University", "Wayne State University", "Michigan State University", "Grand Valley State University", "Oakland University", "University of Michigan"], "Great Lakes-3": ["Western Michigan University", "University of Michigan - Ann Arbor", "Macomb Community College", "Michigan State University", "University of Michigan"], "Great Lakes-4": ["Illinois State University", "University Of Wisconsin - Milwaukee", "University of Illinois", "Northern Illinois University"], "Mid-Atlantic-0": ["University of Maryland", "The College of New Jersey", "Rowan University", "Rutgers University", "Westminster Choir College"], "Mid-Atlantic-1": ["University of Maryland Eastern Shore", "University of Maryland", "Villanova University", "University of Pennsylvania", "Drexel University", "Georgetown University", "Temple University"], "Mid-Atlantic-2": ["Towson University", "University of Maryland Baltimore County", "George Washington University", "Salisbury University", "Johns Hopkins University"], "Mid-Atlantic-3": ["Southern Virginia University", "Virginia Commonwealth University", "George Mason University", "William & Mary", "James Madison University", "Christopher Newport University", "Washington and Lee University"], "Mid-Atlantic-4": ["University of Delaware", "Lafayette College", "West Chester University", "Stockton University"], "Midwest-0": ["Kent State University", "Indiana University Indianapolis", "Purdue University", "Bowling Green State University", "Miami University", "Indiana University", "Washington University in St. Louis", "University of Dayton"], "Midwest-1": ["University of Notre Dame", "Saint Louis University", "Missouri University of Science and Technology", "University of Missouri", "University of Cincinnati", "Washington University in St. Louis"], "Midwest-2": ["University of Kansas", "Saint Louis University", "Iowa State University", "Missouri State University", "Truman State University", "Murray State University", "Washington University in St. Louis"], "Midwest-3": ["Case Western Reserve University", "The Ohio State University", "Bowling Green State University", "University of Dayton", "Baldwin Wallace University"], "Midwest-4": ["Case Western Reserve University", "Ohio University", "University of Kentucky", "The Ohio State University", "The University of Akron", "Baldwin Wallace University"], "Northeast-0": ["University of Vermont", "SUNY Potsdam", "SUNY New Paltz", "Rensselaer Polytechnic Institute", "University at Albany", "University of Massachusetts Amherst"], "Northeast-1": ["Boston University", "The Colleges of Fenway", "The New School", "Northeastern University", "Wesleyan University", "Emerson College", "Boston College", "Brown University", "Worcester Polytechnic Institute"], "Northeast-2": ["Boston University", "Berklee College of Music", "Suffolk University", "Bryant University", "Northeastern University", "Boston College", "Marist University", "Bentley University"], "Northeast-3": ["University of Hartford", "Hunter College", "Roger Williams University", "Fordham University", "University of Connecticut", "Eastern Connecticut State University", "Quinnipiac University", "New York University"], "Northeast-4": ["Pace University", "Hofstra University", "Columbia University", "New York University"], "South-0": ["University of Mount Olive", "North Carolina State University", "University of Georgia", "Georgia Institute of Technology", "University of North Carolina at Chapel Hill", "University of South Carolina", "High Point University"], "South-1": ["Florida International University", "University of Miami", "University of Central Florida", "University of Florida", "University of South Florida"], "South-2": ["Belmont University", "East Tennessee State University", "University of Tennessee", "Vanderbilt University"], "South-3": ["Vanderbilt University", "North Carolina State University", "Wake Forest University", "Emory University", "Appalachian State University", "Duke University", "University of North Carolina At Greensboro"], "South-4": ["University of Southern Mississippi", "Pearl River Community College", "Florida State University", "Mississippi State University", "East Central Community College", "University of Alabama", "Emory University"], "Southwest-0": ["University of Houston", "Baylor University", "Texas A&M University", "University of Texas at Arlington", "Texas Tech University", "University of Texas at Austin", "University of Texas at Dallas", "Dallas-Fort Worth"], "Southwest-1": ["University of Denver", "Colorado State University", "University of Nebraska", "Oklahoma City University", "University of Colorado Boulder"], "Southwest-2": ["University of California, San Diego", "University of California, Irvine", "San Diego State University"], "Southwest-3": ["Grand Canyon University", "Arizona State University", "Northern Arizona University", "University of Arizona"], "Southwest-4": ["Mt. San Antonio College", "The Claremont Colleges", "Northern Arizona University", "University of California, Irvine"], "United Kingdom-0": ["University of Cambridge", "University of Aberdeen", "University of St Andrews", "University of Stirling", "University of Edinburgh"], "United Kingdom-1": ["University of Warwick", "University of Nottingham", "University of Leeds", "University of Sheffield", "University of York", "University of Birmingham"], "United Kingdom-2": ["University of Bath", "University of Exeter", "University of Bristol", "Cardiff University", "Royal Welsh College of Music and Drama"], "United Kingdom-3": ["University of Warwick", "University of Oxford", "Cardiff University", "Lancaster University", "Newcastle University", "Durham University", "University of Manchester", "University of Birmingham"], "United Kingdom-4": ["University of Nottingham", "University College London", "King's College London", "Imperial College London", "London School of Economics", "University of Reading"], "West-0": ["University of British Columbia", "Gonzaga University", "Western Washington University", "University of Washington", "University of British Columbia, Okanagan"], "West-1": ["University of Utah", "Oregon State University", "Portland State University", "University of Oregon", "Southern Oregon University", "Montana State University", "Willamette University"], "West-2": ["University of Southern California", "Chapman University", "University of California, Santa Barbara", "University of California, Los Angeles", "California State University, Fullerton", "Moorpark College"], "West-3": ["Chapman University", "California State University, Northridge", "University of California, Los Angeles", "University of California, Santa Cruz"], "West-4": ["San Jose State University", "Diablo Valley College", "UC Berkeley", "Stanford University", "University of California, Davis"]};
const SCHOOL_COORDS = {
  "Cornell University":[42.45,-76.47],"Lehigh University":[40.61,-75.38],"Binghamton University":[42.09,-75.97],"Ithaca College":[42.42,-76.50],"Syracuse University":[43.04,-76.14],"University of Waterloo":[43.47,-80.54],"Western University":[43.01,-81.27],"McMaster University":[43.26,-79.92],"Toronto Metropolitan University":[43.66,-79.38],"University of Toronto":[43.66,-79.40],"Rochester Institute of Technology":[43.08,-77.67],"Queen's University":[44.23,-76.50],"Nazareth University":[43.10,-77.51],"SUNY Fredonia":[42.45,-79.33],"Wilfrid Laurier University":[43.47,-80.53],"Monroe Community College":[43.08,-77.62],"University of Rochester":[43.13,-77.63],"University of Pittsburgh":[40.44,-79.96],"Carnegie Mellon University":[40.44,-79.94],"Penn State University":[40.80,-77.86],"Millersville University":[39.99,-76.35],"Indiana University of Pennsylvania":[40.62,-79.15],"Duquesne University":[40.44,-79.99],
  "Eastern Illinois University":[39.48,-88.18],"University of Chicago":[41.79,-87.60],"North Central College":[41.77,-88.15],"University of Wisconsin - Madison":[43.08,-89.41],"Columbia College Chicago":[41.87,-87.62],"University of Illinois Urbana-Champaign":[40.10,-88.23],"University of Wisconsin - Parkside":[42.64,-87.85],"Northwestern University":[42.06,-87.68],"University of Minnesota":[44.97,-93.23],"University of Wisconsin - Stevens Point":[44.53,-89.57],"Marquette University":[43.04,-87.93],"University of Wisconsin - Eau Claire":[44.80,-91.50],"Loyola University - Chicago":[41.99,-87.66],"Grand Valley State University":[42.96,-85.89],"University of Michigan":[42.28,-83.74],"Oakland University":[42.67,-83.22],"Wayne State University":[42.36,-83.07],"Central Michigan University":[43.59,-84.77],"Michigan State University":[42.73,-84.48],"Macomb Community College":[42.67,-82.95],"Western Michigan University":[42.28,-85.61],"Illinois State University":[40.51,-88.99],"Northern Illinois University":[41.93,-88.77],"University of Illinois":[40.10,-88.23],"University Of Wisconsin - Milwaukee":[43.08,-87.88],
  "Rutgers University":[40.50,-74.45],"University of Maryland":[38.99,-76.94],"Westminster Choir College":[40.35,-74.66],"Rowan University":[39.71,-75.12],"The College of New Jersey":[40.27,-74.78],"Drexel University":[39.96,-75.19],"Temple University":[39.98,-75.16],"University of Maryland Eastern Shore":[38.39,-75.67],"University of Pennsylvania":[39.95,-75.19],"Georgetown University":[38.91,-77.07],"Villanova University":[40.04,-75.34],"Johns Hopkins University":[39.33,-76.62],"University of Maryland Baltimore County":[39.25,-76.71],"George Washington University":[38.90,-77.05],"Towson University":[39.39,-76.61],"Salisbury University":[38.37,-75.60],"Southern Virginia University":[37.78,-79.44],"Christopher Newport University":[37.06,-76.49],"Washington and Lee University":[37.79,-79.44],"James Madison University":[38.43,-78.87],"William & Mary":[37.27,-76.71],"George Mason University":[38.83,-77.31],"Virginia Commonwealth University":[37.55,-77.43],"Lafayette College":[40.70,-75.21],"University of Delaware":[39.68,-75.75],"West Chester University":[39.95,-75.60],"Stockton University":[39.48,-74.54],
  "Purdue University":[40.42,-86.92],"Bowling Green State University":[41.38,-83.64],"Washington University in St. Louis":[38.65,-90.31],"University of Dayton":[39.74,-84.18],"Indiana University":[39.17,-86.52],"Miami University":[39.51,-84.73],"Indiana University Indianapolis":[39.77,-86.17],"Kent State University":[41.15,-81.34],"University of Cincinnati":[39.13,-84.52],"Saint Louis University":[38.64,-90.23],"University of Notre Dame":[41.70,-86.24],"University of Missouri":[38.95,-92.33],"Missouri University of Science and Technology":[37.96,-91.77],"Missouri State University":[37.21,-93.28],"Iowa State University":[42.03,-93.65],"University of Kansas":[38.96,-95.24],"Murray State University":[36.62,-88.33],"Truman State University":[40.19,-92.58],"Case Western Reserve University":[41.50,-81.61],"The Ohio State University":[39.99,-83.01],"Baldwin Wallace University":[41.37,-81.85],"University of Kentucky":[38.04,-84.50],"Ohio University":[39.32,-82.10],"The University of Akron":[41.08,-81.51],
  "SUNY Potsdam":[44.67,-74.98],"University of Massachusetts Amherst":[42.39,-72.53],"University at Albany":[42.69,-73.82],"Rensselaer Polytechnic Institute":[42.73,-73.68],"SUNY New Paltz":[41.74,-74.09],"University of Vermont":[44.48,-73.20],"Emerson College":[42.35,-71.07],"Boston University":[42.35,-71.10],"Worcester Polytechnic Institute":[42.27,-71.81],"Northeastern University":[42.34,-71.09],"Boston College":[42.34,-71.17],"Brown University":[41.83,-71.40],"The Colleges of Fenway":[42.34,-71.10],"Wesleyan University":[41.56,-72.66],"The New School":[40.74,-73.99],"Bryant University":[41.87,-71.46],"Marist University":[41.72,-73.93],"Bentley University":[42.39,-71.22],"Berklee College of Music":[42.35,-71.09],"University of Connecticut":[41.81,-72.25],"Eastern Connecticut State University":[41.72,-72.23],"Fordham University":[40.86,-73.88],"University of Hartford":[41.80,-72.72],"Hunter College":[40.77,-73.96],"Roger Williams University":[41.64,-71.26],"Quinnipiac University":[41.42,-72.89],"New York University":[40.73,-73.99],"Columbia University":[40.81,-73.96],"Pace University":[40.71,-74.00],"Hofstra University":[40.72,-73.60],
  "North Carolina State University":[35.79,-78.68],"University of Mount Olive":[35.20,-78.07],"University of South Carolina":[33.99,-81.02],"University of Georgia":[33.95,-83.37],"Georgia Institute of Technology":[33.77,-84.40],"High Point University":[35.97,-80.01],"University of North Carolina at Chapel Hill":[35.91,-79.05],"University of Florida":[29.64,-82.35],"University of Miami":[25.72,-80.28],"University of Central Florida":[28.60,-81.20],"Florida International University":[25.76,-80.37],"University of South Florida":[28.06,-82.41],"East Tennessee State University":[36.30,-82.37],"Belmont University":[36.13,-86.79],"University of Tennessee":[35.95,-83.93],"Vanderbilt University":[36.15,-86.80],"Emory University":[33.79,-84.32],"University of North Carolina At Greensboro":[36.07,-79.81],"Wake Forest University":[36.13,-80.28],"Appalachian State University":[36.22,-81.69],"Duke University":[36.00,-78.94],"Florida State University":[30.44,-84.30],"Pearl River Community College":[30.77,-89.57],"East Central Community College":[32.35,-89.12],"University of Southern Mississippi":[31.33,-89.33],"Mississippi State University":[33.45,-88.79],"University of Alabama":[33.21,-87.54],
  "University of Texas at Austin":[30.28,-97.74],"Texas Tech University":[33.58,-101.85],"University of Houston":[29.72,-95.34],"Texas A&M University":[30.62,-96.34],"University of Texas at Dallas":[32.99,-96.75],"Dallas-Fort Worth":[32.78,-96.80],"University of Texas at Arlington":[32.73,-97.11],"Baylor University":[31.55,-97.12],"University of Nebraska":[40.82,-96.70],"University of Denver":[39.68,-104.96],"University of Colorado Boulder":[40.01,-105.27],"Colorado State University":[40.57,-105.08],"Oklahoma City University":[35.47,-97.52],"University of California, San Diego":[32.88,-117.23],"University of California, Irvine":[33.64,-117.84],"San Diego State University":[32.77,-117.07],"University of Arizona":[32.23,-110.95],"Northern Arizona University":[35.19,-111.65],"Grand Canyon University":[33.51,-112.13],"Arizona State University":[33.42,-111.93],"The Claremont Colleges":[34.10,-117.71],"Mt. San Antonio College":[34.05,-117.84],
  "University of Washington":[47.65,-122.30],"Gonzaga University":[47.67,-117.40],"University of British Columbia":[49.26,-123.25],"University of British Columbia, Okanagan":[49.94,-119.40],"Western Washington University":[48.73,-122.49],"Oregon State University":[44.56,-123.28],"Southern Oregon University":[42.34,-122.71],"Portland State University":[45.51,-122.68],"Willamette University":[44.94,-123.03],"University of Oregon":[44.04,-123.07],"Montana State University":[45.67,-111.05],"University of Utah":[40.76,-111.84],"University of California, Los Angeles":[34.07,-118.44],"Chapman University":[33.79,-117.85],"California State University, Fullerton":[33.88,-117.89],"Moorpark College":[34.28,-118.88],"University of California, Santa Barbara":[34.41,-119.85],"University of Southern California":[34.02,-118.29],"California State University, Northridge":[34.24,-118.53],"University of California, Santa Cruz":[36.99,-122.06],"University of California, Davis":[38.54,-121.76],"UC Berkeley":[37.87,-122.26],"Stanford University":[37.43,-122.17],"Diablo Valley College":[37.95,-122.06],"San Jose State University":[37.34,-121.88],
};

const SCHOOL_GROUPS = {"Cornell University": ["The Chordials", "The Class Notes"], "Lehigh University": ["Echoes", "Off the Record", "A Whole Step Up", "The Melismatics"], "Binghamton University": ["The Harpur Harpeggios", "Rhythm Method"], "Ithaca College": ["Ithacappella", "Tone Cold", "Voicestream"], "Syracuse University": ["Otto Tunes"], "University of Waterloo": ["The AcaBellas", "The Unaccompanied Minors", "The Water Boys"], "Western University": ["Equivox"], "McMaster University": ["The MacaFellas", "Macappella", "PitchSlapped"], "Toronto Metropolitan University": ["On That Note", "RESONATE"], "University of Toronto": ["Tunes. Beats. Awesome."], "Rochester Institute of Technology": ["The Brick City Singers", "Encore", "Vocal Accent"], "Queen's University": ["The Caledonias"], "Nazareth University": ["Call4Backup"], "SUNY Fredonia": ["Dynamic Intonation"], "Wilfrid Laurier University": ["Hawkapella"], "Monroe Community College": ["Tributones"], "University of Rochester": ["Vocal Point", "YellowJackets"], "University of Pittsburgh": ["C Flat Run", "Pitches & Tones", "The Pitt Pendulums", "Sargam", "The Songburghs", "Sounds Like Treble"], "Carnegie Mellon University": ["C Sharp Singers", "Counterpoint", "The Originals", "The Treblemakers"], "Millersville University": ["Chromatic", "VilleHarmonics"], "Penn State University": ["The Coda Conduct", "Fanaa", "None of the Above", "The Statesmen"], "Indiana University of Pennsylvania": ["Crimson Chords"], "Duquesne University": ["Mic Drop"], "Eastern Illinois University": ["Blue Fusion"], "University of Chicago": ["Cadenza", "The Ransom Notes"], "North Central College": ["Final Cut", "Sonata Problem"], "University of Wisconsin - Madison": ["Fundamentally Sound", "Pitches & Notes", "Under A-Rest"], "Columbia College Chicago": ["Horizon"], "University of Illinois Urbana-Champaign": ["Illini Awaaz"], "University of Wisconsin - Parkside": ["Parkside Range"], "Northwestern University": ["Undertones", "The Treblemakers"], "University of Minnesota": ["7Days", "The Enchantments", "Urban Sound", "Vocal U"], "University of Wisconsin - Stevens Point": ["CounterPoint"], "Marquette University": ["Gold 'n Blues", "The Naturals"], "University of Wisconsin - Eau Claire": ["Impromptu"], "Loyola University - Chicago": ["Counterpoint"], "Grand Valley State University": ["Euphoria"], "University of Michigan": ["Gimble", "Maize Mirchi", "Sopranos", "58 Greene", "DJs", "The G-Men", "The Harmonettes"], "Oakland University": ["Gold Vibrations"], "Wayne State University": ["Melodytroit"], "Central Michigan University": ["On The Rox"], "Michigan State University": ["State of Fifths", "The Accafellas", "Capital Green", "Ladies First"], "University of Michigan - Ann Arbor": ["Amazin' Blue"], "Macomb Community College": ["The Expressions"], "Western Michigan University": ["Radio Treble"], "Illinois State University": ["The Acafellaz", "Clef Hangers", "On the Brink of Normal", "Secondary Dominance"], "Northern Illinois University": ["The Harmelodics"], "University of Illinois": ["No Comment", "No Strings Attached", "The Rip Chords", "The Xtension Chords"], "University Of Wisconsin - Milwaukee": ["Public Hearing"], "Rutgers University": ["Casual Harmony", "The OrphanSporks", "RAAG", "ShockWave"], "University of Maryland": ["DaCadence", "Faux Paz"], "Westminster Choir College": ["The Deaftones"], "Rowan University": ["Profecy", "Rowan Vocals"], "The College of New Jersey": ["The Trentones"], "Drexel University": ["The Cleftomaniacs", "The TrebleMakers"], "Temple University": ["LiaChorus", "Owlcappella", "Pitch, Please"], "University of Maryland Eastern Shore": ["The Muses"], "University of Pennsylvania": ["Penny Loafers"], "Georgetown University": ["Superfood"], "Villanova University": ["The Supernovas"], "Johns Hopkins University": ["The AllNighters", "The Notes of Ranvier", "The Vocal Chords"], "University of Maryland Baltimore County": ["Cleftomaniacs", "The Stilettos"], "George Washington University": ["The GW Vibes", "Sons of Pitch"], "Towson University": ["Off Track", "UNTITLED"], "Salisbury University": ["Squawkappella"], "Southern Virginia University": ["Accolade"], "Christopher Newport University": ["Extreme Measures", "Take Note", "University Sounds"], "Washington and Lee University": ["General Admission"], "James Madison University": ["Low Key", "Purple Reign"], "William & Mary": ["No Ceiling"], "George Mason University": ["Noteworthy"], "Virginia Commonwealth University": ["The Ramifications"], "Lafayette College": ["Cadence", "The Chorduroys", "The Mar-Keys", "Soulfege"], "University of Delaware": ["The Golden Blues", "The MelUDees", "Vocal Point"], "West Chester University": ["High Street Harmonix", "Under A Rest"], "Stockton University": ["Stockapella"], "Purdue University": ["Acabellas", "Soundtracks"], "Bowling Green State University": ["AcousChicks", "Retrograde", "Ten40!", "Tonal Eclipse"], "Washington University in St. Louis": ["After Dark", "The Sensasians", "Reverb"], "University of Dayton": ["Audio Pilots", "The Flying Solos", "Remedy", "Underscore"], "Indiana University": ["The Bloomingtones", "Resting Pitch Face"], "Miami University": ["Just Duet"], "Indiana University Indianapolis": ["On A Side Note"], "Kent State University": ["Vocal Intensity"], "University of Cincinnati": ["Avocalypse", "The Vocaholics"], "Saint Louis University": ["The Bare Naked Statues", "Beyond All Reason", "Decadence", "Astha"], "University of Notre Dame": ["The Echoes"], "University of Missouri": ["Forte", "The Naturelles"], "Missouri University of Science and Technology": ["Miner Key"], "Missouri State University": ["A Cub Bella", "The Beartones", "The Hibernotes"], "Iowa State University": ["Count Me In", "Mezzo Forte"], "University of Kansas": ["Crimson and Blues"], "Murray State University": ["EQ Blu"], "Truman State University": ["Minor Detail"], "Case Western Reserve University": ["Case in Point", "Dhamakapella"], "The Ohio State University": ["Scarlet and Grace Notes", "The Ohio State of Mind", "Buck That!", "Majors & minors", "Sound of Science"], "Baldwin Wallace University": ["S\u014cL", "Cosmos"], "University of Kentucky": ["AcoUstiKats"], "Ohio University": ["Dynamics", "New Chords on the Block", "The Tempo Tantrums"], "The University of Akron": ["Rhythm & Roos"], "SUNY Potsdam": ["A Sharp Arrangement", "The Potsdam Pitches", "The Potsdam Pointercounts", "Stay Tuned"], "University of Massachusetts Amherst": ["Duly Noted", "S#arp Attitude"], "University at Albany": ["Pitch Please"], "Rensselaer Polytechnic Institute": ["The Rusty Pipes"], "SUNY New Paltz": ["The Sexy Pitches"], "University of Vermont": ["Viridescent"], "Emerson College": ["Acappellics"], "Boston University": ["Allegrettos", "Treblemakers"], "Worcester Polytechnic Institute": ["Audiophiles"], "Northeastern University": ["Distilled Harmony", "Treble on Huntington", "The Nor'easters", "The Unisons"], "Boston College": ["Dynamics", "The Bostonians"], "Brown University": ["The Jabberwocks"], "The Colleges of Fenway": ["The Sirens"], "Wesleyan University": ["Triple Major"], "The New School": ["Unjust Intonation"], "Bryant University": ["The Bottom Line"], "Marist University": ["The Enharmonics"], "Bentley University": ["Off The Clock"], "Suffolk University": ["The Ramifications"], "Berklee College of Music": ["Treble Threat", "Upper Structure"], "University of Connecticut": ["A Minor"], "Eastern Connecticut State University": ["East Harmonies"], "Fordham University": ["The F Sharps", "The Fordham Ramblers"], "University of Hartford": ["HartAttack", "L'Shir"], "Hunter College": ["Hawkappella"], "Roger Williams University": ["Hawkward"], "Quinnipiac University": ["The Legends"], "New York University": ["The Vocaholics", "The Cleftomaniacs", "The Mixtapes", "N'Harmonics", "Vocollision"], "Columbia University": ["The Clefhangers"], "Pace University": ["Frequency", "Tonal Recall"], "Hofstra University": ["The Hofbeats", "Makin' Treble", "Sigma'cappella"], "North Carolina State University": ["Acappology", "Chordination", "Grains of Time", "Ladies In Red", "Wolfgang"], "University of Mount Olive": ["Carolina Sound"], "University of South Carolina": ["Cockappella"], "University of Georgia": ["Noteworthy"], "Georgia Institute of Technology": ["Nothin' But Treble"], "High Point University": ["Offbeats"], "University of North Carolina at Chapel Hill": ["Tar Heel Voices"], "University of Florida": ["Accent", "The Sedoctaves", "Tone Definition"], "University of Miami": ["BisCaydence", "Tufaan"], "University of Central Florida": ["Gemini Boulevard", "KeyHarmony", "Mixed Mode"], "Florida International University": ["HEARTbeats"], "University of South Florida": ["Tones of Gold"], "East Tennessee State University": ["Ascension", "Harmonium"], "Belmont University": ["The Belles", "The Beltones", "Intonations", "Prismatics"], "University of Tennessee": ["reVOLution", "VOLT"], "Vanderbilt University": ["Spectrum", "Harmonic Notion"], "Emory University": ["Aural Pleasure", "Dooley Noted"], "University of North Carolina At Greensboro": ["The Chariots"], "Wake Forest University": ["Demon Divas"], "Appalachian State University": ["Ear Candy", "VoiceMale"], "Duke University": ["Rhythm & Blue"], "Florida State University": ["AcaBelles", "All-Night Yahtzee", "Reverb"], "Pearl River Community College": ["Currents", "The Voices"], "East Central Community College": ["EC Listening"], "University of Southern Mississippi": ["Spirit of Southern"], "Mississippi State University": ["TrebullDawgs"], "University of Alabama": ["Tune In"], "University of Texas at Austin": ["Beauties and the Beat", "Noteworthy"], "Texas Tech University": ["Empire"], "University of Houston": ["Final Measure", "Star Struck"], "Texas A&M University": ["HardChord DynaMix"], "University of Texas at Dallas": ["Novis"], "Dallas-Fort Worth": ["Trillium"], "University of Texas at Arlington": ["RISE"], "Baylor University": ["VirtuOSO"], "University of Nebraska": ["The Bathtub Dogs", "Boots & Cats", "Pitch Please", "The Red Keys", "Take Note"], "University of Denver": ["Exit 205"], "University of Colorado Boulder": ["Extreme Measures"], "Colorado State University": ["Mainstreet"], "Oklahoma City University": ["Tonal Eclipse"], "University of California, San Diego": ["Acamazing", "The Daughters of Triton", "Sitaare", "The Trebles", "The Tritones"], "University of California, Irvine": ["Clair de Lune", "Morse Coda", "NOVA", "Vermillion Vocalists", "Aerodynamix", "Haath", "Uniting Voices", "VocaLotus"], "San Diego State University": ["SoundWave"], "University of Arizona": ["Amplified", "Enharmonics", "Meow or Never", "Noteriety"], "Northern Arizona University": ["The Axecidentals", "Elevation", "The Highlanders"], "Grand Canyon University": ["Canyon Crescendos"], "Arizona State University": ["Devil Clefs", "The Pitchforks", "Priority Male", "The TEMPEtations"], "The Claremont Colleges": ["Claremont Shades", "Earth Tones", "Midnight Echo"], "Mt. San Antonio College": ["Nu Aria"], "University of Aberdeen": ["Aberpella", "Killer Quines"], "University of St Andrews": ["The Accidentals", "The Alleycats", "The Hummingbirds"], "University of Cambridge": ["Cadenza"], "University of Edinburgh": ["Cloud IX", "Licence To Trill", "Tone Up"], "University of Stirling": ["Stirling Stellars"], "University of Birmingham": ["AbraCappella", "The Uptone Girls"], "University of Nottingham": ["Aca-Pocalypse", "Firecracappella", "RadioOctave", "Echotones"], "University of Warwick": ["The Leamingtones", "OffScore"], "University of Leeds": ["The Songsmiths"], "University of Sheffield": ["Steelworks"], "University of York": ["VOX"], "University of Bristol": ["Academy", "The Bristol Suspensions", "Pitch Fight"], "University of Bath": ["Aquapella"], "Royal Welsh College of Music and Drama": ["Aurum Voices"], "Cardiff University": ["DeciBelles", "Vox", "The Acappellads"], "University of Exeter": ["The Illuminations", "Sweet Nothings"], "Durham University": ["Northern Lights"], "University of Oxford": ["The Oxford Commas"], "Lancaster University": ["Roselution"], "University of Manchester": ["The Skylarks"], "Newcastle University": ["Tune Army"], "University College London": ["The Eustones"], "London School of Economics": ["The Houghtones"], "Imperial College London": ["The Imperielles", "Nth Harmonic", "The Scopes"], "King's College London": ["Kadence", "The Rolling Tones"], "University of Reading": ["RACA"], "University of Washington": ["Awaaz", "Furmata"], "Gonzaga University": ["Big Bing Theory"], "University of British Columbia": ["Eh? Cappella", "The Northwest Collective"], "University of British Columbia, Okanagan": ["Trebled Acaholics", "The Trill Seekers"], "Western Washington University": ["For Good Measure", "Pacific Note West"], "Oregon State University": ["Divine", "Power Chord"], "Southern Oregon University": ["Dulcet"], "Portland State University": ["The Green Note"], "Willamette University": ["Headband", "Tandem", "Up Top"], "University of Oregon": ["Mind the Gap"], "Montana State University": ["Rhapsody"], "University of Utah": ["Salt Flats"], "University of California, Los Angeles": ["Bruin Harmony", "Naya Zamaana", "ScatterTones", "Awaken", "Pitch, Please!", "Random Voices", "Resonance"], "Chapman University": ["Chapman SoundCheck", "The Dissonants", "The ChapTones", "Simply Vocale"], "California State University, Fullerton": ["The FullerTones"], "Moorpark College": ["MoorHarmony"], "University of California, Santa Barbara": ["Naked Voices"], "University of Southern California": ["Reverse Osmosis"], "California State University, Northridge": ["Acasola", "Vocal Percussion Radio (VPR)"], "University of California, Santa Cruz": ["Cloud 9"], "University of California, Davis": ["The Cleftomaniacs", "Jhankaar", "The Liquid Hotplates", "The Lounge Lizards", "The Spokes"], "UC Berkeley": ["Drawn to Scale", "The Golden Overtones"], "Stanford University": ["The Mendicants"], "Diablo Valley College": ["The pH Scale"], "San Jose State University": ["The Spartones"]};

const STATE_REGION = {
  "New York":"Central","Pennsylvania":"Central",
  "Minnesota":"Great Lakes","Wisconsin":"Great Lakes","Illinois":"Great Lakes","Michigan":"Great Lakes",
  "New Jersey":"Mid-Atlantic","Maryland":"Mid-Atlantic","Delaware":"Mid-Atlantic","Virginia":"Mid-Atlantic","West Virginia":"Mid-Atlantic","District of Columbia":"Mid-Atlantic",
  "Indiana":"Midwest","Ohio":"Midwest","Missouri":"Midwest","Kentucky":"Midwest","Kansas":"Midwest","Iowa":"Midwest","North Dakota":"Midwest","South Dakota":"Midwest",
  "Connecticut":"Northeast","Rhode Island":"Northeast","Massachusetts":"Northeast","Vermont":"Northeast","New Hampshire":"Northeast","Maine":"Northeast",
  "Tennessee":"South","North Carolina":"South","South Carolina":"South","Georgia":"South","Florida":"South","Alabama":"South","Mississippi":"South","Arkansas":"South","Louisiana":"South",
  "Texas":"Southwest","Nebraska":"Southwest","Colorado":"Southwest","Oklahoma":"Southwest","Arizona":"Southwest","New Mexico":"Southwest","Nevada":"Southwest",
  "Washington":"West","Oregon":"West","California":"West","Idaho":"West","Montana":"West","Wyoming":"West","Utah":"West",
};


const ORIG_STATE_REGION = Object.assign({}, STATE_REGION);
const ORIG_SCHOOL_GROUPS = JSON.parse(JSON.stringify(SCHOOL_GROUPS));
const ORIG_SCHOOL_COORDS = JSON.parse(JSON.stringify(SCHOOL_COORDS));
function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
function esc(s) { return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let data = deepClone(REGIONS);
encodeGroups(data);
let unassigned = []; // groups not assigned to any QF (also encoded)
let undoStack = [];
let openRegions = {};
let openQFs = {};
let selectedRegionName = null;
let viewMode = true;
let highlightedQF = null; // QF index for view mode highlighting
let currentZoom = null;

// ‚îÄ‚îÄ‚îÄ UNDO ‚îÄ‚îÄ‚îÄ
function saveUndo() {
  undoStack.push({ d: deepClone(data), u: [...unassigned], sr: Object.assign({}, STATE_REGION) });
  if (undoStack.length > 40) undoStack.shift();
}
function undoAction() {
  if (!undoStack.length) return;
  const prev = undoStack.pop();
  data = prev.d; unassigned = prev.u;
  for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
  Object.assign(STATE_REGION, prev.sr);
  renderEditor(); renderMap();
}

// ‚îÄ‚îÄ‚îÄ COMPUTED ‚îÄ‚îÄ‚îÄ
function countGroups(r) { return r.quarterfinals.reduce((s, q) => s + q.groups.length, 0); }

function getQFSchools(regionName, qfIdx) {
  if (!regionName || qfIdx == null || !data[regionName]) return null;
  const qf = data[regionName].quarterfinals[qfIdx];
  if (!qf) return null;
  const schools = new Set();
  for (const g of qf.groups) {
    const s = schoolOf(g);
    if (s) schools.add(s);
  }
  return schools;
}
function totalStats() {
  let r=0,g=0,s=0;
  for (const v of Object.values(data)) { r++; s+=v.schools.length; g+=countGroups(v); }
  return {r,g,s};
}

// Find which school a group belongs to
// Group names stored as "GroupName@SchoolName" internally
// Display helpers strip the @suffix
function displayName(g) { const i = g.lastIndexOf('@'); return i > 0 ? g.substring(0, i) : g; }
function schoolOf(g) { const i = g.lastIndexOf('@'); return i > 0 ? g.substring(i + 1) : null; }

// Encode all groups at init using QF_SCHOOLS as authoritative school mapping
function encodeGroups(regionData) {
  // Build group->school from QF_SCHOOLS: "RegionName-qfIdx" -> [schools]
  // For each QF, we know exactly which schools are in it
  const qfSchoolMap = {}; // "regionName|qfIdx" -> Set of schools
  for (const [key, schools] of Object.entries(QF_SCHOOLS)) {
    qfSchoolMap[key] = new Set(schools);
  }

  // Build global reverse map: groupName -> [school1, school2, ...]
  const groupToSchools = {};
  for (const [school, groups] of Object.entries(SCHOOL_GROUPS)) {
    for (const g of groups) {
      if (!groupToSchools[g]) groupToSchools[g] = [];
      groupToSchools[g].push(school);
    }
  }

  for (const [rn, rd] of Object.entries(regionData)) {
    rd.quarterfinals.forEach((qf, qi) => {
      // Get authoritative school list for this QF
      const qfKey = rn + '-' + qi;
      const authSchools = qfSchoolMap[qfKey];

      qf.groups = qf.groups.map(g => {
        if (g.includes('@')) return g;
        const candidates = groupToSchools[g];
        if (!candidates || !candidates.length) return g;
        if (candidates.length === 1) return g + '@' + candidates[0];
        // Use authoritative QF_SCHOOLS to disambiguate
        if (authSchools) {
          const inAuth = candidates.find(s => authSchools.has(s));
          if (inAuth) return g + '@' + inAuth;
        }
        return g + '@' + candidates[0];
      });
    });
  }
}

// Legacy wrapper for pool/no-context
function findSchoolForGroup(groupName) {
  // If already encoded
  const s = schoolOf(groupName);
  if (s) return s;
  for (const [school, groups] of Object.entries(SCHOOL_GROUPS)) {
    if (groups.includes(groupName)) return school;
  }
  return null;
}

// Rebuild schools list from QF group assignments
function rebuildSchools(regionName) {
  const region = data[regionName];
  const schoolSet = new Set();
  region.quarterfinals.forEach((qf, qi) => {
    for (const group of qf.groups) {
      const school = schoolOf(group) || findSchoolForGroup(displayName(group));
      if (school) schoolSet.add(school);
    }
  });
  region.schools = Array.from(schoolSet).sort();
}

// ‚îÄ‚îÄ‚îÄ REGION OPS ‚îÄ‚îÄ‚îÄ
function addRegion() {
  showModal('New Region', `
    <div class="modal-label">Region Name</div>
    <input class="modal-input" id="m-name" placeholder="e.g. Pacific Northwest" autofocus>
    <div class="modal-label">Color</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="color" class="color-picker" id="m-color" value="#6C8EBF">
      <span style="font-size:11px;color:#888" id="m-color-lbl">#6C8EBF</span>
    </div>
  `, () => {
    const name = document.getElementById('m-name').value.trim();
    const color = document.getElementById('m-color').value;
    if (!name) return;
    saveUndo();
    data[name] = { color, accent: color, schools: [], quarterfinals: [], semifinal:{date:"",location:"",lat:null,lng:null} };
    openRegions[name] = true;
    renderEditor(); renderMap();
  });
  document.getElementById('m-color').oninput = function() { document.getElementById('m-color-lbl').textContent = this.value; };
}

function renameRegion(oldName) {
  showModal('Rename Region', `
    <div class="modal-label">New Name</div>
    <input class="modal-input" id="m-name" value="${esc(oldName)}" autofocus>
  `, () => {
    const nn = document.getElementById('m-name').value.trim();
    if (!nn || nn === oldName) return;
    if (data[nn]) { alert('Region name already exists.'); return; }
    saveUndo();
    // Preserve all data including color
    data[nn] = data[oldName];
    delete data[oldName];
    if (openRegions[oldName]) { openRegions[nn] = true; delete openRegions[oldName]; }
    if (selectedRegionName === oldName) selectedRegionName = nn;
    // Update STATE_REGION references
    for (const [st, rn] of Object.entries(STATE_REGION)) {
      if (rn === oldName) STATE_REGION[st] = nn;
    }
    renderEditor(); renderMap();
  });
}

function editRegionColor(name) {
  const current = data[name].color;
  showModal('Edit Region Color', `
    <div class="modal-label">Region: ${esc(name)}</div>
    <div style="display:flex;gap:12px;align-items:center;margin:12px 0">
      <input type="color" class="color-picker" id="m-color" value="${current}" style="width:60px;height:40px">
      <div>
        <div class="modal-label">Accent Color (optional)</div>
        <input type="color" class="color-picker" id="m-accent" value="${data[name].accent || current}" style="width:60px;height:40px">
      </div>
    </div>
  `, () => {
    saveUndo();
    data[name].color = document.getElementById('m-color').value;
    data[name].accent = document.getElementById('m-accent').value;
    renderEditor(); renderMap();
  });
}

function deleteRegion(name) {
  const gc = countGroups(data[name]);
  const msg = gc ? `Delete "${name}"? Its ${gc} groups will move to the unassigned pool.` : `Delete "${name}"?`;
  customConfirm(msg, () => {
    saveUndo();
    for (const qf of data[name].quarterfinals) { unassigned.push(...qf.groups); }
    delete data[name];
    for (const [st, rn] of Object.entries(STATE_REGION)) { if (rn === name) delete STATE_REGION[st]; }
    if (selectedRegionName === name) selectedRegionName = null;
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ QF OPS ‚îÄ‚îÄ‚îÄ
function assignStateRegion(stateName) {
  const current = STATE_REGION[stateName] || '';
  const opts = ['<option value="">‚Äî None ‚Äî</option>'].concat(
    Object.keys(data).map(rn => `<option value="${esc(rn)}"${rn===current?' selected':''}>${rn}</option>`)
  ).join('');
  showModal(`Assign State: ${stateName}`, `
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${opts}</select>
    <div style="font-size:10px;color:#555;margin-top:-8px">Currently: ${current || 'unassigned'}</div>
  `, () => {
    const rn = document.getElementById('m-region').value;
    saveUndo();
    if (rn) { STATE_REGION[stateName] = rn; }
    else { delete STATE_REGION[stateName]; }
    renderMap();
  });
}
function addQF() {
  if (!Object.keys(data).length) { alert('Create a region first.'); return; }
  const opts = Object.keys(data).map(n => `<option value="${esc(n)}"${selectedRegionName===n?' selected':''}>${n}</option>`).join('');
  showModal('Add Quarterfinal', `
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${opts}</select>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-loc" placeholder="e.g. University of Rochester">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" placeholder="Feb 14"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" placeholder="43.13"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" placeholder="-77.63"></div>
    </div>
  `, () => {
    const rn = document.getElementById('m-region').value;
    saveUndo();
    data[rn].quarterfinals.push({
      date: document.getElementById('m-date').value.trim(),
      location: document.getElementById('m-loc').value.trim(),
      lat: parseFloat(document.getElementById('m-lat').value) || null,
      lng: parseFloat(document.getElementById('m-lng').value) || null,
      groups: []
    });
    openRegions[rn] = true;
    renderEditor(); renderMap();
  });
}

function editQF(regionName, qfIdx) {
  const qf = data[regionName].quarterfinals[qfIdx];
  const allRegions = Object.keys(data).map(n => `<option value="${esc(n)}"${n===regionName?' selected':''}>${n}</option>`).join('');
  showModal(`Edit QF${qfIdx+1} ‚Äî ${esc(regionName)}`, `
    <div class="modal-label">Assigned Region</div>
    <select class="modal-input" id="m-region">${allRegions}</select>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-loc" value="${esc(qf.location)}">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" value="${esc(qf.date)}"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" value="${qf.lat||''}"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" value="${qf.lng||''}"></div>
    </div>
  `, () => {
    const newRegion = document.getElementById('m-region').value;
    saveUndo();
    qf.location = document.getElementById('m-loc').value.trim();
    qf.date = document.getElementById('m-date').value.trim();
    qf.lat = parseFloat(document.getElementById('m-lat').value) || null;
    qf.lng = parseFloat(document.getElementById('m-lng').value) || null;
    // Move QF to new region if changed
    if (newRegion !== regionName) {
      data[regionName].quarterfinals.splice(qfIdx, 1);
      data[newRegion].quarterfinals.push(qf);
      rebuildSchools(regionName);
      rebuildSchools(newRegion);
      openRegions[newRegion] = true;
    }
    renderEditor(); renderMap();
  });
}

function deleteQF(rn, idx) {
  const qf = data[rn].quarterfinals[idx];
  const msg = qf.groups.length ? `Delete QF at "${qf.location}"? Its ${qf.groups.length} groups will move to the pool.` : `Delete QF at "${qf.location}"?`;
  customConfirm(msg, () => {
    saveUndo();
    unassigned.push(...qf.groups);
    data[rn].quarterfinals.splice(idx, 1);
    rebuildSchools(rn);
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ GROUP OPS ‚îÄ‚îÄ‚îÄ
function addGroup() {
  const opts = buildAssignSelect('__pool__');
  const schoolNames = Object.keys(SCHOOL_COORDS).sort();
  const datalist = schoolNames.map(s => `<option value="${esc(s)}">`).join('');

  showModal('Add Group', `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" placeholder="e.g. Midnight Ramblers" autofocus>
    <div class="modal-label">School (for map coordinates)</div>
    <input class="modal-input" id="m-school" list="school-list" placeholder="Start typing school name...">
    <datalist id="school-list">${datalist}</datalist>
    <div class="modal-label">Assign to</div>
    <select class="modal-input" id="m-target">${opts}</select>
    <div style="font-size:10px;color:#555;margin-top:-8px">
      If the school isn't in the list, add coordinates below:
    </div>
    <div class="modal-row" style="margin-top:8px">
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" placeholder="43.13"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" placeholder="-77.63"></div>
    </div>
  `, () => {
    const groupName = document.getElementById('m-group').value.trim();
    const schoolName = document.getElementById('m-school').value.trim();
    const target = document.getElementById('m-target').value;
    const lat = parseFloat(document.getElementById('m-lat').value);
    const lng = parseFloat(document.getElementById('m-lng').value);
    if (!groupName) return;
    saveUndo();
    // Register school/group mapping if provided
    if (schoolName) {
      if (!SCHOOL_GROUPS[schoolName]) SCHOOL_GROUPS[schoolName] = [];
      if (!SCHOOL_GROUPS[schoolName].includes(groupName)) SCHOOL_GROUPS[schoolName].push(groupName);
      if (!SCHOOL_COORDS[schoolName] && !isNaN(lat) && !isNaN(lng)) {
        SCHOOL_COORDS[schoolName] = [lat, lng];
      }
    } else if (!isNaN(lat) && !isNaN(lng)) {
      const pseudoSchool = groupName + " (school)";
      SCHOOL_COORDS[pseudoSchool] = [lat, lng];
      SCHOOL_GROUPS[pseudoSchool] = [groupName];
    }
    // Assign to pool or QF (encode with @school)
    const encoded = schoolName ? groupName + '@' + schoolName : groupName;
    if (target === '__pool__') {
      unassigned.push(encoded);
    } else {
      const [rn, qi] = target.split('|');
      data[rn].quarterfinals[parseInt(qi)].groups.push(encoded);
      rebuildSchools(rn);
    }
    renderEditor(); renderMap();
  });
}

function editGroup(regionName, qfIdx, groupName) {
  const school = schoolOf(groupName) || findSchoolForGroup(displayName(groupName));
  const dn = displayName(groupName);
  const coords = school ? SCHOOL_COORDS[school] : null;
  const opts = buildAssignSelect(regionName + '|' + qfIdx);
  showModal(`Edit Group`, `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" value="${esc(dn)}">
    <div class="modal-label">School</div>
    <input class="modal-input" id="m-school" value="${esc(school||'')}" list="school-list-edit">
    <datalist id="school-list-edit">${Object.keys(SCHOOL_COORDS).sort().map(s=>`<option value="${esc(s)}">`).join('')}</datalist>
    <div class="modal-label">Assigned to</div>
    <select class="modal-input" id="m-target">${opts}</select>
    ${coords ? `<div style="font-size:10px;color:#666;margin-top:-8px">üìç ${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}</div>` : '<div style="font-size:10px;color:#ff6b6b;margin-top:-8px">‚ö† No coordinates ‚Äî school not on map</div>'}
  `, () => {
    const newName = document.getElementById('m-group').value.trim();
    const newSchool = document.getElementById('m-school').value.trim();
    const target = document.getElementById('m-target').value;
    if (!newName) return;
    saveUndo();

    // Remove from old location (uses full encoded string)
    const oldGroups = data[regionName].quarterfinals[qfIdx].groups;
    const idx = oldGroups.indexOf(groupName);
    if (idx !== -1) oldGroups.splice(idx, 1);

    // Update SCHOOL_GROUPS
    const finalSchool = newSchool || school || '';
    if (newName !== dn && school) {
      const gs = SCHOOL_GROUPS[school];
      if (gs) { const gi = gs.indexOf(dn); if (gi !== -1) gs[gi] = newName; }
    }
    if (finalSchool && finalSchool !== school) {
      if (school && SCHOOL_GROUPS[school]) {
        const gi = SCHOOL_GROUPS[school].indexOf(newName !== dn ? newName : dn);
        if (gi !== -1) SCHOOL_GROUPS[school].splice(gi, 1);
      }
      if (!SCHOOL_GROUPS[finalSchool]) SCHOOL_GROUPS[finalSchool] = [];
      if (!SCHOOL_GROUPS[finalSchool].includes(newName)) SCHOOL_GROUPS[finalSchool].push(newName);
    }

    // Build encoded name and assign
    const encoded = finalSchool ? newName + '@' + finalSchool : newName;
    if (target === '__pool__') {
      unassigned.push(encoded);
    } else {
      const [newRn, newQi] = target.split('|');
      data[newRn].quarterfinals[parseInt(newQi)].groups.push(encoded);
      rebuildSchools(newRn);
    }

    rebuildSchools(regionName);
    renderEditor(); renderMap();
  });
}

// Edit a pool group (similar but source is pool)
function editPoolGroup(groupName) {
  const school = schoolOf(groupName) || findSchoolForGroup(displayName(groupName));
  const dn = displayName(groupName);
  const coords = school ? SCHOOL_COORDS[school] : null;
  const opts = buildAssignSelect('__pool__');
  showModal(`Edit Group`, `
    <div class="modal-label">Group Name</div>
    <input class="modal-input" id="m-group" value="${esc(dn)}">
    <div class="modal-label">School</div>
    <input class="modal-input" id="m-school" value="${esc(school||'')}" list="school-list-edit2">
    <datalist id="school-list-edit2">${Object.keys(SCHOOL_COORDS).sort().map(s=>`<option value="${esc(s)}">`).join('')}</datalist>
    <div class="modal-label">Assign to</div>
    <select class="modal-input" id="m-target">${opts}</select>
    ${coords ? `<div style="font-size:10px;color:#666;margin-top:-8px">üìç ${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}</div>` : '<div style="font-size:10px;color:#ff6b6b;margin-top:-8px">‚ö† No coordinates ‚Äî school not on map</div>'}
  `, () => {
    const newName = document.getElementById('m-group').value.trim();
    const newSchool = document.getElementById('m-school').value.trim();
    const target = document.getElementById('m-target').value;
    if (!newName) return;
    saveUndo();

    const idx = unassigned.indexOf(groupName);
    if (idx !== -1) unassigned.splice(idx, 1);

    const finalSchool = newSchool || school || '';
    if (newName !== dn && school) {
      const gs = SCHOOL_GROUPS[school];
      if (gs) { const gi = gs.indexOf(dn); if (gi !== -1) gs[gi] = newName; }
    }
    if (finalSchool && finalSchool !== school) {
      if (school && SCHOOL_GROUPS[school]) {
        const gi = SCHOOL_GROUPS[school].indexOf(newName !== dn ? newName : dn);
        if (gi !== -1) SCHOOL_GROUPS[school].splice(gi, 1);
      }
      if (!SCHOOL_GROUPS[finalSchool]) SCHOOL_GROUPS[finalSchool] = [];
      if (!SCHOOL_GROUPS[finalSchool].includes(newName)) SCHOOL_GROUPS[finalSchool].push(newName);
    }

    const encoded = finalSchool ? newName + '@' + finalSchool : newName;
    if (target === '__pool__') {
      unassigned.push(encoded);
    } else {
      const [newRn, newQi] = target.split('|');
      data[newRn].quarterfinals[parseInt(newQi)].groups.push(encoded);
      rebuildSchools(newRn);
    }
    renderEditor(); renderMap();
  });
}

function removeGroup(rn, qi, g) {
  saveUndo();
  const groups = data[rn].quarterfinals[qi].groups;
  const idx = groups.indexOf(g);
  if (idx !== -1) groups.splice(idx, 1);
  unassigned.push(g);
  rebuildSchools(rn);
  renderEditor(); renderMap();
}

function deletePoolGroup(g) {
  saveUndo();
  const idx = unassigned.indexOf(g);
  if (idx !== -1) unassigned.splice(idx, 1);
  renderEditor();
}

// ‚îÄ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ
let dragData = null;
let dragType = 'group'; // 'group' or 'qf'

function onDragStart(e, rn, qi, g) {
  dragData = {rn, qi, g}; dragType = 'group';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', g);
}
function onDragStartPool(e, g) {
  dragData = {rn: '__pool__', qi: -1, g}; dragType = 'group';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', g);
}
function onDragStartQF(e, rn, qi) {
  dragData = {rn, qi}; dragType = 'qf';
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', 'qf:' + rn + ':' + qi);
}
function onDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}
function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect='move'; e.currentTarget.classList.add('drag-over'); }
function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function onDragOverRegion(e) {
  if (dragType === 'qf' || dragType === 'group') {
    e.preventDefault(); e.dataTransfer.dropEffect='move'; e.currentTarget.classList.add('drag-over');
  }
}
function onDropToQF(e, targetRn, targetQi) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if (!dragData || dragType !== 'group') return;
  if (dragData.rn===targetRn && dragData.qi===targetQi) return;
  saveUndo();
  if (dragData.rn === '__pool__') {
    const idx = unassigned.indexOf(dragData.g);
    if (idx !== -1) unassigned.splice(idx, 1);
  } else {
    const src = data[dragData.rn].quarterfinals[dragData.qi].groups;
    const idx = src.indexOf(dragData.g);
    if (idx !== -1) src.splice(idx, 1);
    rebuildSchools(dragData.rn);
  }
  data[targetRn].quarterfinals[targetQi].groups.push(dragData.g);
  rebuildSchools(targetRn);
  dragData = null;
  renderEditor(); renderMap();
}
function onDropToPool(e) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if (!dragData) return;
  if (dragType === 'qf') {
    // Dissolve QF: move all its groups to pool, delete QF
    saveUndo();
    const qf = data[dragData.rn].quarterfinals[dragData.qi];
    unassigned.push(...qf.groups);
    data[dragData.rn].quarterfinals.splice(dragData.qi, 1);
    rebuildSchools(dragData.rn);
    dragData = null;
    renderEditor(); renderMap();
  } else if (dragType === 'group') {
    if (dragData.rn === '__pool__') return;
    saveUndo();
    const src = data[dragData.rn].quarterfinals[dragData.qi].groups;
    const idx = src.indexOf(dragData.g);
    if (idx !== -1) src.splice(idx, 1);
    rebuildSchools(dragData.rn);
    unassigned.push(dragData.g);
    dragData = null;
    renderEditor(); renderMap();
  }
}
function onDropToRegion(e, targetRn) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if (!dragData) return;
  if (dragType === 'qf') {
    // Move entire QF to target region
    if (dragData.rn === targetRn) return;
    saveUndo();
    const qf = data[dragData.rn].quarterfinals.splice(dragData.qi, 1)[0];
    data[targetRn].quarterfinals.push(qf);
    rebuildSchools(dragData.rn);
    rebuildSchools(targetRn);
    openRegions[targetRn] = true;
    dragData = null;
    renderEditor(); renderMap();
  } else if (dragType === 'group') {
    // Drop group into first QF of target region, or create one
    if (!data[targetRn].quarterfinals.length) {
      data[targetRn].quarterfinals.push({date:'',location:'',lat:null,lng:null,groups:[]});
    }
    onDropToQF(e, targetRn, 0);
  }
}

// ‚îÄ‚îÄ‚îÄ ASSIGN TARGET BUILDER ‚îÄ‚îÄ‚îÄ
function buildAssignSelect(currentTarget) {
  let h = '<optgroup label="Unassigned"><option value="__pool__"';
  if (currentTarget === '__pool__') h += ' selected';
  h += '>‚Äî Unassigned Pool ‚Äî</option></optgroup>';
  for (const [rn, rd] of Object.entries(data)) {
    h += `<optgroup label="${rn}">`;
    if (rd.quarterfinals.length > 0) {
      rd.quarterfinals.forEach((qf, i) => {
        const val = rn + '|' + i;
        const sel = currentTarget === val ? ' selected' : '';
        h += `<option value="${esc(val)}"${sel}>QF${i+1} ‚Äî ${qf.location||'(no location)'}</option>`;
      });
    } else {
      h += `<option value="${esc(rn)}|new">+ Create new QF</option>`;
    }
    h += '</optgroup>';
  }
  return h;
}

// ‚îÄ‚îÄ‚îÄ SCHOOL MODAL (from map click) ‚îÄ‚îÄ‚îÄ
function showSchoolModal(school) {
  const coords = SCHOOL_COORDS[school];
  const allGroups = SCHOOL_GROUPS[school] || [];

  function findGroupLocation(groupName) {
    // Use canonical index: find QF where this group+school combination lives
    for (const [rn, rd] of Object.entries(data)) {
      for (let i = 0; i < rd.quarterfinals.length; i++) {
        if (rd.quarterfinals[i].groups.some(g => displayName(g) === groupName && schoolOf(g) === school)) {
          return { rn, qi: i };
        }
      }
    }
    // Fallback: maybe group was moved and index not yet updated
    for (const [rn, rd] of Object.entries(data)) {
      for (let i = 0; i < rd.quarterfinals.length; i++) {
        if (rd.quarterfinals[i].groups.some(g => displayName(g) === groupName)) return { rn, qi: i };
      }
    }
    if (unassigned.some(u => displayName(u) === groupName && (schoolOf(u) === school || !schoolOf(u)))) return { rn: '__pool__', qi: -1 };
    return null;
  }

  let groupRows = '';
  allGroups.forEach(g => {
    const loc = findGroupLocation(g);
    let locLabel = '<span style="color:#ff6b6b">Not placed</span>';
    let curTarget = '__pool__';
    if (loc) {
      if (loc.rn === '__pool__') {
        locLabel = '<span style="color:#888">Unassigned</span>';
      } else {
        locLabel = `<span style="color:${data[loc.rn].color}">${loc.rn}</span> ‚Ä∫ QF${loc.qi+1}`;
        curTarget = loc.rn + '|' + loc.qi;
      }
    }
    groupRows += `
      <div style="margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <span style="font-weight:600;font-size:13px">${g}</span>
          <span style="font-size:10px">${locLabel}</span>
        </div>
        <select class="modal-input group-assign-select" data-group="${esc(g)}" style="margin-bottom:0">
          ${buildAssignSelect(curTarget)}
        </select>
      </div>`;
  });

  const coordsInfo = coords ? `üìç ${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}` : '‚ö† No coordinates';

  showModal(school, `
    <div style="font-size:10px;color:#666;margin:-8px 0 12px">${coordsInfo}</div>
    <div class="modal-label">Groups (${allGroups.length})</div>
    <div style="max-height:300px;overflow-y:auto">
      ${groupRows || '<div style="font-size:12px;color:#555;padding:8px">No groups registered</div>'}
    </div>
  `, () => {
    const selects = document.querySelectorAll('.group-assign-select');
    saveUndo();
    selects.forEach(sel => {
      const group = sel.dataset.group; // raw group name from SCHOOL_GROUPS
      const target = sel.value;
      const encoded = group + '@' + school; // we know the school context
      // Remove from everywhere (match by encoded or raw name)
      const poolIdx = unassigned.findIndex(u => displayName(u) === group && (schoolOf(u) === school || !schoolOf(u)));
      if (poolIdx !== -1) unassigned.splice(poolIdx, 1);
      for (const rd of Object.values(data)) {
        for (const qf of rd.quarterfinals) {
          const gi = qf.groups.findIndex(g => displayName(g) === group && (schoolOf(g) === school || !schoolOf(g)));
          if (gi !== -1) qf.groups.splice(gi, 1);
        }
      }
      // Assign
      if (target === '__pool__') {
        unassigned.push(encoded);
      } else {
        const [rn, qi] = target.split('|');
        if (qi === 'new') {
          data[rn].quarterfinals.push({date:'',location:'',lat:null,lng:null,groups:[encoded]});
        } else {
          data[rn].quarterfinals[parseInt(qi)].groups.push(encoded);
        }
      }
    });
    for (const rn of Object.keys(data)) rebuildSchools(rn);
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ QF DETAIL MODAL (from map diamond click) ‚îÄ‚îÄ‚îÄ
function showQFDetailModal(regionName, qfIdx) {
  const qf = data[regionName].quarterfinals[qfIdx];
  const rd = data[regionName];

  let groupList = '';
  qf.groups.forEach(g => {
    const school = schoolOf(g);
    const gd = displayName(g);
    groupList += `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.04)">
        <div>
          <span style="font-weight:500" data-group-tip="${esc(gd)}" data-group-ctx="${esc(regionName)}|${qfIdx}">${gd}</span>
          ${school ? `<span style="font-size:10px;color:#666;margin-left:6px">${school}</span>` : ''}
        </div>
        <button class="region-action-btn del" onclick="event.stopPropagation();removeGroupFromQFModal('${esc(regionName)}',${qfIdx},'${esc(g)}')" title="Unassign to pool">‚úï</button>
      </div>`;
  });

  const allRegions = Object.keys(data).map(rn =>
    `<option value="${esc(rn)}"${rn===regionName?' selected':''}>${rn}</option>`
  ).join('');

  showModal(`QF${qfIdx+1} ‚Äî ${qf.location || 'No location'}`, `
    <div style="display:flex;gap:8px;font-size:10px;color:#666;margin:-8px 0 12px">
      <span style="color:${rd.color}">‚óè ${regionName}</span>
      ${qf.date ? `<span>üìÖ ${qf.date}</span>` : ''}
      ${qf.lat ? `<span>üìç ${qf.lat.toFixed(2)}, ${qf.lng.toFixed(2)}</span>` : ''}
    </div>
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Location</div><input class="modal-input" id="m-loc" value="${esc(qf.location)}"></div>
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" value="${esc(qf.date)}"></div>
    </div>
    <div class="modal-label">Region</div>
    <select class="modal-input" id="m-region">${allRegions}</select>
    <div class="modal-label">Groups (${qf.groups.length})</div>
    <div style="max-height:200px;overflow-y:auto;background:rgba(255,255,255,0.02);border-radius:6px;border:1px solid rgba(255,255,255,0.06);margin-bottom:4px">
      ${groupList || '<div style="font-size:11px;color:#555;padding:10px">No groups assigned</div>'}
    </div>
  `, () => {
    const newRegion = document.getElementById('m-region').value;
    saveUndo();
    qf.location = document.getElementById('m-loc').value.trim();
    qf.date = document.getElementById('m-date').value.trim();
    if (newRegion !== regionName) {
      data[regionName].quarterfinals.splice(qfIdx, 1);
      data[newRegion].quarterfinals.push(qf);
      rebuildSchools(regionName);
      rebuildSchools(newRegion);
      openRegions[newRegion] = true;
    }
    renderEditor(); renderMap();
  });
}

function removeGroupFromQFModal(rn, qi, g) {
  saveUndo();
  const groups = data[rn].quarterfinals[qi].groups;
  const idx = groups.indexOf(g);
  if (idx !== -1) groups.splice(idx, 1);
  unassigned.push(g);
  rebuildSchools(rn);
  renderEditor(); renderMap();
  showQFDetailModal(rn, qi);
}

// ‚îÄ‚îÄ‚îÄ SEMIFINAL MODAL (from map star click) ‚îÄ‚îÄ‚îÄ
function showSFModal(regionName) {
  const rd = data[regionName];
  const sf = rd.semifinal || {date:'',location:'',lat:null,lng:null};

  showModal(`Semifinal ‚Äî ${regionName}`, `
    <div style="font-size:10px;color:${rd.color};margin:-8px 0 12px">‚óè ${regionName} ¬∑ ‚òÖ Semifinal</div>
    <div class="modal-label">Location</div>
    <input class="modal-input" id="m-loc" value="${esc(sf.location||'')}">
    <div class="modal-row">
      <div style="flex:1"><div class="modal-label">Date</div><input class="modal-input" id="m-date" value="${esc(sf.date||'')}"></div>
      <div style="flex:1"><div class="modal-label">Lat</div><input class="modal-input" id="m-lat" value="${sf.lat||''}"></div>
      <div style="flex:1"><div class="modal-label">Lng</div><input class="modal-input" id="m-lng" value="${sf.lng||''}"></div>
    </div>
  `, () => {
    saveUndo();
    rd.semifinal = {
      location: document.getElementById('m-loc').value.trim(),
      date: document.getElementById('m-date').value.trim(),
      lat: parseFloat(document.getElementById('m-lat').value) || null,
      lng: parseFloat(document.getElementById('m-lng').value) || null
    };
    renderEditor(); renderMap();
  });
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
function showModal(title, body, onConfirm) {
  const overlay = document.getElementById('modal-overlay');
  const modal = document.getElementById('modal');
  modal.innerHTML = `<h3>${title}</h3>${body}
    <div class="modal-actions">
      <button class="tb-btn" onclick="closeModal()">Cancel</button>
      <button class="tb-btn primary" id="modal-ok">Confirm</button>
    </div>`;
  overlay.classList.add('active');
  document.getElementById('modal-ok').onclick = () => { onConfirm(); closeModal(); };
  setTimeout(() => {
    const inp = modal.querySelector('input');
    if (inp) inp.focus();
    else document.getElementById('modal-ok').focus();
  }, 50);
  modal.onkeydown = (e) => { if (e.key==='Enter' && e.target.tagName!=='SELECT') { onConfirm(); closeModal(); } };
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

function customConfirm(msg, onYes) {
  showModal('Confirm', `<div style="font-size:13px;color:#ccc;margin-bottom:4px">${msg}</div>`, onYes);
  // Restyle confirm button as danger
  const btn = document.getElementById('modal-ok');
  btn.textContent = 'Delete';
  btn.className = 'tb-btn danger';
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
function exportJSON() {
  const exportData = deepClone(data);
  for (const rd of Object.values(exportData)) {
    rd.quarterfinals.forEach(qf => { qf.groups = qf.groups.map(g => displayName(g)); });
  }
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'icca-regions.json'; a.click();
}
function importJSON() { document.getElementById('file-import').click(); }
function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const imported = JSON.parse(ev.target.result);
      if (typeof imported !== 'object' || !Object.keys(imported).length) throw new Error('Invalid format');
      saveUndo();
      data = imported;
      encodeGroups(data);
      unassigned = [];
      openRegions = {};
      selectedRegionName = null;
      renderEditor(); renderMap();
    } catch(err) { alert('Import failed: ' + err.message); }
  };
  reader.readAsText(file);
  e.target.value = '';
}
function resetToDefault() {
  if (!confirm('Reset all changes to the default 2026 data?')) return;
  saveUndo();
  // Restore all mutable globals
  for (const k of Object.keys(SCHOOL_GROUPS)) delete SCHOOL_GROUPS[k];
  Object.assign(SCHOOL_GROUPS, JSON.parse(JSON.stringify(ORIG_SCHOOL_GROUPS)));
  for (const k of Object.keys(SCHOOL_COORDS)) delete SCHOOL_COORDS[k];
  Object.assign(SCHOOL_COORDS, JSON.parse(JSON.stringify(ORIG_SCHOOL_COORDS)));
  for (const k of Object.keys(STATE_REGION)) delete STATE_REGION[k];
  Object.assign(STATE_REGION, ORIG_STATE_REGION);
  data = deepClone(REGIONS);
  encodeGroups(data);
  unassigned = [];
  openRegions = {}; openQFs = {}; selectedRegionName = null; highlightedQF = null;
  renderEditor(); renderMap();
}
function exportGroupsCSV() {
  const rows = [['Group','School','Region','QF','Location','Date']];
  for (const [rn, rd] of Object.entries(data)) {
    rd.quarterfinals.forEach((qf, qi) => {
      for (const g of qf.groups) {
        rows.push([displayName(g), schoolOf(g)||'', rn, 'QF'+(qi+1), qf.location||'', qf.date||'']);
      }
    });
  }
  for (const g of unassigned) {
    rows.push([displayName(g), schoolOf(g)||'', 'Unassigned', '', '', '']);
  }
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'icca-groups.csv'; a.click();
}

function importGroupsCSV() {
  showModal('Import Groups (CSV)', `
    <div class="modal-label">Paste CSV</div>
    <textarea class="modal-input" id="m-groups-csv" rows="8" style="font-family:'Space Mono',monospace;font-size:11px;resize:vertical" placeholder="Group,School,Region,QF,Location,Date
Midnight Ramblers,University of Rochester,Central,QF3,Rochester NY,Feb 14
New Ensemble,Stanford University"></textarea>
    <div style="font-size:10px;color:#666;margin-top:4px">
      Columns: <code>Group, School, Region, QF, Location, Date</code>. Only Group is required.<br>
      With Region + QF ‚Üí placed in that QF. With Region only ‚Üí first QF in that region. Otherwise ‚Üí pool.
    </div>
  `, () => {
    const raw = document.getElementById('m-groups-csv').value.trim();
    if (!raw) return;
    const lines = raw.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return;

    function parseCSVLine(line) {
      const fields = [];
      let cur = '', inQuote = false;
      for (let c = 0; c < line.length; c++) {
        const ch = line[c];
        if (inQuote) {
          if (ch === '"' && line[c+1] === '"') { cur += '"'; c++; }
          else if (ch === '"') inQuote = false;
          else cur += ch;
        } else {
          if (ch === '"') inQuote = true;
          else if (ch === ',') { fields.push(cur.trim()); cur = ''; }
          else cur += ch;
        }
      }
      fields.push(cur.trim());
      return fields;
    }

    // Detect and skip header
    const firstLower = lines[0].toLowerCase().replace(/[" ]/g,'');
    const hasHeader = firstLower.startsWith('group') || firstLower.startsWith('name');
    const start = hasHeader ? 1 : 0;

    saveUndo();
    let placed = 0, pooled = 0, skipped = 0;
    for (let i = start; i < lines.length; i++) {
      const f = parseCSVLine(lines[i]);
      const name = (f[0] || '').trim();
      const school = (f[1] || '').trim();
      const region = (f[2] || '').trim();
      const qfStr = (f[3] || '').trim();
      if (!name) { skipped++; continue; }

      // Register school
      if (school) {
        if (!SCHOOL_GROUPS[school]) SCHOOL_GROUPS[school] = [];
        if (!SCHOOL_GROUPS[school].includes(name)) SCHOOL_GROUPS[school].push(name);
      }
      const encoded = school ? name + '@' + school : name;

      // Try to place in region/QF
      if (region && region !== 'Unassigned' && data[region]) {
        const qfIdx = qfStr ? parseInt(qfStr.replace(/\D/g,'')) - 1 : -1;
        if (qfIdx >= 0 && data[region].quarterfinals[qfIdx]) {
          data[region].quarterfinals[qfIdx].groups.push(encoded);
          placed++;
        } else if (data[region].quarterfinals.length > 0) {
          data[region].quarterfinals[0].groups.push(encoded);
          placed++;
        } else {
          unassigned.push(encoded);
          pooled++;
        }
        rebuildSchools(region);
      } else {
        unassigned.push(encoded);
        pooled++;
      }
    }
    renderEditor(); renderMap();
    let msg = '';
    if (placed) msg += placed + ' placed in QFs. ';
    if (pooled) msg += pooled + ' added to pool. ';
    if (skipped) msg += skipped + ' skipped.';
    alert(msg.trim() || 'No groups imported.');
  });
  setTimeout(() => document.getElementById('m-groups-csv').focus(), 50);
}

function toggleDropdown() {
  const el = document.getElementById('json-dropdown');
  el.classList.toggle('open');
}
// Close dropdown on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.dropdown-wrap')) {
    document.getElementById('json-dropdown').classList.remove('open');
  }
});

// ‚îÄ‚îÄ‚îÄ RENDER EDITOR ‚îÄ‚îÄ‚îÄ
function renderEditor() {
  const body = document.getElementById('editor-body');
  const st = totalStats();
  document.getElementById('editor-stats').textContent = `${st.r}R ¬∑ ${st.g}G ¬∑ ${st.s}S`;

  let h = '';
  const vm = viewMode;
  for (const [rn, rd] of Object.entries(data)) {
    const isOpen = openRegions[rn];
    const gc = countGroups(rd);
    h += `<div class="region-block">`;
    h += `<div class="region-header" onclick="toggleRegion('${esc(rn)}')"${vm?'':` ondragover="onDragOverRegion(event)" ondragleave="onDragLeave(event)" ondrop="onDropToRegion(event,'${esc(rn)}')"`}>`;
    h += `<span class="region-chevron ${isOpen?'open':''}">‚ñ∂</span>`;
    h += `<div class="region-swatch" style="background:${rd.color}"${vm?'':` onclick="event.stopPropagation();editRegionColor('${esc(rn)}')" title="Edit color"`}></div>`;
    h += `<span class="region-name">${rn}</span>`;
    h += `<span class="region-meta">${rd.schools.length}s ¬∑ ${gc}g ¬∑ ${rd.quarterfinals.length}qf</span>`;
    if (!vm) {
      h += `<div class="region-actions">`;
      h += `<button class="region-action-btn" onclick="event.stopPropagation();renameRegion('${esc(rn)}')" title="Rename">‚úé</button>`;
      h += `<button class="region-action-btn del" onclick="event.stopPropagation();deleteRegion('${esc(rn)}')" title="Delete">‚úï</button>`;
      h += `</div>`;
    }
    h += `</div>`;

    if (isOpen) {
      h += `<div class="region-body">`;
      rd.quarterfinals.forEach((qf, i) => {
        const qfKey = rn + '|' + i;
        const qfOpen = openQFs[qfKey] !== false;
        h += `<div class="qf-block">`;
        h += `<div class="qf-header"${vm?'':` draggable="true" ondragstart="onDragStartQF(event,'${esc(rn)}',${i})" ondragend="onDragEnd(event)"`} onclick="toggleQF('${esc(rn)}',${i})">`;
        h += `<span class="region-chevron ${qfOpen?'open':''}" style="font-size:8px">‚ñ∂</span>`;
        h += `<span class="qf-label" style="color:${rd.color}">QF${i+1}</span>`;
        h += `<span class="qf-location">${qf.location||'No location'}</span>`;
        h += `<span class="qf-count">${qf.groups.length}</span>`;
        if (!vm) {
          h += `<div class="qf-actions">`;
          h += `<button class="region-action-btn" onclick="event.stopPropagation();editQF('${esc(rn)}',${i})" title="Edit QF">‚úé</button>`;
          h += `<button class="region-action-btn del" onclick="event.stopPropagation();deleteQF('${esc(rn)}',${i})" title="Delete QF">‚úï</button>`;
          h += `</div>`;
        }
        h += `</div>`;
        if (qfOpen) {
          h += `<div class="qf-groups"${vm?'':` ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDropToQF(event,'${esc(rn)}',${i})"`}>`;
          qf.groups.forEach(g => {
            if (vm) {
              h += `<span class="group-tag" data-group-tip="${esc(displayName(g))}" data-group-ctx="${esc(rn)}|${i}">${displayName(g)}</span>`;
            } else {
              h += `<span class="group-tag" data-group-tip="${esc(displayName(g))}" data-group-ctx="${esc(rn)}|${i}" draggable="true" ondragstart="onDragStart(event,'${esc(rn)}',${i},'${esc(g)}')" ondragend="onDragEnd(event)" onclick="editGroup('${esc(rn)}',${i},'${esc(g)}')" title="Click to edit">`;
              h += `${displayName(g)}<span class="remove-group" onclick="event.stopPropagation();removeGroup('${esc(rn)}',${i},'${esc(g)}')" title="Remove">‚úï</span></span>`;
            }
          });
          if (!qf.groups.length) h += `<span style="font-size:10px;color:#444;padding:4px">${vm?'Empty':'Drop groups here'}</span>`;
          h += `</div>`;
        }
        h += `</div>`;
      });
      h += `</div>`;
    }
    h += `</div>`;
  }

  // Unassigned pool
  h += `<div class="pool-section">`;
  h += `<div class="pool-header"><span class="pool-label">Unassigned Groups</span><span class="region-meta">${unassigned.length}</span></div>`;
  h += `<div class="qf-groups pool-drop" style="margin:0 10px 10px;border-radius:6px;border-style:dashed" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDropToPool(event)">`;
  if (unassigned.length) {
    unassigned.forEach(g => {
      h += `<span class="group-tag" data-group-tip="${esc(displayName(g))}" draggable="true" ondragstart="onDragStartPool(event,'${esc(g)}')" ondragend="onDragEnd(event)" onclick="editPoolGroup('${esc(g)}')" title="Click to edit">`;
      h += `${displayName(g)}<span class="remove-group" onclick="event.stopPropagation();deletePoolGroup('${esc(g)}')" title="Delete permanently">‚úï</span></span>`;
    });
  } else {
    h += `<span style="font-size:10px;color:#444;padding:4px">Drag groups or entire QFs here to unassign</span>`;
  }
  h += `</div></div>`;

  body.innerHTML = h;
}

function toggleViewMode() {
  viewMode = !viewMode;
  highlightedQF = null;
  closeVenuePopup();
  const btn = document.getElementById('view-toggle');
  if (viewMode) {
    btn.textContent = '‚úé Edit';
    btn.classList.add('primary');
    document.body.classList.add('view-mode');
  } else {
    btn.textContent = 'üëÅ View';
    btn.classList.remove('primary');
    document.body.classList.remove('view-mode');
  }
  updateMapStats();
  renderEditor(); renderMap();
}

function toggleRegion(name) {
  openRegions[name] = !openRegions[name];
  selectedRegionName = openRegions[name] ? name : null;
  highlightedQF = null;
  closeVenuePopup();
  renderEditor(); renderMap();
}

// ‚îÄ‚îÄ‚îÄ ZOOM-BASED DOT SPREADING ‚îÄ‚îÄ‚îÄ
function spreadDots(dots, minDist) {
  const positions = dots.map(d => ({...d, sx: d.x, sy: d.y}));
  for (let iter = 0; iter < 12; iter++) {
    let moved = false;
    for (let i = 0; i < positions.length; i++) {
      for (let j = i + 1; j < positions.length; j++) {
        const dx = positions[j].sx - positions[i].sx;
        const dy = positions[j].sy - positions[i].sy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < minDist) {
          const overlap = (minDist - dist) / 2;
          if (dist > 0) {
            const nx = dx/dist, ny = dy/dist;
            positions[i].sx -= nx*overlap*0.5;
            positions[i].sy -= ny*overlap*0.5;
            positions[j].sx += nx*overlap*0.5;
            positions[j].sy += ny*overlap*0.5;
          } else {
            const angle = (i*2.399) + j;
            positions[i].sx -= Math.cos(angle)*minDist*0.3;
            positions[i].sy -= Math.sin(angle)*minDist*0.3;
            positions[j].sx += Math.cos(angle)*minDist*0.3;
            positions[j].sy += Math.sin(angle)*minDist*0.3;
          }
          moved = true;
        }
      }
    }
    if (!moved) break;
  }
  return positions;
}

function applyZoomSpread(g, k) {
  const spreadFactor = Math.max(0, Math.min(1, (k - 6) / 8));
  if (spreadFactor === 0) {
    g.selectAll(".school-dot").each(function() {
      const el = d3.select(this);
      el.attr("cx", el.attr("data-ox")).attr("cy", el.attr("data-oy"));
    });
    g.selectAll(".school-glow").each(function() {
      const el = d3.select(this);
      el.attr("cx", el.attr("data-ox")).attr("cy", el.attr("data-oy"));
    });
    return;
  }
  const dots = [];
  g.selectAll(".school-dot").each(function() {
    const el = d3.select(this);
    dots.push({ el, ox: +el.attr("data-ox"), oy: +el.attr("data-oy") });
  });
  const minDist = 0.5 + spreadFactor * 0.5;
  const spread = spreadDots(dots.map(d => ({x: d.ox, y: d.oy})), minDist);
  dots.forEach((d, i) => {
    d.el.attr("cx", d.ox + (spread[i].sx - spread[i].x)*spreadFactor);
    d.el.attr("cy", d.oy + (spread[i].sy - spread[i].y)*spreadFactor);
  });
  const glows = [];
  g.selectAll(".school-glow").each(function() { glows.push(d3.select(this)); });
  let gi = 0;
  dots.forEach((d, i) => {
    while (gi < glows.length) {
      const glow = glows[gi];
      if (+glow.attr("data-ox") === d.ox && +glow.attr("data-oy") === d.oy) {
        glow.attr("cx", d.ox + (spread[i].sx - spread[i].x)*spreadFactor);
        glow.attr("cy", d.oy + (spread[i].sy - spread[i].y)*spreadFactor);
        gi++; break;
      }
      gi++;
    }
  });
}

// ‚îÄ‚îÄ‚îÄ VENUE POPUP ‚îÄ‚îÄ‚îÄ
function showVenuePopup(screenX, screenY, qfEntries, activeIdx) {
  // qfEntries: [{qf, qfIdx, regionName, regionData}, ...]
  // activeIdx: index into qfEntries for which tab is active
  const popup = document.getElementById('venue-popup');
  const mapArea = document.querySelector('.map-area');
  const rect = mapArea.getBoundingClientRect();
  let left = screenX - rect.left + 14;
  let top = screenY - rect.top - 10;
  if (left + 330 > rect.width) left = screenX - rect.left - 340;
  if (top + 250 > rect.height) top = rect.height - 260;
  if (top < 10) top = 10;
  if (left < 10) left = 10;
  popup.style.display = 'block';
  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
  popup._qfEntries = qfEntries;
  popup._screenX = screenX;
  popup._screenY = screenY;

  const active = qfEntries[activeIdx];
  const {qf, qfIdx, regionName, regionData} = active;

  let tabsHtml = '';
  if (qfEntries.length > 1) {
    tabsHtml = '<div class="venue-popup-tabs">' + qfEntries.map((e, ti) => {
      const c = e.regionData.accent || e.regionData.color;
      const cls = ti === activeIdx ? 'venue-popup-tab active' : 'venue-popup-tab';
      return `<button class="${cls}" style="--tab-color:${c}" onclick="switchVenueTab(${ti})">QF${e.qfIdx+1} ¬∑ ${e.qf.date||''}</button>`;
    }).join('') + '</div>';
  }

  popup.innerHTML = `
    <div style="width:32px;height:3px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 10px;"></div>
    <div class="venue-popup-header">
      <div>
        <div class="venue-popup-title" style="color:${regionData.accent||regionData.color}">QF${qfIdx+1} ‚Äî ${qf.location||'No location'}</div>
        <div class="venue-popup-meta">${qf.date||''} ¬∑ ${regionName} ¬∑ ${qf.groups.length} groups</div>
      </div>
      <button class="venue-popup-close" onclick="closeVenuePopup()">‚úï</button>
    </div>
    ${tabsHtml}
    <div class="venue-popup-groups">
      ${qf.groups.map(g => `<span class="venue-popup-group" data-group-tip="${displayName(g)}" data-group-ctx="${regionName}|${qfIdx}">${displayName(g)}</span>`).join('')}
    </div>`;
}
function switchVenueTab(tabIdx) {
  const popup = document.getElementById('venue-popup');
  const entries = popup._qfEntries;
  if (!entries || !entries[tabIdx]) return;
  const entry = entries[tabIdx];
  // Update highlighting
  highlightedQF = entry.qfIdx;
  selectedRegionName = entry.regionName;
  showVenuePopup(popup._screenX, popup._screenY, entries, tabIdx);
  renderMap();
  // Re-show popup after renderMap (which may clear it visually)
  const p = document.getElementById('venue-popup');
  p.style.display = 'block';
}
function closeVenuePopup() { document.getElementById('venue-popup').style.display = 'none'; }

// Draggable venue popup
(function() {
  let isDragging = false, startX, startY, startLeft, startTop;
  const popup = document.getElementById('venue-popup');
  popup.addEventListener('mousedown', function(e) {
    if (e.target.closest('.venue-popup-close')) return;
    isDragging = true; popup.classList.add('dragging');
    startX = e.clientX; startY = e.clientY;
    startLeft = parseInt(popup.style.left)||0;
    startTop = parseInt(popup.style.top)||0;
    e.preventDefault();
  });
  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    popup.style.left = (startLeft + e.clientX - startX) + 'px';
    popup.style.top = (startTop + e.clientY - startY) + 'px';
  });
  document.addEventListener('mouseup', function() {
    if (isDragging) { isDragging = false; popup.classList.remove('dragging'); }
  });
})();

// ‚îÄ‚îÄ‚îÄ MAP STATS BAR ‚îÄ‚îÄ‚îÄ
function updateMapStats() {
  const el = document.getElementById('map-stats');
  const st = totalStats();
  el.innerHTML = `<span><span class="map-stat-val">${st.r}</span>Regions</span>`
    + `<span><span class="map-stat-val">${st.g}</span>Groups</span>`
    + `<span><span class="map-stat-val">${st.s}</span>Schools</span>`;
}

// ‚îÄ‚îÄ‚îÄ GLOBAL GROUP TOOLTIP ‚îÄ‚îÄ‚îÄ
(function() {
  const gtt = document.getElementById('group-tooltip');
  let activeEl = null;

  document.addEventListener('mouseover', function(e) {
    const el = e.target.closest('[data-group-tip]');
    if (!el) { if (activeEl) { gtt.classList.remove('visible'); activeEl = null; } return; }
    activeEl = el;
    const groupName = el.getAttribute('data-group-tip');
    const ctx = el.getAttribute('data-group-ctx');
    let school;
    if (ctx) {
      const [rn, qi] = ctx.split('|');
      // Find the encoded group in the QF to get school
      const rd = data[rn], qf = rd && rd.quarterfinals[parseInt(qi)];
      if (qf) {
        const match = qf.groups.find(g => displayName(g) === groupName);
        school = match ? schoolOf(match) : null;
      }
    }
    if (!school) school = findSchoolForGroup(groupName);
    gtt.textContent = school || 'Unknown school';
    gtt.classList.add('visible');
    gtt.style.left = (e.clientX + 14) + 'px';
    gtt.style.top = (e.clientY - 10) + 'px';
  });

  document.addEventListener('mousemove', function(e) {
    if (!activeEl) return;
    gtt.style.left = (e.clientX + 14) + 'px';
    gtt.style.top = (e.clientY - 10) + 'px';
  });

  document.addEventListener('mouseout', function(e) {
    const el = e.target.closest('[data-group-tip]');
    if (el === activeEl) { gtt.classList.remove('visible'); activeEl = null; }
  });
})();

function toggleQF(rn, qi) {
  const key = rn + '|' + qi;
  openQFs[key] = openQFs[key] === false ? true : false;
  renderEditor();
}

function expandAll() {
  for (const rn of Object.keys(data)) {
    openRegions[rn] = true;
    data[rn].quarterfinals.forEach((_, i) => { openQFs[rn + '|' + i] = true; });
  }
  renderEditor();
}

function collapseAll() {
  for (const rn of Object.keys(data)) {
    openRegions[rn] = false;
    data[rn].quarterfinals.forEach((_, i) => { openQFs[rn + '|' + i] = false; });
  }
  selectedRegionName = null;
  renderEditor(); renderMap();
}

// ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ
let usTopoData = null, mapSvg = null, mapG = null, mapZoom = null;
let mapProjection = null; // stored for lasso

async function loadMapData() {
  try {
    const resp = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
    usTopoData = await resp.json();
  } catch(e) { console.warn("Map load failed:", e); }
  renderMap();
}

function renderMap() {
  const container = document.getElementById('map-container');
  const w = container.clientWidth, h = container.clientHeight;
  if (!w || !h) return;

  d3.select("#map-container svg").remove();
  const svg = d3.select("#map-container").append("svg").attr("width", w).attr("height", h);

  const defs = svg.append("defs");

  const g = svg.append("g");
  mapSvg = svg; mapG = g;

  const zoom = d3.zoom().scaleExtent([1, 24])
    .filter((ev) => !ev.shiftKey || ev.type === 'wheel')
    .on("zoom", (ev) => {
    g.attr("transform", ev.transform);
    currentZoom = ev.transform;
    const k = ev.transform.k;
    const dotScale = Math.sqrt(k);
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||0.6)/k; });
    g.selectAll(".venue-marker").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||1.5)/dotScale; });
    g.selectAll(".venue-marker-g").each(function() {
      const el = d3.select(this);
      el.attr("transform", `translate(${el.attr("data-tx")},${el.attr("data-ty")}) scale(${1/dotScale})`);
    });
    applyZoomSpread(g, k);
  });
  svg.call(zoom);
  if (currentZoom) svg.call(zoom.transform, currentZoom);
  mapZoom = zoom;

  const projection = d3.geoAlbersUsa().fitSize([w*0.92, h*0.88], {type:"Sphere"});
  projection.translate([w*0.48, h*0.49]);
  mapProjection = projection;

  // States
  if (usTopoData) {
    const states = topojson.feature(usTopoData, usTopoData.objects.states);
    g.append("g").selectAll("path").data(states.features).enter().append("path")
      .attr("d", d3.geoPath().projection(projection))
      .attr("class", "state-path")
      .attr("stroke", function(d) {
        if (!viewMode) return "rgba(255,255,255,0.08)";
        const sn = d.properties.name;
        const rn = STATE_REGION[sn];
        const rd = rn ? data[rn] : null;
        if (!rd) return "rgba(255,255,255,0.04)";
        const isActive = !selectedRegionName || selectedRegionName === rn;
        return isActive ? rd.color + "60" : "rgba(255,255,255,0.06)";
      })
      .attr("stroke-width", function(d) {
        if (!viewMode) return 0.6;
        const rn = STATE_REGION[d.properties.name];
        return selectedRegionName && selectedRegionName === rn ? 1.5 : 0.6;
      })
      .each(function(d) {
        const rn = STATE_REGION[d.properties.name];
        const sw = viewMode && selectedRegionName && selectedRegionName === rn ? 1.5 : 0.6;
        d3.select(this).attr("data-base-sw", sw);
      })
      .attr("fill", function(d) {
        const sn = d.properties.name;
        const rn = STATE_REGION[sn];
        const rd = rn ? data[rn] : null;
        if (!rd) return viewMode ? "rgba(255,255,255,0.02)" : "rgba(255,255,255,0.015)";
        if (viewMode) {
          const isActive = !selectedRegionName || selectedRegionName === rn;
          return rd.color + (isActive ? "20" : "08");
        }
        return rd.color + "10";
      })
      .style("cursor", viewMode ? "pointer" : "pointer")
      .on("click", function(e, d) {
        if (viewMode) {
          const rn = STATE_REGION[d.properties.name];
          if (rn) { toggleRegion(rn); }
          return;
        }
        assignStateRegion(d.properties.name);
      })
      .on("mouseenter", function(e, d) {
        d3.select(this).attr("stroke", "rgba(255,255,255,0.3)");
        const sn = d.properties.name;
        const rn = STATE_REGION[sn];
        ttSchool.textContent = sn;
        ttRegion.textContent = rn ? `Region: ${rn}` : 'No region assigned';
        ttRegion.style.color = rn && data[rn] ? data[rn].color : '#666';
        document.getElementById("tt-groups").style.display = "none";
        tooltip.classList.add("visible");
        tooltip.style.left = (e.clientX - mapRect.left + 14) + "px";
        tooltip.style.top = (e.clientY - mapRect.top - 32) + "px";
      })
      .on("mousemove", function(e) {
        tooltip.style.left = (e.clientX - mapRect.left + 14) + "px";
        tooltip.style.top = (e.clientY - mapRect.top - 32) + "px";
      })
      .on("mouseleave", function() {
        d3.select(this).attr("stroke", function(d2) {
          if (!viewMode) return "rgba(255,255,255,0.08)";
          const rn = STATE_REGION[d2.properties.name];
          const rd = rn ? data[rn] : null;
          if (!rd) return "rgba(255,255,255,0.04)";
          const isActive = !selectedRegionName || selectedRegionName === rn;
          return isActive ? rd.color + "60" : "rgba(255,255,255,0.06)";
        });
        tooltip.classList.remove("visible");
      });
  }

  const tooltip = document.getElementById("tooltip");
  const ttSchool = document.getElementById("tt-school");
  const ttRegion = document.getElementById("tt-region");
  const mapRect = document.querySelector(".map-area").getBoundingClientRect();

  // Collect all assigned schools for overlap check
  const assignedSchools = new Set();
  for (const rd of Object.values(data)) {
    for (const s of rd.schools) assignedSchools.add(s);
  }

  // Unassigned group dots (white) ‚Äî drawn first so assigned dots are on top
  const unassignedSchools = new Set();
  for (const g2 of unassigned) {
    const school = schoolOf(g2) || findSchoolForGroup(displayName(g2));
    if (school) unassignedSchools.add(school);
  }
  for (const school of unassignedSchools) {
    if (assignedSchools.has(school)) continue; // skip if also assigned ‚Äî assigned dot takes priority
    const c = SCHOOL_COORDS[school];
    if (!c) continue;
    const p = projection([c[1], c[0]]);
    if (!p) continue;
    const [x, y] = p;
    g.append("circle").attr("cx",x).attr("cy",y).attr("r",8).attr("data-base-r",8)
      .attr("data-ox",x).attr("data-oy",y)
      .attr("fill","rgba(255,255,255,0.06)").attr("class","school-glow");
    g.append("circle").attr("cx",x).attr("cy",y).attr("r",3.5).attr("data-base-r",3.5)
      .attr("data-ox",x).attr("data-oy",y)
      .attr("fill","#fff").attr("opacity",0.5).attr("class","school-dot").style("cursor","pointer")
      .on("click", function(e) { if (!e.shiftKey && !viewMode) { tooltip.classList.remove("visible"); showSchoolModal(school); } })
      .on("mouseenter", function(e) {
        const k = currentZoom ? currentZoom.k : 1;
        d3.select(this).attr("r", 7/Math.sqrt(k));
        ttSchool.textContent = school;
        ttRegion.textContent = "Unassigned"; ttRegion.style.color = "#888";
        const grps = SCHOOL_GROUPS[school];
        const ttg = document.getElementById("tt-groups");
        if (grps && grps.length) {
          const poolGroups = grps.filter(gg => unassigned.some(u => displayName(u) === gg));
          ttg.innerHTML = poolGroups.map(gg => `<span style="color:#ddd">${gg}</span>`).join(" ¬∑ ");
          ttg.style.display = poolGroups.length ? "block" : "none";
        } else ttg.style.display="none";
        tooltip.classList.add("visible");
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      })
      .on("mousemove", function(e) {
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      })
      .on("mouseleave", function() {
        d3.select(this).attr("r", 3.5/Math.sqrt(currentZoom?currentZoom.k:1));
        tooltip.classList.remove("visible");
      });
  }

  // Assigned dots
  const hlSchools = viewMode && highlightedQF !== null ? getQFSchools(selectedRegionName, highlightedQF) : null;
  for (const [rn, rd] of Object.entries(data)) {
    const isActive = !selectedRegionName || selectedRegionName === rn;
    for (const school of rd.schools) {
      const c = SCHOOL_COORDS[school];
      if (!c) continue;
      const p = projection([c[1], c[0]]);
      if (!p) continue;
      const [x, y] = p;

      const isInQF = hlSchools ? hlSchools.has(school) : false;
      const isDimmedByQF = hlSchools && !isInQF;
      const isBrightByQF = hlSchools && isInQF;

      const dotR = isBrightByQF ? 6 : (isActive && selectedRegionName ? 4.5 : 3);
      const dotOp = isDimmedByQF ? 0.08 : (isActive ? (viewMode ? 0.9 : 0.85) : (viewMode ? 0.12 : 0.1));

      if (isActive && selectedRegionName && !isDimmedByQF) {
        g.append("circle").attr("cx",x).attr("cy",y)
          .attr("r", isBrightByQF ? 14 : 10).attr("data-base-r", isBrightByQF ? 14 : 10)
          .attr("data-ox",x).attr("data-oy",y)
          .attr("fill", rd.color + (isBrightByQF ? "25" : "15")).attr("class","school-glow");
      }
      g.append("circle").attr("cx",x).attr("cy",y).attr("r",dotR).attr("data-base-r",dotR)
        .attr("data-ox",x).attr("data-oy",y)
        .attr("fill",rd.color).attr("opacity",dotOp).attr("class","school-dot").style("cursor","pointer")
        .on("click", function(e) { if (!e.shiftKey && !viewMode) { tooltip.classList.remove("visible"); showSchoolModal(school); } })
        .on("mouseenter", function(e) {
          const k = currentZoom ? currentZoom.k : 1;
          d3.select(this).attr("r", 7/Math.sqrt(k));
          ttSchool.textContent = school;
          ttRegion.textContent = rn; ttRegion.style.color = rd.accent||rd.color;
          const grps = SCHOOL_GROUPS[school];
          const ttg = document.getElementById("tt-groups");
          if (grps && grps.length) { ttg.innerHTML = grps.map(g=>`<span style="color:#ddd">${g}</span>`).join(" ¬∑ "); ttg.style.display="block"; }
          else ttg.style.display="none";
          tooltip.classList.add("visible");
          tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
          tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
        })
        .on("mousemove", function(e) {
          tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
          tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
        })
        .on("mouseleave", function() {
          d3.select(this).attr("r", dotR/Math.sqrt(currentZoom?currentZoom.k:1));
          tooltip.classList.remove("visible");
        });
    }
  }

  // Venue markers for selected region (scaled to match 2026 map)
  if (selectedRegionName && data[selectedRegionName]) {
    const rd = data[selectedRegionName];

    const vg = g.append("g").attr("class","venue-markers");

    if (rd.semifinal && rd.semifinal.lat) {
      const sp = projection([rd.semifinal.lng, rd.semifinal.lat]);
      if (sp) {
        const sg = vg.append("g").attr("class","venue-marker-g").attr("data-tx",sp[0]).attr("data-ty",sp[1]).attr("transform",`translate(${sp[0]},${sp[1]})`);
        const star = d3.symbol().type(d3.symbolStar).size(100);
        sg.append("circle").attr("r",14).attr("fill",rd.color+"15").style("pointer-events","none");
        sg.append("path").attr("d", star()).attr("fill","#FFD700").attr("stroke","#fff").attr("stroke-width",1.5).attr("opacity",0.75)
          .attr("class","venue-marker").attr("data-base-sw",1.5).style("pointer-events","none");
        // Click catcher
        sg.append("circle").attr("r",8).attr("fill","transparent").style("cursor","pointer")
          .on("click", ((rn) => () => { if (!viewMode) { tooltip.classList.remove("visible"); showSFModal(rn); } })(selectedRegionName));
      }
    }

    // Group QFs by location for co-located venues
    const venueGroups = {};
    rd.quarterfinals.forEach((qf, i) => {
      if (!qf.lat) return;
      const key = qf.lat + ',' + qf.lng;
      if (!venueGroups[key]) venueGroups[key] = [];
      venueGroups[key].push({qf, idx: i});
    });

    for (const [key, vqfs] of Object.entries(venueGroups)) {
      const first = vqfs[0];
      const p = projection([first.qf.lng, first.qf.lat]);
      if (!p) continue;
      const hlEntry = vqfs.find(v => viewMode && highlightedQF === v.idx);
      const isHL = !!hlEntry;
      const displayIdx = hlEntry ? hlEntry.idx : first.idx;
      const qg = vg.append("g").attr("class","venue-marker-g")
        .attr("data-tx",p[0]).attr("data-ty",p[1])
        .attr("transform",`translate(${p[0]},${p[1]})`);
      const s = 7;
      const glowR = isHL ? 18 : 14;
      qg.append("circle").attr("r",glowR)
        .attr("fill",rd.color+(isHL?"30":"15")).attr("stroke",isHL?rd.color+"50":"none").attr("stroke-width",isHL?1.5:0)
        .style("pointer-events","none");
      qg.append("path").attr("d",`M0,${-s} L${s},0 L0,${s} L${-s},0 Z`)
        .attr("fill",isHL ? (rd.accent||rd.color) : rd.color).attr("stroke","#fff").attr("stroke-width",isHL?2.5:1.5).attr("opacity",0.75)
        .attr("class","venue-marker").attr("data-base-sw",isHL?2.5:1.5).style("pointer-events","none");
      qg.append("text").attr("x",0).attr("y",0).attr("dy","0.35em").attr("text-anchor","middle")
        .attr("fill","#fff").attr("font-size","8px").attr("font-weight","700").attr("font-family","'Space Mono',monospace")
        .attr("pointer-events","none").text(displayIdx+1);
      // "+" pip for co-located venues
      if (vqfs.length > 1) {
        qg.append("text").attr("x",s-2).attr("y",-s+2).attr("text-anchor","start")
          .attr("fill","#fff").attr("font-size","10px").attr("font-weight","900").attr("font-family","'Space Mono',monospace")
          .attr("pointer-events","none").attr("opacity",0.85).text("+");
      }
      // Click catcher
      const cc = qg.append("circle").attr("r",9).attr("fill","transparent").style("cursor","pointer");
      cc.on("mouseenter", function(e) {
        ttSchool.textContent = first.qf.location||'No location';
        const hoverMeta = vqfs.length > 1
          ? vqfs.map(v => `QF${v.idx+1} (${v.qf.date||''})`).join(' + ')
          : `QF ${first.idx+1} ¬∑ ${first.qf.date||''} ¬∑ ${first.qf.groups.length} groups`;
        ttRegion.textContent = hoverMeta + (viewMode?' ¬∑ click to highlight':'');
        ttRegion.style.color = rd.accent||rd.color;
        document.getElementById("tt-groups").style.display = "none";
        tooltip.classList.add("visible");
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      }).on("mousemove", function(e) {
        tooltip.style.left = (e.clientX-mapRect.left+14)+"px";
        tooltip.style.top = (e.clientY-mapRect.top-32)+"px";
      }).on("mouseleave", function() {
        tooltip.classList.remove("visible");
      });
      cc.on("click", ((rn, venueQFs) => (e) => {
        tooltip.classList.remove("visible");
        const entries = venueQFs.map(v => ({
          qf: data[rn].quarterfinals[v.idx], qfIdx: v.idx, regionName: rn, regionData: data[rn]
        }));
        if (viewMode) {
          if (venueQFs.length === 1) {
            highlightedQF = highlightedQF === venueQFs[0].idx ? null : venueQFs[0].idx;
            if (highlightedQF !== null) {
              showVenuePopup(e.clientX, e.clientY, entries, 0);
            } else { closeVenuePopup(); }
          } else {
            // Find currently highlighted tab, default to first
            const curTab = venueQFs.findIndex(v => highlightedQF === v.idx);
            const tab = curTab >= 0 ? curTab : 0;
            highlightedQF = venueQFs[tab].idx;
            showVenuePopup(e.clientX, e.clientY, entries, tab);
          }
          renderMap();
          document.getElementById('venue-popup').style.display = document.getElementById('venue-popup')._qfEntries ? 'block' : 'none';
        } else {
          if (venueQFs.length === 1) {
            showQFDetailModal(rn, venueQFs[0].idx);
          } else {
            showVenuePopup(e.clientX, e.clientY, entries, 0);
          }
        }
      })(selectedRegionName, vqfs));
    }
  }

  // Post-render zoom
  if (currentZoom && currentZoom.k !== 1) {
    const k = currentZoom.k;
    const dotScale = Math.sqrt(k);
    g.selectAll(".school-dot").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".school-glow").attr("r", function() { return (+d3.select(this).attr("data-base-r"))/dotScale; });
    g.selectAll(".state-path").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||0.6)/k; });
    g.selectAll(".venue-marker").attr("stroke-width", function() { return (+d3.select(this).attr("data-base-sw")||1.5)/dotScale; });
    g.selectAll(".venue-marker-g").each(function() {
      const el = d3.select(this);
      el.attr("transform", `translate(${el.attr("data-tx")},${el.attr("data-ty")}) scale(${1/dotScale})`);
    });
    applyZoomSpread(g, k);
  }

  updateMapStats();
  renderLegend();
}

function renderLegend() {
  const el = document.getElementById('map-legend');
  let h = '<div class="legend-title">Regions</div>';
  for (const [name, rd] of Object.entries(data)) {
    const active = selectedRegionName === name;
    h += `<div class="legend-item" onclick="toggleRegion('${esc(name)}')" style="${active?'color:#fff;font-weight:600':''}">`;
    h += `<div class="legend-swatch" style="background:${rd.color}${active?'':'88'}"></div>${name}</div>`;
  }
  el.innerHTML = h;
}

window.zoomIn = () => { if (mapSvg&&mapZoom) mapSvg.transition().duration(300).call(mapZoom.scaleBy,1.5); };
window.zoomOut = () => { if (mapSvg&&mapZoom) mapSvg.transition().duration(300).call(mapZoom.scaleBy,1/1.5); };
window.resetZoom = () => { currentZoom=null; if (mapSvg&&mapZoom) mapSvg.transition().duration(500).call(mapZoom.transform,d3.zoomIdentity); };

// ‚îÄ‚îÄ‚îÄ LASSO SELECTION ‚îÄ‚îÄ‚îÄ
(function() {
  const mapArea = document.getElementById('map-area');
  const lassoEl = document.getElementById('lasso-rect');
  const hintEl = document.getElementById('lasso-hint');
  let lassoActive = false, lassoStart = null;

  // Show/hide hint based on shift key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Shift') hintEl.style.display = 'none';
  });
  document.addEventListener('keyup', (e) => {
    if (e.key === 'Shift' && !lassoActive) hintEl.style.display = '';
  });

  mapArea.addEventListener('mousedown', (e) => {
    if (!e.shiftKey || viewMode) return;
    e.preventDefault();
    e.stopPropagation();
    lassoActive = true;
    const rect = mapArea.getBoundingClientRect();
    lassoStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    lassoEl.style.left = lassoStart.x + 'px';
    lassoEl.style.top = lassoStart.y + 'px';
    lassoEl.style.width = '0px';
    lassoEl.style.height = '0px';
    lassoEl.style.display = 'block';
    // Disable zoom while lasso is active
    if (mapSvg && mapZoom) mapSvg.on('.zoom', null);
  });

  document.addEventListener('mousemove', (e) => {
    if (!lassoActive) return;
    const rect = mapArea.getBoundingClientRect();
    const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
    const x = Math.min(lassoStart.x, cx), y = Math.min(lassoStart.y, cy);
    const w = Math.abs(cx - lassoStart.x), h = Math.abs(cy - lassoStart.y);
    lassoEl.style.left = x + 'px';
    lassoEl.style.top = y + 'px';
    lassoEl.style.width = w + 'px';
    lassoEl.style.height = h + 'px';
  });

  document.addEventListener('mouseup', (e) => {
    if (!lassoActive) return;
    lassoActive = false;
    lassoEl.style.display = 'none';
    hintEl.style.display = '';

    // Re-enable zoom
    if (mapSvg && mapZoom) mapSvg.call(mapZoom);

    const rect = mapArea.getBoundingClientRect();
    const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
    const x1 = Math.min(lassoStart.x, cx), y1 = Math.min(lassoStart.y, cy);
    const x2 = Math.max(lassoStart.x, cx), y2 = Math.max(lassoStart.y, cy);

    // Minimum drag size
    if (x2 - x1 < 10 || y2 - y1 < 10) return;

    // Find all schools whose projected coords fall inside the lasso rect
    // Need to account for current zoom transform
    const t = currentZoom || d3.zoomIdentity;
    const selected = [];

    // Check all schools in all regions + unassigned
    const allSchools = new Set(Object.keys(SCHOOL_COORDS));
    for (const school of allSchools) {
      const c = SCHOOL_COORDS[school];
      if (!c) continue;
      const p = mapProjection([c[1], c[0]]);
      if (!p) continue;
      // Apply zoom transform to projected point
      const sx = t.applyX(p[0]);
      const sy = t.applyY(p[1]);
      if (sx >= x1 && sx <= x2 && sy >= y1 && sy <= y2) {
        selected.push(school);
      }
    }

    if (!selected.length) return;

    // Find which groups belong to selected schools (encode with @school)
    const selectedGroups = [];
    for (const school of selected) {
      const groups = SCHOOL_GROUPS[school];
      if (groups) selectedGroups.push(...groups.map(g => g + '@' + school));
    }

    showModal(`Assign ${selected.length} Schools (${selectedGroups.length} groups)`, `
      <div style="max-height:120px;overflow-y:auto;font-size:11px;color:#888;margin-bottom:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px">
        ${selected.map(s => `<div>${s}</div>`).join('')}
      </div>
      <div class="modal-label">Assign all groups to</div>
      <select class="modal-input" id="m-target">
        ${buildAssignSelect(selectedRegionName ? selectedRegionName + '|0' : '__pool__')}
      </select>
    `, () => {
      const target = document.getElementById('m-target').value;
      saveUndo();

      // Remove groups from current locations (match by displayName+school)
      for (const grp of selectedGroups) {
        const dn = displayName(grp), sc = schoolOf(grp);
        const poolIdx = unassigned.findIndex(u => displayName(u) === dn && schoolOf(u) === sc);
        if (poolIdx !== -1) { unassigned.splice(poolIdx, 1); continue; }
        for (const rd of Object.values(data)) {
          let found = false;
          for (const qf of rd.quarterfinals) {
            const gi = qf.groups.findIndex(g => displayName(g) === dn && schoolOf(g) === sc);
            if (gi !== -1) { qf.groups.splice(gi, 1); found = true; break; }
          }
          if (found) break;
        }
      }

      // Assign
      if (target === '__pool__') {
        unassigned.push(...selectedGroups);
      } else {
        const [targetRn, targetQi] = target.split('|');
        if (targetQi === 'new') {
          data[targetRn].quarterfinals.push({date:'',location:'',lat:null,lng:null,groups:[...selectedGroups]});
        } else {
          data[targetRn].quarterfinals[parseInt(targetQi)].groups.push(...selectedGroups);
        }
        openRegions[targetRn] = true;
      }

      for (const rn of Object.keys(data)) rebuildSchools(rn);
      renderEditor(); renderMap();
    });
  });
})();

// ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', (e) => {
  // Ctrl+Z / Cmd+Z: Undo
  if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
    e.preventDefault();
    undoAction();
    return;
  }
  // Escape: Close modal or UK popup
  if (e.key === 'Escape') {
    if (document.getElementById('modal-overlay').classList.contains('active')) {
      closeModal();
    } else if (document.querySelector('.uk-popup-overlay')) {
      closeUKPopup();
    }
    return;
  }
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
renderEditor();
loadMapData();
window.addEventListener('resize', () => renderMap());

</script>
</body>
</html>
